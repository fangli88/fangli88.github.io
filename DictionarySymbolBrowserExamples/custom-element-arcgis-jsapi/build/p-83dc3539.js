import"./p-476cf7c4.js";import{m as e,U as t,Z as n,ap as r}from"./p-ab028778.js";import"./p-3cd8f347.js";import{t as o}from"./p-17b09f4f.js";import{a as l}from"./p-65502cfa.js";import{o as i}from"./p-c39cd353.js";async function u(r,u){const c=r.instance.portalItem;return c&&c.id?(await c.load(u),function(t){const n=t.instance.portalItem;if(-1===t.supportedTypes.indexOf(n.type))throw new e("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:n.type,expectedType:t.supportedTypes.join(", ")})}(r),async function(r,u){const c=r.instance,f=c.portalItem,{url:m,title:d}=f,y=i(f);if("group"===c.type)return c.read({title:d},y),function(r,o){let i;const u=r.portalItem.type;switch(u){case"Feature Service":i=l.FeatureLayer;break;case"Stream Service":i=l.StreamLayer;break;case"Scene Service":i=l.SceneLayer;break;case"Feature Collection":i=l.FeatureLayer;break;default:throw new e("portal:unsupported-item-type-as-group",`The item type '${u}' is not supported as a 'GroupLayer'`)}let c;return i().then((e=>(c=e,s(o)))).then((e=>p(e)>0?a(r,c,e):function(e,r){return e.portalItem.url?n(e.portalItem.url,{responseType:"json",query:{f:"json"}}).then((t=>{var n,o;const l=t.data;function i(e){return{id:e.id,name:e.name}}l&&a(e,r,{layers:null==(n=l.layers)?void 0:n.map(i),tables:null==(o=l.tables)?void 0:o.map(i)})})):t()}(r,c)))}(c,r);m&&c.read({url:m},y);const v=await s(r,u);return v&&c.read(v,y),c.resourceReferences={portalItem:f,paths:y.readResourcePaths},c.read({title:d},y),o(c,y)}(r,u)):t()}function a(e,t,n){let r=n.layers||[];const o=n.tables||[];"Feature Collection"===e.portalItem.type&&(r.forEach((e=>{var t;"Table"===(null==e||null==(t=e.layerDefinition)?void 0:t.type)&&o.push(e)})),r=r.filter((e=>{var t;return"Table"!==(null==e||null==(t=e.layerDefinition)?void 0:t.type)}))),r.reverse().forEach((r=>{const o=c(e,t,n,r);e.add(o)})),o.reverse().forEach((r=>{const o=c(e,t,n,r);e.tables.add(o)}))}function c(e,t,n,o){const l=new t({portalItem:e.portalItem.clone(),layerId:o.id,sublayerTitleMode:"service-name"});if("Feature Collection"===e.portalItem.type){const t={origin:"portal-item",portal:e.portalItem.portal||r.getDefault()};l.read(o,t);const i=n.showLegend;null!=i&&l.read({showLegend:i},t)}return l}function s(e,n){if(!1===e.supportsData)return t();const r=e.instance;return r.portalItem.fetchData("json",n).catch((()=>null)).then((e=>{const t=e;let n;if(function(e){return"stream"!==e.type&&"layerId"in e}(r)){let o=!0;return e&&p(t)>0&&(null==r.layerId&&(r.layerId=function(e){const t=e.layers;if(t&&t.length)return t[0].id;const n=e.tables;return n&&n.length?n[0].id:null}(t)),n=function(e,t){const n=e.layers;if(n)for(let e=0;e<n.length;e++)if(n[e].id===t)return n[e];const r=e.tables;if(r)for(let e=0;e<r.length;e++)if(r[e].id===t)return r[e];return null}(t,r.layerId),n&&(1===p(t)&&(o=!1),null!=e.showLegend&&(n.showLegend=e.showLegend))),o&&"service-name"!==r.sublayerTitleMode&&(r.sublayerTitleMode="item-title-and-service-name"),n}return e}))}function p(e){var t,n,r,o;return(null!=(t=null==e||null==(n=e.layers)?void 0:n.length)?t:0)+(null!=(r=null==e||null==(o=e.tables)?void 0:o.length)?r:0)}export{u as load}