import"./p-476cf7c4.js";import{D as e,J as t,K as i,L as s,l as n,b3 as r,b6 as a,aS as o,b7 as l,m as h,U as c,ae as u,s as d,W as p,E as f,b9 as m,I as v,bp as g,e3 as y,Y as b,bV as w,ay as _,aW as M,aU as I,t as k,aX as x,dU as F,b as O,O as T,aR as A,aB as C,aD as E,bQ as L,k as P,c0 as j,dt as $,cQ as N,cX as S,e4 as V,e5 as R,cJ as D,e6 as z,e7 as U,e8 as B,bd as H,P as W,cp as q,e9 as G,cF as K,M as J,dO as Y,ca as X,ea as Q,j as Z,i as ee,eb as te,ec as ie,ax as se,dY as ne,ed as re,ee as ae,ef as oe,bf as le,d as he,w as ce,b_ as ue,eg as de,aE as pe,aY as fe,eh as me,df as ve,bN as ge,aP as ye,bM as be,z as we,y as _e,F as Me,bw as Ie}from"./p-dc4230e0.js";import{o as ke}from"./p-197a5d34.js";import"./p-643e1e47.js";import"./p-66f366a9.js";import"./p-ebb65ba7.js";import"./p-78c83631.js";import{s as xe,r as Fe,u as Oe,d as Te,l as Ae,w as Ce,p as Ee}from"./p-a8d014d4.js";import{n as Le,a as Pe,r as je,o as $e,e as Ne,H as Se}from"./p-d1386a23.js";import{u as Ve}from"./p-365c5902.js";import{d as Re,C as De,h as ze,B as Ue,O as Be,j as He,y as We,$ as qe}from"./p-76e49c46.js";import"./p-540c739d.js";import{i as Ge}from"./p-f207db84.js";import{s as Ke,M as Je}from"./p-71546ce1.js";import"./p-fa146c73.js";import"./p-00eed204.js";import"./p-505542c8.js";import"./p-b415e09b.js";import{b as Ye,l as Xe}from"./p-05aa0405.js";import{f as Qe}from"./p-f1856c76.js";import{m as Ze}from"./p-6e5ff36c.js";import{m as et,l as tt,p as it}from"./p-5e52b0f8.js";import{p as st}from"./p-6a7ee25c.js";import{p as nt}from"./p-6d77caaa.js";import{d as rt}from"./p-536a38f2.js";import{R as at,m as ot}from"./p-aedb886e.js";import"./p-0a74e573.js";import"./p-46a6b4f6.js";import"./p-a1a69fdc.js";import"./p-0038f454.js";import"./p-1f2c53c6.js";import"./p-0c52ed76.js";import"./p-725a886f.js";import"./p-b3fbb570.js";import{t as lt}from"./p-4cc1d148.js";import{e as ht}from"./p-d69473fe.js";import{o as ct}from"./p-3ce6769f.js";import{s as ut}from"./p-3a5e7221.js";import{f as dt}from"./p-25ae7985.js";import"./p-d5b5a48a.js";import"./p-f7d3c7de.js";import"./p-311069c2.js";import"./p-44614414.js";import"./p-43e6d0b9.js";import{u as pt}from"./p-24476141.js";import"./p-0e87baef.js";import"./p-80a59d87.js";import"./p-90bfedb8.js";import{l as ft,O as mt}from"./p-a2136a85.js";import{d as vt,c as gt,a as yt}from"./p-6c319af5.js";import{s as bt}from"./p-42ae9f69.js";import{e as wt}from"./p-cc293e3c.js";import{n as _t,f as Mt,u as It,e as kt,H as xt}from"./p-c8000054.js";import{l as Ft}from"./p-dabedd67.js";import{l as Ot,p as Tt}from"./p-51852aa1.js";import{u as At,h as Ct}from"./p-06ee2632.js";function Et(){return function(e,t){if(!e[t])throw new TypeError(`Cannot auto bind undefined function '${t}'`);return{value:(i=e[t],function(e,...t){!function(e){const{type:t}=e;return e instanceof KeyboardEvent||"keyup"===t||"keydown"===t||"keypress"===t}(e)?i.call(this,e,...t):"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),e.target.click())})};var i}}var Lt;let Pt=Lt=class extends s{constructor(e){super(e),this.type="none"}clone(){return new Lt({type:this.type})}};var jt;e([t({none:"none",stayAbove:"stay-above"})],Pt.prototype,"type",void 0),Pt=Lt=e([i("esri.ground.NavigationConstraint")],Pt);const $t=n.getLogger("esri.Ground");let Nt=jt=class extends(r(a)){constructor(e){super(e),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new o;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"!==e.type&&"base-elevation"!==e.type&&$t.error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)};this.layers.on("after-add",(e=>t(e.item))),this.layers.on("after-remove",(e=>{e.item.parent=null}))}initialize(){this.when().catch((e=>{$t.error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)t.destroy();this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set layers(e){this._set("layers",l(e,this._get("layers")))}writeLayers(e,t,i,s){const n=[];e?(s={...s,layerContainerType:"ground"},e.forEach((e=>{if("write"in e){const t={};ke(e)().write(t,s)&&n.push(t)}else s&&s.messages&&s.messages.push(new h("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in the ground`,{layer:e}))})),t.layers=n):t.layers=n}load(e){return this.addResolvingPromise(this._loadFromSource(e)),c(this)}loadAll(){return Ge(this,(e=>{e(this.layers)}))}async queryElevation(e,t){await this.load({signal:null==t?void 0:t.signal});const{ElevationQuery:i}=await import("./p-62976dc6.js");u(t);const s=new i,n=this.layers.filter(St).toArray();return s.queryAll(n,e,t)}async createElevationSampler(e,t){await this.load({signal:null==t?void 0:t.signal});const{ElevationQuery:i}=await import("./p-62976dc6.js");u(t);const s=new i,n=this.layers.filter(St).toArray();return s.createSamplerAll(n,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:d(this.surfaceColor),navigationConstraint:d(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new jt({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):c(null)}_loadLayersFromJSON(e,t,i){const s=t&&t.origin||"web-scene",n=t&&t.portal||null,r=t&&t.url||null;return import("./p-6343fc8b.js").then((({populateOperationalLayers:t})=>{u(i);const a=[];return e.layers&&Array.isArray(e.layers)&&a.push(t(this.layers,e.layers,{context:{origin:s,url:r,portal:n,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"})),p(a)})).then((()=>{}))}};function St(e){return"elevation"===e.type||function(e){return e&&"createElevationSampler"in e}(e)}e([f({json:{read:!1}})],Nt.prototype,"layers",null),e([m("layers")],Nt.prototype,"writeLayers",null),e([f({readOnly:!0})],Nt.prototype,"resourceInfo",void 0),e([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:v,read:{reader:g,source:"transparency"},write:{writer:(e,t)=>{t.transparency=y(e)},target:"transparency"}}})],Nt.prototype,"opacity",void 0),e([f({type:b,json:{type:[v],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],Nt.prototype,"surfaceColor",void 0),e([f({type:Pt,json:{write:!0}})],Nt.prototype,"navigationConstraint",void 0),Nt=jt=e([i("esri.Ground")],Nt);var Vt=Nt;const Rt=n.getLogger("esri.support.basemapUtils"),Dt=n.getLogger("esri.support.groundUtils"),zt={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}},Ut=n.getLogger("esri.Map");let Bt=class extends(Ot(Tt(_.EventedMixin(M)))){constructor(e){super(e),this.allLayers=new Ft({root:this,rootCollectionNames:["basemap.baseLayers","ground.layers","layers","basemap.referenceLayers"],getChildrenFunction:e=>e.layers}),this.allTables=this._createTablesFlattener(this),this.basemap=null,this.ground=new Vt,this._basemapCache={}}destroy(){var e,t;this.allLayers.destroy(),this.allTables.destroy(),null==(e=this.ground)||e.destroy(),null==(t=this.basemap)||t.destroy(),function(e){for(const t in e){const i=e[t];!1===(null==i?void 0:i.destroyed)&&i.destroy(),delete e[t]}}(this._basemapCache),this._basemapCache=null}castBasemap(e){return function(e,t){var i;let s;if("string"==typeof e){if(!(e in Ke)){const t=Object.keys(Ke).map((e=>`"${e}"`)).join(", ");return Rt.warn(`Unable to find basemap definition for: ${e}. Try one of these: ${t}`),null}t&&(s=t[e]),s||(s=Je.fromId(e),t&&(t[e]=s))}else s=w(Je,e);return null!=(i=s)&&i.destroyed&&(Rt.warn("The provided basemap is already destroyed",{basemap:s}),s=null),s}(e,this._basemapCache)}castGround(e){return function(e){let t;return"string"==typeof e?e in zt?t=new Vt({resourceInfo:{data:{layers:[zt[e]]}}}):Dt.warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`):t=w(Vt,e),t}(e)||(Ut.error("Map.ground may not be set to null or undefined"),this._get("ground"))}findLayerById(e){return this.allLayers.find((t=>t.id===e))}findTableById(e){return this.allTables.find((t=>t.id===e))}_createTablesFlattener(e){return new Ft({root:e,rootCollectionNames:["tables","layers"],getChildrenFunction:e=>e&&"group"===e.type?this._createTablesFlattener(e):null,itemFilterFunction:e=>this._isMapOrGroupLayer(e.parent)&&e.parent.tables.includes(e)})}_isMapOrGroupLayer(e){return e&&(e===this||this._isGroupLayer(e))}_isGroupLayer(e){return e&&"group"===e.type}};e([f({readOnly:!0,dependsOn:[],autoTracked:!1})],Bt.prototype,"allLayers",void 0),e([f({readOnly:!0})],Bt.prototype,"allTables",void 0),e([f({type:Je})],Bt.prototype,"basemap",void 0),e([I("basemap")],Bt.prototype,"castBasemap",null),e([f({type:Vt,nonNullable:!0})],Bt.prototype,"ground",void 0),e([I("ground")],Bt.prototype,"castGround",null),Bt=e([i("esri.Map")],Bt);var Ht=Bt;let Wt=class extends M{constructor(e){super(e),this.view=null,this.baseLayerViews=new o,this.referenceLayerViews=new o,this._loadingHandle=Re(this,"view.map.basemap",(e=>{e&&e.load().catch((()=>{}))}))}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){return!(this.view&&this.view.suspended||!(this.view&&this.view.map&&this.view.map.basemap)||this.view.map.basemap.loaded)}};function qt(e,t){for(const[i,s]of e)if(t(s,i))return!0;return!1}e([f({constructOnly:!0})],Wt.prototype,"view",void 0),e([f({readOnly:!0})],Wt.prototype,"baseLayerViews",void 0),e([f({readOnly:!0})],Wt.prototype,"referenceLayerViews",void 0),e([f({readOnly:!0,dependsOn:["view.suspended"]})],Wt.prototype,"suspended",null),e([f({type:Boolean,readOnly:!0,dependsOn:["view.suspended","view.map.basemap.loaded"]})],Wt.prototype,"updating",null),Wt=e([i("esri.views.BasemapView")],Wt);const Gt=n.getLogger("esri.views.LayerViewManager");class Kt{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=C(),this._deferred=x(),this._started=!1,this.done=!1,E(this._controller.signal,(()=>{const t=new h("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{var s,n;let r,a;if(await t.load({signal:e}),"prefetchResources"in t&&await t.prefetchResources({signal:e}),t.createLayerView)r=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new h("layer:view-not-supported","No layerview implementation was found");const s=await this.layerViewImporter.importLayerView(t);u(e),r="default"in s?new s.default({layer:t,view:i}):new s({layer:t,view:i})}const o=()=>{a=L(a),r.destroy(),r.layer=null,r.parent=null,r.view=null,this.done=!0};a=E(e,o),u(e);try{await r.when()}catch(e){throw o(),e}if(!(null==(s=this._map)||null==(n=s.allLayers)?void 0:n.includes(t)))return o(),void this._deferred.reject(new h("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=r,t.emit("layerview-create",{view:i,layerView:r}),i.emit("layerview-create",{layer:t,layerView:r}),this.done=!0,this._deferred.resolve(r)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new h("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let Jt=class extends vt{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new gt,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var e;const t=null==(e=this.view.map)?void 0:e.allLayers;if(t)for(const e of t)this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e)},this._reschedule=()=>(k(this._workPromise)&&(this._workPromise=x()),this.handles.remove("reschedule"),this.handles.add(F(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var e,t,i;const s=this.view.map;if(this._map!==s&&(this.clear(),this._map=s),k(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const n=new Ft({root:this,rootCollectionNames:this._rootCollectionNames,getChildrenFunction:e=>e.layers});if(!n)return this._workPromise.resolve(),void(this._workPromise=null);for(const e of n)this._createLayerView(e);this._refreshCollections();for(const[e,t]of this._layerLayerViewInfoMap)n.includes(e)||(this._layerLayerViewInfoMap.delete(t.layer),t.destroy());const r=n.filter((e=>"group"===e.type)).map((e=>e.layers)),a=[null==s||null==(e=s.ground)?void 0:e.layers,null==s||null==(t=s.basemap)?void 0:t.baseLayers,null==s||null==(i=s.basemap)?void 0:i.referenceLayers,null==s?void 0:s.layers,...r].filter((e=>!!e));this.handles.add(a.map((e=>this._watchUpdatingTracking.addOnCollectionChange(e,this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([De(this,"view.map.allLayers","change",this._preloadLayerViewModules,this._preloadLayerViewModules),Re(this.view,["map.basemap","map.ground","map.layers","ready"],this._reschedule,!0)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return!(!O(this._workPromise)&&!this._watchUpdatingTracking.updating)||qt(this._layerLayerViewInfoMap,(e=>!e.done))}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){return await this._reschedule(),this._layerLayerViewInfoMap.has(e)?this._layerLayerViewInfoMap.get(e).promise:T(new h("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e}))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let s=0;for(const n of e){const e=this._layerLayerViewInfoMap.get(n);if(!e||!e.layerView)continue;const r=e.layerView;r.layer=n,r.parent=i,t.getItemAt(s)!==r&&t.splice(s,0,r),n.layers&&this._populateLayerViewsOwners(n.layers,r.layerViews,r),s+=1}s<t.length&&t.splice(s,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),void this.notifyChange("updating");e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new Kt(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{var i,s;t&&(A(t)||"cancelled:layerview-create"===t.name)||Gt.error(`Failed to create layerview for layer title:'${null!=(i=e.title)?i:"no title"}', id:'${null!=(s=e.id)?s:"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating")}};e([f()],Jt.prototype,"_workPromise",void 0),e([f({readOnly:!0})],Jt.prototype,"_watchUpdatingTracking",void 0),e([f({dependsOn:["supportsGround"],readOnly:!0})],Jt.prototype,"_layersToLayerViews",null),e([f({dependsOn:["_layersToLayerViews"],readOnly:!0})],Jt.prototype,"_rootCollectionNames",null),e([f()],Jt.prototype,"layerViewImporter",void 0),e([f()],Jt.prototype,"supportsGround",void 0),e([f({readOnly:!0,dependsOn:["_workPromise","_watchUpdatingTracking.updating"]})],Jt.prototype,"updating",null),e([f({constructOnly:!0})],Jt.prototype,"view",void 0),Jt=e([i("esri.views.LayerViewManager")],Jt);var Yt=Jt;let Xt=class extends M{constructor(e){super(e),this.factor=1.5,this.offsetX=0,this.offsetY=0,this.position=null,this.size=120,this.mask=null,this.maskEnabled=!0,this.overlay=null,this.overlayEnabled=!0,this.visible=!1}get version(){return(this._get("version")||0)+1}};e([f({type:Number})],Xt.prototype,"factor",void 0),e([f({type:Number})],Xt.prototype,"offsetX",void 0),e([f({type:Number})],Xt.prototype,"offsetY",void 0),e([f()],Xt.prototype,"position",void 0),e([f({type:Number,range:{min:0}})],Xt.prototype,"size",void 0),e([f()],Xt.prototype,"mask",void 0),e([f()],Xt.prototype,"maskEnabled",void 0),e([f()],Xt.prototype,"overlay",void 0),e([f()],Xt.prototype,"overlayEnabled",void 0),e([f({readOnly:!0,dependsOn:["factor","offsetX","offsetY","position","visible","mask","overlay","maskEnabled","overlayEnabled","size"]})],Xt.prototype,"version",null),e([f({type:Boolean})],Xt.prototype,"visible",void 0),Xt=e([i("esri.views.Magnifier")],Xt);var Qt=Xt;function Zt(e){return"refresh"in e}let ei=class extends M{constructor(){super(...arguments),this._handles=new Ve,this._currentTick=0}initialize(){this._handles.add([this.view.allLayerViews.on("after-changes",(()=>{this.notifyChange("tickInterval"),this._handles.remove("layerViewsUpdating"),this._handles.add(this._getLayerViewHandles(),"layerViewsUpdating")})),this.watch("tickInterval",(()=>this._restartTicking())),this.watch("view.ready",(()=>this._restartTicking()))]),this._restartTicking()}destroy(){this._handles&&(this._handles.destroy(),this._handles=null,this._intervalID&&clearInterval(this._intervalID),this._currentTick=0)}get tickInterval(){const e=this.view.allLayerViews.filter((e=>Zt(e)));return this._getCommonInterval(e)}_restartTicking(){this._currentTick=0,this._intervalID&&clearInterval(this._intervalID),this.get("view.ready")&&this.tickInterval&&(this._intervalID=setInterval((()=>{const e=Date.now();this._currentTick+=this.tickInterval,this.view.allLayerViews.forEach((t=>{if(Zt(t)){const i=Math.round(6e4*t.refreshInterval),s=this._currentTick%i==0,n=e-t.refreshTimestamp<5400;i&&s&&!n&&t.refresh(e)}}))}),this.tickInterval))}_getLayerViewHandles(){const e=[],t=()=>this.notifyChange("tickInterval");return this.view.allLayerViews.forEach((i=>{Zt(i)&&i.layer&&e.push(i.watch("refreshInterval",t),i.layer.on("refresh",(()=>{i.refresh(Date.now())})))})),e}_getCommonInterval(e){const t=(e,i)=>isNaN(e)||isNaN(i)?0:i<=0?e:t(i,e%i);return e.toArray().reduce(((e,i)=>t(Math.round(6e4*i.refreshInterval),e)),0)}};e([f()],ei.prototype,"view",void 0),e([f({readOnly:!0})],ei.prototype,"tickInterval",null),ei=e([i("esri.views.RefreshManager")],ei);var ti=ei;class ii{constructor(e,t=[]){this.eventType=e,this.keyModifiers=t}matches(e){if(e.type!==this.eventType)return!1;if(0===this.keyModifiers.length)return!0;const t=e.modifiers;for(const e of this.keyModifiers)if(!t.has(e))return!1;return!0}}const si=n.getLogger("esri.views.input.InputHandler");class ni{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const t=this._incoming[e];for(const e of t)this._incomingEventMatches.push(e.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map((e=>e.eventType))),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?si.error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback((e=>this._handleEvent(e))),e.setUninstallCallback((()=>this._onUninstall())),this._manager=e)}onUninstall(){}registerIncoming(e,t,i){let s;"function"==typeof t?(i=t,s=[]):s=t||[];const n="string"==typeof e?new ii(e,s):e,r=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=e=>{const t=this._incoming[e.match.eventType];if(t){const i=t.indexOf(e);t.splice(i,1),r(),this._manager&&this._manager.updateDependencies()}},o=new ri(n,i,{onPause:a,onRemove:a,onResume:e=>{const t=this._incoming[e.match.eventType];t&&-1===t.indexOf(e)&&(t.push(e),r(),this._manager&&this._manager.updateDependencies())}});let l=this._incoming[n.eventType];return l||(l=[],this._incoming[n.eventType]=l),l.push(o),r(),this._manager&&this._manager.updateDependencies(),o}registerOutgoing(e){if(this._outgoing[e])throw Error("There is already a callback registered for this outgoing InputEvent: "+e);const t=new ai(e,{onEmit:(e,t,i,s)=>{this._manager.emit(e.eventType,t,i,s)},onRemove:e=>{delete this._outgoing[e.eventType],this._manager.updateDependencies()}});return this._outgoing[e]=t,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),t}startCapturingPointer(e){this._manager.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):si.error("This InputHandler is not registered with an InputManager")}_handleEvent(e){const t=this._incoming[e.type];if(t)for(const i of t)if(i.match.matches(e)&&(i.callback(e),e.shouldStopPropagation()))break}}class ri{constructor(e,t,i){this.match=e,this._callback=t,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class ai{constructor(e,t){this.eventType=e,this._removed=!1,this._handler=t}emit(e,t,i){this._removed||this._handler.onEmit(this,e,t,i)}remove(){this._removed=!0,this._handler.onRemove(this)}}const oi=P("mac")?"Meta":"Ctrl";function li(e){switch(e){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}class hi extends ni{constructor(e){super(!0),this._onChange=e,this._value="mouse",this.registerIncoming("pointer-down",(e=>{this._setValue("touch"===e.data.native.pointerType?"touch":"mouse")})),this._moveHandler=this.registerIncoming("pointer-move",(e=>{this._setValue("touch"===e.data.native.pointerType?"touch":"mouse")})),this._moveHandler.pause()}_setValue(e){e!==this._value&&("touch"===e?this._moveHandler.resume():this._moveHandler.pause(),this._value=e,this._onChange(e))}}const ci=n.getLogger("esri.views.input.InputManager");let ui=class extends M{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=oi,this.latestPointerType="mouse",this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource=null,this._currentPropagation=null}get hasPendingInputs(){return this._handlers.some((e=>e.handler.hasPendingInputs))}installHandlers(e,t,i=pi.INTERNAL){if(this._nameToGroup[e])return void ci.error("There is already an InputHandler group registered under the name `"+e+"`");if(0===t.length)return void ci.error("Can't register a group of zero handlers");const s={name:e,handlers:t.map((e=>({handler:e,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null})))};this._nameToGroup[e]=s;for(let e=s.handlers.length-1;e>=0;e--){const t=s.handlers[e];this._handlers.push(t),t.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(e,i,s,n,r)=>{this._emitInputEvent(t.priorityIndex+1,e,i,s,r,n)},setPointerCapture:(e,i)=>{this._setPointerCapture(s,t,e,i)},setEventCallback:e=>{t.eventCallback=e},setUninstallCallback:e=>{t.uninstallCallback=e},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach((e=>{e.removed=!0,e.uninstallCallback()})),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):ci.error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return void 0!==this._nameToGroup[e]}updateDependencies(){const e=new Set,t=new Set;this._handlersPriority=[];for(let e=this._handlers.length-1;e>=0;e--){const t=this._handlers[e];t.priorityIndex=e,this._handlersPriority.push(t)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const s=this._handlersPriority[i];s.priorityIndex=i;let n=s.handler.hasSideEffects;if(!n)for(const t of s.handler.outgoingEventTypes)if(e.has(t)){n=!0;break}if(n)for(const i of s.handler.incomingEventMatches){e.add(i.eventType);for(const e of i.keyModifiers)li(e)||t.add(e)}s.active=n}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointerType(e){this._set("latestPointerType",e)}_onEventReceived(e,t){"pointer-capture-lost"===e&&this._pointerCaptures.delete(t.native.pointerId),this._updateKeyModifiers(e,t),this._emitInputEventFromSource(e,t,null!=this.test.timestamp?this.test.timestamp:t.native?t.native.timestamp:void 0,t.native?t.native.cancelable:void 0)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const s=()=>{if(!i){const e=new Set;this._activeKeyModifiers.forEach((t=>{e.add(t)})),this._activeKeyModifiers=e,i=!0}},n=(e,t)=>{t&&!this._activeKeyModifiers.has(e)?(s(),this._activeKeyModifiers.add(e)):!t&&this._activeKeyModifiers.has(e)&&(s(),this._activeKeyModifiers.delete(e))};if("key-down"===e||"key-up"===e){const i=t.key;this._keyModifiers.has(i)&&n(i,"key-down"===e)}const r=t.native;n("Alt",!(!r||!r.altKey)),n("Ctrl",!(!r||!r.ctrlKey)),n("Shift",!(!r||!r.shiftKey)),n("Meta",!(!r||!r.metaKey)),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerTypeHandler=new hi((e=>this._setLatestPointerType(e))),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,pi.INTERNAL),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],pi.INTERNAL)}_setPointerCapture(e,t,i,s){const n=e.name+"-"+t.priorityIndex,r=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,r),s?(r.add(n),1===r.size&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):r.has(n)&&(r.delete(n),0===r.size&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter((e=>!e.removed)),this.updateDependencies()}_emitInputEventFromSource(e,t,i,s){this._emitInputEvent(0,e,t,i,s)}_emitInputEvent(e,t,i,s,n,r){const a=void 0!==s?s:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),o={event:new di(t,i,a,r||this._activeKeyModifiers,void 0!==n&&n),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(o):this._doNewPropagation(o)}_doNewPropagation(e){this._currentPropagation={events:new bt,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){const e=this._currentPropagation;if(e){for(;this._currentPropagation.events.length>0;){const{event:t,priorityIndex:i}=this._currentPropagation.events.pop(),s=t.data&&t.data.eventId;if(null==s||!this._stoppedPropagationEventIds.has(s))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback(t),t.shouldStopPropagation()){null!=s&&this._stoppedPropagationEventIds.add(s);break}if(t.shouldPausePropagation((()=>this._continuePropagation())))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null}}_pausePropagation(e){const t=new bt;for(t.push(e);this._currentPropagation.events.length;)t.push(this._currentPropagation.events.pop());this._currentPropagation.events=t,this._currentPropagation.currentHandler=null}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const e of t.handler.incomingEventMatches){if(i.eventType!==e.eventType)continue;const t=i.keyModifiers.filter((t=>-1!==e.keyModifiers.indexOf(t)));if(t.length===i.keyModifiers.length!=(t.length===e.keyModifiers.length))return i.keyModifiers.length>e.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let e=0;for(;e<t.length&&this._compareHandlerPriority(i,t[e])>=0;)e++;t.splice(e,0,i)}return t}get debug(){const e=e=>{const t=this._setPointerCapture;this._setPointerCapture=()=>{},e(),this._setPointerCapture=t};return{injectEvent:(t,i)=>{e((()=>{this._onEventReceived(t,i)}))},disablePointerCapture:e}}};e([f({readOnly:!0})],ui.prototype,"hasPendingInputs",null),e([f()],ui.prototype,"eventSource",void 0),e([f()],ui.prototype,"recognizers",void 0),e([f({readOnly:!0})],ui.prototype,"latestPointerType",void 0),ui=e([i("esri.views.input.InputManager")],ui);class di{constructor(e,t,i,s,n){this.type=e,this.data=t,this.timestamp=i,this.modifiers=s,this.cancelable=n,this._propagationState=0,this._resumeCallback=null}stopPropagation(){this._propagationState|=1}shouldStopPropagation(){return 0!=(1&this._propagationState)}async(e){this._propagationState|=2;const t=(e,t)=>{this._propagationState&=-3;const i=this._resumeCallback;if(this._resumeCallback=null,i&&i(),t)throw e;return e};return("function"==typeof e?e():e).then((e=>t(e,!1)),(e=>t(e,!0)))}shouldPausePropagation(e){return!!(2&this._propagationState)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}}const pi={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3},fi=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],mi={};function vi(e){return!!mi[e]}fi.forEach((e=>{mi[e]=!0}));class gi{constructor(e){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this.handlers.forEach((({handler:e,priority:t},i)=>this.inputManager.installHandlers(i,[e],t)))}disconnect(){this.inputManager&&this.handlers.forEach(((e,t)=>this.inputManager.uninstallHandlers(t))),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(e,t,i,s){const n=Array.isArray(e)?e:e.split(",");if(!function(e){for(const t of e)if(!vi(t))return!1;return!0}(n))return n.some(vi)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let r,a;Array.isArray(t)?a=t:(r=t,a=[]),"function"==typeof i?r=i:s=i,s=null!=s?s:pi.DEFAULT;const o=this.createUniqueGroupName(),l=new yi(this.view,n,a,r);this.handlers.set(o,{handler:l,priority:s});for(const e of n){const t=this.handlerCounts.get(e)||0;this.handlerCounts.set(e,t+1)}return this.inputManager&&this.inputManager.installHandlers(o,[l],s),{remove:()=>this.removeHandler(o,n)}}hasHandler(e){return!!this.handlerCounts.get(e)}removeHandler(e,t){if(this.handlers.has(e)){this.handlers.delete(e);for(const e of t){const t=this.handlerCounts.get(e);void 0===t?console.error("Trying to remove handler for event that has no handlers registered: ",e):1===t?this.handlerCounts.delete(e):this.handlerCounts.set(e,t-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class yi extends ni{constructor(e,t,i,s){super(!0),this.view=e;for(const e of t)switch(e){case"click":this.registerIncoming("click",i,(e=>s(this.wrapClick(e))));break;case"double-click":this.registerIncoming("double-click",i,(e=>s(this.wrapDoubleClick(e))));break;case"immediate-click":this.registerIncoming("immediate-click",i,(e=>s(this.wrapImmediateClick(e))));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,(e=>s(this.wrapImmediateDoubleClick(e))));break;case"hold":this.registerIncoming("hold",i,(e=>s(this.wrapHold(e))));break;case"drag":this.registerIncoming("drag",i,(e=>{const t=this.wrapDrag(e);t&&s(t)}));break;case"key-down":this.registerIncoming("key-down",i,(e=>s(this.wrapKeyDown(e))));break;case"key-up":this.registerIncoming("key-up",i,(e=>s(this.wrapKeyUp(e))));break;case"pointer-down":this.registerIncoming("pointer-down",i,(e=>s(this.wrapPointer(e,"pointer-down"))));break;case"pointer-move":this.registerIncoming("pointer-move",i,(e=>s(this.wrapPointer(e,"pointer-move"))));break;case"pointer-up":this.registerIncoming("pointer-up",i,(e=>s(this.wrapPointer(e,"pointer-up"))));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,(e=>s(this.wrapPointerDrag(e))));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,(e=>s(this.wrapMouseWheel(e))));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,(e=>s(this.wrapPointer(e,"pointer-enter"))));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,(e=>s(this.wrapPointer(e,"pointer-leave"))));break;case"gamepad":this.registerIncoming("gamepad",i,(e=>{s(this.wrapGamepad(e))}));break;case"focus":this.registerIncoming("focus",i,(e=>{s(this.wrapFocus(e))}));break;case"blur":this.registerIncoming("blur",i,(e=>{s(this.wrapBlur(e))}))}}wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapClick(e){const{pointerType:t,button:i,buttons:s,x:n,y:r,native:a,eventId:o}=e.data,{cancelable:l,timestamp:h}=e;return{type:"click",pointerType:t,button:i,buttons:s,x:n,y:r,native:a,timestamp:h,screenPoint:j(n,r),mapPoint:this.getMapPoint(n,r),eventId:o,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapDoubleClick(e){const{pointerType:t,button:i,buttons:s,x:n,y:r,native:a,eventId:o}=e.data,{cancelable:l,timestamp:h}=e;return{type:"double-click",pointerType:t,button:i,buttons:s,x:n,y:r,native:a,timestamp:h,mapPoint:this.getMapPoint(n,r),eventId:o,cancelable:l,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateClick(e){const{pointerType:t,button:i,buttons:s,x:n,y:r,native:a,eventId:o}=e.data,l=a.pointerId,{cancelable:h,timestamp:c}=e;return{type:"immediate-click",pointerId:l,pointerType:t,button:i,buttons:s,x:n,y:r,native:a,timestamp:c,mapPoint:this.getMapPoint(n,r),eventId:o,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapImmediateDoubleClick(e){const{pointerType:t,button:i,buttons:s,x:n,y:r,native:a,eventId:o}=e.data,l=a.pointerId,{cancelable:h,timestamp:c}=e;return{type:"immediate-double-click",pointerId:l,pointerType:t,button:i,buttons:s,x:n,y:r,native:a,timestamp:c,mapPoint:this.getMapPoint(n,r),eventId:o,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapHold(e){const{pointerType:t,button:i,buttons:s,x:n,y:r,native:a}=e.data,{cancelable:o,timestamp:l}=e;return{type:"hold",pointerType:t,button:i,buttons:s,x:n,y:r,native:a,timestamp:l,mapPoint:this.getMapPoint(n,r),cancelable:o,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}getMapPoint(e,t){return this.view.toMap(j(e,t),{exclude:[]})}wrapDrag(e){const t=e.data,{x:i,y:s}=t.center,{action:n,pointerType:r,button:a}=t;if("start"===n&&(this.latestDragStart=t),!this.latestDragStart)return;const o=t.pointer.native,l=t.buttons,{cancelable:h,timestamp:c}=e,u={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return"end"===n&&(this.latestDragStart=void 0),{type:"drag",action:n,x:i,y:s,origin:u,pointerType:r,button:a,buttons:l,radius:t.radius,angle:$(t.angle),native:o,timestamp:c,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyDown(e){const{key:t,repeat:i,native:s}=e.data,{cancelable:n,timestamp:r}=e;return{type:"key-down",key:t,repeat:i,native:s,timestamp:r,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapKeyUp(e){const{key:t,native:i}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-up",key:t,native:i,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointer(e,t){const{x:i,y:s,button:n,buttons:r,native:a,eventId:o}=e.data,l=a.pointerId,h=a.pointerType,{cancelable:c,timestamp:u}=e;return{type:t,x:i,y:s,pointerId:l,pointerType:h,button:n,buttons:r,native:a,timestamp:u,eventId:o,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapPointerDrag(e){const{x:t,y:i,buttons:s,native:n,eventId:r}=e.data.currentEvent,{button:a}=e.data.startEvent,o=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,h=e.data.action,c={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:u,timestamp:d}=e;return{type:"pointer-drag",x:t,y:i,pointerId:o,pointerType:l,button:a,buttons:s,action:h,origin:c,native:n,timestamp:d,eventId:r,cancelable:u,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapMouseWheel(e){const{cancelable:t,data:i,timestamp:s}=e,{x:n,y:r,deltaY:a,native:o}=i;return{type:"mouse-wheel",x:n,y:r,deltaY:a,native:o,timestamp:s,cancelable:t,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}wrapGamepad(e){const{action:t,state:i,device:s}=e.data,{cancelable:n,timestamp:r}=e,{buttons:a,axes:o}=i;return{type:"gamepad",device:s,timestamp:r,action:t,buttons:a,axes:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:t=>e.async(t),preventDefault:()=>e.preventDefault()}}}let bi=class extends M{constructor(){super(...arguments),this.items=new o,this._watchUpdatingTracking=new gt,this._callbacks=new Map,this._projector=xe(),this._hiddenProjector=xe()}get needsRender(){return this.items.length>0}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(this.items,(e=>{e.added.map((e=>{const t=()=>e.render();this._callbacks.set(e,t),this._projector.append(this.surface,t)})),e.removed.map((e=>{const t=this._projector.detach(this._callbacks.get(e));this.surface.removeChild(t.domNode),this._callbacks.delete(e)}))}))}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach((e=>this._projector.detach(e))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let s=null;const n=()=>(s=e.render(),s);i.append(t,n),i.renderNow();const r={left:0,top:0,right:0,bottom:0};if(s&&s.domNode){const e=s.domNode.getBoundingClientRect();r.left=e.left,r.top=e.top,r.right=e.right,r.bottom=e.bottom}for(i.detach(n);t.firstChild;)t.removeChild(t.firstChild);return r}overlaps(e,t){const i=this.computeBoundingRect(e),s=this.computeBoundingRect(t);return Math.max(i.left,s.left)<=Math.min(i.right,s.right)&&Math.max(i.top,s.top)<=Math.min(i.bottom,s.bottom)}get hasVisibleItems(){return this.items.some((e=>e.visible))}renderCanvas(e){if(!this.items.some((e=>e.visible)))return;const t=e.getContext("2d");t.save(),t.font=`10px ${getComputedStyle(this.surface).fontFamily}`,this.items.forEach((e=>{t.save(),e.renderCanvas(t),t.restore()})),t.restore()}};function wi(e,t,i,s){let n=null,r=1e3;"number"==typeof t?(r=t,s=i):(n=null!=t?t:null,r=i);let a,o=0;const l=()=>{o=0,e.apply(s,a)},h=(...e)=>{n&&n.apply(s,e),a=e,r?o||(o=setTimeout(l,r)):l()};return h.remove=()=>{o&&(clearTimeout(o),o=0)},h.forceUpdate=()=>{o&&(clearTimeout(o),l())},h.hasPendingUpdates=()=>!!o,h}e([f({readOnly:!0})],bi.prototype,"surface",void 0),e([f({readOnly:!0})],bi.prototype,"items",void 0),e([f({readOnly:!0,dependsOn:["items.length"]})],bi.prototype,"needsRender",null),e([f({readOnly:!0})],bi.prototype,"_watchUpdatingTracking",void 0),e([f({readOnly:!0,aliasOf:"_watchUpdatingTracking.updating"})],bi.prototype,"updating",void 0),bi=e([i("esri.views.overlay.ViewOverlay")],bi);const _i=t=>{let s=class extends t{constructor(){super(...arguments),this.renderNodeContent=e=>Pe(e)&&!e.destroyed?Fe("div",{key:e},e.render()):e instanceof HTMLElement?Fe("div",{key:e,bind:e,afterCreate:this._attachToNode}):je(e)?Fe("div",{key:e,bind:e.domNode,afterCreate:this._attachToNode}):null}_attachToNode(e){e.appendChild(this)}};return s=e([i("esri.widgets.Feature.ContentMixin")],s),s},Mi=["B","kB","MB","GB","TB"],Ii=n.getLogger("esri.widgets.Feature.support.featureUtils"),ki=/href=(""|'')/gi,xi=/(\{([^\{\r\n]+)\})/g,Fi=/\'/g,Oi=/^\s*expression\//i,Ti=/(\n)/gi,Ai=/[\u00A0-\u9999<>\&]/gim,Ci=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,Ei=/^(?:mailto:|tel:)/,Li=B("short-date-short-time");function Pi(e){if(!k(e))return e.get("sourceLayer")||e.get("layer")}async function ji(e,t){return"function"==typeof e?e.call(null,t):e}function $i(e=""){if(e)return!Ei.test(e.trim().toLowerCase())}function Ni(e,t){const i=function(e,t){if(!function(e){return Oi.test(e)}(t)||!e)return null;const i=t.replace(Oi,"").toLowerCase();let s;return e.some((e=>e.name.toLowerCase()===i&&(s=e,!0))),s}(t,null==e?void 0:e.fieldName);return i?i.title||null:e?e.label||e.fieldName:null}function Si(e,t){const i=Vi(t,e);return i?i.name:e}function Vi(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function Ri(e){return`${e}`.trim()}function Di({formattedAttributes:e,template:t,fieldInfoMap:i}){return Ri(N(N(t,(e=>function(e,t){const i=t.get(e.toLowerCase());return`{${i&&i.fieldName||e}}`}(e,i))),e).replace(ki,""))}function zi(e,t){return e.replace(xi,((e,i,s)=>{const n=Vi(t,s);return n?`{${n.name}}`:i}))}function Ui(e,t,i){const s=zi(e,i);return s?s.replace(Ci,((e,i,s)=>function(e,t,i){const s=(t=Ri(t))&&"{"!==t[0];return N(e,function(e,t=!1){const i={...e};return Object.keys(i).forEach((e=>function(e,t,i=!1){const s=t[e];if("string"==typeof s){const n="%27",r=(i?encodeURIComponent(s):s).replace(Fi,n);t[e]=r}}(e,i,t))),i}(i,s))}(e,i||s,t))):s}function Bi(e,t){const i=t.fieldName,s=Hi(t.fieldInfos,i),n=null==s?void 0:s.clone(),r=t.preventPlacesFormatting,a=Vi(t.layer,i);if(n&&a&&"date"===a.type){const e=n.format||new D;e.dateFormat=e.dateFormat||"short-date-short-time",n.format=e}const o=n&&n.format;return"string"==typeof(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,o))||null==e||null==o?e:r?V(e,{...R(o),minimumFractionDigits:0,maximumFractionDigits:20}):o.format(e)}function Hi(e,t){if(!e||!e.length||!t)return;const i=t.toLowerCase();let s;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==i||(s=e,0)))),s}function Wi(e){const t=[];if(!e)return t;const{fieldInfos:i,content:s}=e;return i&&t.push(...i),s&&Array.isArray(s)?(s.forEach((e=>{if("fields"===e.type){const i=e&&e.fieldInfos;i&&t.push(...i)}})),t):t}function qi(e){return e.replace(Ai,(e=>`&#${e.charCodeAt(0)};`))}function Gi(e){return"string"==typeof e?e.replace(Ti,'<br class="esri-text-new-line" />'):e}function Ki({fieldInfos:e,attributes:t,layer:i,graphic:s,fieldInfoMap:n,relatedInfos:r}){const a={...t};return null==r||r.forEach((e=>function(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((i=>Xi({attributes:e,graphic:i,relatedInfo:t}))),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((i=>Xi({attributes:e,graphic:i,relatedInfo:t}))))}(a,e))),Object.keys(a).forEach((t=>{a[t]=function(e){const{value:t,fieldName:i,fieldInfos:s,fieldInfoMap:n,layer:r,graphic:a}=e;if(null==t)return"";const o=function({fieldName:e,value:t,graphic:i,layer:s}){if(Yi(e))return null;if(!s||"function"!=typeof s.getFieldDomain)return null;const n=s.getFieldDomain(e,{feature:i});return n&&"coded-value"===n.type?n.getName(t):null}({fieldName:i,value:t,graphic:a,layer:r});if(o)return o;const l=function({fieldName:e,graphic:t,layer:i}){if(Yi(e))return null;if(!i||"function"!=typeof i.getFeatureType)return null;const{typeIdField:s}=i;if(!s||e!==s)return null;const n=i.getFeatureType(t);return n?n.name:null}({fieldName:i,graphic:a,layer:r});if(l)return l;if(n.get(i.toLowerCase()))return Bi(t,{fieldInfos:s,fieldName:i,layer:r});const h=r&&r.fieldsIndex;return h&&h.isDateField(i)?z(t,Li):Gi(t)}({fieldName:t,fieldInfos:e,fieldInfoMap:n,layer:i,value:a[t],graphic:s})})),a}async function Ji({graphic:e,popupTemplate:t,layer:i},s){if(!i||!t)return;const{returnGeometry:n}=t;"function"==typeof i.load&&await i.load(s);const r=e.attributes[i.objectIdField];if(null==r)return;const a=[r],o=await t.getRequiredFields(i.fields),l=U(o,e),c=l?[]:o;if(l&&!n)return;const u=await async function(e,t){const{layer:i,graphic:s,outFields:n,objectIds:r,returnGeometry:a}=e,o=r[0];if("number"!=typeof o){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:i,graphic:s,objectId:o,requiredFields:n},r=new h("layer-query-features-invalid-objectid",e,t);throw Ii.warn(e,t),r}if("function"!=typeof i.queryFeatures){const e="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",t={layer:i,graphic:s,requiredFields:n},r=new h("layer-query-features-unsupported",e,t);throw Ii.warn(e,t),r}const l=i.createQuery();return l.objectIds=r,l.outFields=n,l.returnGeometry=!!a,(await i.queryFeatures(l,t)).features[0]}({layer:i,graphic:e,outFields:c,objectIds:a,returnGeometry:n},s);u&&(u.geometry&&(e.geometry=u.geometry),u.attributes&&(e.attributes={...e.attributes,...u.attributes}))}function Yi(e=""){return!!e&&-1!==e.indexOf("relationships/")}function Xi({attributes:e,graphic:t,relatedInfo:i}){e&&t&&i&&Object.keys(t.attributes).forEach((s=>{const n=(r={layerId:i.relation.id.toString(),fieldName:s})?`relationships/${r.layerId}/${r.fieldName}`:"";var r;e[n]=t.attributes[s]}))}const Qi={editing:!1,operations:{add:!0,update:!0,delete:!0}},Zi=o.ofType(ft);let es=class extends vt{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities={...Qi},this.activeAttachmentInfo=null,this.attachmentInfos=new Zi,this.graphic=null,this.mode="view",this.handles.add([Re(this,"graphic",(()=>this._graphicChanged()))])}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return{...Qi,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){return this.get("graphic.layer.capabilities.operations.supportsResizeAttachments")||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t}=this;if(!e||"function"!=typeof e.queryAttachments)throw new h("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getFeatureId(),s=new pt({objectIds:[i],returnMetadata:!0}),n=[],r=e.queryAttachments(s).then((e=>e[i]||n)).catch((()=>n));this._getAttachmentsPromise=r,this.notifyChange("state");const a=await r;return t.removeAll(),a.length&&t.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:s,abilities:n}=this;if(!e)throw new h("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!n.operations.add)throw new h("invalid-abilities","addAttachment(): add abilities are required.");if(!t||"function"!=typeof t.addAttachment)throw new h("invalid-layer","addAttachment(): A valid layer is required.");const r=t.addAttachment(s,e).then((e=>this._queryAttachment(e.objectId))),a=await r;return i.add(a),a}async deleteAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:s,abilities:n}=this;if(!e)throw new h("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!n.operations.delete)throw new h("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!t||"function"!=typeof t.deleteAttachments)throw new h("invalid-layer","deleteAttachment(): A valid layer is required.");const r=t.deleteAttachments(s,[e.id]).then((()=>e)),a=await r;return i.remove(a),a}async updateAttachment(e,t=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:s,graphic:n,abilities:r}=this;if(!e)throw new h("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new h("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!r.operations.update)throw new h("invalid-abilities","updateAttachment(): Update abilities are required.");const a=s.findIndex((e=>e===t));if(!i||"function"!=typeof i.updateAttachment)throw new h("invalid-layer","updateAttachment(): A valid layer is required.");const o=i.updateAttachment(n,t.id,e).then((e=>this._queryAttachment(e.objectId))),l=await o;return s.splice(a,1,l),l}async _queryAttachment(e){if(!e)throw new h("invalid-attachment-id","Could not query attachment.");const{_attachmentLayer:t}=this,i=this._getFeatureId(),s=new pt({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return t.queryAttachments(s).then((e=>e[i][0]))}_getFeatureId(){const{_attachmentLayer:e,graphic:t}=this;if(!e||!t)return null;const{objectIdField:i}=e,{attributes:s}=t;return s&&s[i]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((()=>{})))}_setAttachmentLayer(){const{graphic:e}=this,t=Pi(e);this._attachmentLayer=t?"scene"===t.type&&O(t.associatedLayer)?t.associatedLayer:t:null}};e([f()],es.prototype,"abilities",void 0),e([I("abilities")],es.prototype,"castAbilities",null),e([f()],es.prototype,"activeAttachmentInfo",void 0),e([f({readOnly:!0,type:Zi})],es.prototype,"attachmentInfos",void 0),e([f({type:H})],es.prototype,"graphic",void 0),e([f()],es.prototype,"mode",void 0),e([f({dependsOn:["graphic"],readOnly:!0})],es.prototype,"state",null),e([f({readOnly:!0,dependsOn:["graphic","graphic.layer","graphic.layer.loaded","graphic.layer.capabilities.operations.supportsResizeAttachments"]})],es.prototype,"supportsResizeAttachments",null),es=e([i("esri.widgets.Attachments.AttachmentsViewModel")],es);var ts=es;const is=W("esri/themes/base/images/files/"),ss={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},ns="esri-attachments__item-button",rs="esri-attachments__form-node",as="esri-attachments__file-fieldset",os="esri-attachments__file-label",ls="esri-attachments__file-name",hs="esri-attachments__file-input",cs="esri-attachments__metadata-fieldset",us="esri-button",ds="esri-button--disabled",ps="esri-button--secondary",fs="esri-button--tertiary",ms="esri-button--third",vs="esri-button--small",gs="esri-button--half",ys=window.CSS;let bs=class extends Se{constructor(e,t){super(e,t),this.abilities=null,this.displayType="list",this.graphic=null,this.label=void 0,this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=new ts,this.visibleElements={...ss},this._supportsImageOrientation=ys&&ys.supports&&ys.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.own(De(this,"viewModel.attachmentInfos","change",(()=>this.scheduleRender())),Re(this,"viewModel.mode",(()=>this._modeChanged())))}castVisibleElements(e){return{...ss,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((e=>{throw this._set("submitting",!1),this._set("error",new h("attachments:add-attachment",this.messages.addErrorMessage,e)),e}))}deleteAttachment(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then((e=>(this._set("submitting",!1),this._set("error",null),t.mode="view",e))).catch((e=>{throw this._set("submitting",!1),this._set("error",new h("attachments:delete-attachment",this.messages.deleteErrorMessage,e)),e}))}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then((t=>(this._set("submitting",!1),this._set("error",null),e.mode="view",t))).catch((e=>{throw this._set("submitting",!1),this._set("error",new h("attachments:update-attachment",this.messages.updateErrorMessage,e)),e}))}render(){const{submitting:e,viewModel:t}=this,{state:i}=t;return Fe("div",{class:this.classes("esri-attachments","esri-widget")},e?this.renderProgressBar():null,"loading"===i?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?Fe("div",{key:"error-message",class:"esri-attachments__error-message"},e.message):null}renderAttachments(){const{mode:e,activeAttachmentInfo:t}=this.viewModel;return"add"===e?this.renderAddForm():"edit"===e?this.renderDetailsForm(t):this.renderAttachmentContainer()}renderLoading(){return Fe("div",{class:"esri-attachments__loader-container",key:"loader"},Fe("div",{class:"esri-attachments__loader"}))}renderProgressBar(){return this.visibleElements.progressBar?Fe("div",{class:"esri-attachments__progress-bar",key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:t}=this,i=e||!t,s=this.visibleElements.cancelAddButton?Fe("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(us,fs,vs,gs,e&&ds)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?Fe("button",{type:"submit",disabled:i,class:this.classes(us,ps,vs,gs,{[ds]:i})},this.messages.add):null,r=t?Fe("span",{key:"file-name",class:ls},t.name):null,a=Fe("form",{bind:this,afterCreate:Oe,afterRemoved:Te,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},Fe("fieldset",{class:as},r,Fe("label",{class:this.classes(os,us,ps)},t?this.messages.changeFile:this.messages.selectFile,Fe("input",{class:hs,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,s);return Fe("div",{key:"add-form-container",class:rs},a)}renderDetailsForm(e){const{visibleElements:t,viewModel:i,selectedFile:s,submitting:n}=this,{contentType:r,size:a,url:o}=e,{abilities:l}=i,h=n||!s,c=l.editing&&l.operations.delete&&t.deleteButton?Fe("button",{key:"delete-button",type:"button",disabled:n,bind:this,onclick:t=>this._submitDeleteAttachment(t,e),class:this.classes(us,vs,fs,"esri-attachments__delete-button",{[ds]:n})},this.messages.delete):null,u=l.editing&&l.operations.update&&t.updateButton?Fe("button",{disabled:h,key:"update-button",type:"submit",class:this.classes(us,vs,ms,{[ds]:h})},this.messages.update):null,d=this.visibleElements.cancelUpdateButton?Fe("button",{disabled:n,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(us,vs,fs,ms,{[ds]:n})},this.messages.cancel):null,p=s?Fe("span",{key:"file-name",class:ls},s.name):null,f=l.editing&&l.operations.update?Fe("fieldset",{key:"file",class:as},p,Fe("label",{class:this.classes(os,us,ps)},this.messages.changeFile,Fe("input",{class:hs,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,m=Fe("fieldset",{key:"size",class:cs},Fe("label",null,function(e,t){let i=0===t?0:Math.floor(Math.log(t)/Math.log(1024));i=S(i,0,Mi.length-1);const s=V(t/Math.pow(1024,i),{maximumFractionDigits:2});return N(e.units.bytes[Mi[i]],{fileSize:s})}(this.messagesUnits,a))),v=Fe("fieldset",{key:"content-type",class:cs},Fe("label",null,r)),g=Fe("form",{bind:this,afterCreate:Oe,afterRemoved:Te,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},Fe("div",{class:"esri-attachments__metadata"},m,v),f,Fe("div",{class:"esri-attachments__actions"},c,d,u));return Fe("div",{key:"edit-form-container",class:rs},Fe("a",{class:"esri-attachments__item-link",href:o,rel:"noreferrer",target:"_blank",alt:name},this.renderImageMask({attachmentInfo:e,size:400}),Fe("div",{class:"esri-attachments__item-link-overlay"},Fe("span",{class:"esri-attachments__item-link-overlay-icon"},Fe("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},Fe("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),Fe("path",{fill:"none",d:"M0 0h32v32H0z"}))))),g)}renderImageMask({attachmentInfo:e,size:t}){const{supportsResizeAttachments:i}=this.viewModel,{contentType:s,url:n}=e,r=i&&function(e){const t=e.toLowerCase();return"image/bmp"===t||"image/emf"===t||"image/exif"===t||"image/gif"===t||"image/x-icon"===t||"image/jpeg"===t||"image/png"===t||"image/tiff"===t||"image/x-wmf"===t}(s),a=this._getCSSTransform(e,r),o=a?{transform:a,"image-orientation":"none"}:{},l=-1===n.indexOf("?")?"?":"&",h=r?`${n}${l}w=${t}`:function(e){return e?"text/plain"===e?`${is}text-32.svg`:"application/pdf"===e?`${is}pdf-32.svg`:"text/csv"===e?`${is}csv-32.svg`:"application/gpx+xml"===e?`${is}gpx-32.svg`:"application/x-dwf"===e?`${is}cad-32.svg`:"application/postscript"===e||"application/json"===e||"text/xml"===e||"model/vrml"===e?`${is}code-32.svg`:"application/x-zip-compressed"===e||"application/x-7z-compressed"===e||"application/x-gzip"===e||"application/x-tar"===e||"application/x-gtar"===e||"application/x-bzip2"===e||"application/gzip"===e||"application/x-compress"===e||"application/x-apple-diskimage"===e||"application/x-rar-compressed"===e||"application/zip"===e?`${is}zip-32.svg`:-1!==e.indexOf("image/")?`${is}image-32.svg`:-1!==e.indexOf("audio/")?`${is}sound-32.svg`:-1!==e.indexOf("video/")?`${is}video-32.svg`:-1!==e.indexOf("msexcel")||-1!==e.indexOf("ms-excel")||-1!==e.indexOf("spreadsheetml")?`${is}excel-32.svg`:-1!==e.indexOf("msword")||-1!==e.indexOf("ms-word")||-1!==e.indexOf("wordprocessingml")?`${is}word-32.svg`:-1!==e.indexOf("powerpoint")||-1!==e.indexOf("presentationml")?`${is}report-32.svg`:`${is}generic-32.svg`:`${is}generic-32.svg`}(s),c={"esri-attachments__image--resizable":i};return Fe("div",{class:this.classes({"esri-attachments__item-mask--icon":!r},"esri-attachments__item-mask")},Fe("img",{styles:o,alt:"",src:h,class:this.classes(c,"esri-attachments__image")}))}renderAttachmentInfo({attachmentInfo:e,displayType:t}){const{viewModel:i}=this,{abilities:s}=i,{name:n,url:r}=e,a=this.renderImageMask({attachmentInfo:e,size:"list"===t?48:400}),o=s.editing?Fe("span",{"aria-hidden":"true",class:this.classes("esri-attachments__item-chevron-icon",Ae()?"esri-icon-left":"esri-icon-right")}):null,l=[a,Fe("label",{class:"esri-attachments__label"},Fe("span",{class:"esri-attachments__filename"},n||this.messages.noTitle),o)],h=s.editing?Fe("button",{key:"details-button",bind:this,class:ns,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},l):Fe("a",{key:"details-link",class:ns,href:r,target:"_blank"},l);return Fe("li",{class:"esri-attachments__item",key:e},h)}renderAttachmentContainer(){const{displayType:e,viewModel:t,visibleElements:i}=this,{attachmentInfos:s,abilities:n}=t,r=s&&s.length,a={"esri-attachments__container--list":"preview"!==e,"esri-attachments__container--preview":"preview"===e},o=n.editing&&n.operations.add&&i.addButton?Fe("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(us,fs,"esri-attachments__add-attachment-button"),type:"button"},Fe("span",{"aria-hidden":"true",class:this.classes("esri-attachments__item-add-icon","esri-icon-plus")}),this.messages.add):null,l=r?Fe("ul",{class:"esri-attachments__items"},s.toArray().map((t=>this.renderAttachmentInfo({attachmentInfo:t,displayType:e})))):Fe("div",{class:"esri-widget__content--empty"},this.messages.noAttachments);return Fe("div",{key:"attachments-container",class:this.classes("esri-attachments__container",a)},l,o)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const t=e.target,i=t&&t.files&&t.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,t){e.preventDefault(),this.deleteAttachment(t)}_submitAddAttachment(e){e.preventDefault(),this.addAttachment()}_submitUpdateAttachment(e){e.preventDefault(),this.updateAttachment()}_startEditAttachment(e){const{viewModel:t}=this;t.activeAttachmentInfo=e,t.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e,t){const{orientationInfo:i}=e;return!this._supportsImageOrientation&&t&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};e([q("viewModel.abilities")],bs.prototype,"abilities",void 0),e([f(),$e()],bs.prototype,"displayType",void 0),e([q("viewModel.graphic")],bs.prototype,"graphic",void 0),e([f({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],bs.prototype,"label",void 0),e([f(),$e(),Ne("esri/widgets/Attachments/t9n/Attachments")],bs.prototype,"messages",void 0),e([f(),$e(),Ne("esri/core/t9n/Units")],bs.prototype,"messagesUnits",void 0),e([f({readOnly:!0})],bs.prototype,"selectedFile",void 0),e([$e(),f({readOnly:!0})],bs.prototype,"submitting",void 0),e([$e(),f({readOnly:!0})],bs.prototype,"error",void 0),e([f({type:ts}),$e(["viewModel.activeAttachmentInfo","viewModel.mode","viewModel.state","viewModel.supportsResizeAttachments","viewModel.attachmentInfos","viewModel.graphic","viewModel.abilities","viewModel.abilities.editing","viewModel.abilities.operations"])],bs.prototype,"viewModel",void 0),e([f(),$e()],bs.prototype,"visibleElements",void 0),e([I("visibleElements")],bs.prototype,"castVisibleElements",null),bs=e([i("esri.widgets.Attachments")],bs);var ws=bs;let _s=class extends(yt(M)){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(Re(this,"creator",(e=>{this._destroyContent(),this._createContent(e)})))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:i}=this;e&&(ji(i,{graphic:t}).catch((()=>null)),this._set("created",null))}async _createContent(e){const{graphic:t}=this,i=ji(e,{graphic:t}).catch((()=>null));this._loadingPromise=i,this.notifyChange("state");const s=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};e([f({readOnly:!0})],_s.prototype,"created",void 0),e([f()],_s.prototype,"creator",void 0),e([f()],_s.prototype,"destroyer",void 0),e([f({type:H})],_s.prototype,"graphic",void 0),e([f({readOnly:!0})],_s.prototype,"state",null),_s=e([i("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],_s);var Ms=_s;let Is=class extends Se{constructor(e,t){super(e,t),this.creator=null,this.graphic=null,this.viewModel=null,this._addTargetToAnchors=e=>{Array.from(e.querySelectorAll("a")).forEach((e=>{$i(e.href)&&!e.hasAttribute("target")&&e.setAttribute("target","_blank")}))}}renderLoading(){return Fe("div",{class:"esri-feature-content__loader-container",key:"loader"},Fe("div",{class:"esri-feature-content__loader"}))}renderCreated(){var e;const t=null==(e=this.viewModel)?void 0:e.created;return t?t instanceof HTMLElement?Fe("div",{key:t,bind:t,afterCreate:this._attachToNode}):Pe(t)?Fe("div",{key:t},!t.destroyed&&t.render()):Fe("div",{key:t,innerHTML:t,afterCreate:this._addTargetToAnchors}):null}render(){var e;const t=null==(e=this.viewModel)?void 0:e.state;return Fe("div",{class:"esri-feature-content"},"loading"===t?this.renderLoading():this.renderCreated())}_attachToNode(e){e.appendChild(this)}};e([q("viewModel.creator")],Is.prototype,"creator",void 0),e([q("viewModel.graphic")],Is.prototype,"graphic",void 0),e([$e(["viewModel.created","viewModel.state"]),f({type:Ms})],Is.prototype,"viewModel",void 0),Is=e([i("esri.widgets.Feature.FeatureContent")],Is);var ks=Is;let xs=class extends M{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.fieldInfos=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,i=[];return null==t||t.forEach((t=>{if(t.hasOwnProperty("visible")&&!t.visible)return;const s=t.clone();s.label=Ni(s,e),i.push(s)})),i}};e([f()],xs.prototype,"attributes",void 0),e([f({type:[G]})],xs.prototype,"expressionInfos",void 0),e([f({type:[K]})],xs.prototype,"fieldInfos",void 0),e([f({readOnly:!0,dependsOn:["expressionInfos","fieldInfos"]})],xs.prototype,"formattedFieldInfos",null),xs=e([i("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],xs);var Fs=xs;const Os=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];let Ts=class extends Se{constructor(e,t){super(e,t),this.attributes=null,this.expressionInfos=null,this.fieldInfos=null,this.viewModel=new Fs,this.messages=null,this.messagesURIUtils=null}renderFieldInfo(e,t){const{attributes:i}=this.viewModel,s=e.fieldName,n=e.label||s,r=i?null==i[s]?"":i[s]:"",a=!(!e.format||!e.format.dateFormat),o="number"!=typeof r||a?function(e,t){if("string"!=typeof t||!t)return t;const i=function(e){let t=null;return Os.some((i=>(i.pattern.test(e)&&(t=i),!!t))),t}(t);if(!i)return t;const s=t.match(i.pattern),n=N(N(i.label,{messages:e,hierPart:s&&s[2]}),{appName:i.appName});return t.replace(i.pattern,`<a${i.target?` target="${i.target}"`:""} href="$1"${"_blank"===i.target?' rel="noreferrer"':""}>${n}</a>`)}(this.messagesURIUtils,r):this._forceLTR(r),l={"esri-feature-fields__field-data--date":a};return Fe("tr",{key:`fields-element-info-row-${s}-${t}`},Fe("th",{key:`fields-element-info-row-header-${s}-${t}`,class:"esri-feature-fields__field-header",innerHTML:n}),Fe("td",{key:`fields-element-info-row-data-${s}-${t}`,class:this.classes("esri-feature-fields__field-data",l),innerHTML:o}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e.length?Fe("table",{class:"esri-widget__table",summary:this.messages.fieldsSummary},Fe("tbody",null,e.map(((e,t)=>this.renderFieldInfo(e,t))))):null}render(){return Fe("div",{class:"esri-feature-fields"},this.renderFields())}_forceLTR(e){return`&lrm;${e}`}};e([q("viewModel.attributes")],Ts.prototype,"attributes",void 0),e([q("viewModel.expressionInfos")],Ts.prototype,"expressionInfos",void 0),e([q("viewModel.fieldInfos")],Ts.prototype,"fieldInfos",void 0),e([f({type:Fs}),$e(["viewModel.attributes","viewModel.formattedFieldInfos"])],Ts.prototype,"viewModel",void 0),e([f(),$e(),Ne("esri/widgets/Feature/t9n/Feature")],Ts.prototype,"messages",void 0),e([f(),$e(),Ne("esri/widgets/support/t9n/uriUtils")],Ts.prototype,"messagesURIUtils",void 0),Ts=e([i("esri.widgets.Feature.FeatureFields")],Ts);var As=Ts;const Cs=n.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),Es=new Map;function Ls(e){if(!Yi(e))return null;const[t,i]=e.split("/").slice(1);return{layerId:t,fieldName:i}}let Ps=class extends M{constructor(e){super(e),this.activeMediaInfoIndex=0,this.attributes=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this;this.activeMediaInfoIndex=(e+t)%t}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this;this._setContentElementMedia(t+e)}_formatMediaInfos(){const{attributes:e,mediaInfos:t,formattedAttributes:i,fieldInfoMap:s,layer:n}=this,r={...i,...e};return null==t?void 0:t.map((t=>{if(!t)return null;const a=t.title?Ui(t.title,r,n):"";t.title=a?Di({formattedAttributes:i,template:a,fieldInfoMap:s}):"";const o=t.caption?Ui(t.caption,r,n):"";t.caption=o?Di({formattedAttributes:i,template:o,fieldInfoMap:s}):"";const l=t.altText?Ui(t.altText,r,n):"";if(t.altText=l?Di({formattedAttributes:i,template:l,fieldInfoMap:s}):"","image"===t.type){const{value:e}=t;return this._setImageValue({value:e,formattedAttributes:i,layer:n}),t.value.sourceURL?t:void 0}if("pie-chart"===t.type||"line-chart"===t.type||"column-chart"===t.type||"bar-chart"===t.type){const{value:s}=t;return this._setChartValue({value:s,chartType:t.type,attributes:e,formattedAttributes:i,layer:n}),t}return null})).filter(Boolean)}_setImageValue(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:s,layer:n}=e,{linkURL:r,sourceURL:a}=i;if(a){const e=zi(a,n);i.sourceURL=Di({formattedAttributes:s,template:e,fieldInfoMap:t})}if(r){const e=zi(r,n);i.linkURL=Di({formattedAttributes:s,template:e,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:i,formattedAttributes:s,chartType:n,layer:r}=e,{popupTemplate:a,relatedInfos:o}=this,{fields:l,normalizeField:h}=t;if(t.fields=function(e,t){return e&&e.map((e=>Si(e,t)))}(l,r),h&&(t.normalizeField=Si(h,r)),!l.some((e=>!!(null!=s[e]||Yi(e)&&o.size))))return;const c=null==a?void 0:a.fieldInfos;l.forEach((e=>{if(Yi(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:s,chartType:n,value:t})]);const r=this._getChartOption({value:t,attributes:i,chartType:n,formattedAttributes:s,fieldName:e,fieldInfos:c});t.series.push(r)}))}_getRelatedChartInfos(e){var t;const{fieldInfos:i,fieldName:s,formattedAttributes:n,chartType:r,value:a}=e,o=[],l=Ls(s),{layerId:h,fieldName:c}=l,u=null==(t=this.relatedInfos)?void 0:t.get(h.toString());if(!u)return o;const{relatedFeatures:d,relation:p}=u;if(!p||!d)return o;const{cardinality:f}=p;return d.forEach((e=>{const{attributes:t}=e;t&&Object.keys(t).forEach((e=>{e===c&&o.push(this._getChartOption({value:a,attributes:t,formattedAttributes:n,fieldName:s,chartType:r,relatedFieldName:e,fieldInfos:i}))}))})),"one-to-many"===f||"many-to-many"===f?o:[o[0]]}_getTooltip({label:e,value:t,chartType:i}){return"pie-chart"===i?e:`${e}: ${t}`}_getChartOption(e){var t;const{value:i,attributes:s,formattedAttributes:n,fieldName:r,relatedFieldName:a,fieldInfos:o,chartType:l}=e,{layer:h}=this,{normalizeField:c,tooltipField:u}=i,d=c?Yi(c)?s[Ls(c).fieldName]:s[c]:null,p=a&&void 0!==s[a]?s[a]:void 0!==s[r]?s[r]:n[r],f=void 0===p?null:p&&d?p/d:p,m=new Q({value:f});if(Yi(r)){const e=Ls(r),t=Ls(u),i=t?t.fieldName:null,n=Bi(f,{fieldInfos:o,fieldName:a,layer:h,preventPlacesFormatting:!!d}),c=e?e.label||e.fieldName:a;return m.tooltip=this._getTooltip({label:i&&void 0!==s[i]?s[i]:c,value:n,chartType:l}),m}const v=Hi(o,r),g=Si(r,h),y=u&&void 0!==n[u]?n[u]:Ni(v||new K({fieldName:g}),null==(t=this.popupTemplate)?void 0:t.expressionInfos);return m.tooltip=this._getTooltip({label:y,value:n[g],chartType:l}),m}};e([f()],Ps.prototype,"activeMediaInfoIndex",void 0),e([f({readOnly:!0,dependsOn:["formattedMediaInfos","activeMediaInfoIndex"]})],Ps.prototype,"activeMediaInfo",null),e([f()],Ps.prototype,"attributes",void 0),e([f()],Ps.prototype,"fieldInfoMap",void 0),e([f()],Ps.prototype,"formattedAttributes",void 0),e([f({readOnly:!0,dependsOn:["attributes","fieldInfoMap","formattedAttributes","mediaInfos","popupTemplate","layer","relatedInfos"]})],Ps.prototype,"formattedMediaInfos",null),e([f()],Ps.prototype,"layer",void 0),e([f({readOnly:!0,dependsOn:["formattedMediaInfos"]})],Ps.prototype,"formattedMediaInfoCount",null),e([f()],Ps.prototype,"mediaInfos",void 0),e([f()],Ps.prototype,"popupTemplate",void 0),e([f()],Ps.prototype,"relatedInfos",void 0),Ps=e([i("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],Ps);var js=Ps,$s=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],Ns=[{name:"default",colors:[].concat($s.slice(30,39),$s.slice(28,30).reverse())},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const Ss=new Map([["ar",()=>import("./p-4de596d3.js").then((function(e){return e.a}))],["bs-ba",()=>import("./p-171fe173.js").then((function(e){return e.b}))],["ca-es",()=>import("./p-d66d6dc2.js").then((function(e){return e.c}))],["cs-cz",()=>import("./p-6f819fc3.js").then((function(e){return e.c}))],["da-dk",()=>import("./p-4e08e8eb.js").then((function(e){return e.d}))],["de-de",()=>import("./p-6a119055.js").then((function(e){return e.d}))],["de-ch",()=>import("./p-c2abdaa3.js").then((function(e){return e.d}))],["el-gr",()=>import("./p-a0c3839c.js").then((function(e){return e.e}))],["en-us",()=>import("./p-423433fd.js").then((function(e){return e.e}))],["en-ca",()=>import("./p-bb63fe1d.js").then((function(e){return e.e}))],["es-es",()=>import("./p-f1d7539c.js").then((function(e){return e.e}))],["et-ee",()=>import("./p-a652a275.js").then((function(e){return e.e}))],["fi-fi",()=>import("./p-47b67bb3.js").then((function(e){return e.f}))],["fr-fr",()=>import("./p-bf00d4fa.js").then((function(e){return e.f}))],["he-il",()=>import("./p-d4079ac5.js").then((function(e){return e.h}))],["hr-hr",()=>import("./p-8994b492.js").then((function(e){return e.h}))],["hu-hu",()=>import("./p-f08823c1.js").then((function(e){return e.h}))],["id-id",()=>import("./p-857b128c.js").then((function(e){return e.i}))],["it-it",()=>import("./p-9b786af0.js").then((function(e){return e.i}))],["ja-jp",()=>import("./p-48c73644.js").then((function(e){return e.j}))],["ko-kr",()=>import("./p-5895f965.js").then((function(e){return e.k}))],["lt-lt",()=>import("./p-db8aa785.js").then((function(e){return e.l}))],["lv-lv",()=>import("./p-852c7163.js").then((function(e){return e.l}))],["nb-no",()=>import("./p-fdf31b19.js").then((function(e){return e.n}))],["nl-nl",()=>import("./p-a86e2355.js").then((function(e){return e.n}))],["pl-pl",()=>import("./p-02576998.js").then((function(e){return e.p}))],["pt-br",()=>import("./p-0e34f5cf.js").then((function(e){return e.p}))],["pt-pt",()=>import("./p-e253def8.js").then((function(e){return e.p}))],["ro-ro",()=>import("./p-6102d7c0.js").then((function(e){return e.r}))],["ru-ru",()=>import("./p-63015b8a.js").then((function(e){return e.r}))],["sl-sl",()=>import("./p-3e3034b6.js").then((function(e){return e.s}))],["sr-rs",()=>import("./p-3b3b1673.js").then((function(e){return e.s}))],["sv-se",()=>import("./p-c9392e2f.js").then((function(e){return e.s}))],["th-th",()=>import("./p-c2e8ef4b.js").then((function(e){return e.t}))],["tr-tr",()=>import("./p-4c892f7a.js").then((function(e){return e.t}))],["uk-ua",()=>import("./p-6cc4a59c.js").then((function(e){return e.u}))],["vi-vn",()=>import("./p-729d37d7.js").then((function(e){return e.v}))],["zh-cn",()=>import("./p-19c721a8.js").then((function(e){return e.z}))],["zh-hk",()=>import("./p-3a8dc612.js").then((function(e){return e.z}))],["zh-tw",()=>import("./p-3a8dc612.js").then((function(e){return e.z}))]]);let Vs,Rs;const Ds="esri-feature-media__icon",zs="esri-icon-left-triangle-arrow",Us="esri-icon-right-triangle-arrow";let Bs=class extends Se{constructor(e,t){super(e,t),this._refreshTimer=null,this._refreshIntervalInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.viewModel=new js,this.messages=null}initialize(){this.own(Re(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],(()=>this._setupMediaRefreshTimer())))}destroy(){this._clearMediaRefreshTimer()}render(){return Fe("div",{bind:this,class:"esri-feature-media",onkeyup:this._handleMediaKeyup},this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?Fe("div",{key:"media-element-container",class:"esri-feature-media__container"},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel,{value:n,refreshInterval:r,altText:a,title:o,type:l}=e,{sourceURL:h,linkURL:c}=n,u=$i(c)?"_blank":"_self",d="_blank"===u?"noreferrer":"",p=r?t:null,f=Fe("img",{alt:a||o,key:`media-${l}-${i}-${s}-${p?p.timestamp:0}`,src:p?p.sourceURL:h});return(c?Fe("a",{title:o,href:c,rel:d,target:u},f):null)||f}renderChartMediaInfo(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return Fe("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:"esri-feature-media__chart",afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?"image"===e.type?this.renderImageMediaInfo(e):-1!==e.type.indexOf("chart")?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel,t=e.title?Fe("div",{key:"media-title",class:"esri-feature-media__item-title",innerHTML:e.title}):null,i=e.caption?Fe("div",{key:"media-caption",class:"esri-feature-media__item-caption",innerHTML:e.caption}):null;return Fe("div",{key:"media-container",class:"esri-feature-media__item-container"},t,i,Fe("div",{key:"media-item-container",class:"esri-feature-media__item"},this.renderMediaInfoType()))}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t="previous"===e,i=t?this.messages.previous:this.messages.next,s=this.classes("esri-feature-media__button",t?"esri-feature-media__previous":"esri-feature-media__next"),n=t?this.classes(Ds,"esri-feature-media__previous-icon",zs):this.classes(Ds,"esri-feature-media__next-icon",Us),r=t?this.classes(Ds,"esri-feature-media__previous-icon--rtl",Us):this.classes(Ds,"esri-feature-media__next-icon--rtl",zs);return Fe("button",{type:"button",key:t?"media-previous":"media-next",title:i,"aria-label":i,tabIndex:0,class:s,bind:this,onclick:t?this._previous:this._next},Fe("span",{"aria-hidden":"true",class:n}),Fe("span",{"aria-hidden":"true",class:r}))}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}async _getChartDependencies(e){const t=await async function(e=Z()){if(e=function(e){return e?Ss.has(e.toLowerCase())?e.toLowerCase():function(e){const t=e.split("-")[0].toLowerCase();let i=null;for(const e of Ss.keys())if(e.startsWith(t)){i=e;break}return i}(e)||"en-us":"en-us"}(e),Vs&&e===Rs)return Vs;Vs=import("./p-02136451.js").then((function(e){return e.i})),Rs=e;try{const[t,i]=await ee([Vs,Ss.get(Rs)()]);Rs===e&&(t.am4core.options.defaultLocale=i.default),t.am4core.options.suppressWarnings=!0,t.am4core.options.autoDispose=!0}catch{return Vs=null,Rs=null,null}return Vs}(),{activeMediaInfo:i}=this.viewModel;this._renderChart({chartDiv:e,mediaInfo:i,chartsModule:t})}_handleMediaKeyup(e){const t=te(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{chartsModule:t,chartDiv:i,mediaInfo:s}=e,{value:n,type:r}=s,{am4core:a}=t,o=function(e,t="default"){const i=Ns.find((e=>e.name===t));return i?i.colors.map((t=>e.color(t))):null}(a);Ce()&&a.useTheme(t.am4themes_dark),a.useTheme(t.am4themes_animated),a.useTheme((function(e){e instanceof a.ColorSet&&o&&(e.list=o)}));const l="pie-chart"===r?this._createPieChart(e):this._createXYChart(e);i.setAttribute("aria-label",s.altText||s.title),l.data=n.series.map((e=>({tooltip:e.tooltip,value:e.value}))).filter((e=>"pie-chart"!==r||e.value>0))}_customizeChartTooltip(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})}_createPieChart(e){const{chartDiv:t,chartsModule:i}=e,{am4core:s,am4charts:n}=i,r=s.create(t,n.PieChart);r.rtl=Ae();const a=r.series.push(new n.PieSeries);return a.labels.template.disabled=!0,a.ticks.template.disabled=!0,a.dataFields.value="value",a.dataFields.category="tooltip",this._customizeChartTooltip(a.tooltip,s),r}_getMinSeriesValue(e){let t=0;return e.forEach((e=>t=Math.min(e.value,t))),t}_createColumnChart(e,t){const{chartsModule:i,mediaInfo:s}=t,{value:n}=s,{am4core:r,am4charts:a}=i,o=e.xAxes.push(new a.CategoryAxis);o.dataFields.category="tooltip",o.renderer.labels.template.disabled=!0,this._customizeChartTooltip(o.tooltip,r),o.tooltip.events.on("sizechanged",(()=>{o.tooltip.dy=-o.tooltip.contentHeight}));const l=e.yAxes.push(new a.ValueAxis),h=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(l.tooltip,r),h.wrap=!0;const c=e.series.push(new a.ColumnSeries);c.dataFields.valueY="value",c.dataFields.categoryX="tooltip",e.cursor=new a.XYCursor,n.series.length>15&&(e.scrollbarX=new r.Scrollbar)}_createBarChart(e,t){const{chartsModule:i,mediaInfo:s}=t,{value:n}=s,{am4core:r,am4charts:a}=i,o=e.yAxes.push(new a.CategoryAxis);o.dataFields.category="tooltip",o.renderer.inversed=!0,o.renderer.labels.template.disabled=!0,this._customizeChartTooltip(o.tooltip,r),o.tooltip.events.on("sizechanged",(()=>{o.tooltip.dx=o.tooltip.contentWidth}));const l=e.xAxes.push(new a.ValueAxis),h=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(l.tooltip,r),h.wrap=!0;const c=e.series.push(new a.ColumnSeries);c.dataFields.valueX="value",c.dataFields.categoryY="tooltip",e.cursor=new a.XYCursor,n.series.length>15&&(e.scrollbarY=new r.Scrollbar)}_createLineChart(e,t){const{chartsModule:i,mediaInfo:s}=t,{value:n}=s,{am4core:r,am4charts:a}=i,o=e.xAxes.push(new a.CategoryAxis);o.dataFields.category="tooltip",o.renderer.labels.template.disabled=!0,this._customizeChartTooltip(o.tooltip,r),o.tooltip.events.on("sizechanged",(()=>{o.tooltip.dy=-o.tooltip.contentHeight}));const l=e.yAxes.push(new a.ValueAxis),h=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(l.tooltip,r),h.wrap=!0;const c=e.series.push(new a.LineSeries);c.dataFields.categoryX="tooltip",c.dataFields.valueY="value",e.cursor=new a.XYCursor,n.series.length>15&&(e.scrollbarX=new r.Scrollbar)}_createXYChart(e){const{chartDiv:t,chartsModule:i,mediaInfo:s}=e,{type:n}=s,{am4core:r,am4charts:a}=i,o=r.create(t,a.XYChart);return o.rtl=Ae(),"column-chart"===n&&this._createColumnChart(o,e),"bar-chart"===n&&this._createBarChart(o,e),"line-chart"===n&&this._createLineChart(o,e),o}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:t,value:i}=e;if(!t)return;const s=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),s);this._refreshTimer=n}_getImageSource(e,t){const i=-1!==e.indexOf("?")?"&":"?",[s,n=""]=e.split("#");return`${s}${i}timestamp=${t}${n?"#":""}${n}`}};e([q("viewModel.attributes")],Bs.prototype,"attributes",void 0),e([q("viewModel.activeMediaInfoIndex")],Bs.prototype,"activeMediaInfoIndex",void 0),e([q("viewModel.fieldInfoMap")],Bs.prototype,"fieldInfoMap",void 0),e([q("viewModel.layer")],Bs.prototype,"layer",void 0),e([q("viewModel.mediaInfos")],Bs.prototype,"mediaInfos",void 0),e([q("viewModel.popupTemplate")],Bs.prototype,"popupTemplate",void 0),e([q("viewModel.relatedInfos")],Bs.prototype,"relatedInfos",void 0),e([f({type:js}),$e(["viewModel.formattedMediaInfos","viewModel.activeMediaInfoIndex","viewModel.activeMediaInfo"])],Bs.prototype,"viewModel",void 0),e([f(),$e(),Ne("esri/widgets/Feature/t9n/Feature")],Bs.prototype,"messages",void 0),Bs=e([i("esri.widgets.Feature.FeatureMedia")],Bs);var Hs=Bs;const Ws=["$datastore","$map","$layer"],qs=n.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");async function Gs({expressionAttributes:e,info:t,arcadeUtils:i,spatialReference:s,map:n,graphic:r}){const a=`expression/${t.name}`,o=i.createSyntaxTree(t.expression),l=Ws.filter((e=>i.hasVariable(o,e)));await i.loadScriptDependencies(o,!0,l);const h=i.getViewInfo({spatialReference:s}),c=i.createExecContext(r,h);c.useAsync=!0,function({arcadeUtils:e,featureSetVars:t,context:i,viewInfo:s,map:n,graphic:r}){t.forEach((t=>{const a=t.toLowerCase();"$map"===a&&(i.vars[a]=e.convertMapToFeatureSetCollection({map:n,spatialReference:s.sr})),"$layer"===a&&(i.vars[a]=e.convertFeatureLayerToFeatureSet(r.sourceLayer,s.sr)),"$datastore"===a&&(i.vars[a]=e.convertServiceUrlToWorkspace(r.sourceLayer.url,s.sr))}))}({arcadeUtils:i,featureSetVars:l,context:c,viewInfo:h,map:n,graphic:r});const u=i.createFunction(o,c),d=await i.executeAsyncFunction(u,c).catch((e=>qs.error("arcade-execution-error",{error:e,graphic:r,expressionInfo:t})));var p;e[a]="string"==typeof d?Gi(qi(d)):Array.isArray(d)?function(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?Gi(qi(e)):e}</li>`)).join("")}</ul>`}(d):d&&"esri.arcade.Dictionary"===d.declaredClass?`<table class="esri-widget__table">${(p=d).keys().map((e=>{const t=p.field(e);return`<tr><th>${e}</th><td>${"string"==typeof t?Gi(qi(t)):t}</td></tr>`})).join("")}</table>`:d}async function Ks({popupTemplate:e,spatialReference:t,graphic:i,map:s}){const n=e.expressionInfos,r=[],a={};if(!n||!n.length)return a;const o=await import("./p-aa6688d1.js").then((function(e){return e.aq}));for(const e of n)r.push(Gs({expressionAttributes:a,info:e,arcadeUtils:o,spatialReference:t,map:s,graphic:i}));return await p(r),a}const Js=n.getLogger("esri.widgets.FeatureViewModel");let Ys=class extends M{constructor(e){super(e),this._handles=new Ve,this._featureAbortController=null,this.graphicChangedThrottled=wi(this.graphicChanged,1,this),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._handles.add(Re(this,["graphic","_effectivePopupTemplate"],(()=>this.graphicChangedThrottled())))}destroy(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return O(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return function(e,t){const i=new Map;return e&&e.forEach((e=>{const s=Si(e.fieldName,t);e.fieldName=s,i.set(s.toLowerCase(),e)})),i}(Wi(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Pi(this.graphic)}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){void 0!==e?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof js&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof js&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof js&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._clear();const{graphic:e}=this;if(!e)return;const t=C();this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(t){Js.error("error","error loading popupTemplate for graphic",{error:t,graphic:e})}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new ie({text:e}),0).text:e}_destroyContentViewModels(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])}_compileAttachments(e,t){const{graphic:i}=this;return this.contentViewModels[t]=new ts({graphic:i}),e}_compileCustom(e,t){const{graphic:i}=this,{creator:s,destroyer:n}=e;return this.contentViewModels[t]=new Ms({graphic:i,creator:s,destroyer:n}),e}_compileFields(e,t){const{_effectivePopupTemplate:i,formattedAttributes:s}=this,n=e.clone(),r={...s.global,...s.content[t]},a=new Fs({attributes:r,expressionInfos:null==i?void 0:i.expressionInfos,fieldInfos:(null==e?void 0:e.fieldInfos)||(null==i?void 0:i.fieldInfos)});return this.contentViewModels[t]=a,n.fieldInfos=a.formattedFieldInfos.slice(0),n}_compileMedia(e,t){const{graphic:i,_fieldInfoMap:s,_effectivePopupTemplate:n,relatedInfos:r,_sourceLayer:a}=this,{attributes:o}=i,l=this.formattedAttributes.global,h=e.clone(),{mediaInfos:c}=h,u=new js({activeMediaInfoIndex:h.activeMediaInfoIndex||0,attributes:o,layer:a,fieldInfoMap:s,formattedAttributes:l,mediaInfos:c,popupTemplate:n,relatedInfos:r});return h.mediaInfos=u.formattedMediaInfos.slice(0),this.contentViewModels[t]=u,h}_compileText(e,t){const i=e.clone(),{graphic:s,_fieldInfoMap:n,_sourceLayer:r}=this;if(i&&i.text){const{attributes:e}=s,t=this.formattedAttributes.global,a=Ui(i.text,{...t,...e},r);i.text=Di({formattedAttributes:t,template:a,fieldInfoMap:n})}return this.contentViewModels[t]=new Ms({graphic:s,creator:i.text}),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i}=this;if(!e)return;const{lastEditInfoEnabled:s}=e,n=null==t?void 0:t.editFieldsInfo;return s&&n?function(e,t){const{creatorField:i,creationDateField:s,editorField:n,editDateField:r}=e;if(!t)return;const a=t[r];if("number"==typeof a){const e=t[n];return{type:"edit",date:z(a,Li),user:e}}const o=t[s];if("number"==typeof o){const e=t[i];return{type:"create",date:z(o,Li),user:e}}return null}(n,i.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:s}=this,{attributes:n}=s,r=this.formattedAttributes.global;return e?Di({formattedAttributes:r,template:Ui(e,{...r,...n},i),fieldInfoMap:t}):""}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this;return ji(null==e?void 0:e.title,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this;return ji(null==e?void 0:e.content,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:i,graphic:s,_effectivePopupTemplate:n,spatialReference:r,map:a}=this,{content:{value:o},title:{value:l}}=await p({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!s)return;const{expressionAttributes:{value:h}}=await p({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:Ks({popupTemplate:this._effectivePopupTemplate,spatialReference:r,graphic:s,map:a}),queryUpdatedFeature:Ji({graphic:s,popupTemplate:n,layer:i},e)});t===this._featureAbortController&&s&&(this._set("formattedAttributes",this._createFormattedAttributes(o,h)),this._set("title",this._compileTitle(l)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(o)||null))}_createFormattedAttributes(e,t){const{_effectivePopupTemplate:i,graphic:s,relatedInfos:n,_sourceLayer:r,_fieldInfoMap:a}=this,o={...s.attributes,...t},l={global:Ki({fieldInfos:null==i?void 0:i.fieldInfos,graphic:s,attributes:o,layer:r,fieldInfoMap:a,relatedInfos:n}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(l.content[t]=Ki({fieldInfos:e.fieldInfos,graphic:s,attributes:o,layer:r,fieldInfoMap:a,relatedInfos:n}))})),l}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,Wi(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:s,_sourceLayer:n}=this;s.clear();const r=O(n.associatedLayer)?await n.associatedLayer.load(i):n;if(!r)return;const a=t.filter((e=>e&&Yi(e.fieldName)));if(!a||!a.length)return;t.forEach((e=>this._configureRelatedInfo(e,r)));const o=await function({relatedInfos:e,layer:t},i){const s={};return e.forEach(((e,n)=>{const{relation:r}=e;if(!r){const e=new h("relation-required","A relation is required on a layer to retrieve related records.");throw Cs.error(e),e}const{relatedTableId:a}=r;if("number"!=typeof a){const e=new h("A related table ID is required on a layer to retrieve related records.");throw Cs.error(e),e}const o=`${t.url}/${a}`,l=Es.get(o),c=l||function(e,t){return J(e,{query:{f:"json"},signal:t&&t.signal})}(o,i);l||Es.set(o,c),s[n]=c})),p(s)}({relatedInfos:s,layer:r},i);Object.keys(o).forEach((e=>{var t;const i=s.get(e.toString()),n=null==(t=o[e])?void 0:t.value;i&&n&&(i.layerInfo=n.data)}));const l=await function({graphic:e,relatedInfos:t,layer:i},s){const n={};return t.forEach(((t,r)=>{t.layerInfo&&(n[r]=async function(e,t,i,s){var n;const r=i.layerId.toString(),{layerInfo:a,queryTask:o,relation:l}=t,h=null==(n=function({originRelationship:e,relationships:t,layerId:i}){let s;return t&&t.some((t=>(`${t.relatedTableId}`===i&&t.id===e.id&&(s=t),!!s))),s}({originRelationship:l,relationships:a.relationships,layerId:r}))?void 0:n.keyField;if(h){const i=Y(X(a.fields,h)),n=function(e,t){const i=t.toLowerCase();for(const t in e)if(t.toLowerCase()===i)return e[t];return null}(e.attributes,l.keyField),r=i?`${h}=${n}`:`${h}='${n}'`,c=o.execute(new at({where:r,outFields:t.relatedFields}),s),u=t.outStatistics&&t.outStatistics.length>0&&a.supportsStatistics?o.execute(new at({where:r,outFields:t.relatedFields,outStatistics:t.outStatistics}),s):null,d={features:c};return u&&(d.statsFeatures=u),p(d)}return null}(e,t,i,s))})),p(n)}({graphic:e,relatedInfos:s,layer:r},i);Object.keys(l).forEach((e=>{var t;!function(e,t){if(!t)return;if(!e)return;const{features:i,statsFeatures:s}=e,n=i&&i.value;t.relatedFeatures=n?n.features:[];const r=s&&s.value;t.relatedStatsFeatures=r?r.features:[]}(null==(t=l[e])?void 0:t.value,s.get(e.toString()))}))}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,s=Ls(e.fieldName);if(!s)return;const{layerId:n,fieldName:r}=s;if(!n)return;const a=i.get(n.toString())||function(e,t){const i=function(e,t){if(!t.relationships)return null;let i=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(i=t,!0))),i}(e,t);if(!i)return;const s=`${t.url}/${i.relatedTableId}`;return{url:s,queryTask:new mt({url:s,sourceSpatialReference:t.spatialReference}),relation:i,relatedFields:[],outStatistics:[]}}(n,t);a&&(function({relatedInfo:e,fieldName:t,fieldInfo:i}){if(e.relatedFields.push(t),i.statisticType){const s=new ot({statisticType:i.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(s)}}({relatedInfo:a,fieldName:r,fieldInfo:e}),this.relatedInfos.set(n,a))}};e([f()],Ys.prototype,"_featureAbortController",void 0),e([f({readOnly:!0,dependsOn:["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo","defaultPopupTemplateEnabled"]})],Ys.prototype,"_effectivePopupTemplate",null),e([f({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],Ys.prototype,"_fieldInfoMap",null),e([f({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],Ys.prototype,"_sourceLayer",null),e([f({readOnly:!0})],Ys.prototype,"content",void 0),e([f({readOnly:!0})],Ys.prototype,"contentViewModels",void 0),e([f({type:Boolean})],Ys.prototype,"defaultPopupTemplateEnabled",void 0),e([f({readOnly:!0})],Ys.prototype,"formattedAttributes",void 0),e([f({type:H,value:null})],Ys.prototype,"graphic",null),e([f({readOnly:!0})],Ys.prototype,"lastEditInfo",void 0),e([f()],Ys.prototype,"relatedInfos",void 0),e([f({dependsOn:["view"]})],Ys.prototype,"spatialReference",null),e([f({readOnly:!0})],Ys.prototype,"title",void 0),e([f({dependsOn:["view"]})],Ys.prototype,"map",null),e([f({readOnly:!0,dependsOn:["_featureAbortController"]})],Ys.prototype,"waitingForContent",null),e([f()],Ys.prototype,"view",void 0),Ys=e([i("esri.widgets.FeatureViewModel")],Ys);var Xs=Ys;const Qs="esri-feature__content-element",Zs={title:!0,content:!0,lastEditedInfo:!0};let en=class extends(_i(Se)){constructor(e,t){super(e,t),this._contentWidgets=[],this.graphic=null,this.defaultPopupTemplateEnabled=!1,this.label=void 0,this.messages=null,this.messagesURIUtils=null,this.spatialReference=null,this.title=null,this.visibleElements={...Zs},this.map=null,this.view=null,this.viewModel=new Xs}initialize(){this.own(Re(this,"viewModel.contentViewModels",(()=>this._setupContentWidgets())))}destroy(){this._destroyContentWidgets()}castVisibleElements(e){return{...Zs,...e}}render(){const{waitingForContent:e}=this.viewModel;return Fe("div",{class:this.classes("esri-feature","esri-widget")},Fe("div",{class:"esri-feature__size-container"},this.renderTitle(),e?this.renderLoading():this.renderContentContainer()))}setActiveMedia(e,t){this.viewModel.setActiveMedia(e,t)}nextMedia(e){this.viewModel.nextMedia(e)}previousMedia(e){this.viewModel.previousMedia(e)}renderLoading(){return Fe("div",{key:"loading-container",class:"esri-feature__loading-container"},Fe("span",{class:this.classes("esri-icon-loading-indicator esri-rotating","esri-feature__loading-spinner")}))}renderContentContainer(){const{visibleElements:e}=this;return e.content?Fe("div",{class:"esri-feature__main-container"},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:e,title:t}=this;return e.title?Fe("h4",{class:"esri-feature__title",innerHTML:t}):null}renderContent(){const e=this.viewModel.content;if(!e)return null;if(Array.isArray(e))return e.length?Fe("div",{key:"content-content-elements"},e.map(this.renderContentElement,this)):null;if("string"==typeof e){const e=this._contentWidgets[0];return!e||e.destroyed?null:Fe("div",{key:"content-content"},e.render())}return this.renderNodeContent(e)}renderContentElement(e,t){const{visibleElements:i}=this;if("boolean"!=typeof i.content&&!i.content[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(t);case"text":return this.renderText(e,t);default:return null}}renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:i,attachmentInfos:s}=t.viewModel;return"loading"===i||s.length>0?Fe("div",{key:this._buildKey("attachments-element",e),class:this.classes("esri-feature__attachments",Qs)},Fe("h2",null,this.messages.attach),t.render()):null}renderCustom(e,t){const{creator:i}=e,s=this._contentWidgets[t];return!s||s.destroyed?null:i?Fe("div",{key:this._buildKey("custom-element",t),class:Qs},s.render()):null}renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:Fe("div",{key:this._buildKey("fields-element",e),class:Qs},t.render())}renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:Fe("div",{key:this._buildKey("media-element",e),class:Qs},t.render())}renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:i}=this.viewModel;if(!i||!e.lastEditedInfo)return null;const{date:s,user:n}=i,r=se("edit"===i.type?n?t.lastEditedByUser:t.lastEdited:n?t.lastCreatedByUser:t.lastCreated,{date:s,user:n});return Fe("div",{key:"edit-info-element",class:this.classes("esri-feature__last-edited-info",Qs)},r)}renderText(e,t){const i=this._contentWidgets[t];return!i||i.destroyed?null:e.text?Fe("div",{key:this._buildKey("text-element",t),class:this.classes(Qs,"esri-feature__text")},i.render()):null}_buildKey(e,...t){return`${e}__${this.get("viewModel.graphic.uid")||"0"}-${t.join("-")}`}_destroyContentWidgets(){this._contentWidgets.forEach((e=>{e.viewModel=null,e&&!e.destroyed&&e.destroy()})),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const e=this.get("viewModel.content"),{contentViewModels:t}=this.viewModel;if(Array.isArray(e))e.forEach(((e,i)=>{"attachments"===e.type&&(this._contentWidgets[i]=new ws({displayType:e.displayType,viewModel:t[i]})),"fields"===e.type&&(this._contentWidgets[i]=new As({viewModel:t[i]})),"media"===e.type&&(this._contentWidgets[i]=new Hs({viewModel:t[i]})),"text"===e.type&&(this._contentWidgets[i]=new ks({viewModel:t[i]})),"custom"===e.type&&(this._contentWidgets[i]=new ks({viewModel:t[i]}))}),this);else{const e=t[0];e&&!e.destroyed&&(this._contentWidgets[0]=new ks({viewModel:e}))}this.scheduleRender()}};e([q("viewModel.graphic")],en.prototype,"graphic",void 0),e([q("viewModel.defaultPopupTemplateEnabled")],en.prototype,"defaultPopupTemplateEnabled",void 0),e([f({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],en.prototype,"label",void 0),e([f(),$e(),Ne("esri/widgets/Feature/t9n/Feature")],en.prototype,"messages",void 0),e([f(),$e(),Ne("esri/widgets/support/t9n/uriUtils")],en.prototype,"messagesURIUtils",void 0),e([q("viewModel.spatialReference")],en.prototype,"spatialReference",void 0),e([q("viewModel.title")],en.prototype,"title",void 0),e([f(),$e()],en.prototype,"visibleElements",void 0),e([I("visibleElements")],en.prototype,"castVisibleElements",null),e([q("viewModel.map")],en.prototype,"map",void 0),e([q("viewModel.view")],en.prototype,"view",void 0),e([f({type:Xs}),$e(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo","viewModel.contentViewModels"])],en.prototype,"viewModel",void 0),en=e([i("esri.widgets.Feature")],en);var tn=en;let sn=class extends _.EventedAccessor{constructor(...e){super(...e),this._anchorHandles=new Ve,this.location=null,this.screenLocation=null,this.screenLocationEnabled=!1,this.view=null,this._anchorHandles.add([ze(this,["screenLocationEnabled","location","view.size","view.stationary"],(()=>this._updateScreenPointAndHandle())),ze(this,["view","view.ready"],(()=>this._wireUpView()))])}destroy(){this.view=null,this._anchorHandles&&this._anchorHandles.destroy(),this._anchorHandles=null,this._viewpointHandle=null}_wireUpView(){const e="view";if(this._anchorHandles.remove(e),this._viewpointHandle=null,!this.get("view.ready"))return;this._setScreenLocation();const{view:t}=this,i=Ue(t,"3d"===t.type?"camera":"viewpoint",(()=>this._viewpointChange()));this._anchorHandles.add(i,e),this._viewpointHandle=i,this._toggleWatchingViewpoint()}_viewpointChange(){this._setScreenLocation(),this.emit("view-change")}_updateScreenPointAndHandle(){this._setScreenLocation(),this._toggleWatchingViewpoint()}_toggleWatchingViewpoint(){const{_viewpointHandle:e,location:t,screenLocationEnabled:i}=this;e&&(t&&i?e.resume():e.pause())}_setScreenLocation(){const{location:e,view:t,screenLocationEnabled:i}=this,s=this.get("view.ready"),n=i&&e&&s?t.toScreen(e):null;this._set("screenLocation",n)}};e([f()],sn.prototype,"location",void 0),e([f({readOnly:!0})],sn.prototype,"screenLocation",void 0),e([f()],sn.prototype,"screenLocationEnabled",void 0),e([f()],sn.prototype,"view",void 0),sn=e([i("esri.widgets.support.AnchorElementViewModel")],sn);var nn=sn;let rn=class extends nn{constructor(e){super(e),this.visible=!1}};e([f()],rn.prototype,"visible",void 0),rn=e([i("esri.widgets.CompassViewModel")],rn);var an=rn;let on=class extends Se{constructor(e,t){super(e,t),this._animationDelay=500,this._animationPromise=null,this.location=null,this.view=null,this.viewModel=new an,this.visible=!1}initialize(){this.own([ze(this,"visible",(e=>this._visibleChange(e)))])}destroy(){this._animationPromise=null}show(e){const{location:t,promise:i}=e;t&&(this.viewModel.location=t),this.visible=!0,i&&i.catch((()=>{})).then((()=>this.hide()))}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:t}=this.viewModel,i=!!t,s={"esri-spinner--start":e&&i,"esri-spinner--finish":!e&&i},n=this._getPositionStyles();return Fe("div",{class:this.classes("esri-spinner",s),styles:n})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const t=ne(this._animationDelay);this._animationPromise=t,t.catch((()=>{})).then((()=>{this._animationPromise===t&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)}))}_getPositionStyles(){const{screenLocation:e,view:t}=this.viewModel;if(!t||!e)return{};const{padding:i}=t;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};e([q("viewModel.location")],on.prototype,"location",void 0),e([q("viewModel.view")],on.prototype,"view",void 0),e([f({type:an}),$e(["viewModel.screenLocation","viewModel.screenLocationEnabled"])],on.prototype,"viewModel",void 0),e([q("viewModel.visible")],on.prototype,"visible",void 0),on=e([i("esri.widgets.Spinner")],on);var ln=on;const hn=new re({id:"zoom-to-feature",title:"{messages.zoom}",className:"esri-icon-zoom-in-magnifying-glass"}),cn=new re({id:"remove-selected-feature",title:"{messages.remove}",className:"esri-icon-trash"}),un=t=>{let s=class extends t{constructor(...e){super(...e),this.goToOverride=null,this.view=null}callGoTo(e){const{view:t}=this;return this.goToOverride?this.goToOverride(t,e):t.goTo(e.target,e.options)}};return e([f()],s.prototype,"goToOverride",void 0),e([f()],s.prototype,"view",void 0),s=e([i("esri.widgets.support.GoTo")],s),s},dn=o.ofType({key:"type",defaultKeyValue:"button",base:ae,typeMap:{button:re,toggle:oe}}),pn=n.getLogger("esri.widgets.Popup.PopupViewModel");let fn=class extends(un(nn)){constructor(e){super(e),this._handles=new Ve,this._pendingPromises=new Set,this._zoomToLocation=null,this._fetchFeaturesController=null,this.actions=new dn([hn.clone()]),this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.content=null,this.featureViewModels=[],this.highlightEnabled=!0,this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4}initialize(){this._handles.add([Re(this,["autoOpenEnabled","view"],(()=>this._autoOpenEnabledChange())),this.on("view-change",(()=>this._autoClose())),ze(this,["highlightEnabled","selectedFeature","visible","view"],(()=>this._highlightFeature())),ze(this,"view.animation.state",(e=>this._animationStateChange(e))),ze(this,"location",(e=>this._locationChange(e))),ze(this,"selectedFeature",(e=>this._selectedFeatureChange(e))),this.on("trigger-action",(e=>function(e){const{event:t,view:i}=e,{action:s}=t,n=i&&i.popup;if(!s)return T(new h("trigger-action:missing-arguments","Event has no action"));if(!n)return T(new h("trigger-action:missing-arguments","view.popup is missing"));const{disabled:r,id:a}=s;if(!a)return T(new h("trigger-action:invalid-action","action.id is missing"));if(r)return T(new h("trigger-action:invalid-action","Action is disabled"));if(a===hn.id)return n.viewModel.zoomToLocation();if(a===cn.id){n.close();const{selectedFeature:e}=n;if(!e)return T(new h(`trigger-action:${cn.id}`,"selectedFeature is required",{selectedFeature:e}));const{sourceLayer:t}=e;return t?t.remove(e):i.graphics.remove(e),c()}return c()}({event:e,view:this.view}))),Be(this,"waitingForResult",(()=>this._waitingForResultChange())),ze(this,["features","view","view.map","view.spatialReference"],(()=>this._updateFeatureVMs()))])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new dn;e.removeAll();const t=this.selectedFeature&&("function"==typeof this.selectedFeature.getEffectivePopupTemplate&&this.selectedFeature.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled)||this.selectedFeature.popupTemplate),i=t&&t.actions,s=t&&t.overwriteActions?i:i?i.concat(this.actions):this.actions;return s&&s.filter(Boolean).forEach((t=>e.add(t))),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:n}=this,r=s&&t.length;r&&i&&-1===n?this.selectedFeatureIndex=0:r&&-1!==n||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=le(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach((e=>{this._pendingPromises.add(e),e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t),this._updatePendingPromises(e)}),(()=>this._updatePendingPromises(e)))})),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return-1===t?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=this._getSelectedTarget();if(!t){const i=new h("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return pn.error(i),T(i)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:i}=this;if(!i||!e){const t=new h("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return pn.error(t),T(t)}return i.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:i}=t;delete t.fetchFeatures,i&&this._setFetchFeaturesPromises(t.location),this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}zoomToLocation(){const{location:e,selectedFeature:t,view:i,zoomFactor:s}=this,n=this._getSelectedTarget();if(!n){const e=new h("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:i});return pn.error(e),T(e)}const r=i.scale/s,a=this.get("selectedFeature.geometry")||e,o=a&&"point"===a.type&&this._isZoomScreenSize(t);hn.active=!0,hn.disabled=!0;const l=this.callGoTo({target:{target:n,scale:o?r:void 0}}).catch((()=>{hn.active=!1,hn.disabled=!1,this._zoomToLocation=null})).then((()=>{o&&(this.location=a)}));return this._zoomToLocation=l,l}_animationStateChange(e){this._zoomToLocation||(hn.disabled="waiting-for-target"===e)}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:i}=this;i&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:i,view:s}=this;!i&&t||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then((()=>{this.location=s.center.clone()})):this.location=he(this._getPointFromGeometry(e.geometry))}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:i}=e,s=c(t),n=i.map((e=>e.promise));this.promises=[s,...n]}))}_destroyFeatureVMs(){this.featureViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{features:e,featureViewModels:t}=this;if(this._destroyFeatureVMs(),!e||!e.length)return;const i=t.slice(0),s=[];e.forEach(((e,t)=>{if(!e)return;let n=null;if(i.some(((t,s)=>(t&&t.graphic===e&&(n=t,i.splice(s,1)),!!n))),n)s[t]=n;else{var r,a;const i=new Xs({defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,graphic:e,spatialReference:null==(r=this.view)?void 0:r.spatialReference,map:null==(a=this.view)?void 0:a.map});s[t]=i}})),i.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",s)}_getScreenPoint(e){const{view:t}=this;return t&&e&&"function"==typeof t.toScreen?t.toScreen(e):null}_getSelectedTarget(){const{selectedFeature:e,location:t,view:i}=this;return i?"3d"===i.type?e||t:this.get("selectedFeature.geometry")||t:null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:i}=this;if(t.remove(e),i&&this.view){const i=this.view.on("click",(e=>{"mouse"===e.pointerType&&0!==e.button||this._fetchFeaturesAndOpen(e)}),pi.WIDGET);t.add(i,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const i=C(),{signal:s}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const n=this.fetchFeatures(e,{signal:s,event:t});return n.catch((()=>{})).then((()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")})),n}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:i}=e,{view:s}=this;this._fetchFeaturesWithController(t,e).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:n,location:r}=e,a=[c(t),...n.map((e=>e.promise))];return s.popup.open({location:r||i,promises:a}),e}))}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_isZoomScreenSize(e){const{view:t}=this;if("3d"!==t.type||!e||"esri.Graphic"!==e.declaredClass)return!0;const i=t.getViewForGraphic(e);if(i&&"whenGraphicBounds"in i){let t=!1;return i.whenGraphicBounds(e,{useViewElevation:!0}).then((e=>{t=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((()=>{const t=new h("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});pn.error(t)})),t}return!0}_getPointFromGeometry(e){return k(e)?null:"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type||"polyline"===e.type?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:i,view:s,visible:n}=this;if(!(t&&s&&i&&n))return;const{layer:r}=t;if(!(r&&r instanceof Ye))return;const a=this._getLayerView(s,r);this._highlightPromise=a;const o=await a;if(!(o&&function(e){return e&&"function"==typeof e.highlight}(o)&&this._highlightPromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l="objectIdField"in r&&r.objectIdField,h=t.attributes,c=o.highlight(h&&l&&h[l]||t);this._handles.add(c,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const i=e.filter((e=>-1===t.indexOf(e)));this.features=t.concat(i)}};e([f({type:dn})],fn.prototype,"actions",void 0),e([f({readOnly:!0,dependsOn:["visible","waitingForResult"]})],fn.prototype,"active",null),e([f({dependsOn:["actions.length","selectedFeature.sourceLayer.popupTemplate.actions.length","selectedFeature.sourceLayer.popupTemplate.overwriteActions","selectedFeature.popupTemplate.actions.length","selectedFeature.popupTemplate.overwriteActions"],readOnly:!0})],fn.prototype,"allActions",null),e([f({type:Boolean})],fn.prototype,"defaultPopupTemplateEnabled",void 0),e([f()],fn.prototype,"autoCloseEnabled",void 0),e([f()],fn.prototype,"autoOpenEnabled",void 0),e([f()],fn.prototype,"content",void 0),e([f({readOnly:!0,dependsOn:["features"]})],fn.prototype,"featureCount",null),e([f()],fn.prototype,"features",null),e([f({readOnly:!0})],fn.prototype,"featureViewModels",void 0),e([f()],fn.prototype,"highlightEnabled",void 0),e([f({type:ce})],fn.prototype,"location",null),e([f({readOnly:!0,dependsOn:["promises"]})],fn.prototype,"pendingPromisesCount",null),e([f({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],fn.prototype,"waitingForResult",null),e([f({readOnly:!0,dependsOn:["promises"]})],fn.prototype,"promiseCount",null),e([f()],fn.prototype,"promises",null),e([f({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],fn.prototype,"selectedFeature",null),e([f({value:-1})],fn.prototype,"selectedFeatureIndex",null),e([f({readOnly:!0,dependsOn:["featureViewModels","selectedFeatureIndex"]})],fn.prototype,"selectedFeatureViewModel",null),e([f({readOnly:!0,dependsOn:["view.ready"]})],fn.prototype,"state",null),e([f()],fn.prototype,"title",void 0),e([f()],fn.prototype,"updateLocationEnabled",void 0),e([f()],fn.prototype,"view",void 0),e([f()],fn.prototype,"visible",void 0),e([f()],fn.prototype,"zoomFactor",void 0),e([f()],fn.prototype,"centerAtLocation",null),e([f()],fn.prototype,"zoomToLocation",null),fn=e([i("esri.widgets.Popup.PopupViewModel")],fn);var mn=fn;const vn="esri-icon-left-triangle-arrow",gn="esri-icon-right-triangle-arrow",yn="esri-icon-loading-indicator",bn="esri-rotating",wn="esri-popup--shadow",_n="esri-popup__header-container",Mn="esri-popup__button",In="esri-popup__icon",kn={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};function xn(e,t){return void 0===t?`esri-popup__${e}`:`esri-popup__${e}-${t}`}const Fn=n.getLogger("esri.widgets.Popup"),On={closeButton:!0,featureNavigation:!0};let Tn=class extends(_i(Se)){constructor(e,t){super(e,t),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new Ve,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._displaySpinnerThrottled=wi((()=>this._displaySpinner()),0),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new mn,this.visible=null,this.visibleElements={...On},this._addSelectedFeatureIndexHandle(),this.own([ze(this,"viewModel.screenLocation",(()=>this._positionContainer())),ze(this,["viewModel.active","dockEnabled"],(()=>this._toggleScreenLocationEnabled())),ze(this,"viewModel.screenLocation",((e,t)=>{!!e!=!!t&&this.reposition()})),ze(this,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],(()=>this.reposition())),ze(this,"spinnerEnabled",(e=>this._spinnerEnabledChange(e))),ze(this,"viewModel.view.size",((e,t)=>this._updateDockEnabledForViewSize(e,t))),ze(this,"viewModel.view",((e,t)=>this._viewChange(e,t))),ze(this,"viewModel.view.ready",((e,t)=>this._viewReadyChange(e,t))),ze(this,["viewModel.waitingForResult","viewModel.location"],(()=>{this._hideSpinner(),this._displaySpinnerThrottled()})),ze(this,"selectedFeatureWidget.viewModel.title",(e=>this._setTitleFromFeatureWidget(e))),ze(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],(()=>this._setContentFromFeatureWidget())),Be(this,"collapsed",(()=>{var e,t;"xsmall"===(null==(e=this.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint)&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()})),De(this,"viewModel.allActions","change",(()=>this._watchActions())),Re(this,"viewModel.allActions",(()=>this._watchActions()))])}destroy(){this._destroySelectedFeatureWidget(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var e,t,i,s,n;return!!(this.selectedFeatureWidget?(null==(e=this.selectedFeatureWidget)||null==(t=e.viewModel)?void 0:t.waitingForContent)||(null==(i=this.selectedFeatureWidget)||null==(s=i.viewModel)?void 0:s.content):null==(n=this.viewModel)?void 0:n.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||kn}set dockOptions(e){const t={...kn},i=this.get("viewModel.view.breakpoints"),s={};i&&(s.width=i.xsmall,s.height=i.xsmall);const n={...t,...e},r={...t.breakpoint,...s},{breakpoint:a}=n;!0===a?n.breakpoint=r:"object"==typeof a&&(n.breakpoint={...r,...a}),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}set featureNavigationEnabled(e){ue(Fn,"featureNavigationEnabled",{replacement:"visibleElements.featureNavigation",version:"4.15"}),this.visibleElements={...this.visibleElements,featureNavigation:e}}get selectedFeatureWidget(){const{_feature:e,visibleElements:t}=this,{selectedFeatureViewModel:i}=this.viewModel,s={...t,title:!1};return i?(e?(e.viewModel=i,e.visibleElements=s):this._feature=new tn({viewModel:i,visibleElements:s}),this._feature):null}castVisibleElements(e){return{...On,...e}}blur(){const{active:e}=this.viewModel;e||Fn.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||Fn.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var t,i;this._handles.remove("selected-index");const s={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:!!e&&!!e.actionsMenuOpen,featureMenuOpen:!!e&&!!e.featureMenuOpen};"xsmall"===(null==(t=this.viewModel)||null==(i=t.view)?void 0:i.widthBreakpoint)&&(s.collapsed=!0),this.set(s),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){this.viewModel.triggerAction(e)}render(){var e,t,i,s;const{actionsMenuOpen:n,dockEnabled:r,featureMenuVisible:a,dividedActions:o,currentAlignment:l,currentDockPosition:h}=this,{active:c}=this.viewModel,{menuActions:u}=o,d=null==(e=this.selectedFeature)||null==(t=e.layer)?void 0:t.title,p=null==(i=this.selectedFeature)||null==(s=i.layer)?void 0:s.id;return Fe("div",{class:this.classes("esri-popup",{"esri-popup--aligned-top-center":"top-center"===l,"esri-popup--aligned-bottom-center":"bottom-center"===l,"esri-popup--aligned-top-left":"top-left"===l,"esri-popup--aligned-bottom-left":"bottom-left"===l,"esri-popup--aligned-top-right":"top-right"===l,"esri-popup--aligned-bottom-right":"bottom-right"===l,"esri-popup--is-docked":c&&r,[wn]:c&&!r,"esri-popup--is-docked-top-left":"top-left"===h,"esri-popup--is-docked-top-center":"top-center"===h,"esri-popup--is-docked-top-right":"top-right"===h,"esri-popup--is-docked-bottom-left":"bottom-left"===h,"esri-popup--is-docked-bottom-center":"bottom-center"===h,"esri-popup--is-docked-bottom-right":"bottom-right"===h,"esri-popup--feature-menu-open":a,"esri-popup--actions-menu-open":c&&u.length>1&&n}),role:"presentation","data-layer-title":d,"data-layer-id":p,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},c?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return Fe("span",{"aria-hidden":"true",class:this.classes(In,yn,bn)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?Fe("div",{key:xn("loading-container"),role:"presentation",class:"esri-popup__loading-container","aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=Ae();return Fe("span",{"aria-hidden":"true",class:this.classes(In,{[gn]:e,"esri-popup__pagination-previous-icon--rtl":e,[vn]:!e,"esri-popup__pagination-previous-icon":!e})})}renderPreviousButton(){const{messages:e}=this;return Fe("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Mn,"esri-popup__pagination-previous"),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=Ae();return Fe("span",{"aria-hidden":"true",class:this.classes(In,{[vn]:e,"esri-popup__pagination-next-icon--rtl":e,[gn]:!e,"esri-popup__pagination-next-icon":!e})})}renderNextButton(){const{messages:e}=this;return Fe("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Mn,"esri-popup__pagination-next"),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:i}=this,{featureCount:s,selectedFeatureIndex:n}=this.viewModel;return Fe("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Mn,"esri-popup__feature-menu-button"),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e,"aria-label":i.menu,title:i.menu},this._getPageText(s,n))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:e}=this,t=this._wouldDockTo();return Fe("span",{"aria-hidden":"true",class:this.classes({"esri-icon-minimize":e,"esri-popup__icon--dock-icon":!e,"esri-icon-dock-right":!e&&("top-right"===t||"bottom-right"===t),"esri-icon-dock-left":!e&&("top-left"===t||"bottom-left"===t),"esri-icon-maximize":!e&&"top-center"===t,"esri-icon-dock-bottom":!e&&"bottom-center"===t},In)})}renderDockButton(){var e,t,i;const{dockEnabled:s,messages:n}=this,r=null==(e=this.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint,a=s?n.undock:n.dock;return"xsmall"!==r&&null!=(i=this.dockOptions)&&i.buttonEnabled?Fe("div",{role:"button","aria-label":a,title:a,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Mn,"esri-popup__button--dock")},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:t,collapsible:i,contentCollapsed:s,messagesCommon:n}=this,r={"esri-popup__header-container--button":i},a=Fe("h2",{class:"esri-popup__header-title",innerHTML:e}),o=i?Fe("button",{key:`${e}--collapsible`,id:t,title:s?n.expand:n.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(_n,r),"aria-expanded":s?"false":"true",onclick:this._toggleCollapsed},a):Fe("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(_n,r)},a);return e?o:null}renderCloseIcon(){return Fe("span",{"aria-hidden":"true",class:this.classes(In,"esri-icon-close")})}renderCloseButton(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?Fe("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Mn,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return Fe("header",{class:"esri-popup__header"},this.renderTitle(),Fe("div",{class:"esri-popup__header-buttons"},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:t,contentCollapsed:i}=this,{content:s}=this.viewModel;return t&&!i?Fe("article",{key:s,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:"esri-popup__content"},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:s,messagesCommon:n}=this,r=i?n.close:n.open,{menuActions:a}=s;return a.length?Fe("div",{key:xn("actions-menu-button"),class:this.classes(Mn,"esri-popup__actions-menu-button"),role:"button",id:t,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":r,title:r},Fe("span",{"aria-hidden":"true",class:"esri-icon-handle-horizontal"})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:s}=this,{menuActions:n,inlineActions:r}=s;return n.length&&i?Fe("ul",{id:e,role:"menu","aria-labelledby":t,key:xn("actions"),class:"esri-popup__actions",bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},n.toArray().map(((e,t)=>this.renderAction({action:e,index:t+r.length,type:"menu-item"})))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(((e,t)=>this.renderAction({action:e,index:t,type:"inline"})))}renderInlineActionsContainer(){const{inlineActions:e,menuActions:t}=this.dividedActions,i=!!e.length,s=!!t.length;return i||s?Fe("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":s.toString(),class:"esri-popup__inline-actions-container"},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?Fe("section",{key:xn("navigation"),class:this.classes("esri-popup__navigation")},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:i,menuActions:s}=t,n=!!i.length,r={"esri-popup__footer--has-pagination":e,"esri-popup__footer--has-actions":n,"esri-popup__footer--has-actions-menu":!!s.length};return e||n?Fe("div",{key:xn("feature-buttons"),class:this.classes("esri-popup__footer",r)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:t}=this.viewModel,i=se(e.selectedFeatures,{total:t.length});return Fe("section",{key:xn("menu"),class:"esri-popup__feature-menu"},Fe("h2",{class:"esri-popup__feature-menu-header"},i),Fe("nav",{class:"esri-popup__feature-menu-viewport",afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},this.renderFeatureMenu()))}renderPointer(){return this.dockEnabled?null:Fe("div",{key:xn("pointer"),class:"esri-popup__pointer",role:"presentation"},Fe("div",{class:this.classes("esri-popup__pointer-direction",wn)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:i,titleId:s,contentId:n,collapsible:r,hasContent:a,contentCollapsed:o,visibleElements:l}=this,{title:h}=this.viewModel,c="bottom-left"===t||"bottom-center"===t||"bottom-right"===t||"top-left"===i||"top-center"===i||"top-right"===i,u="top-left"===t||"top-center"===t||"top-right"===t||"bottom-left"===i||"bottom-center"===i||"bottom-right"===i;return Fe("div",{class:this.classes("esri-popup__main-container","esri-widget",{[wn]:e,"esri-popup--is-collapsible":r,"esri-popup--is-collapsed":o}),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":h?s:"","aria-describedby":a&&!o?n:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},c?this.renderFooter():null,c?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),u?this.renderFooter():null,u?this.renderFeatureMenuContainer():null)}renderContent(){var e;const t=null==(e=this.viewModel)?void 0:e.content;return t?"string"==typeof t?Fe("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null}renderActionText(e){return Fe("span",{key:"text",class:"esri-popup__action-text"},e)}renderActionIcon(e){const t=this._getActionClass(e),i=this._getActionImage(e),s={[yn]:e.active,[bn]:e.active,[In]:!!t,"esri-popup__action-image":!e.active&&!!i};return t&&(s[t]=!e.active),Fe("span",{key:"icon","aria-hidden":"true",class:this.classes(In,s),styles:this._getIconStyles(i)})}renderAction(e){const{action:t,index:i,type:s}=e,n=this._getActionTitle(t),r={"esri-popup__action":"toggle"!==t.type,"esri-popup__action-toggle":"toggle"===t.type,"esri-popup__action-toggle--on":"toggle"===t.type&&t.value,"esri-popup__button--disabled":t.disabled},a=[this.renderActionIcon(t),this.renderActionText(n)],o="menu-item"===s?Fe("li",{key:t.uid,role:"menuitem",tabIndex:0,title:n,"aria-label":n,class:this.classes(Mn,r),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},a):Fe("div",{key:t.uid,role:"button",tabIndex:0,title:n,"aria-label":n,class:this.classes(Mn,r),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},a);return t.visible?o:null}renderFeatureMenuItem(e,t){const{messages:i,messagesCommon:s}=this,{selectedFeatureIndex:n,selectedFeatureViewModel:r}=this.viewModel,a=e===r,o={"esri-popup__feature-menu-item--selected":a},l=a?Fe("span",{key:xn(`feature-menu-selected-feature-${n}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:"esri-icon-check-mark"}):null,h=Fe("span",{innerHTML:e.title||s.untitled});return Fe("li",{role:"menuitem",tabIndex:-1,key:xn(`feature-menu-feature-${n}`),class:this.classes(o,"esri-popup__feature-menu-item"),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},Fe("span",{class:"esri-popup__feature-menu-title"},h,l))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?Fe("ol",{class:"esri-popup__feature-menu-list",id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.map(((e,t)=>this.renderFeatureMenuItem(e,t)))):null}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:s}=this,{id:n}=e,r=null==i?void 0:i.attributes,a="zoom-to-feature"===n?se(e.title,{messages:t}):"remove-selected-feature"===n?se(e.title,{messages:s}):e.title;return a&&r?se(a,r):a}_getActionClass(e){const{selectedFeature:t}=this,i=null==t?void 0:t.attributes,{className:s,image:n}=e,r=n||s?s:"esri-icon-default-action";return r&&i?se(r,i):r}_getActionImage(e){const{selectedFeature:t}=this,i=null==t?void 0:t.attributes,{image:s}=e;return s&&i?se(s,i):s}_createFeatureUpdatedAnimation(){return Ee("enter","esri-popup--feature-updated")}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if("number"!=typeof e)return null;const i=Math.round(e);return Math.max(t?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach((e=>{this._handles.add(ze(e,["active","className","disabled","id","title","image","visible"],(()=>this.scheduleRender())),t)}))}_divideActions(){const{allActions:e}=this.viewModel,t=this._getInlineActionCount(),i=null===t,s=0===t;return{inlineActions:i?e.slice(0):s?new o:e.slice(0,t),menuActions:i?new o:e.slice(s?0:t)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(e){const{selectedFeatureWidget:t}=this;t&&(this.viewModel.title=e||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_handleFeatureMenuKeyup(e){"Escape"===te(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){"Escape"===te(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_handleFeatureMenuItemKeyup(e){const t=te(e),{_featureMenuNode:i}=this,s=e.currentTarget["data-feature-index"];if(!i)return;const n=i.querySelectorAll("li"),r=n.length;"ArrowUp"!==t?"ArrowDown"!==t?"Home"!==t?"End"!==t||(e.stopPropagation(),n[n.length-1].focus()):(e.stopPropagation(),n[0].focus()):(e.stopPropagation(),n[(s+1+r)%r].focus()):(e.stopPropagation(),n[(s-1+r)%r].focus())}_handleActionMenuItemKeyup(e){const t=te(e),{_actionsMenuNode:i}=this,s=e.currentTarget["data-action-index"];if(!i)return;const n=i.querySelectorAll("li"),r=n.length;"ArrowUp"!==t?"ArrowDown"!==t?"Home"!==t?"End"!==t||(e.stopPropagation(),n[n.length-1].focus()):(e.stopPropagation(),n[0].focus()):(e.stopPropagation(),n[(s+1+r)%r].focus()):(e.stopPropagation(),n[(s-1+r)%r].focus())}_handleMainKeyup(e){const t=te(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i?e.show({location:t}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}_addSelectedFeatureIndexHandle(){const e=ze(this,"viewModel.selectedFeatureIndex",((e,t)=>this._selectedFeatureIndexUpdated(e,t)));this._handles.add(e,"selected-index")}_selectedFeatureIndexUpdated(e,t){const{featureCount:i}=this;i&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height}_isOutsideView(e){const{popupHeight:t,popupWidth:i,screenLocation:s,side:n,view:r}=e;if(isNaN(i)||isNaN(t)||!r||!s)return!1;const a=r.padding;return"right"===n&&s.x+i/2>r.width-a.right||"left"===n&&s.x-i/2<a.left||"top"===n&&s.y-t<a.top||"bottom"===n&&s.y+t>r.height-a.bottom}_calculateAutoAlignment(e){if("auto"!==e)return e;const{_pointerOffsetInPx:t,_containerNode:i,_mainContainerNode:s,viewModel:n}=this,{screenLocation:r,view:a}=n;if(!r||!a||!i)return"top-center";if(!this._isScreenLocationWithinView(r,a))return this._get("currentAlignment")||"top-center";function o(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}const l=s?window.getComputedStyle(s,null):null,h=l?o(l.getPropertyValue("max-height")):0,c=l?o(l.getPropertyValue("height")):0,{height:u,width:d}=i.getBoundingClientRect(),p=d+t,f=Math.max(u,h,c)+t,m=this._isOutsideView({popupHeight:f,popupWidth:p,screenLocation:r,side:"right",view:a}),v=this._isOutsideView({popupHeight:f,popupWidth:p,screenLocation:r,side:"left",view:a}),g=this._isOutsideView({popupHeight:f,popupWidth:p,screenLocation:r,side:"top",view:a}),y=this._isOutsideView({popupHeight:f,popupWidth:p,screenLocation:r,side:"bottom",view:a});return v?g?"bottom-right":"top-right":m?g?"bottom-left":"top-left":g?y?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return"function"==typeof e?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return Ae()&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])}_callDockPosition(e){return"function"==typeof e?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(null==(e=this.dockOptions)?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var t;if("auto"!==e)return e;const i=null==(t=this.viewModel)?void 0:t.view,s=Ae()?"top-left":"top-right";if(!i)return s;const n=i.padding||{left:0,right:0,top:0,bottom:0},r=i.width-n.left-n.right,{breakpoints:a}=i;return a&&r<=a.xsmall?"bottom-center":s}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:i}=e.getBoundingClientRect(),s=this._calculatePositionStyle(t,i);s&&(e.style.top=s.top,e.style.left=s.left,e.style.bottom=s.bottom,e.style.right=s.right)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:i}=this;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+i:e}_calculateAlignmentPosition(e,t,i,s){const{currentAlignment:n,_pointerOffsetInPx:r}=this,a=s/2,o=i.height-t,l=i.width-e,{padding:h}=this.view;return"bottom-center"===n?{top:t+r-h.top,left:e-a-h.left}:"top-left"===n?{bottom:o+r-h.bottom,right:l+r-h.right}:"bottom-left"===n?{top:t+r-h.top,right:l+r-h.right}:"top-right"===n?{bottom:o+r-h.bottom,left:e+r-h.left}:"bottom-right"===n?{top:t+r-h.top,left:e+r-h.left}:"top-center"===n?{bottom:o+r-h.bottom,left:e-a-h.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:i,view:s}=this;if(!s)return;if(i)return{left:"",top:"",right:"",bottom:""};if(!e||!t)return;const n=this._calculateFullWidth(t),r=this._calculateAlignmentPosition(e.x,e.y,s,n);return r?{top:void 0!==r.top?`${r.top}px`:"auto",left:void 0!==r.left?`${r.left}px`:"auto",bottom:void 0!==r.bottom?`${r.bottom}px`:"auto",right:void 0!==r.right?`${r.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){if(e){const e=this.get("viewModel.view");this._wireUpView(e)}else t&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,i){const[s,n]=e,[r,a]=t,{width:o,height:l}=i;return s<=o&&r>o||s>o&&r<=o||n<=l&&a>l||n>l&&a<=l}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},s=i.left+i.right,n=i.top+i.bottom,r=[],a=[];r[0]=e[0]-s,r[1]=e[1]-n,a[0]=t[0]-s,a[1]=t[1]-n;const{dockOptions:o}=this;this._dockingThresholdCrossed(r,a,o.breakpoint)&&this._setDockEnabledForViewSize(o),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportNodeUpdated(e){e&&(e.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;t&&(t.screenLocationEnabled=t.active&&!e)}_shouldDockAtCurrentViewSize(e){var t,i;const s=e.breakpoint,n=null==(t=this.viewModel)||null==(i=t.view)?void 0:i.ui;if(!n)return!1;const{width:r,height:a}=n;if(isNaN(r)||isNaN(a))return!1;const o=s.hasOwnProperty("width")&&r<=s.width,l=s.hasOwnProperty("height")&&a<=s.height;return o||l}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,t){return this.featureNavigationVisible?se(this.messages.pageText,{index:t+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,"popup-spinner"),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new ln({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const t=e.currentTarget["data-action-index"],i=this.viewModel.allActions.getItemAt(t);i&&"toggle"===i.type&&(i.value=!i.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(t)}_selectFeature(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};function An(e,t){const i=e.view;i&&(t&&i.ready&&i.activeTool!==e?(i.activeTool=e,function(e){return e&&"focus"in e}(i)&&i.focus()):t||i.activeTool!==e||(i.activeTool=null))}function Cn(e){return!1!==e.visible&&!1!==e.editable&&(null==e.hasEditableFlag||e.hasEditableFlag(1))}function En(e){return k(e)?{}:"function"==typeof e?e():e}function Ln(e){return j(e.x,e.y)}function Pn(e){return"mouse"===e}function jn(e){return"mouse"!==e.pointerType||0===e.button}function $n(e){return!!e.native.shiftKey}var Nn;e([f({readOnly:!0,dependsOn:["id"]}),$e()],Tn.prototype,"actionsMenuId",null),e([f({readOnly:!0,dependsOn:["id"]}),$e()],Tn.prototype,"actionsMenuButtonId",null),e([f({readOnly:!0,dependsOn:["id"]}),$e()],Tn.prototype,"featureMenuId",null),e([f({readOnly:!0,dependsOn:["id"]}),$e()],Tn.prototype,"titleId",null),e([f({readOnly:!0,dependsOn:["id"]}),$e()],Tn.prototype,"contentId",null),e([f({readOnly:!0,dependsOn:["selectedFeatureWidget","selectedFeatureWidget.viewModel","selectedFeatureWidget.viewModel.waitingForContent","selectedFeatureWidget.viewModel.content","viewModel.content"]}),$e()],Tn.prototype,"hasContent",null),e([f({readOnly:!0,dependsOn:["viewModel.active","viewModel.featureCount","visibleElements.featureNavigation"]}),$e()],Tn.prototype,"featureNavigationVisible",null),e([f({readOnly:!0,dependsOn:["collapseEnabled","viewModel.title","hasContent"]}),$e()],Tn.prototype,"collapsible",null),e([f({readOnly:!0,dependsOn:["featureNavigationVisible","featureMenuOpen"]}),$e()],Tn.prototype,"featureMenuVisible",null),e([f({readOnly:!0,dependsOn:["collapsible","featureMenuVisible","collapsed"]}),$e()],Tn.prototype,"contentCollapsed",null),e([f({readOnly:!0,dependsOn:["featureNavigationVisible","maxInlineActions","viewModel.allActions","viewModel.allActions.length"]}),$e()],Tn.prototype,"dividedActions",null),e([q("viewModel.actions"),$e()],Tn.prototype,"actions",void 0),e([f({dependsOn:["viewModel.active"]}),$e()],Tn.prototype,"actionsMenuOpen",null),e([f()],Tn.prototype,"alignment",void 0),e([q("viewModel.autoCloseEnabled")],Tn.prototype,"autoCloseEnabled",void 0),e([q("viewModel.autoOpenEnabled")],Tn.prototype,"autoOpenEnabled",void 0),e([q("viewModel.defaultPopupTemplateEnabled")],Tn.prototype,"defaultPopupTemplateEnabled",void 0),e([q("viewModel.content"),$e()],Tn.prototype,"content",void 0),e([f(),$e()],Tn.prototype,"collapsed",void 0),e([f(),$e()],Tn.prototype,"collapseEnabled",void 0),e([f({readOnly:!0,dependsOn:["dockEnabled","alignment","viewModel.active"]}),$e()],Tn.prototype,"currentAlignment",null),e([f({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions","viewModel.active"]}),$e()],Tn.prototype,"currentDockPosition",null),e([f(),$e()],Tn.prototype,"dockOptions",null),e([f(),$e()],Tn.prototype,"dockEnabled",void 0),e([q("viewModel.featureCount"),$e()],Tn.prototype,"featureCount",void 0),e([f(),$e()],Tn.prototype,"featureMenuOpen",void 0),e([q("viewModel.features"),$e()],Tn.prototype,"features",void 0),e([f(),$e()],Tn.prototype,"featureNavigationEnabled",null),e([q("viewModel.goToOverride")],Tn.prototype,"goToOverride",void 0),e([q("viewModel.highlightEnabled")],Tn.prototype,"highlightEnabled",void 0),e([q("viewModel.location"),$e()],Tn.prototype,"location",void 0),e([f({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Tn.prototype,"label",void 0),e([f(),$e()],Tn.prototype,"maxInlineActions",void 0),e([f(),$e(),Ne("esri/widgets/Popup/t9n/Popup")],Tn.prototype,"messages",void 0),e([f(),$e(),Ne("esri/t9n/common")],Tn.prototype,"messagesCommon",void 0),e([q("viewModel.promises")],Tn.prototype,"promises",void 0),e([q("viewModel.selectedFeature"),$e()],Tn.prototype,"selectedFeature",void 0),e([q("viewModel.selectedFeatureIndex"),$e()],Tn.prototype,"selectedFeatureIndex",void 0),e([f({readOnly:!0,dependsOn:["viewModel.selectedFeatureViewModel","visibleElements"]}),$e()],Tn.prototype,"selectedFeatureWidget",null),e([f()],Tn.prototype,"spinnerEnabled",void 0),e([q("viewModel.title"),$e()],Tn.prototype,"title",void 0),e([q("viewModel.updateLocationEnabled")],Tn.prototype,"updateLocationEnabled",void 0),e([q("viewModel.view")],Tn.prototype,"view",void 0),e([f({type:mn}),$e(["viewModel.active","viewModel.view.widthBreakpoint","viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),(Nn=["triggerAction","trigger-action"],e=>{e.hasOwnProperty("_delegatedEventNames")||(e._delegatedEventNames=e._delegatedEventNames?e._delegatedEventNames.slice():[]);const t=e._delegatedEventNames,i=Array.isArray(Nn)?Nn:Le(Nn);t.push(...i)})],Tn.prototype,"viewModel",void 0),e([q("viewModel.visible"),$e()],Tn.prototype,"visible",void 0),e([f(),$e()],Tn.prototype,"visibleElements",void 0),e([I("visibleElements")],Tn.prototype,"castVisibleElements",null),e([Et()],Tn.prototype,"_close",null),e([Et()],Tn.prototype,"_toggleDockEnabled",null),e([Et()],Tn.prototype,"_toggleFeatureMenu",null),e([Et()],Tn.prototype,"_toggleActionsMenu",null),e([Et()],Tn.prototype,"_triggerAction",null),e([Et()],Tn.prototype,"_selectFeature",null),e([Et()],Tn.prototype,"_next",null),e([Et()],Tn.prototype,"_previous",null),Tn=e([i("esri.widgets.Popup")],Tn);const Sn={manipulator:null,tool:null};class Vn{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToActiveTool=null,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Pn(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!jn(e)||$n(e))break;const s=Ln(e),n=this._intersect(s,e.pointerType,t.forEachTool);if(k(n))break;const r=this._findToolAndManipulatorByKey(n,t.forEachTool,Sn),a=de(r,(e=>e.manipulator)),o=de(r,(e=>e.tool));!(O(a)&&O(o)&&a.interactive)||a.grabbable&&a.grabbableForEvent(e)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,o,e),O(a)&&a.interactive&&a.grabbable&&a.grabbableForEvent(e)&&!a.grabbing&&(this._grabbedManipulators.set(e.pointerId,{key:n,start:s}),1===this._grabbedManipulators.size&&(this._revertToActiveTool=t.activeTool,t.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",screenPoint:s}),i());break}case"pointer-up":this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!jn(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=this._draggedManipulators.get(e.pointerId),r=de(s||n,(({key:e})=>e)),a=this._findManipulatorByKey(r,t.forEachTool);if(k(a))break;const o=Ln(e);o.x=S(o.x,0,t.view.width),o.y=S(o.y,0,t.view.height);const l=he(s||n).start;switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(a.dragging=!0,a.events.emit("drag",n?{action:"update",start:l,screenPoint:o}:{action:"start",start:l,screenPoint:o,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{key:he(r),start:l}));break;case"end":a.dragging=!1,n&&a.events.emit("drag",{action:"end",start:l,screenPoint:o}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const s=Ln(e),n=this._intersect(s,e.pointerType,t.forEachTool),r=this._findToolAndManipulatorByKey(n,t.forEachTool,Sn);if($n(e)||t.forEachTool((e=>{if((!O(r)||r.tool!==e||!e.selectionManagementDisabled)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.manipulatorSelectionChanged&&e.manipulatorSelectionChanged()}})),k(r))break;const{manipulator:a,tool:o}=r;if(!a.interactive)break;a.selectable&&!o.selectionManagementDisabled&&(a.selected=!a.selected,o.manipulatorSelectionChanged&&o.manipulatorSelectionChanged()),a.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:e.native.shiftKey,stopPropagation:i});break}case"click":{const s=Ln(e),n=this._intersect(s,e.pointerType,t.forEachTool),r=this._findManipulatorByKey(n,t.forEachTool);if(k(r)||!r.interactive)break;r.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:e.native.shiftKey}),i();break}case"double-click":{const s=Ln(e),n=this._intersect(s,e.pointerType,t.forEachTool),r=this._findManipulatorByKey(n,t.forEachTool);if(k(r)||!r.interactive)break;r.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:e.native.shiftKey,stopPropagation:i});break}case"immediate-double-click":{const s=Ln(e),n=this._intersect(s,e.pointerType,t.forEachTool),r=this._findManipulatorByKey(n,t.forEachTool);if(k(r)||!r.interactive)break;r.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:e.native.shiftKey,stopPropagation:i});break}}this._updateCursor(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",screenPoint:Ln(i)}),this._grabbedManipulators.forEach((({key:i},s)=>{i.tool===t&&t.manipulators.findById(i.manipulatorId)===e&&this._grabbedManipulators.delete(s)}))}_handlePointerEnd(e,t){const i=de(this._grabbedManipulators.get(e.pointerId),(({key:e})=>e)),s=this._findManipulatorByKey(i,t.forEachTool);if(O(s)&&!s.dragging){const n=O(t.creatingTool)&&t.creatingTool===he(i).tool;1!==this._grabbedManipulators.size||0!==this._draggedManipulators.size||n||(t.setActiveTool(this._revertToActiveTool),this._revertToActiveTool=null),s.grabbing&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",screenPoint:Ln(e)})),this._grabbedManipulators.delete(e.pointerId)}}_cursorFromMap(e,t){let i=null;return qt(e,(({key:e})=>{const s=this._findManipulatorByKey(e,t);return!!(O(s)&&s.interactive&&"cursor"in s&&s.cursor)&&(i=s.cursor,!0)})),i}_updateCursor(e){this._cursor=this._grabbedManipulators.size>0?this._cursorFromMap(this._grabbedManipulators,e)||"grabbing":this._hoveredManipulators.size>0?this._cursorFromMap(this._hoveredManipulators,e)||"pointer":null}clearPointers(e,t,i=!0,s){const n=t=>t.tool===e&&(k(s)||t.manipulatorId===s);this._grabbedManipulators.forEach((({key:e},i)=>{if(n(e)){this._grabbedManipulators.delete(i);const s=this._findManipulatorByKey(e,t);O(s)&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",screenPoint:null}))}})),this._draggedManipulators.forEach((({key:e},i)=>{if(n(e)){this._draggedManipulators.delete(i);const s=this._findManipulatorByKey(e,t);O(s)&&(s.dragging=!1,s.events.emit("drag",{action:"cancel"}))}})),i&&this._hoveredManipulators.forEach((({key:e},i)=>{if(n(e)){this._hoveredManipulators.delete(i);const s=this._findManipulatorByKey(e,t);O(s)&&(s.hovering=!1)}})),this._updateCursor(t)}_intersect(e,t,i){let s=null;return i((i=>{if(null==i.manipulators||!Cn(i))return!1;const n=i.manipulators.intersect(e,t);return!k(n)&&(s={manipulatorId:n,tool:i},!0)})),s}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(j(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!Pn(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(Ln(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,i,s){const n=this._intersect(e,i,s);let r=this._findManipulatorByKey(n,s);const a=de(this._hoveredManipulators.get(t),(({key:e})=>e)),o=this._findManipulatorByKey(a,s);O(r)&&!r.interactive&&(r=null),o!==r&&(O(o)&&(o.hovering=!1),O(r)?(r.hovering=!0,this._hoveredManipulators.set(t,{key:he(n)})):this._hoveredManipulators.delete(t),this._updateCursor(s))}_findManipulatorByKey(e,t){return this._findToolAndManipulatorByKey(e,t,Sn)?Sn.manipulator:null}_findToolAndManipulatorByKey(e,t,i){return k(e)?null:(i.tool=null,i.manipulator=null,t((t=>{if(t!==e.tool||null==t.manipulators||!Cn(t))return!1;const s=t.manipulators.findById(e.manipulatorId);return!!O(s)&&(i.manipulator=s,i.tool=t,!0)})),i.manipulator?i:null)}}const Rn=n.getLogger("esri.views.ToolViewManager");let Dn=class extends M{constructor(e){super(e),this._handles=new Ve,this._creatingTool=null,this._manipulatorState=new Vn,this.tools=function(){const e=new o;return e.on("after-add",(e=>{const t=e.item;t.view&&t.view.ready&&t.attach()})),e.on("after-remove",(e=>{const t=e.item;An(t,!1),t.destroyed||t.detach()})),e}(),this.cursor=null,this._forEachTool=e=>{if(!O(this._creatingTool)||!e(this._creatingTool))for(const t of this.tools.items)if(e(t))return}}initialize(){this._handles.add([this.view.on(fi,(e=>{this._handleInputEvent(e)}),pi.TOOL),this.tools.on("before-add",(e=>{const t=e.item;null==t||this.tools.includes(t)?e.preventDefault():null==t.created||t.created||(Rn.error("tools","Tool can not be added to view before it has been created"),e.preventDefault())})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((e=>e.destroy())),this._handles.destroy(),this._handles=null}set activeTool(e){!O(e)||this.view.ready?(function(e,t,i){const s=e.activeTool;t!==s&&(O(s)&&s.deactivate&&s.deactivate(),i(t),O(t)&&t.activate&&t.activate())}(this,e,(t=>{this._set("activeTool",t),this._removeIncompleteTools(e),this._forEachTool((e=>{const t=k(this.activeTool)||e===this.activeTool;e.setEditableFlag&&e.setEditableFlag(1,t);const i=Cn(e);!k(this.activeTool)&&i||this._manipulatorState.clearPointers(e,this._forEachTool,!i)})),this._updateCursor()})),this._creatingTool!==e&&this._rejectCreatingTool()):Rn.error("#activeTool=","cannot set active tool while view is not ready")}async createTool(e,t,i){await this.view.whenReady();const s="Tool creation was interrupted by another tool being created";if(pe(i))throw fe(s);const n=new e({...En(t),view:this.view}),r=E(i,(()=>this.activeTool=null));return this._rejectCreatingTool(s),this._creatingTool=n,n.attach(),this._refreshToolWatchers(),An(n,!0),await n.when(),O(r)&&r.remove(),this._creatingTool=null,this.tools.add(n),n instanceof M&&null!=n.completed&&He(n,"completed").then((()=>{An(n,!1)})),n}attach(){this._forEachTool((e=>e.attach())),"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",(()=>{this.forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(e=>{this.forEachManipulator((t=>{null!=t.onElevationChange&&t.onElevationChange(e)}))}))],"manipulators"):this._handles.add(this.view.watch("extent",(()=>{this.forEachManipulator((e=>{null!=e.onViewChange&&e.onViewChange()}))})))}detach(){this.activeTool=null,this._forEachTool((e=>{e.detach(),e.destroy()})),this.tools.removeAll(),this._handles.remove("manipulators")}forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};O(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&!1!==e.visible&&e.handleInputEvent&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},creatingTool:this._creatingTool,view:this.view}),!t&&O(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this._handles.remove("tools"),this._forEachTool((e=>{if(e instanceof M){const t=ze(e,["cursor","visible","editable"],(()=>{Cn(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()}));this._handles.add(t,"tools")}e.manipulators&&this._handles.add(e.manipulators.on("change",(t=>{t.removed.forEach((({id:t})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,t)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),"tools")})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let e=null;this._forEachTool((t=>null!=t.cursor&&!1!==t.visible&&(e=t.cursor,!0))),e||(e=this._manipulatorState.cursor),this._get("cursor")!==e&&this._set("cursor",e)}_rejectCreatingTool(e){const t=this._creatingTool;k(t)||(this._manipulatorState.clearPointers(t,this._forEachTool),t.rejectCreation&&t.rejectCreation(fe(e)),t.destroy(),this._creatingTool=null,this._refreshToolWatchers())}_removeIncompleteTools(e){this.tools.filter((t=>(k(e)||t!==e)&&null!=t.completed&&!t.completed)).forEach((e=>{this.tools.remove(e)}))}};e([f({constructOnly:!0,nonNullable:!0})],Dn.prototype,"view",void 0),e([f({value:null})],Dn.prototype,"activeTool",null),e([f({readOnly:!0,type:o})],Dn.prototype,"tools",void 0),e([f({readOnly:!0})],Dn.prototype,"cursor",void 0),Dn=e([i("esri.views.ToolViewManager")],Dn);var zn=Dn;let Un=class extends M{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",this._detectedDeviceType="standard"===e.mapping?"standard":Bn.test(e.id)?"spacemouse":"unknown",this.nativeIndex=e.index}get native(){return(navigator.getGamepads?navigator.getGamepads():[])[this.nativeIndex]}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return Hn[this.deviceType]}};e([f({nonNullable:!0,readOnly:!0})],Un.prototype,"nativeIndex",void 0),e([f({type:String,readOnly:!0})],Un.prototype,"deviceType",null),e([f({type:Number,readOnly:!0})],Un.prototype,"axisThreshold",null),Un=e([i("esri.views.input.gamepad.GamepadInputDevice")],Un);const Bn=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),Hn={standard:.15,spacemouse:.025,unknown:0};var Wn=Un;let qn=class extends M{constructor(...e){super(...e),this.devices=new o,this.enabledFocusMode="document"}};e([f({type:o.ofType(Wn),readOnly:!0})],qn.prototype,"devices",void 0),e([f({type:["document","view","none"]})],qn.prototype,"enabledFocusMode",void 0),qn=e([i("esri.views.input.gamepad.GamepadSettings")],qn);var Gn=qn;let Kn=class extends M{constructor(){super(...arguments),this.gamepad=new Gn}};e([f({readOnly:!0})],Kn.prototype,"gamepad",void 0),Kn=e([i("esri.views.input.Input")],Kn);var Jn=Kn;let Yn=class extends M{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};e([f({type:Boolean,nonNullable:!0})],Yn.prototype,"enabled",void 0),e([f({type:Wn})],Yn.prototype,"device",void 0),e([f({type:["pan","zoom"],nonNullable:!0})],Yn.prototype,"mode",void 0),e([f({type:["forward-down","forward-up"],nonNullable:!0})],Yn.prototype,"tiltDirection",void 0),e([f({type:Number,nonNullable:!0})],Yn.prototype,"velocityFactor",void 0),Yn=e([i("esri.views.navigation.gamepad.GamepadSettings")],Yn);var Xn=Yn;let Qn=class extends M{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new Xn,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};e([f({type:Boolean})],Qn.prototype,"browserTouchPanEnabled",void 0),e([f({type:Xn,nonNullable:!0})],Qn.prototype,"gamepad",void 0),e([f({type:Boolean})],Qn.prototype,"momentumEnabled",void 0),e([f({type:Boolean})],Qn.prototype,"mouseWheelZoomEnabled",void 0),Qn=e([i("esri.views.navigation.Navigation")],Qn);var Zn=Qn;function er(e){return"heightModelInfo"in e}function tr(e){if("unknown"===e.type||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"ogc-feature":return!0;case"imagery":case"map-image":case"map-notes":case"tile":case"vector-tile":case"scene":case null:default:return!1}}function ir(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":case null:return!1}return!1}const sr=new Qe({heightModel:"gravity-related-height"});var nr;const rr=n.getLogger("esri.views.support.DefaultsFromMap");let ar=nr=class extends M{constructor(){super(...arguments),this._handles=new Ve,this._waitTask=null,this._extentProjectController=null,this._spatialReferenceCandidates=null,this._extentCandidates=null,this.logDebugInformation=!1,this.isSpatialReferenceDone=!1,this.isTileInfoDone=!1,this.isHeightModelInfoSearching=!1,this.spatialReference=null,this.extent=null,this.heightModelInfo=null,this.vcsWkid=null,this.latestVcsWkid=null,this.mapCollectionPaths=nr.DefaultMapCollectionPaths.slice(),this.tileInfo=null}initialize(){this.watch("mapCollectionPaths",(()=>{this._running&&(this.reset(),this.start())}))}destroy(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null),this._cancelLoading()}get _running(){return!!(this._handles&&this._handles.size>0)}reset(){this._handles.removeAll(),this._set("isSpatialReferenceDone",!1),this._set("isTileInfoDone",!1),this._set("isHeightModelInfoSearching",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("vcsWkid",null),this._set("latestVcsWkid",null),this._set("tileInfo",null),this._spatialReferenceCandidates=null,this._extentCandidates=null}start(){this._handles.removeAll();const e=this._updateLayerChange.bind(this);for(const t of this.mapCollectionPaths)this._handles.add(De(this.view,`map.${t}`,"change",e,e,e,!0));this._handles.add(We(this,"isSpatialReferenceDone",(()=>this._updateTileInfo()),!0))}_ownerNameFromCollectionName(e){const t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)}_ensureLoadedOwnersFromCollectionName(e){const t=this._ownerNameFromCollectionName(e).split(".");let i;for(let s=0;s<t.length&&(i=this.get(t.slice(0,s+1).join(".")),i);s++)if(i.load&&!i.isFulfilled())return{collectionName:e,owner:null,loading:i.load().catch((()=>{}))};return{collectionName:e,owner:i}}_cancelLoading(){this._waitTask=null,this._extentProjectController&&(this._extentProjectController.abort(),this._extentProjectController=null)}_updateWhen(e){let t=!0,i=!1;const s=e.catch((()=>{})).then((()=>{t?i=!0:s===this._waitTask&&this._update()}));return t=!1,i||(this._waitTask=s),i}_updateLayerChange(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()}_update(){if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog("Starting search for spatial reference...");const e=this._processMapCollections((e=>this._processSpatialReferenceSource(e)));if(this._debugLog(`Search ended with status '${lr(e)}'`),0!==e){let e=null,t=this._spatialReferenceCandidates;if(!t||t.length<1?(e=this.defaultSpatialReference,this._debugLog(`No spatial reference found, locking to default (${or(e)})`)):(this.defaultSpatialReference&&t.length>1&&t.findIndex((e=>e.equals(this.defaultSpatialReference)))>-1&&(t=[this.defaultSpatialReference]),e=t[0],this._debugLog(`Locking to ${or(e)}`)),this._set("spatialReference",e),e)if(this.extent)this._set("isSpatialReferenceDone",!0);else{const t=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections((t=>this._findExtent(t,e))),this.logDebugInformation=t,this._projectExtentCandidate().catch((()=>{})).then((()=>this._set("isSpatialReferenceDone",!0)))}else this._set("isSpatialReferenceDone",!0)}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog("Starting search for height model info...");const e=this._processMapCollections((e=>this._processHeightModelInfoSource(e)),(e=>function(e){return null!=e.layers||ir(e)||tr(e)||er(e)}(e)));this._debugLog(`Search ended with status ${lr(e)}`),this._set("isHeightModelInfoSearching",0===e)}this._updateTileInfo()}}_processMapCollections(e,t){this._preloadMapCollections(t);let i=2;return this._forAllMapCollectionSources((e=>{if(2!==i)return!1;const{collectionName:t}=e;return this._debugLog(`Processing collection ${t}...`),!(e.loading&&!this._updateWhen(e.loading)&&(this._debugLog(`Collection ${e.collectionName} owner is loading -> wait`),i=0,1))}),(s=>!(2!==i||(null==t||t(s)?!s.load||s.isFulfilled()||this._updateWhen(s.load())?(!s.load||s.isResolved())&&e(s)&&(i=1,1):(this._debugLog(`Source ${s.id} is loading -> wait`),i=0,1):(this._debugLog(`Source ${s.id} is skipped due to predicate`),1))))),i}_preloadMapCollections(e){let t=10;const i=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources((()=>!0),(s=>0!==t&&!(null!=e&&!e(s)||(s.load&&!s.isFulfilled()&&(this.logDebugInformation=i,this._debugLog(`Pre-loading source ${s.id}`),this.logDebugInformation=!1,s.load().catch((()=>{})),t--),0)))),this.logDebugInformation=i}_forAllMapCollectionSources(e,t){for(const i of this.mapCollectionPaths){const s=`map.${i}`,n=this._ensureLoadedOwnersFromCollectionName(s);if(!1===e(n))continue;const r=n.owner;if(!r||r.isRejected&&r.isRejected()){this._debugLog(`Collection ${s} owner is invalid or rejected -> skip`);continue}const a=this.view.get(s);a?this._forEachSource(a,t):this._debugLog(`Collection ${s} does not exist -> skip`)}}_forEachSource(e,t){for(const i of e.items)!1!==t(i)&&"layers"in i&&i.layers&&this._forEachSource(i.layers,t)}_processSpatialReferenceSource(e){let t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=me(t,this._spatialReferenceCandidates,((e,t)=>e.equals(t))),t.length>0?this._spatialReferenceCandidates=t:this._debugLog(`Layer ${e.id} is ignored because its supported spatial\n          references are not compatible with the previous candidates`)):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)}_findExtent(e,t){const i="fullExtents"in e&&e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),s=i.find((e=>e.spatialReference.equals(t)));if(s)return this._set("extent",s),!0;if(this._getSupportedSpatialReferences(e).length>0){const t=i.map((t=>({extent:t,layer:e})));this._extentCandidates=(this._extentCandidates||[]).concat(t)}return!1}async _projectExtentCandidate(){if(!this._extentCandidates||!this._extentCandidates.length)return;const e=this.spatialReference,t=this._extentCandidates.find((t=>ve(t.extent.spatialReference,e)));if(t)this._set("extent",ge(t.extent,e));else{const t=this._extentCandidates[0];this._extentProjectController=C();const i=await import("./p-25ba4726.js");try{const s=await i.projectGeometry(t.extent,e,t.layer.portalItem,this._extentProjectController.signal);this._set("extent",s)}catch{}this._extentProjectController=null}}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return this._debugLog(`Layer ${e.id} is ignored because it does not have any spatial references`),[];const i=t.filter((t=>this.view.isSpatialReferenceSupported(t,e,(e=>this._debugLog(e)))));return this._debugLog(0===i.length?`Layer ${e.id} has spatial references but none of them are supported (or layer doesn't require locking)`:`Layer ${e.id} has spatial references. Resulting candidate set: ${i.map(or).join(", ")}`),i}_processHeightModelInfoSource(e){const t=function(e){const t=e.url&&st(e.url);return null==(e.spatialReference&&e.spatialReference.vcsWkid)&&O(t)&&"ImageServer"===t.serverType||!er(e)||!e.heightModelInfo?function(e){return tr(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):ir(e)}(e)?Qe.deriveUnitFromSR(sr,e.spatialReference):null:e.heightModelInfo}(e);return!!t&&(this._set("heightModelInfo",t),this._set("isHeightModelInfoSearching",!1),e.spatialReference&&(this._set("vcsWkid",e.spatialReference.vcsWkid),this._set("latestVcsWkid",e.spatialReference.latestVcsWkid)),!0)}_updateTileInfo(){if(null!=this.tileInfo)return;if(!this.view.isTileInfoRequired())return void this._set("isTileInfoDone",!0);if(!this.isSpatialReferenceDone)return;const e=this.get("view.map");if(!e)return void this._debugLog("updateTileInfo: no map");const t=e.basemap,i=e.get("layers.0");let s=null;if(t&&"failed"!==t.loadStatus){if(!t.loaded)return this._updateWhen(t.load()),void this._debugLog("updateTileInfo: basemap still loading");const e=t&&t.get("baseLayers.0");if(e&&"failed"!==e.loadStatus){if(!e.loaded)return this._updateWhen(e.load()),void this._debugLog("updateTileInfo: first basemap layer still loading");s="tileInfo"in e&&e.tileInfo}else{if(!i||"failed"===i.loadStatus)return this._debugLog("updateTileInfo: no tileInfo"),void this._set("isTileInfoDone",!0);if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");s="tileInfo"in i&&i.tileInfo}}else if(i&&"failed"!==i.loadStatus){if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");s="tileInfo"in i&&i.tileInfo}s&&!s.spatialReference.equals(this.spatialReference)&&(s=null),this._debugLog(`updateTileInfo: setting ${s}`),this._set("tileInfo",s),this._set("isTileInfoDone",!0)}_debugLog(e){this.logDebugInformation&&rr.info(e)}};function or(e){return e?JSON.stringify(e.toJSON()):"undefined"}function lr(e){switch(e){case 0:return"Waiting";case 1:return"Found";case 2:return"Exhausted"}}ar.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],e([f()],ar.prototype,"logDebugInformation",void 0),e([f({readOnly:!0})],ar.prototype,"isSpatialReferenceDone",void 0),e([f({readOnly:!0})],ar.prototype,"isTileInfoDone",void 0),e([f({readOnly:!0})],ar.prototype,"isHeightModelInfoSearching",void 0),e([f({constructOnly:!0})],ar.prototype,"view",void 0),e([f({readOnly:!0})],ar.prototype,"spatialReference",void 0),e([f({readOnly:!0})],ar.prototype,"extent",void 0),e([f({readOnly:!0})],ar.prototype,"heightModelInfo",void 0),e([f({readOnly:!0})],ar.prototype,"vcsWkid",void 0),e([f({readOnly:!0})],ar.prototype,"latestVcsWkid",void 0),e([f()],ar.prototype,"mapCollectionPaths",void 0),e([f()],ar.prototype,"defaultSpatialReference",void 0),e([f({readOnly:!0})],ar.prototype,"tileInfo",void 0),ar=nr=e([i("esri.views.support.DefaultsFromMap")],ar);var hr,cr=ar;const ur=n.getLogger("esri.views.View");let dr=hr=class extends(yt(_.EventedMixin(ye(M)))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new Ft({root:this,rootCollectionNames:["basemapView.baseLayerViews","groundView?.layerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:e=>e.layerViews}),this.animation=null,this.basemapView=null,this.defaultsFromMap=new cr({view:this}),this.fatalError=null,this.extent=null,this.graphics=new At,this.navigating=!1,this.layerViews=new o,this.magnifier=new Qt,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.renderContext=null,this.input=new Jn,this.navigation=new Zn,this.layerViewManager=null,this.refreshManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new gi(this),this.persistableViewModels=new o,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",(e=>{e?(this._currentSpatialReference=this.spatialReference,hr.views.add(this)):(this._currentSpatialReference=null,hr.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.layerViewManager.clear(),this.toolViewManager.detach(),this._teardown()):e&&!this.ready&&(this._startup(),this.toolViewManager.attach())}),!0))}initialize(){let e;this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,He(this,"ready"))))),this.basemapView=new Wt({view:this}),this.layerViewManager=new Yt({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.refreshManager=new ti({view:this}),this.toolViewManager=new zn({view:this}),this._resetInitialViewPropertiesFromContent(),Re(this.defaultsFromMap,"isSpatialReferenceDone",(t=>{const i=!!(this.map&&this.map.allLayers.length>0);if(t&&!this.spatialReference&&i||!e){if(t&&!this.spatialReference&&i&&!e){const t=e=ne(this.spatialReferenceWarningDelay);e.then((()=>{t===e&&ur.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})).catch((()=>{}))}}else e=null}),!0)}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics.destroy(),this.graphics=null,this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager.destroy(),this.toolViewManager=null,this.refreshManager.destroy(),this.refreshManager=null,this.layerViewManager.destroy(),this.layerViewManager=null,this.basemapView.destroy(),this.basemapView=null,this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,null==e||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return c()}toMap(){return ur.error("#toMap()","Not implemented on this instance of View"),null}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){return!!(!this.fatalError&&this._isValid&&!this._readyCycleForced&&this.map&&(!a.isLoadable(this.map)||this.map.loaded)&&0!==this.width&&0!==this.height&&this.spatialReference&&this.isSpatialReferenceSupported(this.spatialReference)&&(this._currentSpatialReference||!this.initialExtentRequired||this.initialExtent||this.defaultsFromMap&&this.defaultsFromMap.isSpatialReferenceDone)&&this.defaultsFromMap&&this.defaultsFromMap.isTileInfoDone)}set map(e){var t;e!==this._get("map")&&(null!=(t=e)&&t.destroyed&&(ur.warn("#map","The provided map is already destroyed",{map:e}),e=null),a.isLoadable(e)&&e.load().catch((()=>{})),this.initialized&&(this.forceReadyCycle(),this._resetInitialViewPropertiesFromContent()),this._set("map",e))}get spatialReference(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.isHeightModelInfoRequired&&this.defaultsFromMap&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){this._userSpatialReference=e,this._set("spatialReference",e)}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){return this.defaultsFromMap&&this.defaultsFromMap.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return O(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getDefaultSpatialReference(){return this.get("defaultsFromMap.spatialReference")}getDefaultHeightModelInfo(){return this.get("map.supportsHeightModelInfo")&&this.get("map.heightModelInfo")||this.get("defaultsFromMap.heightModelInfo")||null}importLayerView(e){throw new h("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}isSpatialReferenceSupported(e,t,i){return!0}isTileInfoRequired(){return!1}when(e,t){return this.isResolved()&&!this.ready&&ur.warn("#when()",'Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use watchUtils.whenOnce(view, "ready").then(...) instead.'),super.when(e,t)}forceReadyCycle(){this.ready&&(this._readyCycleForced=!0,qe(this,"preconditionsReady",(()=>this._readyCycleForced=!1)))}createTool(e,t,i){return this.toolViewManager.createTool(e,t,i)}tryFatalErrorRecovery(){this.fatalError=null}_resetInitialViewPropertiesFromContent(){if(!this.defaultsFromMap)return;const e=()=>this.defaultsFromMap&&this.defaultsFromMap.start();this.defaultsFromMap.reset(),this._currentSpatialReference=null,this.notifyChange("spatialReference"),this.handles.remove("defaultsFromMap"),this.handles.add([ze(this,"spatialReference",((t,i)=>{be(t,i)||e()})),ze(this,"initialExtentRequired",e),F(e)],"defaultsFromMap")}};dr.views=new o,e([q("toolViewManager.activeTool")],dr.prototype,"activeTool",void 0),e([f({readOnly:!0})],dr.prototype,"allLayerViews",void 0),e([f()],dr.prototype,"animation",void 0),e([f()],dr.prototype,"basemapView",void 0),e([f()],dr.prototype,"defaultsFromMap",void 0),e([f()],dr.prototype,"fatalError",void 0),e([f({type:we})],dr.prototype,"extent",void 0),e([f(Ct())],dr.prototype,"graphics",void 0),e([f({readOnly:!0,type:Qe,dependsOn:["map.heightModelInfo?","defaultsFromMap.heightModelInfo"],autoTracked:!1})],dr.prototype,"heightModelInfo",null),e([f({readOnly:!0,dependsOn:["navigating"]})],dr.prototype,"interacting",null),e([f({readOnly:!0})],dr.prototype,"navigating",void 0),e([f({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","initialExtentRequired","initialExtent","defaultsFromMap.isSpatialReferenceDone","defaultsFromMap.isTileInfoDone"],autoTracked:!1})],dr.prototype,"preconditionsReady",null),e([f({type:o,readOnly:!0})],dr.prototype,"layerViews",void 0),e([f({type:Qt})],dr.prototype,"magnifier",void 0),e([f({value:null,type:Ht})],dr.prototype,"map",null),e([f()],dr.prototype,"padding",void 0),e([f({readOnly:!0})],dr.prototype,"ready",void 0),e([f({type:_e,dependsOn:["defaultsFromMap.spatialReference","defaultsFromMap.vcsWkid","defaultsFromMap.latestVcsWkid"]})],dr.prototype,"spatialReference",null),e([f()],dr.prototype,"spatialReferenceWarningDelay",void 0),e([f({dependsOn:["animation","navigating","resizing"]})],dr.prototype,"stationary",null),e([f({readOnly:!0})],dr.prototype,"supportsGround",void 0),e([f({type:Ze})],dr.prototype,"timeExtent",void 0),e([q("toolViewManager.tools")],dr.prototype,"tools",void 0),e([f()],dr.prototype,"toolViewManager",void 0),e([f({readOnly:!0})],dr.prototype,"type",void 0),e([f({type:Number})],dr.prototype,"scale",void 0),e([f({readOnly:!0})],dr.prototype,"updating",void 0),e([f({readOnly:!0})],dr.prototype,"initialExtentRequired",void 0),e([f({readOnly:!0,type:we,dependsOn:["defaultsFromMap.extent"]})],dr.prototype,"initialExtent",null),e([f({dependsOn:["toolViewManager.cursor"]})],dr.prototype,"cursor",null),e([f()],dr.prototype,"renderContext",void 0),e([f({readOnly:!0})],dr.prototype,"input",void 0),e([f({type:Zn,nonNullable:!0})],dr.prototype,"navigation",void 0),e([f()],dr.prototype,"layerViewManager",void 0),e([f()],dr.prototype,"width",void 0),e([f()],dr.prototype,"height",void 0),e([f({readOnly:!0})],dr.prototype,"resizing",void 0),e([f({value:null,dependsOn:["width","height"],readOnly:!0})],dr.prototype,"size",null),e([f({readOnly:!0})],dr.prototype,"suspended",void 0),e([f({readOnly:!0})],dr.prototype,"viewEvents",void 0),e([f({readOnly:!0})],dr.prototype,"persistableViewModels",void 0),e([f()],dr.prototype,"_isValid",void 0),e([f()],dr.prototype,"_readyCycleForced",void 0),e([f()],dr.prototype,"_currentSpatialReference",void 0),dr=hr=e([i("esri.views.View")],dr);var pr=dr;const fr={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"};let mr=class extends(yt(M)){constructor(){super(...arguments),this._scale=null,this.view=null}destroy(){this.layer=this.view=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;const e=this.visibleSublayers.map((e=>e.toExportImageJSON()));return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&_t(this.visibleSublayers,this.layer.serviceSublayers,this.layer)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.handles.remove("layer"),e&&this.handles.add([e.allSublayers.on("change",(()=>this.notifyChange("visibleSublayers"))),e.on("sublayer-update",(e=>this.notifyChange(fr[e.propertyName])))],"layer"))}get layers(){const e=this.visibleSublayers;return e?e.length?"show:"+e.map((e=>e.id)).join(","):"show:-1":null}get layerDefs(){const e=this.visibleSublayers.filter((e=>null!=e.definitionExpression));return e.length?JSON.stringify(e.reduce(((e,t)=>(e[t.id]=t.definitionExpression,e)),{})):null}get scale(){return null!=this._scale?this._scale:this.view&&this.view.scale||0}set scale(e){this.view||(this._scale=e,this.notifyChange("scale"))}get version(){return(this._get("version")||0)+1}set version(e){this._set("version",e)}get visibleSublayers(){const e=[];if(!this.layer)return e;const t=this.layer.sublayers,i=t=>{const s=this.scale;t.visible&&(0===s||(0===t.minScale||s<=t.minScale)&&(0===t.maxScale||s>=t.maxScale))&&(t.sublayers?t.sublayers.forEach(i):e.unshift(t))};t&&t.forEach(i);const s=this._get("visibleSublayers");return!s||s.length!==e.length||s.some(((t,i)=>e[i]!==t))?e:s}toJSON(){const e=this.layer;let t={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?t.dynamicLayers=this.dynamicLayers:t={...t,layers:this.layers,layerDefs:this.layerDefs},t}};e([f({readOnly:!0,dependsOn:["hasDynamicLayers","visibleSublayers"]})],mr.prototype,"dynamicLayers",null),e([f({readOnly:!0,dependsOn:["visibleSublayers","layer.serviceSublayers","layer.capabilities"]})],mr.prototype,"hasDynamicLayers",null),e([f()],mr.prototype,"layer",null),e([f({readOnly:!0,dependsOn:["visibleSublayers"]})],mr.prototype,"layers",null),e([f({readOnly:!0,dependsOn:["visibleSublayers"]})],mr.prototype,"layerDefs",null),e([f({type:Number,dependsOn:["view.scale"]})],mr.prototype,"scale",null),e([f(et)],mr.prototype,"timeExtent",void 0),e([f({dependsOn:["layers","layerDefs","dynamicLayers","layer.dpi","layer.imageFormat","layer.imageTransparency","layer.gdbVersion","timeExtent"]})],mr.prototype,"version",null),e([f({type:pr})],mr.prototype,"view",void 0),e([f({readOnly:!0,dependsOn:["layer.sublayers","scale"]})],mr.prototype,"visibleSublayers",null),mr=e([i("esri.layers.mixins.ExportImageParameters")],mr);let vr=class extends(lt(dt(ut(ct(Mt(It(nt(tt(rt(Xe(ht(yt(Ye))))))))))))){constructor(...e){super(...e),this.alwaysRefetch=!1,this.dpi=96,this.gdbVersion=null,this.imageFormat="png24",this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.labelsVisible=!1,this.isReference=null,this.operationalLayerType="ArcGISMapServiceLayer",this.sourceJSON=null,this.sublayers=null,this.type="map-image",this.url=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=O(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).then((()=>this._fetchService(t)),(()=>this._fetchService(t)))),c(this)}readImageFormat(e,t){const i=t.supportedImageFormatTypes;return i&&i.indexOf("PNG32")>-1?"png32":"png24"}writeSublayers(e,t,i,s){if(!this.loaded||!e)return;const n=e.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).toArray();let r=!1;if(this.capabilities&&this.capabilities.operations.supportsExportMap&&this.capabilities.exportMap.supportsDynamicLayers){const e=Ie(s.origin);if(3===e){const e=this.createSublayersForOrigin("service").sublayers;r=kt(n,e,2)}else if(e>3){const e=this.createSublayersForOrigin("portal-item");r=kt(n,e.sublayers,Ie(e.origin))}}const a=[],o={writeSublayerStructure:r,...s};let l=r;n.forEach((e=>{const t=e.write({},o);a.push(t),l=l||"user"===e.originOf("visible")})),a.some((e=>Object.keys(e).length>1))&&(t.layers=a),l&&(t.visibleLayers=n.filter((e=>e.visible)).map((e=>e.id)))}createExportImageParameters(e,t,i,s){const n=s&&s.pixelRatio||1;e&&this.version>=10&&(e=e.clone().shiftCentralMeridian());const r=new mr({layer:this,scale:wt({extent:e,width:t})*n}),a=r.toJSON();r.destroy();const o=!s||!s.rotation||this.version<10.3?{}:{rotation:-s.rotation},l=e&&e.spatialReference,h=l.wkid||JSON.stringify(l.toJSON());a.dpi*=n;const c={};if(null!=s&&s.timeExtent){const{start:e,end:t}=s.timeExtent.toJSON();c.time=e&&t&&e===t?""+e:`${null==e?"null":e},${null==t?"null":t}`}else this.timeInfo&&!this.timeInfo.hasLiveData&&(c.time="null,null");return{bbox:e&&e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:h,imageSR:h,size:t+","+i,...a,...o,...c}}async fetchImage(e,t,i,s){const n={responseType:"image"};s&&s.timestamp&&(n.query={...n.query,_ts:s.timestamp}),s&&s.signal&&(n.signal=s.signal),this.customParameters&&Object.keys(this.customParameters).length&&(n.query={...this.customParameters,...n.query});const r=this.parsedUrl.path+"/export",a={...this.parsedUrl.query,...this.createExportImageParameters(e,t,i,s),f:"image",_ts:this.alwaysRefetch?Date.now():null};return null==a.dynamicLayers||this.capabilities.exportMap.supportsDynamicLayers?(n.query=n.query?{...a,...n.query}:a,J(r,n).then((e=>e.data)).catch((e=>{if(A(e))throw e;throw new h("mapimagelayer:image-fetch-error",`Unable to load image: ${r}`,{error:e})}))):T(new h("mapimagelayer:dynamiclayer-not-supported",`service ${this.url} doesn't support dynamic layers, which is required to be able to change the sublayer's order, rendering, labeling or source.`,{query:a}))}async fetchRecomputedExtents(e={}){const t={...e,query:{returnUpdates:!0,f:"json"}},{data:i}=await J(this.url,t),{extent:s,fullExtent:n,timeExtent:r}=i,a=s||n;return{fullExtent:a&&we.fromJSON(a),timeExtent:r&&Ze.fromJSON({start:r[0],end:r[1]})}}loadAll(){return Ge(this,(e=>{e(this.allSublayers)}))}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:t,ssl:i}=await J(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:e});i&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=t,this.read(t,{origin:"service",url:this.parsedUrl})}};e([f()],vr.prototype,"alwaysRefetch",void 0),e([f()],vr.prototype,"dpi",void 0),e([f()],vr.prototype,"gdbVersion",void 0),e([f({json:{read:!1,write:!1}})],vr.prototype,"popupEnabled",void 0),e([f()],vr.prototype,"imageFormat",void 0),e([Me("imageFormat",["supportedImageFormatTypes"])],vr.prototype,"readImageFormat",null),e([f({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],vr.prototype,"imageMaxHeight",void 0),e([f({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],vr.prototype,"imageMaxWidth",void 0),e([f()],vr.prototype,"imageTransparency",void 0),e([f({json:{read:!1,write:!1}})],vr.prototype,"labelsVisible",void 0),e([f({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],vr.prototype,"isReference",void 0),e([f({type:["ArcGISMapServiceLayer"]})],vr.prototype,"operationalLayerType",void 0),e([f()],vr.prototype,"sourceJSON",void 0),e([f({json:{write:{ignoreOrigin:!0}}})],vr.prototype,"sublayers",void 0),e([m("sublayers",{layers:{type:[xt]},visibleLayers:{type:[v]}})],vr.prototype,"writeSublayers",null),e([f({type:["show","hide","hide-children"]})],vr.prototype,"listMode",void 0),e([f({json:{read:!1},readOnly:!0,value:"map-image"})],vr.prototype,"type",void 0),e([f(it)],vr.prototype,"url",void 0),vr=e([i("esri.layers.MapImageLayer")],vr);var gr=vr;export default gr;