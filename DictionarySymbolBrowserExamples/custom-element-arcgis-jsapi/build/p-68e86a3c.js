import"./p-476cf7c4.js";import{d1 as t,d2 as n,d3 as r,d4 as e,d5 as o,cH as s}from"./p-ab028778.js";import{n as a}from"./p-abda1e64.js";import{u as i,j as c,c as l,_ as f,o as u,r as d,z as w,q as p}from"./p-a8e713de.js";import{A as g,f as h,u as m,a as y,p as A,c as v,o as U,i as I,m as M,T as b,d as j,b as F,l as S,h as k,e as x,O as z,x as D,g as E,w as N,E as L,L as _,F as P,I as q,U as B,j as H,V as W,M as $,S as C,k as G,q as O,v as T,z as J,B as K,C as Q,D as R,G as V,H as X}from"./p-a8cda886.js";import{w as Y}from"./p-fa359158.js";import"./p-749423b3.js";function Z(n,r,e){const o=n.byteLength/(4*r),s=new Uint32Array(n,0,o*r);let a=new Uint32Array(o);const i=e&&e.minReduction||0,c=e&&e.originalIndices||null,l=e&&e.componentOffsets||null;let f=0;if(l)for(let t=0;t<l.length-1;t++){const n=l[t+1]-l[t];n>f&&(f=n)}else f=o;const u=Math.floor(1.1*f)+1;(null==et||et.length<2*u)&&(et=new Uint32Array(t(2*u)));for(let t=0;t<2*u;t++)et[t]=0;let d=0;const w=!!l&&!!c,p=w?c.length:o,g=w?new Uint32Array(c.length):null,h=1.96;let m=0!==i?Math.ceil(4*h*h/(i*i)*i*(1-i)):p,y=1,A=l?l[1]:p;for(let t=0;t<p;t++){if(t===m){const n=1-d/t;if(n+h*Math.sqrt(n*(1-n)/t)<i)return null;m*=2}if(t===A){for(let t=0;t<2*u;t++)et[t]=0;if(c)for(let t=l[y-1];t<l[y];t++)g[t]=a[c[t]];A=l[++y]}const n=w?c[t]:t,e=n*r,o=rt(s,e,r);let f=o%u,p=d;for(;0!==et[2*f+1];){if(et[2*f]===o){const t=et[2*f+1]-1;if(tt(s,e,t*r,r)){p=a[t];break}}f++,f>=u&&(f-=u)}p===d&&(et[2*f]=o,et[2*f+1]=n+1,d++),a[n]=p}if(0!==i&&1-d/o<i)return null;if(w){for(let t=l[y-1];t<g.length;t++)g[t]=a[c[t]];a=g}const v=new Uint32Array(r*d);d=0;for(let t=0;t<p;t++)a[t]===d&&(nt(s,(w?c[t]:t)*r,v,d*r,r),d++);if(c&&!w){const t=new Uint32Array(c.length);for(let n=0;n<t.length;n++)t[n]=a[c[n]];a=t}return{buffer:v.buffer,indices:a,uniqueCount:d}}function tt(t,n,r,e){for(let o=0;o<e;o++)if(t[n+o]!==t[r+o])return!1;return!0}function nt(t,n,r,e,o){for(let s=0;s<o;s++)r[e+s]=t[n+s]}function rt(t,n,r){let e=0;for(let o=0;o<r;o++)e=t[n+o]+e|0,e=e+(e<<11)+(e>>>2)|0;return e>>>0}let et=null;const ot={divisor:0};function st(t,n={}){n={...ot,...n};const r=t.stride;return t.fieldNames.filter((n=>{const r=t.fields.get(n).optional;return!(r&&r.glPadding)})).map((e=>{const o=t.fields.get(e),s=o.constructor.ElementCount,a=function(t){const n=at[t];if(n)return n;throw new Error("BufferType not supported in WebGL")}(o.constructor.ElementType);return{name:e,stride:r,count:s,type:a,offset:o.offset,normalized:!(!o.optional||!o.optional.glNormalized),divisor:n.divisor}}))}const at={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},it=g().vec3f("position").u16("componentIndex").u16("_padding"),ct=(st(g().vec2u8("sideness")),g().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("_padding",{glPadding:!0}).u16("_padding2",{glPadding:!0})),lt=ct.clone().vec3f("normal"),ft=ct.clone().vec3f("normalA").vec3f("normalB");class ut{updateSettings(t){this.settings=t}write(t,n,r){const e=function(t){const n=dt;n[0]=t.position0[0],n[1]=t.position0[1],n[2]=t.position0[2],n[3]=t.position1[0],n[4]=t.position1[1],n[5]=t.position1[2],pt[0]=5381;for(let t=0;t<wt.length;t++)pt[0]=31*pt[0]+wt[t];return pt[0]}(r);gt.seed=e;const o=gt.getIntRange(0,255),s=gt.getIntRange(0,this.settings.variants-1),a=gt.getFloat(),i=255*(.5*function(t){const n=t<0?-1:1;return Math.pow(Math.abs(t),1.2)*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7))+.5);t.position0.setVec(n,r.position0),t.position1.setVec(n,r.position1),t.componentIndex.set(n,r.componentIndex),t.variantOffset.set(n,o),t.variantStroke.set(n,s),t.variantExtension.set(n,i)}trim(t,n){return t.slice(0,n)}}const dt=new Float32Array(6),wt=new Uint32Array(dt.buffer),pt=new Uint32Array(1),gt=new n;class ht{constructor(){this.commonWriter=new ut}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return lt.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),i(yt,r.faceNormal0,r.faceNormal1),c(yt,yt),t.normal.setVec(n,yt)}trim(t,n){return this.commonWriter.trim(t,n)}}ht.Layout=lt,ht.glLayout=st(lt,{divisor:1});class mt{constructor(){this.commonWriter=new ut}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ft.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),t.normalA.setVec(n,r.faceNormal0),t.normalB.setVec(n,r.faceNormal1)}trim(t,n){return this.commonWriter.trim(t,n)}}mt.Layout=ft,mt.glLayout=st(ft,{divisor:1});const yt=a();function At(t,n){return n.push(t.buffer),{buffer:t.buffer,layout:vt(t.layout)}}function vt(t){const n=new Array;return t.fields.forEach(((t,r)=>{const e={...t,constructor:It(t.constructor)};n.push([r,e])})),{stride:t.stride,fields:n,fieldNames:t.fieldNames}}const Ut=[h,m,y,A,v,U,I,M,b,j,F,S,k,x,z,D,E,N,L,_,P,q,B,H,W,$,C,G,O,T,J,K,Q,R,V,X];function It(t){return`${t.ElementType}_${t.ElementCount}`}const Mt=new Map;function bt(t,n){const r=t.length/3,e=new Uint32Array(n+1),o=new Uint32Array(n+1),s=(t,n)=>{t<n?e[t+1]++:o[n+1]++};for(let n=0;n<r;n++){const r=t[3*n],e=t[3*n+1],o=t[3*n+2];s(r,e),s(e,o),s(o,r)}let a=0,i=0;for(let t=0;t<n;t++){const n=e[t+1],r=o[t+1];e[t+1]=a,o[t+1]=i,a+=n,i+=r}const c=new Uint32Array(6*r),l=e[n],f=(t,n,r)=>{if(t<n){const o=e[t+1]++;c[2*o]=n,c[2*o+1]=r}else{const e=o[n+1]++;c[2*l+2*e]=t,c[2*l+2*e+1]=r}};for(let n=0;n<r;n++){const r=t[3*n],e=t[3*n+1],o=t[3*n+2];f(r,e,n),f(e,o,n),f(o,r,n)}const u=(t,n)=>{const r=2*t,e=n-t;for(let t=1;t<e;t++){const n=c[r+2*t],e=c[r+2*t+1];let o=t-1;for(;o>=0&&c[r+2*o]>n;o--)c[r+2*o+2]=c[r+2*o],c[r+2*o+3]=c[r+2*o+1];c[r+2*o+2]=n,c[r+2*o+3]=e}};for(let t=0;t<n;t++)u(e[t],e[t+1]),u(l+o[t],l+o[t+1]);const d=new Int32Array(3*r),w=(n,r)=>n===t[3*r]?0:n===t[3*r+1]?1:n===t[3*r+2]?2:-1,p=(t,n)=>{const r=w(t,n);d[3*n+r]=-1},g=(t,n,r,e)=>{const o=w(t,n);d[3*n+o]=e;const s=w(r,e);d[3*e+s]=n};for(let t=0;t<n;t++){let n=e[t];const r=e[t+1];let s=o[t];const a=o[t+1];for(;n<r&&s<a;){const r=c[2*n],e=c[2*l+2*s];r===e?(g(t,c[2*n+1],e,c[2*l+2*s+1]),n++,s++):r<e?(p(t,c[2*n+1]),n++):(p(e,c[2*l+2*s+1]),s++)}for(;n<r;)p(t,c[2*n+1]),n++;for(;s<a;)p(c[2*l+2*s],c[2*l+2*s+1]),s++}return d}function jt(t,n){return t.cosAngle<n}function Ft(t,n){return t.cosAngle>n}function St(t,n){const r=o(t.cosAngle),e=kt.fwd,s=kt.ortho;return Y(e,t.position1,t.position0),r*(w(f(s,t.faceNormal0,t.faceNormal1),e)>0?-1:1)>n}Ut.forEach((t=>Mt.set(It(t),t)));const kt={edge:{position0:a(),position1:a(),faceNormal0:a(),faceNormal1:a(),componentIndex:0,cosAngle:0},ortho:a(),fwd:a()},xt={v0:a(),v1:a(),v2:a()},zt={anglePlanar:4,angleSignificantEdge:35};async function Dt(t){const n=function(t){return{data:it.createView(t.dataBuffer),originalIndices:"Uint32Array"===t.originalIndicesType?new Uint32Array(t.originalIndicesBuffer):"Uint16Array"===t.originalIndicesType?new Uint16Array(t.originalIndicesBuffer):void 0,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}(t),r=Et(n),e=[n.data.buffer];return{result:function(t,n){return n.push(t.regular.lodInfo.lengths.buffer),n.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:At(t.regular.instancesData,n),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:At(t.silhouette.instancesData,n),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}(r,e),transferList:e}}function Et(t){const n=function(t,n,r){if(n&&r)return{faces:r,neighbors:bt(r,t.count),vertices:t};{const n=Z(t.buffer,t.stride/4,{originalIndices:r}),e=bt(n.indices,n.uniqueCount);return{faces:n.indices,neighbors:e,vertices:it.createView(n.buffer)}}}(t.data,t.skipDeduplicate,t.originalIndices);return Nt.updateSettings(t.writerSettings),Lt.updateSettings(t.writerSettings),function(t,n,o,a=zt){const i=t.vertices.position,g=t.vertices.componentIndex,h=s(a.anglePlanar),m=s(a.angleSignificantEdge),y=Math.cos(m),A=Math.cos(h),v=kt.edge,U=v.position0,I=v.position1,M=v.faceNormal0,b=v.faceNormal1,j=function(t){const n=t.faces.length/3,r=t.vertices.position,e=t.faces,o=xt.v0,s=xt.v1,a=xt.v2,i=new Float32Array(3*n);for(let t=0;t<n;t++){const n=e[3*t+1],u=e[3*t+2];r.getVec(e[3*t+0],o),r.getVec(n,s),r.getVec(u,a),l(s,s,o),l(a,a,o),f(o,s,a),c(o,o),i[3*t+0]=o[0],i[3*t+1]=o[1],i[3*t+2]=o[2]}return i}(t),F=function(t){const n=t.faces.length/3,r=t.faces,e=t.neighbors;let o=0;for(let t=0;t<n;t++){const n=r[3*t+0],s=r[3*t+1],a=r[3*t+2];o+=-1===e[3*t+0]||n<s?1:0,o+=-1===e[3*t+1]||s<a?1:0,o+=-1===e[3*t+2]||a<n?1:0}const s=new Int32Array(4*o);let a=0;for(let t=0;t<n;t++){const n=e[3*t+0],o=e[3*t+1],i=e[3*t+2],c=r[3*t+0],l=r[3*t+1],f=r[3*t+2];(-1===n||c<l)&&(s[a++]=c,s[a++]=l,s[a++]=t,s[a++]=n),(-1===o||l<f)&&(s[a++]=l,s[a++]=f,s[a++]=t,s[a++]=o),(-1===i||f<c)&&(s[a++]=f,s[a++]=c,s[a++]=t,s[a++]=i)}return s}(t),S=F.length/4,k=n.allocate(S);let x=0;const z=o.allocate(S);let D=0,E=0,N=0;const L=r(0,S),_=new Float32Array(S);e(_,((t,n,r)=>{i.getVec(F[4*n+0],U),i.getVec(F[4*n+1],I),r[n]=p(U,I)})),L.sort(((t,n)=>_[n]-_[t]));const P=new Array,q=new Array;for(let t=0;t<S;t++){const r=L[t],e=_[r],s=F[4*r+0],a=F[4*r+1],c=F[4*r+2],l=F[4*r+3],f=-1===l;if(i.getVec(s,U),i.getVec(a,I),f)u(M,j[3*c+0],j[3*c+1],j[3*c+2]),d(b,M),v.componentIndex=g.get(s),v.cosAngle=w(M,b);else{if(u(M,j[3*c+0],j[3*c+1],j[3*c+2]),u(b,j[3*l+0],j[3*l+1],j[3*l+2]),v.componentIndex=g.get(s),v.cosAngle=w(M,b),Ft(v,A))continue;v.cosAngle<-.9999&&d(b,M)}E+=e,N++,f||jt(v,y)?(n.write(k,x++,v),P.push(e)):St(v,h)&&(o.write(z,D++,v),q.push(e))}const B=new Float32Array(P.reverse()),H=new Float32Array(q.reverse());return{regular:{instancesData:n.trim(k,x),lodInfo:{lengths:B}},silhouette:{instancesData:o.trim(z,D),lodInfo:{lengths:H}},averageEdgeLength:E/N}}(n,Nt,Lt)}const Nt=new ht,Lt=new mt;export{Et as work,Dt as wrappedWork}