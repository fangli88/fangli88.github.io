import{U as t,y as e,B as s,O as i,i as r,bd as n,h as l,M as h,p as u,Z as o,c as a,a1 as c}from"./p-dc4230e0.js";import{a0 as f,a1 as d,a2 as g,a3 as p,a4 as w,G as y,a5 as m,a6 as S,a7 as F,s as _}from"./p-aa6688d1.js";import{y as E}from"./p-66f366a9.js";import{X as b}from"./p-78c83631.js";import{WhereClause as I}from"./p-544c9aeb.js";import A from"./p-540c739d.js";import R from"./p-b415e09b.js";import{R as v,m as T}from"./p-aedb886e.js";import{v as O,l as N,o as D,s as P,n as k,a as C,i as x,u as G,w as U,h as j,b as B,E as M,f as L,g as V,c as q,d as W,e as K}from"./p-5047bd30.js";import{s as Q}from"./p-a1a69fdc.js";import J from"./p-cbbd4609.js";import{u as X}from"./p-d69473fe.js";import{c as H}from"./p-24476141.js";import{a as Y}from"./p-0e87baef.js";import{c as z}from"./p-90bfedb8.js";import{O as Z}from"./p-a2136a85.js";class ${constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(t,e,s){this._layerById[e]=s,this._layerByName[t]=s}featureSetByName(t,e=!0,s=["*"]){return this.resolvePromise(void 0===this._layerByName[t]?null:this._layerByName[t])}featureSetById(t,e=!0,s=["*"]){return this.resolvePromise(void 0===this._layerById[t]?null:this._layerById[t])}castToText(){return"object, FeatureSetCollection"}resolvePromise(e){return t(e)}}class tt extends O{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=t.parentfeatureset,t.whereclause instanceof I?(this._whereclause=t.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=t.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new e({wkid:4326}),this.geometryType=f.point)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("",null,this._whereclause,null,e))).then((t=>(this._checkCancelled(e),this._wset=null!==this._whereClauseFunction?new N(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):new N(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):t(this._wset)}_isInFeatureSet(t){let e=this._parent._isInFeatureSet(t);return e===d.NotInFeatureSet?e:(e=this._idstates[t],void 0===e?d.Unknown:e)}_getFeature(t,e,s){return this._parent._getFeature(t,e,s)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){return this._parent._featureFromCache(t)}executeWhereClause(t){return this._whereclause.testFeature(t)}executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction)try{const i=this._whereClauseFunction(e);return s(i)?i:t(i)}catch(t){return i(t)}return t(this.executeWhereClause(e))}_fetchAndRefineFeatures(t,e,s){const i=new N([],t,!1,null),n=Math.min(e,t.length);return this._parent._getFeatures(i,-1,n,s).then((()=>{if(this._checkCancelled(s),null==this._whereClauseFunction){for(let e=0;e<n;e++){const s=this._parent._featureFromCache(t[e]);this._idstates[t[e]]=!0===this.executeWhereClause(s)?d.InFeatureSet:d.NotInFeatureSet}return"success"}const i=[];for(let e=0;e<n;e++){const s=this._parent._featureFromCache(t[e]);i.push(this.executeWhereClauseDeferred(s))}return r(i).then((s=>{for(let i=0;i<e;i++)this._idstates[t[i]]=!0===s[i]?d.InFeatureSet:d.NotInFeatureSet;return"success"}))}))}_getFilteredSet(t,e,s,i,r){return null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=D(this._whereclause,s)):s=this._whereclause),this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,i,r))).then((t=>{let e;return this._checkCancelled(r),e=null!==this._whereClauseFunction?new N(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):new N(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),e}))}_stat(e,s,i,r,n,l,h){if(null!==this._whereClauseFunction)return null===n&&""===i&&null===r?this._manualStat(e,s,l,h):t({calculated:!1});let u=this._whereclause;return null!==n&&null!==this._whereclause&&(u=D(this._whereclause,n)),this._parent._stat(e,s,i,r,u,l,h).then((t=>!1===t.calculated?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):{calculated:!1}:t))}_canDoAggregates(e,s,i,r,n){return null!==this._whereClauseFunction?t(!1):(null!==n?null!==this._whereclause&&(n=D(this._whereclause,n)):n=this._whereclause,null===this._parent?t(!1):this._parent._canDoAggregates(e,s,i,r,n))}_getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h){return null===this._parent?i(new Error("Should never be called")):(null!==n?null!==this._whereclause&&(n=D(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h))}static registerAction(){O._featuresetFunctions.filter=function(t){if("function"==typeof t)return new tt({parentfeatureset:this,whereclause:t});let e=null;return t instanceof I&&(e=t),new tt({parentfeatureset:this,whereclause:e})}}}function et(t,e){return t===e?0:null===t?-1:null===e?1:t<e?-1:1}class st{constructor(t){const e=t.split(",");this._fields=[],this._directions=[];for(let t=0;t<e.length;t++){const s=e[t].match(/\S+/g);this._fields.push(s[0]),2===s.length?"asc"===s[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let t="";for(let e=0;e<this._fields.length;e++)0!==e&&(t+=","),t+=this._fields[e],t+=1===this._directions[e]?" ASC":" DESC";return t}order(t){t.sort(((t,e)=>{for(let s=0;s<this._fields.length;s++){const i=this.featureValue(t.feature,this._fields[s],s),r=this.featureValue(e.feature,this._fields[s],s);let n=0;if(n=1===this._directions[s]?et(i,r):-1*et(i,r),0!==n)return n}return 0}))}scanForField(t){for(let e=0;e<this._fields.length;e++)if(this._fields[e].toLowerCase().trim()===t.toLowerCase().trim())return!0;return!1}replaceFields(t){let e="";for(let s=0;s<this._fields.length;s++){0!==s&&(e+=",");let i=this._fields[s];for(const e of t)if(i.toLowerCase()===e.field.toLowerCase()){i=e.newfield;break}e+=i,e+=1===this._directions[s]?" ASC":" DESC"}return new st(e)}featureValue(t,e,s){const i=t.attributes[e];if(void 0!==i)return i;for(const i in t.attributes)if(e.toLowerCase()===i.toLowerCase())return this._fields[s]=i,t.attributes[i];return null}}class it extends O{constructor(t){super(t),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=t.orderbyclause,this._parent=t.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,this._orderbyclause,e))).then((t=>(this._checkCancelled(e),this._wset=t,this._wset))):t(this._wset)}manualOrderSet(t,e){return this.getIdColumnDictionary(t,[],-1,e).then((t=>{this._orderbyclause.order(t);const e=new N([],[],!0,null);for(let s=0;s<t.length;s++)e._known.push(t[s].id);return e}))}getIdColumnDictionary(e,s,i,r){if(i<e._known.length-1){const t=this._maxQueryRate();if("GETPAGES"===e._known[i+1])return g(this._parent._expandPagedSet(e,t,0,0,r)).then((()=>this.getIdColumnDictionary(e,s,i,r)));let n=i+1;const l=[];for(;n<e._known.length&&"GETPAGES"!==e._known[n];)l.push(e._known[n]),n++;return i+=l.length,g(this._parent._getFeatureBatch(l,r)).then((t=>{this._checkCancelled(r);for(const e of t)s.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,s,i,r)}))}return e._candidates.length>0?g(this._refineSetBlock(e,this._maxProcessingRate(),r)).then((()=>(this._checkCancelled(r),this.getIdColumnDictionary(e,s,i,r)))):t(s)}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){if(void 0===this._featureCache[t]){const e=this._parent._featureFromCache(t);if(void 0===e)return;return null===e?null:(this._featureCache[t]=e,e)}return this._featureCache[t]}_fetchAndRefineFeatures(){return i(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(t,e,s,i,r){return this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,null===i?this._orderbyclause:i,r))).then((t=>{let i;this._checkCancelled(r),i=new N(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition));let n=!0;return t._candidates.length>0&&(n=!1),!1===i._ordered?this.manualOrderSet(i,r).then((t=>(!1===n&&(null===e&&null===s||(t=new N(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)))),t))):i}))}static registerAction(){O._featuresetFunctions.orderBy=function(t){return""===t?this:new it({parentfeatureset:this,orderbyclause:new st(t)})}}}class rt{constructor(){this.sqlRewritable=!1}postInitialization(t,e){}}class nt extends rt{constructor(t){super(),this.field=t,this.sqlRewritable=!0}extractValue(t){return t.attributes[this.field.name]}rewriteSql(t){return{rewritten:this.sqlRewritable,where:t}}}class lt extends rt{constructor(t,e,s){super(),this.originalField=t,this.sqlRewritable=!0,this.field=p(t),this.field.name=e,this.field.alias=s}rewriteSql(t,e){return{rewritten:this.sqlRewritable,where:P(t,this.field.name,this.originalField.name,e.getFieldsIndex())}}extractValue(t){return t.attributes[this.originalField.name]}}class ht extends rt{constructor(t,e,s){super(),this.field=t,this.codefield=e,this.lkp=s,this.reverseLkp={};for(const t in s)this.reverseLkp[s[t]]=t;this.sqlRewritable=!0}rewriteSql(t,e){const s=this.evaluateNodeToWhereClause(t.parseTree,w.Standardised,this.field.name,this.codefield instanceof I?k(this.codefield,w.Standardised):this.codefield,t.parameters);return s.indexOf(ht.BADNESS)>=0?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:I.create(s,e._parent.getFieldsIndex())}}evaluateNodeToWhereClause(t,e,s=null,i=null,r){let n,l,h,u;switch(t.type){case"interval":return U(this.evaluateNodeToWhereClause(t.value,e,s,i,r),t.qualifier,t.op);case"case_expression":{let i=" CASE ";"simple"===t.format&&(i+=this.evaluateNodeToWhereClause(t.operand,e,s,ht.BADNESS,r));for(let n=0;n<t.clauses.length;n++)i+=" WHEN "+this.evaluateNodeToWhereClause(t.clauses[n].operand,e,s,ht.BADNESS,r)+" THEN "+this.evaluateNodeToWhereClause(t.clauses[n].value,e,s,ht.BADNESS,r);return null!==t.else&&(i+=" ELSE "+this.evaluateNodeToWhereClause(t.else,e,s,ht.BADNESS,r)),i+=" END ",i}case"param":{const s=r[t.value.toLowerCase()];if("string"==typeof s)return"'"+r[t.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(s instanceof Date)return G(s,e);if(s instanceof Array){const t=[];for(let i=0;i<s.length;i++)"string"==typeof s[i]?t.push("'"+s[i].toString().replace(/'/g,"''")+"'"):s[i]instanceof Date?t.push(G(s[i],e)):t.push(s[i].toString());return t}return s.toString()}case"expr_list":l=[];for(const n of t.value)l.push(this.evaluateNodeToWhereClause(n,e,s,i,r));return l;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(t.expr,e,s,ht.BADNESS,r)+" ) ";case"binary_expr":switch(t.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" AND "+this.evaluateNodeToWhereClause(t.right,e,s,i,r)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" OR "+this.evaluateNodeToWhereClause(t.right,e,s,i,r)+") ";case"IS":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IS NULL )";case"ISNOT":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IS NOT NULL )";case"IN":if(n=[],"expr_list"===t.right.type){if("column_ref"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}n.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+n.join(",")+")) "}return n=this.evaluateNodeToWhereClause(t.right,e,s,i,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+n.join(",")+")) "}return u=this.evaluateNodeToWhereClause(t.right,e,s,i,r),u instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+u.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+u+")) ";case"NOT IN":if(n=[],"expr_list"===t.right.type){if("column_ref"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}n.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+n.join(",")+")) "}return n=this.evaluateNodeToWhereClause(t.right,e,s,i,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+n.join(",")+")) "}return u=this.evaluateNodeToWhereClause(t.right,e,s,i,r),u instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+u.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+u+")) ";case"BETWEEN":return h=this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"NOTBETWEEN":return h=this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"NOT LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"<>":case"=":if("column_ref"===t.left.type&&"string"===t.right.type){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[t.right.value.toString()])return" ("+i+" "+t.operator+" "+this.lkp[t.right.value.toString()].toString()+") "}else if("column_ref"===t.right.type&&"string"===t.left.type&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[t.right.value.toString()].toString()+" "+t.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") "}throw new Error("Not Supported Operator "+t.operator);case"null":return"null";case"bool":return!0===t.value?"1":"0";case"string":return"'"+t.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return G(t.value,e);case"number":return t.value.toString();case"current_time":return x("date"===t.mode,e);case"column_ref":return s&&s.toLowerCase()===t.column.toLowerCase()?"("+i+")":t.column;case"function":{const i=this.evaluateNodeToWhereClause(t.args,e,s,ht.BADNESS,r);return C(t.name,i,e)}}throw new Error("Unsupported sql syntax "+t.type)}extractValue(t){return this.codefield instanceof I?this.reverseLkp[this.codefield.calculateValueCompiled(t)]:this.reverseLkp[t.attributes[this.codefield]]}}ht.BADNESS="_!!!_BAD_LKP_!!!!";class ut extends rt{constructor(t,e){super(),this.field=t,this.sql=e}rewriteSql(t,e){return{rewritten:!0,where:P(t,this.field.name,k(this.sql,w.Standardised),e.getFieldsIndex())}}extractValue(t){return this.sql.calculateValueCompiled(t)}}class ot extends O{constructor(t){super(t),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=t.extraFilter,this._parent=t.parentfeatureset,this._maxProcessing=30,this.adaptedFields=t.adaptedFields}static findField(t,e){for(const s of t)if(s.name.toLowerCase()===e.toString().toLowerCase())return s;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new e({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=f.point,this.typeIdField="",this.types=null),this.fields=[];for(const t of this.adaptedFields)t.postInitialization(this,this._parent),this.fields.push(t.field)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._extraFilter?this._getFilteredSet("",null,null,null,e):this._parent._getSet(e))).then((t=>(this._checkCancelled(e),this._wset=new N(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):t(this._wset)}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(e,s,i,r){const l=[];-1!==s&&void 0===this._featureCache[s]&&l.push(s);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,h))return this._expandPagedSet(e,h,0,0,r).then((()=>this._getFeatures(e,s,i,r)));let u=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(u++,u<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&l.push(e._known[t]),l.length>=h-1)));t++);if(0===l.length)return t("success");e=new N([],l,e._ordered,null);const o=Math.min(l.length,i);return this._parent._getFeatures(e,-1,o,r).then((()=>{this._checkCancelled(r);const t=[];for(let e=0;e<o;e++){const s=this._parent._featureFromCache(l[e]);void 0!==s&&t.push({geometry:s.geometry,attributes:s.attributes,id:l[e]})}for(const e of t){const t=[];for(const s of this.adaptedFields)t[s.field.name]=s.extractValue(e);this._featureCache[e.id]=new n({attributes:t,geometry:y(e.geometry)})}return"success"}))}_fetchAndRefineFeatures(){return i(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(t,e,s,i,r){let n=!1;const l=this.reformulateWithoutAdaptions(s);n=l.cannot,s=l.where;let h=!1;if(null!==i){h=!0;const t=[];for(const e of this.adaptedFields)if(!(e instanceof nt)&&!0===i.scanForField(e.field.name)){if(!(e instanceof lt)){i=null,h=!1;break}t.push({field:e.field.name,newfield:e.originalField.name})}i&&t.length>0&&(i=i.replaceFields(t))}return null!==s?null!==this._extraFilter&&(s=D(this._extraFilter,s)):s=this._extraFilter,this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,i,r))).then((t=>{let e;return this._checkCancelled(r),e=!0===n?new N(t._candidates.slice(0).concat(t._known.slice(0)),[],!0===h&&t._ordered,this._clonePageDefinition(t.pagesDefinition)):new N(t._candidates.slice(0),t._known.slice(0),!0===h&&t._ordered,this._clonePageDefinition(t.pagesDefinition)),e}))}reformulateWithoutAdaptions(t){const e={cannot:!1,where:t};if(null!==t)for(const s of this.adaptedFields)if(!0===j(t,s.field.name)){const i=s.rewriteSql(t,this);if(!0!==i.rewritten){e.cannot=!0,e.where=null;break}e.where=i.where}return e}_stat(e,s,i,r,n,l,h){let u=!1,o=this.reformulateWithoutAdaptions(s);return u=o.cannot,s=o.where,o=this.reformulateWithoutAdaptions(n),u=u||o.cannot,null!==(n=o.where)?null!==this._extraFilter&&(n=D(this._extraFilter,n)):n=this._extraFilter,!0===u?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):t({calculated:!1}):this._parent._stat(e,s,i,r,n,l,h).then((t=>!1===t.calculated?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):{calculated:!1}:t))}_canDoAggregates(e,s,i,r,n){if(null===this._parent)return t(!1);for(let s=0;s<e.length;s++)for(const i of this.adaptedFields)if(e[s].toLowerCase()===i.field.name.toLowerCase()&&!(i instanceof nt))return t(!1);const l=[];for(let e=0;e<s.length;e++){const i=s[e];if(null!==i.workingexpr){const e=this.reformulateWithoutAdaptions(i.workingexpr);if(e.cannot)return t(!1);const s=i.clone();s.workingexpr=e.where,l.push(s)}else l.push(i)}const h=this.reformulateWithoutAdaptions(n);return h.cannot?t(!1):(null!==(n=h.where)?null!==this._extraFilter&&(n=D(this._extraFilter,n)):n=this._extraFilter,this._parent._canDoAggregates(e,l,i,r,n))}_getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h){if(null===this._parent)return i(new Error("Should never be called"));const u=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this.reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)return i(new Error("Should never be called"));const e=s.clone();e.workingexpr=t.where,u.push(e)}else u.push(s)}const o=this.reformulateWithoutAdaptions(n);return o.cannot?i(new Error("Should never be called")):(null!==(n=o.where)?null!==this._extraFilter&&(n=D(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(t,u,s,r,n,l,h))}}class at{clone(){const t=new at;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,e,s){const i=new at;i.field=t;const r=I.create(e,s),n=function(t){if("function"===t.parseTree.type){if(0===t.parseTree.args.value.length)return{name:t.parseTree.name,expr:null};if(t.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=I.create(B(t.parseTree.args.value[0],w.Standardised,t.parameters),t.fieldsIndex);return{name:t.parseTree.name,expr:e}}return null}(r);if(null===n)throw new Error("Invalid Statistic Function");const l=n.name.toUpperCase().trim();if("MIN"===l){if(i.typeofstat="MIN",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===l){if(i.typeofstat="MAX",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===l)i.typeofstat="COUNT",i.workingexpr=n.expr;else if("STDEV"===l){if(i.typeofstat="STDDEV",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===l){if(i.typeofstat="SUM",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===l){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===l){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==l)throw new Error("Invalid Statistic Function");if(i.typeofstat="VAR",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}return i}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}function ct(t,e){const s=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(s>>16)<<16|65535&s}function ft(t,e,s,i,r,n){return ct((l=ct(ct(e,t),ct(i,n)))<<(h=r)|l>>>32-h,s);var l,h}function dt(t,e,s,i,r,n,l){return ft(e&s|~e&i,t,e,r,n,l)}function gt(t,e,s,i,r,n,l){return ft(e&i|s&~i,t,e,r,n,l)}function pt(t,e,s,i,r,n,l){return ft(e^s^i,t,e,r,n,l)}function wt(t,e,s,i,r,n,l){return ft(s^(e|~i),t,e,r,n,l)}function yt(t,e=1){const s=e||0,i=function(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let s=1732584193,i=-271733879,r=-1732584194,n=271733878;for(let e=0;e<t.length;e+=16){const l=s,h=i,u=r,o=n;s=dt(s,i,r,n,t[e+0],7,-680876936),n=dt(n,s,i,r,t[e+1],12,-389564586),r=dt(r,n,s,i,t[e+2],17,606105819),i=dt(i,r,n,s,t[e+3],22,-1044525330),s=dt(s,i,r,n,t[e+4],7,-176418897),n=dt(n,s,i,r,t[e+5],12,1200080426),r=dt(r,n,s,i,t[e+6],17,-1473231341),i=dt(i,r,n,s,t[e+7],22,-45705983),s=dt(s,i,r,n,t[e+8],7,1770035416),n=dt(n,s,i,r,t[e+9],12,-1958414417),r=dt(r,n,s,i,t[e+10],17,-42063),i=dt(i,r,n,s,t[e+11],22,-1990404162),s=dt(s,i,r,n,t[e+12],7,1804603682),n=dt(n,s,i,r,t[e+13],12,-40341101),r=dt(r,n,s,i,t[e+14],17,-1502002290),i=dt(i,r,n,s,t[e+15],22,1236535329),s=gt(s,i,r,n,t[e+1],5,-165796510),n=gt(n,s,i,r,t[e+6],9,-1069501632),r=gt(r,n,s,i,t[e+11],14,643717713),i=gt(i,r,n,s,t[e+0],20,-373897302),s=gt(s,i,r,n,t[e+5],5,-701558691),n=gt(n,s,i,r,t[e+10],9,38016083),r=gt(r,n,s,i,t[e+15],14,-660478335),i=gt(i,r,n,s,t[e+4],20,-405537848),s=gt(s,i,r,n,t[e+9],5,568446438),n=gt(n,s,i,r,t[e+14],9,-1019803690),r=gt(r,n,s,i,t[e+3],14,-187363961),i=gt(i,r,n,s,t[e+8],20,1163531501),s=gt(s,i,r,n,t[e+13],5,-1444681467),n=gt(n,s,i,r,t[e+2],9,-51403784),r=gt(r,n,s,i,t[e+7],14,1735328473),i=gt(i,r,n,s,t[e+12],20,-1926607734),s=pt(s,i,r,n,t[e+5],4,-378558),n=pt(n,s,i,r,t[e+8],11,-2022574463),r=pt(r,n,s,i,t[e+11],16,1839030562),i=pt(i,r,n,s,t[e+14],23,-35309556),s=pt(s,i,r,n,t[e+1],4,-1530992060),n=pt(n,s,i,r,t[e+4],11,1272893353),r=pt(r,n,s,i,t[e+7],16,-155497632),i=pt(i,r,n,s,t[e+10],23,-1094730640),s=pt(s,i,r,n,t[e+13],4,681279174),n=pt(n,s,i,r,t[e+0],11,-358537222),r=pt(r,n,s,i,t[e+3],16,-722521979),i=pt(i,r,n,s,t[e+6],23,76029189),s=pt(s,i,r,n,t[e+9],4,-640364487),n=pt(n,s,i,r,t[e+12],11,-421815835),r=pt(r,n,s,i,t[e+15],16,530742520),i=pt(i,r,n,s,t[e+2],23,-995338651),s=wt(s,i,r,n,t[e+0],6,-198630844),n=wt(n,s,i,r,t[e+7],10,1126891415),r=wt(r,n,s,i,t[e+14],15,-1416354905),i=wt(i,r,n,s,t[e+5],21,-57434055),s=wt(s,i,r,n,t[e+12],6,1700485571),n=wt(n,s,i,r,t[e+3],10,-1894986606),r=wt(r,n,s,i,t[e+10],15,-1051523),i=wt(i,r,n,s,t[e+1],21,-2054922799),s=wt(s,i,r,n,t[e+8],6,1873313359),n=wt(n,s,i,r,t[e+15],10,-30611744),r=wt(r,n,s,i,t[e+6],15,-1560198380),i=wt(i,r,n,s,t[e+13],21,1309151649),s=wt(s,i,r,n,t[e+4],6,-145523070),n=wt(n,s,i,r,t[e+11],10,-1120210379),r=wt(r,n,s,i,t[e+2],15,718787259),i=wt(i,r,n,s,t[e+9],21,-343485551),s=ct(s,l),i=ct(i,h),r=ct(r,u),n=ct(n,o)}return[s,i,r,n]}(function(t){const e=[];for(let s=0,i=8*t.length;s<i;s+=8)e[s>>5]|=(255&t.charCodeAt(s/8))<<s%32;return e}(t),8*t.length);switch(s){case 3:return i;case 1:return function(t){const e="0123456789abcdef",s=[];for(let i=0,r=4*t.length;i<r;i++)s.push(e.charAt(t[i>>2]>>i%4*8+4&15)+e.charAt(t[i>>2]>>i%4*8&15));return s.join("")}(i);case 2:return function(t){const e=[];for(let s=0,i=32*t.length;s<i;s+=8)e.push(String.fromCharCode(t[s>>5]>>>s%32&255));return e.join("")}(i);case 0:return function(t){const e=[];for(let s=0,i=4*t.length;s<i;s+=3){const i=(t[s>>2]>>s%4*8&255)<<16|(t[s+1>>2]>>(s+1)%4*8&255)<<8|t[s+2>>2]>>(s+2)%4*8&255;for(let r=0;r<4;r++)e.push(8*s+6*r>32*t.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>6*(3-r)&63))}return e.join("")}(i)}}function mt(t){if(!t)return"COUNT";switch(t.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class St extends O{constructor(t){super(t),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=t.parentfeatureset,this._config=t}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then((t=>(this._wset=t,this._wset))):t(this._wset)}_isInFeatureSet(){return d.InFeatureSet}nextUniqueName(t){for(;1===t["T"+this._uniqueIds.toString()];)this._uniqueIds++;const e="T"+this._uniqueIds.toString();return t[e]=1,e}convertToEsriFieldType(t){return t}_initialiseFeatureSet(){const t={};let s=!1,i=1;const r=this._parent?this._parent.getFieldsIndex():new Q([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===s;){let t=!1;for(let e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}if(!1===t)for(let e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}!1===t?s=!0:(this.objectIdField="ROW__ID"+i.toString(),i++)}for(const t of this._config.statsfields){const e=new at;e.field=t.name,e.tofieldname=t.name,e.workingexpr=t.expression instanceof I?t.expression:I.create(t.expression,r),e.typeofstat=mt(t.statistic),this._decodedStatsfield.push(e)}this._decodedGroupbyfield=[];for(const t of this._config.groupbyfields){const e={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof I?t.expression:I.create(t.expression,r)};this._decodedGroupbyfield.push(e)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const e of this._parent.fields)t[e.name.toUpperCase()]=1;this.types=null}else this.geometryType=f.point,this.typeIdField="",this.types=null,this.spatialReference=new e({wkid:4326});this.fields=[];const n=new at;n.field=this.nextUniqueName(t),n.tofieldname=this.objectIdField,n.workingexpr=I.create(this._parent.objectIdField,this._parent.getFieldsIndex()),n.typeofstat="MIN",this._decodedStatsfield.push(n);for(const e of this._decodedGroupbyfield){const s=new E;if(e.name=this.nextUniqueName(t),s.name=e.tofieldname,s.alias=s.name,M(e.expression)){const t=this._parent.getField(k(e.expression,w.Standardised));if(!t)throw new Error("Field is not present for Aggregation");e.name=t.name,e.singlefield=t.name,this.phsyicalgroupbyfields.push(t.name),s.type=t.type}else{s.type=this.convertToEsriFieldType(L(e.expression,this._parent.fields));const t=new E;t.name=e.name,t.alias=t.name,this.phsyicalgroupbyfields.push(e.name),this._adaptedFields.push(new ut(t,e.expression)),this._candosimplegroupby=!1}this.fields.push(s)}if(this._adaptedFields.length>0)for(const t of this._parent.fields)this._adaptedFields.push(new nt(t));for(let e=0;e<this._decodedStatsfield.length;e++){const s=new E;let i=null;const r=this._decodedStatsfield[e];r.field=this.nextUniqueName(t),r.tofieldname===this.objectIdField&&(this._internalObjectIdField=r.field),s.name=r.tofieldname,s.alias=s.name;const n=null!==r.workingexpr&&M(r.workingexpr)?k(r.workingexpr,w.Standardised):"";switch(this._decodedStatsfield[e].typeofstat){case"SUM":if(""!==n){if(i=this._parent.getField(n),!i)throw new Error("Field is not present for Aggregation");s.type=i.type}else s.type="double";break;case"MIN":case"MAX":if(""!==n){if(i=this._parent.getField(n),!i)throw new Error("Field is not present for Aggregation");s.type=i.type}else s.type="double";break;case"COUNT":s.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==n&&(i=this._parent.getField(n),!i))throw new Error("Field is not present for Aggregation");s.type="double"}this.fields.push(s)}}_canDoAggregates(){return t(!1)}_getFeatures(e,s,i,r){const n=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,n)?this._expandPagedSet(e,n,0,0,r).then((()=>this._getFeatures(e,s,i,r))):t("success")}_getFilteredSet(e,s,i,r,n){if(""!==e)return t(new N([],[],!0,null));let l=null;const h={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((()=>{if(null!==i)for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===j(i,this._decodedStatsfield[t].tofieldname)){h.nowhereclause=!0,i=null;break}if(null!==r){h.ordered=!0;for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===r.scanForField(this._decodedStatsfield[t].tofieldname)){r=null,h.ordered=!1;break}if(null!==r)for(const t of this._decodedGroupbyfield)if(null===t.singlefield&&!0===r.scanForField(t.tofieldname)){r=null,h.ordered=!1;break}}return!1===this._candosimplegroupby?t(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)})).then((t=>{if(t){let t=null;i&&(t=this._reformulateWhereClauseWithoutGroupByFields(i));let e=null;return r&&(e=this._reformulateOrderClauseWithoutGroupByFields(r)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,t,e,this._internalObjectIdField).then((t=>(this._checkCancelled(n),l=!0===h.nowhereclause?new N(t._candidates.slice(0).concat(t._known.slice(0)),[],!0===h.ordered&&t._ordered,this._clonePageDefinition(t.pagesDefinition)):new N(t._candidates.slice(0),t._known.slice(0),!0===h.ordered&&t._ordered,this._clonePageDefinition(t.pagesDefinition)),l)))}let e=this._parent;if(this._adaptedFields.length>0&&(e=new ot({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===h.nowhereclause)l=new N(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new it({parentfeatureset:e,orderbyclause:new st(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let t=e;if(null!==i){let e=null;i&&(e=this._reformulateWhereClauseWithoutGroupByFields(i)),t=new tt({parentfeatureset:t,whereclause:e})}l=new N(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new it({parentfeatureset:t,orderbyclause:new st(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return l}))}_reformulateWhereClauseWithoutStatsFields(t){for(const e of this._decodedStatsfield)t=P(t,e.tofieldname,k(e.workingexpr,w.Standardised),this._parent.getFieldsIndex());return t}_reformulateWhereClauseWithoutGroupByFields(t){for(const e of this._decodedGroupbyfield)e.tofieldname!==e.name&&(t=P(t,e.tofieldname,k(e.expression,w.Standardised),this._parent.getFieldsIndex()));return t}_reformulateOrderClauseWithoutGroupByFields(t){const e=[];for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&e.push({field:t.tofieldname,newfield:t.name});return e.length>0?t.replaceFields(e):t}_clonePageDefinition(t){return null===t?null:!0===t.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,internal:t.internal}:this._parent._clonePageDefinition(t)}_refineSetBlock(e,s,r){try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,r).then((()=>this._refineSetBlock(e,s,r))):(this._checkCancelled(r),this._refineKnowns(e,s),t(e))}catch(t){return i(t)}}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_getPhysicalPage(t,e,s){return!0===t.pagesDefinition.aggregatefeaturesetpagedefinition?l(((e,i)=>{this._sequentialGetPhysicalItem(t,t.pagesDefinition.resultRecordCount,s,[]).then((t=>{e(t)}),i)})):this._getAgregagtePhysicalPage(t,e,s).then((t=>{for(const e of t){const t={geometry:e.geometry,attributes:{}};for(const s of this._decodedGroupbyfield)t.attributes[s.tofieldname]=e.attributes[s.name];for(const s of this._decodedStatsfield)t.attributes[s.tofieldname]=e.attributes[s.field];this._featureCache[t.attributes[this.objectIdField]]=new n(t)}return t.length}))}_sequentialGetPhysicalItem(t,e,s,i){return l(((r,n)=>{null===t.pagesDefinition.internal.iterator&&(t.pagesDefinition.internal.iterator=t.pagesDefinition.internal.subfeatureset.iterator(s)),!0===t.pagesDefinition.internal.fullyResolved||0===e?r(i.length):this._nextAggregateItem(t,e,s,i,(n=>{r(null===n?i.length:this._sequentialGetPhysicalItem(t,e-=1,s,i))}),n)}))}_nextAggregateItem(t,e,s,i,r,n){try{g(t.pagesDefinition.internal.iterator.next()).then((l=>{if(null===l)if(null!==t.pagesDefinition.internal.workingItem){const e=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);i.push(e),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(e.attributes[this.objectIdField]),t.pagesDefinition.internal.fullyResolved=!0,r(null)}else t.pagesDefinition.internal.fullyResolved=!0,r(null);else{const h=this._generateAggregateHash(l);if(null===t.pagesDefinition.internal.workingItem)t.pagesDefinition.internal.workingItem={features:[l],id:h};else{if(h!==t.pagesDefinition.internal.workingItem.id){const s=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);return i.push(s),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(s.attributes[this.objectIdField]),e-=1,t.pagesDefinition.internal.workingItem={features:[l],id:h},void r(s)}t.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(t,e,s,i,r,n)}}),n)}catch(t){n(t)}}_calculateFieldStat(t,e,s){const i=[];for(let s=0;s<t.features.length;s++)if(null!==e.workingexpr){const r=e.workingexpr.calculateValue(t.features[s]);null!==r&&i.push(r)}else i.push(null);switch(e.typeofstat){case"MIN":s.attributes[e.tofieldname]=V("min",i,-1);break;case"MAX":s.attributes[e.tofieldname]=V("max",i,-1);break;case"SUM":s.attributes[e.tofieldname]=V("sum",i,-1);break;case"COUNT":s.attributes[e.tofieldname]=i.length;break;case"VAR":s.attributes[e.tofieldname]=V("var",i,-1);break;case"STDDEV":s.attributes[e.tofieldname]=V("stddev",i,-1);break;case"AVG":s.attributes[e.tofieldname]=V("avg",i,-1)}return!0}_calculateAndAppendAggregateItem(t){const e={attributes:{},geometry:null};for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.features[0].attributes[s.singlefield]:s.expression.calculateValue(t.features[0]);e.attributes[s.tofieldname]=i}for(const s of this._decodedStatsfield)this._calculateFieldStat(t,s,e);const s=[];for(let i=0;i<this._decodedStatsfield.length;i++)s.push(this._calculateFieldStat(t,this._decodedStatsfield[i],e));return this._featureCache[e.attributes[this.objectIdField]]=new n({attributes:e.attributes,geometry:e.geometry}),e}_generateAggregateHash(t){let e="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.attributes[s.singlefield]:s.expression.calculateValue(t);e+=null==i?":":":"+i.toString()}return yt(e,2)}_stat(){return t({calculated:!1})}getFeatureByObjectId(){return t(null)}static registerAction(){O._featuresetFunctions.groupby=function(t,e){return new St({parentfeatureset:this,groupbyfields:t,statsfields:e})}}}class Ft extends O{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getSet(e))).then((t=>(this._wset=new N(t._candidates.slice(0),t._known.slice(0),!1,this._clonePageDefinition(t.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset))):t(this._wset)}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===d.NotInFeatureSet)return e;const s=this._idstates[t];return s===d.InFeatureSet||s===d.NotInFeatureSet?s:e===d.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=d.InFeatureSet,this._countedin++,d.InFeatureSet):(this._idstates[t]=d.NotInFeatureSet,d.NotInFeatureSet):d.Unknown}_expandPagedSet(e,s,r,n,l){if(null===this._parent)return i(new Error("Parent Paging not implemented"));if(s>this._topnum&&(s=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let s=e._known.length;return s>0&&"GETPAGES"===e._known[s-1]&&(e._known.length=s-1),s=e._candidates.length,s>0&&"GETPAGES"===e._candidates[s-1]&&(e._candidates.length=s-1),t("success")}return this._parent._expandPagedSet(e,s,r,n,l).then((t=>(this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),t)))}_getFeatures(e,s,i,r){const n=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,r).then((()=>this._getFeatures(e,s,i,r)));-1!==s&&void 0===this._featureCache[s]&&n.push(s);let h=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(h++,h<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&n.push(e._known[t]),n.length>l-1)));t++);if(0===n.length)return t("success");const u=new N([],n,!1,null),o=Math.min(n.length,i);return this._parent._getFeatures(u,-1,o,r).then((()=>{for(let t=0;t<o;t++){const e=this._parent._featureFromCache(n[t]);void 0!==e&&(this._featureCache[n[t]]=e)}return"success"}))}_getFilteredSet(t,e,s,i,r){return this._ensureLoaded().then((()=>this._getSet(r))).then((t=>new N(t._candidates.slice(0).concat(t._known.slice(0)),[],!1,this._clonePageDefinition(t.pagesDefinition))))}_refineKnowns(t,e){let s=0,i=null;const r=[];for(let n=0;n<t._candidates.length;n++){const l=this._isInFeatureSet(t._candidates[n]);if(l===d.InFeatureSet){if(t._known.push(t._candidates[n]),s+=1,null===i?i={start:n,end:n}:i.end===n-1?i.end=n:(r.push(i),i={start:n,end:n}),t._known.length>=this._topnum)break}else if(l===d.NotInFeatureSet)null===i?i={start:n,end:n}:i.end===n-1?i.end=n:(r.push(i),i={start:n,end:n}),s+=1;else if(l===d.Unknown)break;if(s>=e)break}null!==i&&r.push(i);for(let e=r.length-1;e>=0;e--)t._candidates.splice(r[e].start,r[e].end-r[e].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}_stat(){return t({calculated:!1})}_canDoAggregates(){return t(!1)}static registerAction(){O._featuresetFunctions.top=function(t){return new Ft({parentfeatureset:this,topnum:t})}}}class _t extends O{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return m}end(){return this._layer}optimisePagingFeatureQueries(t){this._pageJustIds=t}convertQueryToLruCacheKey(t){return yt(S(t.toJSON()),2)}load(){return null===this._loadPromise&&(this._loadPromise=l(((t,e)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void t(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),t(this)}catch(t){e(t)}}),e),this._layer.load()}catch(t){e(t)}}))),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const t=[];for(const e of this.fields)if("oid"===e.type)t.push(e);else for(const s of this._layer.outFields)if(s.toLowerCase()===e.name.toLowerCase()){t.push(e);break}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}if(this._layer.source&&this._layer.source.sourceJSON){const t=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=w.StandardisedNoInterval,null!=t&&t>=10.61&&(this._databaseType=w.Standardised)):null!=t&&(t>=10.5&&(this._databaseType=w.StandardisedNoInterval,this._requestStandardised=!0),t>=10.61&&(this._databaseType=w.Standardised))}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return d.InFeatureSet}_refineSetBlock(e){return t(e)}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_runDatabaseProbe(t){return l(((e,s)=>{try{this._ensureLoaded().then((()=>{try{const i=new v;i.where=t.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(i).then((()=>{e(!0)}),(()=>{try{e(!1)}catch(t){s(t)}}))}catch(t){s(t)}}))}catch(e){s(e)}}))}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(t){return!t.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(t){return t.quantizationParameters={mode:"edit"},z(this._layer.parsedUrl,t,new Y({})).then((t=>R.fromJSON(b(t.data)).unquantize()))}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(t,e){const s=new Z({url:this._layer.parsedUrl.path}),i="execute"===e&&this.pbfSupportedForQuery(t);let r=null;if(this.recentlyUsedQueries){const n=this.convertQueryToLruCacheKey(t);r=this.recentlyUsedQueries.getFromCache(n),null===r&&(r=!0!==i?s[e](t):this.queryPBF(t),this.recentlyUsedQueries.addToCache(n,r),r=r.catch((t=>{throw this.recentlyUsedQueries.removeFromCache(n),t})))}return null===r&&(r=!0!==i?s[e](t):this.queryPBF(t)),r}_getFilteredSet(t,e,s,i,r){return this.databaseType().then((n=>{if(this.isTable()&&e&&null!==t&&""!==t)return new N([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(t,e,s,i,r);let l="",h=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=i.constructClause(),h=!0);const u=new v;return u.where=null===s?null===e?"1=1":"":k(s,n),this._requestStandardised&&(u.sqlFormat="standard"),u.spatialRelationship=this._makeRelationshipEnum(t),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===e?null:e,u.relationParameter=this._makeRelationshipParam(t),this.executeQuery(u,"executeForIds").then((t=>(null===t&&(t=[]),this._checkCancelled(r),new N([],t,h,null))))}))}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_getFilteredSetUsingPaging(t,e,s,r,n){try{let i="",l=!1;return null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(i=r.constructClause(),l=!0),this.databaseType().then((r=>{let h=null===s?null===e?"1=1":"":k(s,r);this._layer.definitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression);let u=this._maxQueryRate();const o=this._layer.capabilities.query.maxRecordCount;void 0!==o&&o<u&&(u=o);let a=null;if(!0===this._pageJustIds)a=new N([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:this._layer.objectIdField,resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:i,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let s=!0;!0===this._removeGeometry&&(s=!1);const r=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);a=new N([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:r.join(","),resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:i,returnGeometry:s,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(a,u,0,1,n).then((()=>a))}))}catch(t){return i(t)}}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}_getPhysicalPage(t,e,s){try{const e=t.pagesDefinition.internal.lastRetrieved,i=e,r=t.pagesDefinition.internal.lastPage,n=new v;return this._requestStandardised&&(n.sqlFormat="standard"),n.spatialRelationship=t.pagesDefinition.spatialRel,n.relationParameter=t.pagesDefinition.relationParam,n.outFields=t.pagesDefinition.outFields.split(","),n.num=t.pagesDefinition.resultRecordCount,n.start=t.pagesDefinition.internal.lastPage,n.geometry=t.pagesDefinition.geometry,n.where=t.pagesDefinition.where,n.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,n.returnGeometry=t.pagesDefinition.returnGeometry,n.outSpatialReference=this.spatialReference,this.executeQuery(n,"execute").then((n=>{if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return"done";for(let e=0;e<n.features.length;e++)t.pagesDefinition.internal.set[i+e]=n.features[e].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let t=0;t<n.features.length;t++)this._featureCache[n.features[t].attributes[this._layer.objectIdField]]=n.features[t];return(void 0===n.exceededTransferLimit&&n.features.length!==t.pagesDefinition.resultRecordCount||!1===n.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=e+n.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,"done"}))}catch(t){return i(t)}}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.indexOf("*")>-1)return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}_getFeatures(e,s,r,n){const l=[];try{if(-1!==s&&void 0===this._featureCache[s]&&l.push(s),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then((()=>this._getFeatures(e,s,r,n)));let h=0;for(let t=e._lastFetchedIndex;t<e._known.length;t++){if(e._lastFetchedIndex+=1,h++,void 0===this._featureCache[e._known[t]]){let i=!1;if(null!=this._layer._mode){const s=this._layer._mode;if(void 0!==s._featureMap[e._known[t]]){const r=s._featureMap[e._known[t]];null!==r&&(i=!0,this._featureCache[e._known[t]]=r)}}if(!1===i&&(e._known[t]!==s&&l.push(e._known[t]),l.length>=this._maxProcessingRate()-1))break}if(h>=r&&0===l.length)break}if(0===l.length)return t("success");try{const t=new v;return this._requestStandardised&&(t.sqlFormat="standard"),t.objectIds=l,t.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),t.returnGeometry=!0,!0===this._removeGeometry&&(t.returnGeometry=!1),t.outSpatialReference=this.spatialReference,this.executeQuery(t,"execute").then((t=>{if(this._checkCancelled(n),void 0!==t.error)return i(new Error(t.error));for(let e=0;e<t.features.length;e++)this._featureCache[t.features[e].attributes[this._layer.objectIdField]]=t.features[e];return"success"}))}catch(e){return i(e)}}catch(e){return i(e)}}_getDistinctPages(t,e,s,r,n,l,h,u,o){return this._ensureLoaded().then((()=>this.databaseType())).then((a=>{let c=s.parseTree.column;for(let t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name.toLowerCase()===c.toLowerCase()){c=this._layer.fields[t].name;break}const f=new v;this._requestStandardised&&(f.sqlFormat="standard");let d=null===l?null===n?"1=1":"":k(l,a);return this._layer.definitionExpression&&(d=""!==d?"(("+this._layer.definitionExpression+") AND ("+d+"))":this._layer.definitionExpression),f.where=d,f.spatialRelationship=this._makeRelationshipEnum(r),f.relationParameter=this._makeRelationshipParam(r),f.geometry=null===n?null:n,f.returnDistinctValues=!0,f.returnGeometry=!1,f.outFields=[c],this.executeQuery(f,"execute").then((a=>{if(this._checkCancelled(o),!a.hasOwnProperty("features"))return i(new Error("Unnexected Result querying statistics from layer"));let f=!1;for(let t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name===c){"date"===this._layer.fields[t].type&&(f=!0);break}for(let t=0;t<a.features.length;t++){if(f){const e=a.features[t].attributes[c];u.push(null!==e?new Date(e):e)}else u.push(a.features[t].attributes[c]);if(u.length>=h)break}return 0===a.features.length?u:a.features.length===this._layer.capabilities.query.maxRecordCount&&u.length<h?this._getDistinctPages(t+a.features.length,e,s,r,n,l,h,u,o).then((t=>({calculated:!0,result:t}))):u}))}))}_distinctStat(t,e,s,i,r,n,l){return this._getDistinctPages(0,t,e,s,i,r,n,[],l).then((t=>({calculated:!0,result:t})))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(t,e,s,i){return this.databaseType().then((t=>{const r=new v;if(this._requestStandardised&&(r.sqlFormat="standard"),this.isTable()&&s&&null!==e&&""!==e)return{calculated:!0,result:0};let n=null===i?null===s?"1=1":"":k(i,t);return this._layer.definitionExpression&&(n=""!==n?"(("+this._layer.definitionExpression+") AND ("+n+"))":this._layer.definitionExpression),r.where=n,r.where=n,r.spatialRelationship=this._makeRelationshipEnum(e),r.relationParameter=this._makeRelationshipParam(e),r.geometry=null===s?null:s,r.returnGeometry=!1,this.executeQuery(r,"executeForCount").then((t=>({calculated:!0,result:t})))}))}_stats(t,e,s,r,n,l,h){return this._ensureLoaded().then((()=>{const u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,o=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,a=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===t?a?this._countstat(t,s,r,n):{calculated:!1}:!1===o||!1===M(e)&&!1===u||!1===e.isStandardized?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,l,h):"distinct"===t?!1===a?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,l,h):this._distinctStat(t,e,s,r,n,l,h):this.databaseType().then((l=>{if(this.isTable()&&r&&null!==s&&""!==s)return{calculated:!0,result:null};const h=new v;this._requestStandardised&&(h.sqlFormat="standard");let u=null===n?null===r?"1=1":"":k(n,l);this._layer.definitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression),h.where=u,h.spatialRelationship=this._makeRelationshipEnum(s),h.relationParameter=this._makeRelationshipParam(s),h.geometry=null===r?null:r;const o=new T;o.statisticType=q(t),o.onStatisticField=k(e,l),o.outStatisticFieldName="ARCADE_STAT_RESULT",h.returnGeometry=!1;let a="ARCADE_STAT_RESULT";return h.outStatistics=[o],this.executeQuery(h,"execute").then((t=>{if(!t.hasOwnProperty("features")||0===t.features.length)return i(new Error("Unnexected Result querying statistics from layer"));let e=!1;for(let s=0;s<t.fields.length;s++)if("ARCADE_STAT_RESULT"===t.fields[s].name.toUpperCase()){a=t.fields[s].name,"date"===t.fields[s].type&&(e=!0);break}if(e){let e=t.features[0].attributes[a];return null!==e&&(e=new Date(t.features[0].attributes[a])),{calculated:!0,result:e}}return{calculated:!0,result:t.features[0].attributes[a]}}))}))}))}_stat(t,e,s,i,r,n,l){return this._stats(t,e,s,i,r,n,l)}_canDoAggregates(t,e){return this._ensureLoaded().then((()=>{let t=!1;const s=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(t=!0),t)for(let i=0;i<e.length-1;i++)null!==e[i].workingexpr&&(!1===e[i].workingexpr.isStandardized||!1===M(e[i].workingexpr)&&!1===s)&&(t=!1);return!1!==t}))}_makeRelationshipEnum(t){if(t.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.indexOf("esriSpatialRelRelation")>=0?t.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(t,e,s,i,r,n,l){return this._ensureLoaded().then((()=>this.databaseType())).then((h=>{let u="",o=!1,a=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(u=n.constructClause(),a=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(a=!1,o=!0,u=this._layer.objectIdField);const c=[];for(let t=0;t<e.length;t++){const s=new T;s.onStatisticField=null!==e[t].workingexpr?k(e[t].workingexpr,h):"",s.outStatisticFieldName=e[t].field,s.statisticType=e[t].toStatisticsName(),c.push(s)}""===u&&(u=t.join(","));let f=this._maxQueryRate();const d=this._layer.capabilities.query.maxRecordCount;void 0!==d&&d<f&&(f=d);let g=null===r?null===i?"1=1":"":k(r,h);return this._layer.definitionExpression&&(g=""!==g?"(("+this._layer.definitionExpression+") AND ("+g+"))":this._layer.definitionExpression),new N([],["GETPAGES"],a,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:o,generatedOid:l,resultRecordCount:f,resultOffset:0,groupByFieldsForStatistics:t,outStatistics:c,geometry:null===i?null:i,where:g,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}_getAgregagtePhysicalPage(e,s,r){try{let s=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(s=""!==s?"("+s+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const l=e.pagesDefinition.internal.lastRetrieved,h=l,u=e.pagesDefinition.internal.lastPage,o=new v;return this._requestStandardised&&(o.sqlFormat="standard"),o.where=s,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?t([]):this.executeQuery(o,"execute").then((t=>{if(this._checkCancelled(r),!t.hasOwnProperty("features"))return i(new Error("Unnexected Result querying aggregates from layer"));const s=[];if(e.pagesDefinition.internal.lastPage!==u)return[];for(let s=0;s<t.features.length;s++)e.pagesDefinition.internal.set[h+s]=t.features[s].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<t.features.length;e++)s.push(new n({attributes:t.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=l+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s}))}catch(e){return i(e)}}static create(t,e,s,i){const r=new J({url:t,outFields:null===e?["*"]:e});return new _t({layer:r,spatialReference:s,lrucache:i})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return F(this._layer.parsedUrl.path)}queryAttachments(e,s,i,r){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const t={objectIds:[e]};return(s&&s>0||i&&i>0)&&(t.size=[s&&s>0?s:0,i&&i>0?i:s+1]),r&&r.length>0&&(t.attachmentTypes=r),this._layer.queryAttachments(t).then((t=>{const s=[];return t&&t[e]&&t[e].forEach((t=>{const i=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();s.push(new _(t.id,t.name,t.contentType,t.size,i))})),s}))}return t([])}queryRelatedFeatures(t){const e={f:"json",relationshipId:t.relationshipId.toString(),definitionExpression:t.where,outFields:t.outFields.join(","),returnGeometry:t.returnGeometry.toString()};return null!=t.resultOffset&&(e.resultOffset=t.resultOffset.toString()),null!=t.resultRecordCount&&(e.resultRecordCount=t.resultRecordCount.toString()),t.orderByFields&&(e.orderByFields=t.orderByFields.join(",")),t.objectIds.length>0&&(e.objectIds=t.objectIds.join(",")),t.outSpatialReference&&(e.outSR=JSON.stringify(t.outSpatialReference.toJSON())),h(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:e}).then((t=>{if(t.data){const e={},s=t.data;if(s&&s.relatedRecordGroups){const t=s.spatialReference;for(const i of s.relatedRecordGroups){const r=i.objectId,l=[];for(const e of i.relatedRecords){e.geometry&&(e.geometry.spatialReference=t);const s=new n({geometry:e.geometry?u(e.geometry):null,attributes:e.attributes});l.push(s)}e[r]={features:l,exceededTransferLimit:!0===s.exceededTransferLimit}}}return e}return i("Invalid Request")}))}getFeatureByObjectId(t,e){const s=new Z({url:this._layer.parsedUrl.path}),i=new v;return i.outFields=e,i.returnGeometry=!1,i.outSpatialReference=this.spatialReference,i.where=this.objectIdField+"="+t.toString(),s.execute(i).then((t=>1===t.features.length?t.features[0]:null))}getIdentityUser(){return this.load().then((()=>{var t;const e=null==(t=o)?void 0:t.findCredential(this._layer.url);return e?e.userId:null}))}getOwningSystemUrl(){return this.load().then((()=>{var e;const s=null==(e=o)?void 0:e.findServerInfo(this._layer.url);if(s)return t(s.owningSystemUrl);let i=this._layer.url;const r=i.toLowerCase().indexOf("/rest/services");return i=r>-1?i.substring(0,r):i,i?(i+="/rest/info",l((t=>{h(i,{query:{f:"json"}}).then((e=>{let s="";e.data&&e.data.owningSystemUrl&&(s=e.data.owningSystemUrl),t(s)}),(()=>{t("")}))}))):t("")}))}}class Et extends O{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,!0===t.isTable&&(this._forceIsTable=!0),void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return m}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=l(((t,e)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void t(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),t(this)}catch(t){e(t)}}),e),this._layer.load()}))),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const t=[];for(const e of this.fields)if("oid"===e.type)t.push(e);else for(const s of this._layer.outFields)if(s.toLowerCase()===e.name.toLowerCase()){t.push(e);break}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=w.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return d.InFeatureSet}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new n({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}_getFilteredSet(e,s,i,r,n){let l="",h=!1;if(null!==r&&(l=r.constructClause(),h=!0),this.isTable()&&s&&null!==e&&""!==e){const e=new N([],[],!0,null);return t(e)}const u=new v;return u.where=null===i?null===s?"1=1":"":k(i,w.Standardised),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===s?null:s,u.returnGeometry=!0,u.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(u).then((t=>{if(null===t)return new N([],[],h,null);this._checkCancelled(n);const e=[];return t.features.forEach((t=>{const s=t.attributes[this._layer.objectIdField];e.push(s),this._featureCache[s]=this._changeFeature(t)})),new N([],e,h,null)}))}_makeRelationshipEnum(t){if(t.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.indexOf("esriSpatialRelRelation")>=0?t.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return t(this._wset);const e=new v;return e.where="1=1",this._ensureLoaded().then((()=>{if(this._layer.source&&this._layer.source.items){const t=[];return this._layer.source.items.forEach((e=>{const s=e.attributes[this._layer.objectIdField];t.push(s),this._featureCache[s]=this._changeFeature(e)})),this._wset=new N([],t,!1,null),this._wset}return this._layer.queryFeatures(e).then((t=>{const e=[];return t.features.forEach((t=>{const s=t.attributes[this._layer.objectIdField];e.push(s),this._featureCache[s]=this._changeFeature(t)})),this._wset=new N([],e,!1,null),this._wset}))}))}_getFeatures(e,s,r){const n=[];-1!==s&&void 0===this._featureCache[s]&&n.push(s);for(let t=e._lastFetchedIndex;t<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&n.push(e._known[t]),n.length>r)));t++);return 0===n.length?t("success"):i(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e){return t(e)}_stat(){return t({calculated:!1})}_canDoAggregates(){return t(!1)}relationshipMetaData(){return[]}static _cloneAttr(t){const e={};for(const s in t)e[s]=t[s];return e}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(t,e){let s=t.layerDefinition.objectIdField;const i=t.layerDefinition.typeIdField?t.layerDefinition.typeIdField:"",r=[];if(t.layerDefinition.types)for(const e of t.layerDefinition.types)r.push(X.fromJSON(e));let n=t.layerDefinition.geometryType;void 0===n&&(n=t.featureSet.geometryType||"");let l=t.featureSet.features;const h=e.toJSON();if(""===s||void 0===s){let e=!1;for(const i of t.layerDefinition.fields)if("oid"===i.type||"esriFieldTypeOID"===i.type){s=i.name,e=!0;break}if(!1===e){let e="FID",i=!0,r=0;for(;i;){let s=!0;for(const i of t.layerDefinition.fields)if(i.name===e){s=!1;break}!0===s?i=!1:(r++,e="FID"+r.toString())}t.layerDefinition.fields.push({type:"esriFieldTypeOID",name:e,alias:e});const n=[];for(let s=0;s<l.length;s++)n.push({geometry:t.featureSet.features[s].geometry,attributes:t.featureSet.features[s].attributes?this._cloneAttr(t.featureSet.features[s].attributes):{}}),n[s].attributes[e]=s;l=n,s=e}}const u=[];for(const e of t.layerDefinition.fields)u.push(e instanceof E?e:E.fromJSON(e));let o=n;switch(o){case"esriGeometryPoint":o="point";break;case"esriGeometryPolyline":o="polyline";break;case"esriGeometryPolygon":o="polygon";break;case"esriGeometryExtent":o="extent";break;case"esriGeometryMultipoint":o="multipoint"}for(const t of l)t.geometry&&t.geometry instanceof a==0&&(t.geometry.type=o,void 0===t.geometry.spatialReference&&(t.geometry.spatialReference=h));const c={outFields:["*"],source:l,fields:u,types:r,typeIdField:i,objectIdField:s,spatialReference:e};c.geometryType=o||"point";const f=new J(c);return new Et({layer:f,spatialReference:e,isTable:null===o||""===o})}queryAttachments(){return t([])}getFeatureByObjectId(t){const e=new v;return e.where=this.objectIdField+"="+t.toString(),this._layer.queryFeatures(e).then((t=>1===t.features.length?t.features[0]:null))}getOwningSystemUrl(){return t("")}getIdentityUser(){return t("")}}class bt extends O{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,this._findObjectId=t.objectId,this.featureObjectId=t.objectId,this.relationship=t.relationship,this.relatedLayer=t.relatedLayer,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return m}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=l(((t,e)=>{r([this._layer.load(),this.relatedLayer.load()]).then((()=>{this._initialiseFeatureSet(),t(this)}),e)}))),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}const t=this._layer.nativeCapabilities();t&&(this._databaseType=t.databaseType,this._requestStandardised=t.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then((()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType)))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return d.InFeatureSet}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new n({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}_getFilteredSet(t,e,s,i,r){return this.databaseType().then((()=>{if(this.isTable()&&e&&null!==t&&""!==t)return new N([],[],!0,null);const n=this._layer.nativeCapabilities();if(!1===n.canQueryRelated)return new N([],[],!0,null);if(n.capabilities.queryRelated&&n.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(t,e,s,i,r);let l="",h=!1;null!==i&&n.capabilities&&n.capabilities.queryRelated&&!0===n.capabilities.queryRelated.supportsOrderBy&&(l=i.constructClause(),h=!0);const u=new H;u.objectIds=[this._findObjectId];const o=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((t=>t.name)):["*"]);u.outFields=o,u.relationshipId=this.relationship.id,u.where="1=1";let a=!0;return!0===this._removeGeometry&&(a=!1),u.returnGeometry=a,this._requestStandardised&&(u.sqlFormat="standard"),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,n.source.queryRelatedFeatures(u).then((i=>{this._checkCancelled(r);const n=i[this._findObjectId]?i[this._findObjectId].features:[],l=[];for(let t=0;t<n.length;t++)this._featureCache[n[t].attributes[this._layer.objectIdField]]=n[t],l.push(n[t].attributes[this._layer.objectIdField]);const u=e&&null!==t&&""!==t,o=null!=s;return new N(u||o?l:[],u||o?[]:l,h,null)}))}))}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.indexOf("*")>-1)return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}_getFilteredSetUsingPaging(t,e,s,r,n){try{let i="",l=!1;const h=this._layer.nativeCapabilities();return null!==r&&h&&h.capabilities.queryRelated&&!0===h.capabilities.queryRelated.supportsOrderBy&&(i=r.constructClause(),l=!0),this.databaseType().then((()=>{let r=this._maxQueryRate();const u=h.capabilities.query.maxRecordCount;void 0!==u&&u<r&&(r=u);const o=e&&null!==t&&""!==t,a=null!=s;let c=null,f=!0;!0===this._removeGeometry&&(f=!1);const d=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((t=>t.name)):["*"]);return c=new N(o||a?["GETPAGES"]:[],o||a?[]:["GETPAGES"],l,{outFields:d.join(","),resultRecordCount:r,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:i,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(c,r,0,0,n).then((()=>c))}))}catch(t){return i(t)}}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}_getPhysicalPage(t,e,s){try{const e=t.pagesDefinition.internal.lastRetrieved,i=e,r=t.pagesDefinition.internal.lastPage,n=this._layer.nativeCapabilities(),l=new H;return!0===this._requestStandardised&&(l.sqlFormat="standard"),l.relationshipId=this.relationship.id,l.objectIds=t.pagesDefinition.objectIds,l.resultOffset=t.pagesDefinition.internal.lastPage,l.resultRecordCount=t.pagesDefinition.resultRecordCount,l.outFields=t.pagesDefinition.outFields.split(","),l.where=t.pagesDefinition.where,l.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=t.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference,n.source.queryRelatedFeatures(l).then((n=>{if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return 0;const l=n[this._findObjectId]?n[this._findObjectId].features:[];for(let e=0;e<l.length;e++)t.pagesDefinition.internal.set[i+e]=l[e].attributes[this._layer.objectIdField];for(let t=0;t<l.length;t++)this._featureCache[l[t].attributes[this._layer.objectIdField]]=l[t];return l.length!==t.pagesDefinition.resultRecordCount&&(!n[this._findObjectId]||!1===n[this._findObjectId].exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=e+l.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,l.length}))}catch(t){return i(t)}}_getFeatures(e,s,r,n){const l=[];-1!==s&&void 0===this._featureCache[s]&&l.push(s);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,h))return this._expandPagedSet(e,h,0,0,n).then((()=>this._getFeatures(e,s,r,n)));let u=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(u++,u<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[t]&&void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&l.push(e._known[t]),l.length>r)))&&!(u>=r&&0===l.length);t++);return 0===l.length?t("success"):i(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,s,i){return t(e)}_stat(e,s,i,r,n,l,h){return t({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,s,i,r,n){return t(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(t,e,s,i){return this.relatedLayer.queryAttachments(t,e,s,i)}getFeatureByObjectId(t,e){return this.relatedLayer.getFeatureByObjectId(t,e)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}}function It(e,s){if(W.applicationCache){const i=W.applicationCache.getLayerInfo(e);if(i)return i.then((i=>t(new J({url:e,outFields:s,sourceJSON:i}))));const r=new J({url:e,outFields:s});let n=l(((t,e)=>{r.load().then((()=>{t(r.sourceJSON)}),(t=>{e(t)}))}));return W.applicationCache&&(W.applicationCache.setLayerInfo(e,n),n=n.catch((t=>{throw W.applicationCache.clearLayerInfo(e),t}))),n.then((()=>t(r)))}return t(new J({url:e,outFields:s}))}function At(e,s,i,r,n){return It(e,["*"]).then((e=>t(Rt(e,s,i,r,n))))}function Rt(t,e=null,s=null,i=!0,r=null){return!0===t._hasMemorySource()?new Et({layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:r}):new _t({layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:r})}function vt(e){if(null!==W.applicationCache){const t=W.applicationCache.getLayerInfo(e);if(null!==t)return t}let s=h(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const s=e.data;return s.layers||(s.layers=[]),s.tables||(s.tables=[]),t(s)}return t({layers:[],tables:[]})}));return null!==W.applicationCache&&(W.applicationCache.setLayerInfo(e,s),s=s.catch((t=>{throw W.applicationCache.clearLayerInfo(e),t}))),s}function Tt(e,s){const i={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return vt(e).then((r=>{if(i.metadata=r,r.controllerDatasetLayers&&null!=r.controllerDatasetLayers.utilityNetworkLayerId){if(r.layers)for(const t of r.layers)i.layerNameLkp[t.id]=t.name;if(r.tables)for(const t of r.tables)i.layerNameLkp[t.id]=t.name;const n=r.controllerDatasetLayers.utilityNetworkLayerId;return i.networkId=n,function(t,e){const s="QUERYDATAELEMTS:"+e.toString()+":"+t;if(null!==W.applicationCache){const t=W.applicationCache.getLayerInfo(s);if(null!==t)return t}let i=h(t+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}}).then((t=>{if(t.data){const e=t.data;if(e.layerDataElements&&e.layerDataElements[0])return e.layerDataElements[0]}throw new Error("Not Found")}));return null!==W.applicationCache&&(W.applicationCache.setLayerInfo(s,i),i=i.catch((t=>{throw W.applicationCache.clearLayerInfo(s),t}))),i}(e,n).then((r=>{if(r){i.queryelem=r,i.queryelem&&i.queryelem.dataElement&&void 0!==i.queryelem.dataElement.schemaGeneration&&(i.unVersion=i.queryelem.dataElement.schemaGeneration),i.lkp={},i.queryelem.dataElement.domainNetworks||(i.queryelem.dataElement.domainNetworks=[]);for(const t of i.queryelem.dataElement.domainNetworks){for(const e of t.edgeSources?t.edgeSources:[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:i.layerNameLkp[e.layerId]?i.layerNameLkp[e.layerId]:null};t.className&&(i.lkp[t.className]=t)}for(const e of t.junctionSources?t.junctionSources:[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:i.layerNameLkp[e.layerId]?i.layerNameLkp[e.layerId]:null};t.className&&(i.lkp[t.className]=t)}}if(i.queryelem.dataElement.terminalConfigurations)for(const t of i.queryelem.dataElement.terminalConfigurations)for(const e of t.terminals)i.terminals.push({terminalId:e.terminalId,terminalName:e.terminalName});return function(e){if(null!==W.applicationCache){const t=W.applicationCache.getLayerInfo(e);if(null!==t)return t}let s=h(e,{responseType:"json",query:{f:"json"}}).then((e=>t(e.data?e.data:null)));return null!==W.applicationCache&&(W.applicationCache.setLayerInfo(e,s),s=s.catch((t=>{throw W.applicationCache.clearLayerInfo(e),t}))),s}(e+"/"+n).then((t=>{if(t.systemLayers&&null!=t.systemLayers.associationsTableId){const r=[];return i.unVersion>=4&&(r.push("STATUS"),r.push("PERCENTALONG")),At(e+"/"+t.systemLayers.associationsTableId.toString(),s,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...r],!1,null).then((t=>t.load())).then((t=>i.unVersion>=4?(t=t.filter(I.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",t.getFieldsIndex()))).load():t)).then((t=>({lkp:i.lkp,associations:t,unVersion:i.unVersion,terminals:i.terminals})))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}function Ot(t,e,s,i=null,r=null,n=!0,l=null){let h=t.serviceUrl();return h?(h="/"===h.charAt(h.length-1)?h+e.relatedTableId.toString():h+"/"+e.relatedTableId.toString(),At(h,i,r,n,l).then((h=>new bt({layer:t,relatedLayer:h,relationship:e,objectId:s,spatialReference:i,outFields:r,includeGeometry:n,lrucache:l})))):null}tt.registerAction(),St.registerAction(),it.registerAction(),K.registerAction(),Ft.registerAction();class Nt extends ${constructor(t,e=null,s=null){super(),this._map=t,this._overridespref=e,this.lrucache=s,this._instantLayers=[]}makeAndAddFeatureSet(t,e=!0,s=null){const i=Rt(t,this._overridespref,null===s?["*"]:s,e,this.lrucache);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}featureSetByName(t,e=!0,s=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(t,e,s)}catch(t){return i(t)}}));null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const r=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const i=this._instantLayers[s];if(i.opitem.title===t&&i.includeGeometry===e&&i.outFields===r)return this.resolvePromise(this._instantLayers[s].featureset)}const n=this._map.layers.find((e=>e instanceof J&&e.title===t));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,e,s));if(this._map.tables){const i=this._map.tables.find((e=>!!(e.title&&e.title===t||e.title&&e.title===t)));if(i){if(i instanceof J)return this.resolvePromise(this.makeAndAddFeatureSet(i,e,s));if(i._materializedTable);else{const t=i.outFields?i:{...i,outFields:["*"]};i._materializedTable=new J(t)}return i._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(i._materializedTable,e,s))))}}return this.resolvePromise(null)}featureSetById(t,e=!0,s=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(t,e,s)}catch(t){return i(t)}}));null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const r=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const i=this._instantLayers[s];if(i.opitem.id===t&&i.includeGeometry===e&&i.outFields===r)return this.resolvePromise(this._instantLayers[s].featureset)}const n=this._map.layers.find((e=>e instanceof J&&e.id===t));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,e,s));if(this._map.tables){const i=this._map.tables.find((e=>e.id===t));if(i){if(i instanceof J)return this.resolvePromise(this.makeAndAddFeatureSet(i,e,s));if(i._materializedTable);else{const t={...i,outFields:["*"]};i._materializedTable=new J(t)}return i._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(i._materializedTable,e,s))))}}return this.resolvePromise(null)}}class Dt extends ${constructor(t,e=null,s=null){super(),this._url=t,this._overridespref=e,this.lrucache=s,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(t,e=!0,s=null){const i=Rt(t,this._overridespref,null===s?["*"]:s,e,this.lrucache);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}_loadMetaData(){return vt(this._url).then((t=>(this.metadata=t,t)))}load(){return this._loadMetaData()}clone(){return new Dt(this._url,this._overridespref,this.lrucache)}featureSetByName(t,e=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const r=this._instantLayers[s];if(r.opitem.title===t&&r.includeGeometry===e&&r.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}return this._loadMetaData().then((i=>{let r=null;for(const e of i.layers?i.layers:[])e.name===t&&(r=e);if(!r)for(const e of i.tables?i.tables:[])e.name===t&&(r=e);return r?It(this._url+"/"+r.id,["*"]).then((t=>this.makeAndAddFeatureSet(t,e,s))):this.resolvePromise(null)}))}featureSetById(t,e=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);t=null!=t?t.toString():"";for(let s=0;s<this._instantLayers.length;s++){const r=this._instantLayers[s];if(r.opitem.id===t&&r.includeGeometry===e&&r.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}return this._loadMetaData().then((i=>{let r=null;for(const e of i.layers?i.layers:[])null!=e.id&&e.id.toString()===t&&(r=e);if(!r)for(const e of i.tables?i.tables:[])null!=e.id&&e.id.toString()===t&&(r=e);return r?It(this._url+"/"+r.id,["*"]).then((t=>this.makeAndAddFeatureSet(t,e,s))):this.resolvePromise(null)}))}}function Pt(t,e){return null===t?e:new c({url:t.field("url")})}function kt(e,s,i){return o.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===s&&e.user&&e.user.sourceJSON&&!1===i?t(e.user.sourceJSON):""===s?h(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===i?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const s=e.data;if(s&&s.username)return t(s)}return t(null)})):h(e.restUrl+"/community/users/"+s,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const s=e.data;return s.error?null:t(s)}return t(null)})):t(null)}function Ct(e,s,r,n,h,u,o){if(W.applicationCache){const l=W.applicationCache.getLayerInfo(e+":"+u.url);if(l)return l.then((e=>{try{const i=new J({url:F(e.url)+"/"+s,outFields:["*"]});return t(Rt(i,r,n,h,o))}catch(t){return i(t)}}),(t=>i(t)))}return l(((t,i)=>{const l=new A({id:e,portal:u}).load();W.applicationCache&&W.applicationCache.setLayerInfo(e+":"+u.url,l),l.then((e=>{try{const i=new J({url:F(e.url)+"/"+s,outFields:["*"]});t(Rt(i,r,n,h,o))}catch(t){i(t)}}),(t=>{W.applicationCache&&W.applicationCache.clearLayerInfo(e+":"+u.url),i(t)}))}))}const xt=Object.freeze({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:Tt,constructFeatureSet:Rt,constructFeatureSetFromPortalItem:Ct,constructFeatureSetFromRelationship:Ot,constructFeatureSetFromUrl:At,createFeatureSetCollectionFromMap:function(t,e,s=null){return new Nt(t,e,s)},createFeatureSetCollectionFromService:function(t,e,s=null){return new Dt(t,e,s)},getPortal:Pt,initialiseMetaDataCache:function(){null===W.applicationCache&&(W.applicationCache=new W)},lookupUser:kt});export{Rt as A,ht as C,kt as E,Tt as F,$ as I,At as T,tt as _,it as a,Ct as b,Ft as c,ut as d,st as e,lt as f,Ot as g,ot as h,xt as i,Pt as v,nt as w,Et as y}