import"./p-476cf7c4.js";import{m as e,l as t,s as n,b as r,t as o,d6 as i,U as c,y as s}from"./p-dc4230e0.js";import"./p-eb53cb9f.js";import{P as a}from"./p-8f2b0eee.js";import"./p-f66098c1.js";import{x as f}from"./p-364b7145.js";import"./p-ef72a682.js";import{b as l,w as u,n as d}from"./p-ed479196.js";import{a as w,c as p,b as y}from"./p-1b868368.js";function b(){const e=new Float32Array(4);return e[3]=1,e}function h(e,t,n){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,n+0,10)),version:t.getUint16(n+10,!0),checksum:t.getUint32(n+12,!0)}}function U(e,t,n){const r=[];t=m(e,t,r);const o=[];for(let i=0;i<r.length;i++){o.length=0,t=m(e,t,o);for(let e=0;e<o.length;e++)n.push(o[e]+r[i])}return t}function m(t,n,r){const o=new DataView(t,n),i=o.getUint8(0),c=31&i,s=!!(32&i),a=(192&i)>>6;let f=0;if(0===a)f=o.getUint32(1,!0),n+=5;else if(1===a)f=o.getUint16(1,!0),n+=3;else{if(2!==a)throw new e("lepcc-decode-error","Bad count type");f=o.getUint8(1),n+=2}if(s)throw new e("lepcc-decode-error","LUT not implemented");const l=Math.ceil(f*c/8),u=new Uint8Array(t,n,l);let d=0,w=0,p=0;const y=-1>>>32-c;for(let e=0;e<f;e++){for(;w<c;)d|=u[p]<<w,w+=8,p+=1;r[e]=d&y,d>>>=c,w-=c,w+c>32&&(d|=u[p-1]>>8-w)}return n+p}Object.freeze({__proto__:null,create:b,clone:function(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},fromValues:function(e,t,n,r){const o=new Float32Array(4);return o[0]=e,o[1]=t,o[2]=n,o[3]=r,o},createView:function(e,t){return new Float32Array(e,t,4)}});const A=t.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function I(t,n,r){let o="",i=0;for(;i<r;){const c=t[n+i];if(c<128)o+=String.fromCharCode(c),i++;else if(c>=192&&c<224){if(i+1>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");o+=String.fromCharCode((31&c)<<6|63&t[n+i+1]),i+=2}else if(c>=224&&c<240){if(i+2>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");o+=String.fromCharCode((15&c)<<12|(63&t[n+i+1])<<6|63&t[n+i+2]),i+=3}else{if(!(c>=240&&c<248))throw new e("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(i+3>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const s=(7&c)<<18|(63&t[n+i+1])<<12|(63&t[n+i+2])<<6|63&t[n+i+3];o+=s>=65536?String.fromCharCode(55296+(s-65536>>10),56320+(1023&s)):String.fromCharCode(s),i+=4}}}return o}function g(e,t){const n={byteOffset:0,byteCount:0,fields:Object.create(null)};let r=0;for(let o=0;o<t.length;o++){const i=t[o],c=i.valueType||i.type;n.fields[i.property]=(0,C[c])(e,r),r+=M[c].BYTES_PER_ELEMENT}return n.byteCount=r,n}function v(e,t){return new M[t.valueType](e,t.byteOffset,t.count*t.valuesPerElement)}function B(t,n,r){if(n!==t&&A.error(`Invalid ${r} buffer size\n expected: ${t}, actual: ${n})`),n<t)throw new e("buffer-too-small","Binary buffer is too small",{expectedSize:t,actualSize:n})}const F={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};const M={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},C={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function j(e){return M.hasOwnProperty(e)}function D(e){return j(e)?M[e].BYTES_PER_ELEMENT:0}function S(t,n){if(null==t.encoding||""===t.encoding){const e=function(e,t){const n=g(e,t&&t.header);let r=n.byteCount;const o={isDraco:!1,header:n,byteOffset:n.byteCount,byteCount:0,vertexAttributes:{}},i=n.fields,c=null!=i.vertexCount?i.vertexCount:i.count;for(const e of t.ordering){if(!t.vertexAttributes[e])continue;const n={...t.vertexAttributes[e],byteOffset:r,count:c};o.vertexAttributes[F[e]?F[e]:"_"+e]=n,r+=D(n.valueType)*n.valuesPerElement*c}const s=i.faceCount;if(t.faces&&s){o.faces={};for(const e of t.ordering){if(!t.faces[e])continue;const n={...t.faces[e],byteOffset:r,count:s};o.faces[e]=n,r+=D(n.valueType)*n.valuesPerElement*s}}const a=i.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&a){o.featureAttributes={};for(const e of t.featureAttributeOrder){if(!t.featureAttributes[e])continue;const n={...t.featureAttributes[e],byteOffset:r,count:a};o.featureAttributes[e]=n,r+=("UInt64"===n.valueType?8:D(n.valueType))*n.valuesPerElement*a}}return B(r,e.byteLength,"geometry"),o.byteCount=r-o.byteOffset,o}(n,t);if(o(e.vertexAttributes.position))return;const r=v(n,e.vertexAttributes.position),i=e.header.fields,c=[i.offsetX,i.offsetY,i.offsetZ],s=[i.scaleX,i.scaleY,i.scaleZ],a=r.length/3,f=new Float64Array(3*a);for(let e=0;e<a;e++)f[3*e]=r[3*e]*s[0]+c[0],f[3*e+1]=r[3*e+1]*s[1]+c[1],f[3*e+2]=r[3*e+2]*s[2]+c[2];return f}if("lepcc-xyz"===t.encoding)return function(t){const n=new DataView(t,0);let r=0;const{identifier:o,version:i}=h(t,n,r);if(r+=16,"LEPCC     "!==o)throw new e("lepcc-decode-error","Bad identifier");if(i>1)throw new e("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),minX:e.getFloat64(t+8,!0),minY:e.getFloat64(t+16,!0),minZ:e.getFloat64(t+24,!0),maxX:e.getFloat64(t+32,!0),maxY:e.getFloat64(t+40,!0),maxZ:e.getFloat64(t+48,!0),errorX:e.getFloat64(t+56,!0),errorY:e.getFloat64(t+64,!0),errorZ:e.getFloat64(t+72,!0),count:e.getUint32(t+80,!0),reserved:e.getUint32(t+84,!0)}}(n,r);if(r+=88,c.sizeHi*Math.pow(2,32)+c.sizeLo!==t.byteLength)throw new e("lepcc-decode-error","Bad size");const s=new Float64Array(3*c.count),a=[],f=[],l=[],u=[];if(r=U(t,r,a),r=U(t,r,f),r=U(t,r,l),r=U(t,r,u),r!==t.byteLength)throw new e("lepcc-decode-error","Bad length");let d=0,w=0;for(let e=0;e<a.length;e++){w+=a[e];let t=0;for(let n=0;n<f[e];n++){t+=l[d];const e=u[d];s[3*d]=Math.min(c.maxX,c.minX+2*c.errorX*t),s[3*d+1]=Math.min(c.maxY,c.minY+2*c.errorY*w),s[3*d+2]=Math.min(c.maxZ,c.minZ+2*c.errorZ*e),d++}}return{errorX:c.errorX,errorY:c.errorY,errorZ:c.errorZ,result:s}}(n).result}function z(t,o,i){return r(t)&&t.attributeInfo.useElevation?function(e,t){const n=new Float64Array(t);for(let r=0;r<t;r++)n[r]=e[3*r+2];return n}(o,i):r(t)?function(t,r,o){if("lepcc-rgb"===t.encoding)return function(t){const n=new DataView(t,0);let r=0;const{identifier:o,version:i}=h(t,n,r);if(r+=16,"ClusterRGB"!==o)throw new e("lepcc-decode-error","Bad identifier");if(i>1)throw new e("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),colorMapCount:e.getUint16(t+12,!0),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}(n,r);if(r+=16,c.sizeHi*Math.pow(2,32)+c.sizeLo!==t.byteLength)throw new e("lepcc-decode-error","Bad size");if((2===c.lookupMethod||1===c.lookupMethod)&&0===c.compressionMethod){if(3*c.colorMapCount+c.count+r!==t.byteLength||c.colorMapCount>256)throw new e("lepcc-decode-error","Bad count");const n=new Uint8Array(t,r,3*c.colorMapCount),o=new Uint8Array(t,r+3*c.colorMapCount,c.count),i=new Uint8Array(3*c.count);for(let e=0;e<c.count;e++){const t=o[e];i[3*e]=n[3*t],i[3*e+1]=n[3*t+1],i[3*e+2]=n[3*t+2]}return i}if(0===c.lookupMethod&&0===c.compressionMethod){if(3*c.count+r!==t.byteLength||0!==c.colorMapCount)throw new e("lepcc-decode-error","Bad count");return new Uint8Array(t,r).slice()}if(c.lookupMethod<=2&&1===c.compressionMethod){if(r+3!==t.byteLength||1!==c.colorMapCount)throw new e("lepcc-decode-error","Bad count");const o=n.getUint8(r),i=n.getUint8(r+1),s=n.getUint8(r+2),a=new Uint8Array(3*c.count);for(let e=0;e<c.count;e++)a[3*e]=o,a[3*e+1]=i,a[3*e+2]=s;return a}throw new e("lepcc-decode-error","Bad method "+c.lookupMethod+","+c.compressionMethod)}(r);if("lepcc-intensity"===t.encoding)return function(t){const n=new DataView(t,0);let r=0;const{identifier:o,version:i}=h(t,n,r);if(r+=16,"Intensity "!==o)throw new e("lepcc-decode-error","Bad identifier");if(i>1)throw new e("lepcc-decode-error","Unknown version");const c=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),scaleFactor:e.getUint16(t+12,!0),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}(n,r);if(r+=16,c.sizeHi*Math.pow(2,32)+c.sizeLo!==t.byteLength)throw new e("lepcc-decode-error","Bad size");const s=new Uint16Array(c.count);if(8===c.bitsPerPoint){if(c.count+r!==t.byteLength)throw new e("lepcc-decode-error","Bad size");const n=new Uint8Array(t,r,c.count);for(let e=0;e<c.count;e++)s[e]=n[e]*c.scaleFactor}else if(16===c.bitsPerPoint){if(2*c.count+r!==t.byteLength)throw new e("lepcc-decode-error","Bad size");const n=new Uint16Array(t,r,c.count);for(let e=0;e<c.count;e++)s[e]=n[e]*c.scaleFactor}else{const n=[];if(m(t,r,n)!==t.byteLength)throw new e("lepcc-decode-error","Bad size");for(let e=0;e<c.count;e++)s[e]=n[e]*c.scaleFactor}return s}(r);if(null!=t.encoding&&""!==t.encoding)throw new e("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");t["attributeByteCounts "]&&!t.attributeByteCounts&&(A.warn("Warning: Trailing space in 'attributeByteCounts '."),t.attributeByteCounts=t["attributeByteCounts "]),"ObjectIds"===t.ordering[0]&&t.hasOwnProperty("objectIds")&&(A.warn("Warning: Case error in objectIds"),t.ordering[0]="objectIds");const i=function(t,r,o){const i=null!=r.header?g(t,r.header):{byteOffset:0,byteCount:0,fields:{count:o}},c={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)};let s=i.byteCount;for(let t=0;t<r.ordering.length;t++){const o=r.ordering[t],a=n(r[o]);if(a.count=i.fields.count,"String"===a.valueType){if(a.byteOffset=s,a.byteCount=i.fields[o+"ByteCount"],"UTF-8"!==a.encoding)throw new e("unsupported-encoding","Unsupported String encoding.",{encoding:a.encoding})}else{if(!j(a.valueType))throw new e("unsupported-value-type","Unsupported binary valueType",{valueType:a.valueType});{const e=D(a.valueType);s+=s%e!=0?e-s%e:0,a.byteOffset=s,a.byteCount=e*a.valuesPerElement*a.count}}s+=a.byteCount,c.entries[o]=a}return c.byteCount=s-c.byteOffset,c}(r,t,o);B(i.byteOffset+i.byteCount,r.byteLength,"attribute");const c=i.entries.attributeValues||i.entries.objectIds;if(c){if("String"===c.valueType){const t=i.entries.attributeByteCounts,n=v(r,t),o=function(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}(r,c);return function(t,n,r){const o=[];let i,c,s=0;for(c=0;c<t;c+=1){if(i=n[c],i>0){if(o.push(I(r,s,i-1)),0!==r[s+i-1])throw new e("string-array-error","Invalid string array: missing null termination.")}else o.push(null);s+=i}return o}(t.count,n,o)}return v(r,c)}throw new e("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}(t.attributeInfo.storageInfo,t.buffer,i):null}function O(e){return null==e||"none"===e?null:"low-four-bit"===e?e=>15&e:"high-four-bit"===e?e=>(240&e)>>4:"absolute-value"===e?e=>Math.abs(e):"modulo-ten"===e?e=>e%10:null}function V(e){let t=0;for(const n of e||[])t|=1<<n;return t}class k{transform(e){const t=this._transform(e),n=[t.points.buffer,t.rgb.buffer];r(t.pointIdFilterMap)&&n.push(t.pointIdFilterMap.buffer);for(const e of t.attributes)"buffer"in e.values&&i(e.values.buffer)&&e.values.buffer!==t.rgb.buffer&&n.push(e.values.buffer);return c({result:t,transferList:n})}_transform(e){const t=S(e.schema,e.geometryBuffer);let n=t.length/3,o=null;const i=[],c=z(e.primaryAttributeData,t,n);r(e.primaryAttributeData)&&c&&i.push({attributeInfo:e.primaryAttributeData.attributeInfo,values:c});const a=z(e.modulationAttributeData,t,n);r(e.modulationAttributeData)&&a&&i.push({attributeInfo:e.modulationAttributeData.attributeInfo,values:a});let f=function(e,t,n,r){const{rendererJSON:o,isRGBRenderer:i}=e;let c=null,s=null;if(t&&i)c=t;else if(t&&"pointCloudUniqueValueRenderer"===o.type){s=w.fromJSON(o);const e=s.colorUniqueValueInfos;c=new Uint8Array(3*r);const n=O(s.fieldTransformType);for(let o=0;o<r;o++){const r=(n?n(t[o]):t[o])+"";for(let t=0;t<e.length;t++)if(e[t].values.indexOf(r)>=0){c[3*o]=e[t].color.r,c[3*o+1]=e[t].color.g,c[3*o+2]=e[t].color.b;break}}}else if(t&&"pointCloudStretchRenderer"===o.type){s=p.fromJSON(o);const e=s.stops;c=new Uint8Array(3*r);const n=O(s.fieldTransformType);for(let o=0;o<r;o++){const r=n?n(t[o]):t[o],i=e.length-1;if(r<e[0].value)c[3*o]=e[0].color.r,c[3*o+1]=e[0].color.g,c[3*o+2]=e[0].color.b;else if(r>=e[i].value)c[3*o]=e[i].color.r,c[3*o+1]=e[i].color.g,c[3*o+2]=e[i].color.b;else for(let t=1;t<e.length;t++)if(r<e[t].value){const n=(r-e[t-1].value)/(e[t].value-e[t-1].value);c[3*o]=e[t].color.r*n+e[t-1].color.r*(1-n),c[3*o+1]=e[t].color.g*n+e[t-1].color.g*(1-n),c[3*o+2]=e[t].color.b*n+e[t-1].color.b*(1-n);break}}}else if(t&&"pointCloudClassBreaksRenderer"===o.type){s=y.fromJSON(o);const e=s.colorClassBreakInfos;c=new Uint8Array(3*r);const n=O(s.fieldTransformType);for(let o=0;o<r;o++){const r=n?n(t[o]):t[o];for(let t=0;t<e.length;t++)if(r>=e[t].minValue&&r<=e[t].maxValue){c[3*o]=e[t].color.r,c[3*o+1]=e[t].color.g,c[3*o+2]=e[t].color.b;break}}}else{c=new Uint8Array(3*r);for(let e=0;e<c.length;e++)c[e]=255}if(n&&s&&s.colorModulation){const e=s.colorModulation.minValue,t=s.colorModulation.maxValue,o=.3;for(let i=0;i<r;i++){const r=n[i],s=r>=t?1:r<=e?o:o+(1-o)*(r-e)/(t-e);c[3*i]=s*c[3*i],c[3*i+1]=s*c[3*i+1],c[3*i+2]=s*c[3*i+2]}}return c}(e.rendererInfo,c,a,n);if(e.filterInfo&&e.filterInfo.length>0&&r(e.filterAttributesData)){const r=e.filterAttributesData.map((e=>{const r=z(e,t,n),o={attributeInfo:e.attributeInfo,values:r};return i.push(o),o}));o=new Uint32Array(n),n=function(e,t,n,r,o){const i=e.length/3;let c=0;for(let s=0;s<i;s++){let i=!0;for(let e=0;e<r.length&&i;e++){const{filterJSON:t}=r[e],n=o[e].values[s];switch(t.type){case"pointCloudValueFilter":{const e="exclude"===t.mode;-1!==t.values.indexOf(n)===e&&(i=!1);break}case"pointCloudBitfieldFilter":{const e=V(t.requiredSetBits),r=V(t.requiredClearBits);(n&e)===e&&0==(n&r)||(i=!1);break}case"pointCloudReturnFilter":{const e=15&n,r=n>>>4&15,o=r>1,c=1===e,s=e===r;let a=!1;for(const e of t.includedReturns)if("last"===e&&s||"firstOfMany"===e&&c&&o||"lastOfMany"===e&&s&&o||"single"===e&&!o){a=!0;break}a||(i=!1);break}}}i&&(n[c]=s,e[3*c]=e[3*s],e[3*c+1]=e[3*s+1],e[3*c+2]=e[3*s+2],t[3*c]=t[3*s],t[3*c+1]=t[3*s+1],t[3*c+2]=t[3*s+2],c++)}return c}(t,f,o,e.filterInfo,r)}for(const r of e.userAttributesData){const e=z(r,t,n);i.push({attributeInfo:r.attributeInfo,values:e})}3*n<f.length&&(f=new Uint8Array(f.buffer.slice(0,3*n))),this._applyElevationOffsetInPlace(t,n,e.elevationOffset);const l=this._transformCoordinates(t,n,e.obb,s.fromJSON(e.inSR),s.fromJSON(e.outSR));return{obb:e.obb,points:l,rgb:f,attributes:i,pointIdFilterMap:o}}_transformCoordinates(e,t,n,r,o){if(!f(e,r,0,e,o,0,t))throw Error("Can't reproject");const i=l(n.center[0],n.center[1],n.center[2]),c=d(),s=d();u(x,n.quaternion);const w=new Float32Array(3*t);for(let r=0;r<t;r++)c[0]=e[3*r]-i[0],c[1]=e[3*r+1]-i[1],c[2]=e[3*r+2]-i[2],a(s,c,x),n.halfSize[0]=Math.max(n.halfSize[0],Math.abs(s[0])),n.halfSize[1]=Math.max(n.halfSize[1],Math.abs(s[1])),n.halfSize[2]=Math.max(n.halfSize[2],Math.abs(s[2])),w[3*r]=c[0],w[3*r+1]=c[1],w[3*r+2]=c[2];return w}_applyElevationOffsetInPlace(e,t,n){if(0!==n)for(let r=0;r<t;r++)e[3*r+2]+=n}}const x=b();function T(){return new k}export default T;