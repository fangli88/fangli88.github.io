import"./p-476cf7c4.js";import{M as t,D as e,K as r,b as s}from"./p-ab028778.js";import"./p-73b795c3.js";import"./p-e07a8dfe.js";import{y as n}from"./p-89accc4e.js";import"./p-65bdc41d.js";import{p as o}from"./p-381be496.js";(()=>{if(!("document"in t))return()=>null;const e=document.createElement("canvas");e.getContext("2d");e.height=512,e.width=1})();let i=class extends o{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(t,e){const r=e.schema.processors[0];"heatmap"===r.type&&n(this._schema,r)&&(t.mesh=!0,this._schema=r)}onTileUpdate(t){for(const e of t.removed)this._tileKeyToFeatureSets.delete(e.key.id)}async onTileData(t,e,r){this._tileKeyToFeatureSets.has(t.key.id)&&"replace"!==e.type||this._tileKeyToFeatureSets.set(t.key.id,new Map);const n=this._tileKeyToFeatureSets.get(t.key.id);s(e.addOrUpdate)&&n.set(e.addOrUpdate.instance,e);let o=e.end;if(n.forEach((t=>o=o||t.end)),!o)return;const i=[];n.forEach((t=>{s(t.addOrUpdate)&&i.push(t.addOrUpdate)}));const a=function(t,e,r,s){const{blurRadius:n,fieldOffset:o,field:i}=e,a=new Float64Array(r*s),c=function(t){const e=Math.round(3*t),r=2*t*t,s=new Float64Array(2*e+1);for(let n=0;n<=s.length;n++)s[n]=Math.exp(-Math.pow(n-e,2)/r)/Math.sqrt(2*Math.PI)*(t/2);return s}(n),l=Math.round(3*n);let f,p=Number.NEGATIVE_INFINITY;const h=function(t,e){return null!=t?"string"==typeof e?e=>-1*+e.readAttribute(t):r=>+r.readAttribute(t)+e:()=>1}(i,o),u=new Set;for(const e of t){const t=e.getCursor();for(;t.next();){const e=t.getObjectId();if(u.has(e))continue;u.add(e);const n=t.readLegacyPointGeometry(),o=+h(t),i=n.x-l,m=n.y-l,d=Math.max(0,i),M=Math.max(0,m),y=Math.min(s,n.y+l),b=Math.min(r,n.x+l);for(let t=M;t<y;t++){const e=c[t-m];for(let s=d;s<b;s++)f=a[t*r+s]+=e*c[s-i]*o,f>p&&(p=f)}}}return{matrix:a.buffer,max:p}}(i,this._schema.mesh,512,512);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.key.id,intensityInfo:a},{...r,transferList:[a.matrix]})}onTileError(t,e,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},r)}};i=e([r("esri.views.2d.layers.features.processors.HeatmapProcessor")],i);var a=i;export default a;