import{D as t,E as s,w as e,b9 as i,F as n,aU as r,cB as h,cX as o,K as a,L as c,bi as u,p as l,b as f,bJ as d,bK as p,bh as y,z as g,cR as w,a8 as m,ay as b,k as v,aB as M,aD as x,bP as _,aY as S,aX as I,dU as A,t as F,l as T,m as C,i as R,aC as k,aR as E,U as O,dV as q,dW as j,dX as D,d as N,ar as P,dy as L,M as G,bM as U,ae as z,dY as B,h as X,cz as Y,b1 as V,y as $,dZ as H,d_ as W,di as Z,d$ as Q}from"./p-dc4230e0.js";import"./p-643e1e47.js";import{e as J,t as K,a as tt}from"./p-ebb65ba7.js";import{D as st,e as et,J as it,Q as nt,g as rt,i as ht,K as ot,n as at,o as ct,B as ut,p as lt,I as ft}from"./p-78c83631.js";import{n as dt}from"./p-7b4a37d3.js";import{$ as pt}from"./p-76e49c46.js";import"./p-b415e09b.js";import{m as yt}from"./p-6e5ff36c.js";import{v as gt}from"./p-6a7ee25c.js";import{t as wt}from"./p-7fc65112.js";import{x as mt}from"./p-26546f88.js";import{u as bt}from"./p-5f01bb6f.js";import{a as vt,R as Mt}from"./p-aedb886e.js";import{G as xt}from"./p-78ce4926.js";import{r as _t}from"./p-eb53cb9f.js";import{n as St,h as It,c as At,e as Ft,a as Tt,r as Ct}from"./p-dfd483d8.js";import{s as Rt}from"./p-a1a69fdc.js";import{y as kt,p as Et,a as Ot}from"./p-1f2c53c6.js";import{o as qt}from"./p-725a886f.js";import{F as jt,g as Dt}from"./p-0e87baef.js";import{r as Nt}from"./p-80a59d87.js";import{d as Pt,y as Lt}from"./p-90bfedb8.js";import{i as Gt,g as Ut,f as zt,b as Bt}from"./p-592ab3f4.js";import{B as Xt,p as Yt,l as Vt,r as $t,a as Ht,D as Wt}from"./p-c855175e.js";import{b as Zt}from"./p-f2688ff7.js";import{d as Qt}from"./p-6c319af5.js";import{n as Jt,s as Kt,c as ts,h as ss,d as es,M as is}from"./p-28285148.js";import{e as ns}from"./p-5dd47a31.js";import{s as rs}from"./p-42ae9f69.js";import{N as hs,O as os,K as as,c as cs,J as us,o as ls}from"./p-f6aca36e.js";var fs;let ds=fs=class extends c{constructor(...t){super(...t),this.position=new e([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(t,s,e,i){if(t&&"object"==typeof t&&("x"in t||Array.isArray(t))){const n={position:t};return null!=s&&(n.heading=s),null!=e&&(n.tilt=e),null!=i&&(n.fov=i),n}return t}writePosition(t,s,e,i){const n=t.clone();n.x=h(t.x||0),n.y=h(t.y||0),n.z=t.hasZ?h(t.z||0):t.z,s[e]=n.write(null,i)}readPosition(t,s){const i=new e;return i.read(t,s),i.x=h(i.x||0),i.y=h(i.y||0),i.z=i.hasZ?h(i.z||0):i.z,i}equals(t){return!!t&&this.tilt===t.tilt&&this.heading===t.heading&&this.fov===t.fov&&this.position.equals(t.position)}clone(){return new fs({position:this.position.clone(),heading:this.heading,tilt:this.tilt,fov:this.fov})}};t([s({type:e,json:{write:{isRequired:!0}}})],ds.prototype,"position",void 0),t([i("position")],ds.prototype,"writePosition",null),t([n("position")],ds.prototype,"readPosition",null),t([s({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),r((t=>Xt.normalize(h(t))))],ds.prototype,"heading",void 0),t([s({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),r((t=>o(h(t),-180,180)))],ds.prototype,"tilt",void 0),t([s({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],ds.prototype,"fov",void 0),ds=fs=t([a("esri.Camera")],ds);var ps,ys=ds;let gs=ps=class extends c{constructor(t){super(t),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(t){return(t%=360)<0&&(t+=360),t}clone(){return new ps({rotation:this.rotation,scale:this.scale,targetGeometry:f(this.targetGeometry)?this.targetGeometry.clone():null,camera:f(this.camera)?this.camera.clone():null})}};function ws(){return{enabled:!this.camera}}t([s({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:ws}}}}})],gs.prototype,"rotation",void 0),t([r("rotation")],gs.prototype,"castRotation",null),t([s({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:ws}}}}})],gs.prototype,"scale",void 0),t([s({types:u,json:{read:l,write:!0,origins:{"web-scene":{read:l,write:{overridePolicy:ws}}}}})],gs.prototype,"targetGeometry",void 0),t([s({type:ys,json:{write:!0}})],gs.prototype,"camera",void 0),gs=ps=t([a("esri.Viewpoint")],gs);var ms=gs;function bs(t,s){return s.type?$t(t,s.x,s.y):Ht(t,s)}Object.freeze({__proto__:null,create:function(){return[1,0,0,1,0,0]},clone:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},fromValues:function(t,s,e,i,n,r){return[t,s,e,i,n,r]},createView:function(t,s){return new Float64Array(t,s,6)}});const vs=function(){const t=Jt();return function(s,e,i){const n=e.targetGeometry;bs(t,n);const r=.5*Ms(e);return s.xmin=t[0]-r*i[0],s.ymin=t[1]-r*i[1],s.xmax=t[0]+r*i[0],s.ymax=t[1]+r*i[1],s.spatialReference=n.spatialReference,s}}();function Ms(t){return t.scale*(f(s=t.targetGeometry)&&d(s.spatialReference)?1/(39.37*p(s.spatialReference)*96):1);var s}const xs=function(){const t=Jt(),s=Jt(),e=Jt();return function(i,n,r,h,o,a){return Yt(t,n),Vt(s,r,.5*a),$t(e,1/h*a,-1/h*a),St(i),It(i,i,s),o&&At(i,i,o),Ft(i,i,e),It(i,i,t),i}}(),_s=function(){const t=Jt();return function(s,e,i,n){const r=Ms(e),h=function(t){return _t(t.rotation)||0}(e);return bs(t,e.targetGeometry),xs(s,t,i,r,h,n)}}(),Ss=function(){const t=Jt();return function(s,e,i,n){const r=Ms(e);return bs(t,e.targetGeometry),xs(s,t,i,r,0,n)}}();function Is(){const t=new Float32Array(9);return t[0]=1,t[4]=1,t[8]=1,t}function As(){return new Float32Array(2)}function Fs(t,s){const e=new Float32Array(2);return e[0]=t,e[1]=s,e}function Ts(){return As()}function Cs(){return Fs(1,1)}function Rs(){return Fs(1,0)}function ks(){return Fs(0,1)}Object.freeze({__proto__:null,create:Is,clone:function(t){const s=new Float32Array(9);return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s},fromValues:function(t,s,e,i,n,r,h,o,a){const c=new Float32Array(9);return c[0]=t,c[1]=s,c[2]=e,c[3]=i,c[4]=n,c[5]=r,c[6]=h,c[7]=o,c[8]=a,c},createView:function(t,s){return new Float32Array(t,s,9)}});const Es=Ts(),Os=Cs(),qs=Rs(),js=ks();var Ds;function Ns(t){return function(t){return t instanceof Float32Array&&t.length>=2}(t)||function(t){return Array.isArray(t)&&t.length>=2}(t)}Object.freeze({__proto__:null,create:As,clone:function(t){const s=new Float32Array(2);return s[0]=t[0],s[1]=t[1],s},fromValues:Fs,createView:function(t,s){return new Float32Array(t,s,2)},zeros:Ts,ones:Cs,unitX:Rs,unitY:ks,ZEROS:Es,ONES:Os,UNIT_X:qs,UNIT_Y:js});const Ps=[0,0];let Ls=Ds=class extends c{constructor(...t){super(...t),this._viewpoint2D={center:Jt(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new g,this.id=0,this.inverseTransform=[1,0,0,1,0,0],this.resolution=0,this.rotation=0,this.scale=0,this.transform=[1,0,0,1,0,0],this.transformNoRotation=[1,0,0,1,0,0],this.displayMat3=Is(),this.displayViewMat3=Is(),this.viewMat3=Is(),this.viewMat2d=Tt(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const s=this._viewpoint2D,e=t.targetGeometry;s.center[0]=e.x,s.center[1]=e.y,s.rotation=t.rotation,s.scale=t.scale,s.spatialReference=e.spatialReference}this._update()}copy(t){const s=this.size,e=this.viewpoint;return e&&s?(this.viewpoint=function(t,s){const e=t.targetGeometry,i=s.targetGeometry;return e.x=i.x,e.y=i.y,e.spatialReference=i.spatialReference,t.scale=s.scale,t.rotation=s.rotation,t}(e,t.viewpoint),this._set("size",Ht(s,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Ds({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,s,e){return Ns(s)?Wt(t,s,this.inverseTransform):(Ps[0]=s,Ps[1]=e,Wt(t,Ps,this.inverseTransform))}toScreen(t,s,e){return Ns(s)?Wt(t,s,this.transform):(Ps[0]=s,Ps[1]=e,Wt(t,Ps,this.transform))}toScreenNoRotation(t,s,e){return Ns(s)?Wt(t,s,this.transformNoRotation):(Ps[0]=s,Ps[1]=e,Wt(t,Ps,this.transformNoRotation))}getScreenTransform(t,s){const{center:e}=this._viewpoint2D,i=this._get("pixelRatio")||1,n=this._get("size");return xs(t,e,n,s,0,i),t}_update(){const{center:t,spatialReference:s,scale:i,rotation:n}=this._viewpoint2D,r=this._get("pixelRatio")||1,h=this._get("size"),o=new ms({targetGeometry:new e(t[0],t[1],s),scale:i,rotation:n});if(this._set("viewpoint",o),!h||!s||!i)return;this.resolution=Ms(o),this.rotation=n,this.scale=i,this.spatialReference=s,Ht(this.center,t),Kt(this.displayMat3,0!==h[0]?2/h[0]:0,0,0,0,0!==h[1]?-2/h[1]:0,0,-1,1,1);const a=ts(this.viewMat3),c=Fs(h[0]/2,h[1]/2),u=Fs(-h[0]/2,-h[1]/2),l=_t(n);ss(a,a,c),es(a,a,l),ss(a,a,u),is(this.displayViewMat3,this.displayMat3,a);const f=St(this.viewMat2d);return It(f,f,c),At(f,f,l),It(f,f,u),vs(this.extent,o,h),_s(this.transform,o,h,r),Ct(this.inverseTransform,this.transform),Ss(this.transformNoRotation,o,h,r),this.worldScreenWidth=function(t,s){return Math.round(function(t){if(t.isWrappable){const s=y(t);return s.valid[1]-s.valid[0]}return 0}(t)/s)}(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};t([s({readOnly:!0})],Ls.prototype,"id",void 0),t([s({value:1,json:{write:!0}})],Ls.prototype,"pixelRatio",null),t([s({json:{write:!0}})],Ls.prototype,"size",null),t([s({type:ms,json:{write:!0}})],Ls.prototype,"viewpoint",null),Ls=Ds=t([a("esri.views.2d.ViewState")],Ls);var Gs=Ls;function Us(t,s){return[t,s]}function zs(t,s,e){return t[0]=s,t[1]=e,t}const Bs=new ns("0/0/0/0");class Xs{constructor(t,s,e,i,n,r,h,o,a,c,u,l){this.level=t,this.resolution=s,this.scale=e,this.origin=i,this.first=n,this.last=r,this.size=h,this.norm=o,this.worldStart=a,this.worldEnd=c,this.worldSize=u,this.wrap=l}static create(t,s,e){const i=y(t.spatialReference),n=Us(t.origin.x,t.origin.y),r=Us(t.size[0]*s.resolution,t.size[1]*s.resolution),h=Us(-1/0,-1/0),o=Us(1/0,1/0),a=Us(1/0,1/0);let c,u,l,f;return e&&(zs(h,Math.max(0,Math.floor((e.xmin-n[0])/r[0])),Math.max(0,Math.floor((n[1]-e.ymax)/r[1]))),zs(o,Math.max(0,Math.floor((e.xmax-n[0])/r[0])),Math.max(0,Math.floor((n[1]-e.ymin)/r[1]))),zs(a,o[0]-h[0]+1,o[1]-h[1]+1)),t.isWrappable?(c=Us(Math.ceil(Math.round((i.valid[1]-i.valid[0])/s.resolution)/t.size[0]),a[1]),u=Us(Math.floor((i.origin[0]-n[0])/r[0]),h[1]),l=Us(c[0]+u[0]-1,o[1]),f=!0):(u=h,l=o,c=a,f=!1),new Xs(s.level,s.resolution,s.scale,n,h,o,a,r,u,l,c,f)}normalizeCol(t){if(!this.wrap)return t;const s=this.worldSize[0];return t<0?s-1-Math.abs((t+1)%s):t%s}denormalizeCol(t,s){return this.wrap?this.worldSize[0]*s+t:t}getWorldForColumn(t){return this.wrap?Math.floor(t/this.worldSize[0]):0}getFirstColumnForWorld(t){return t*this.worldSize[0]+this.first[0]}getLastColumnForWorld(t){return t*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(t){return(t-this.origin[0])/this.norm[0]}getXForColumn(t){return this.origin[0]+t*this.norm[0]}getRowForY(t){return(this.origin[1]-t)/this.norm[1]}getYForRow(t){return this.origin[1]-t*this.norm[1]}getTileBounds(t,s,e=!1){Bs.set(s);const i=e?Bs.col:this.denormalizeCol(Bs.col,Bs.world),n=Bs.row;return function(t,s,e,i,n){t[0]=s,t[1]=e,t[2]=i,t[3]=n}(t,this.getXForColumn(i),this.getYForRow(n+1),this.getXForColumn(i+1),this.getYForRow(n)),t}getTileCoords(t,s,e=!1){Bs.set(s);const i=e?Bs.col:this.denormalizeCol(Bs.col,Bs.world);return Array.isArray(t)?zs(t,this.getXForColumn(i),this.getYForRow(Bs.row)):(t.x=this.getXForColumn(i),t.y=this.getYForRow(Bs.row)),t}}class Ys{constructor(){this.spans=[]}acquire(t){this.lodInfo=t}release(){this.lodInfo=null,this.spans.length=0}forEach(t,s){const{spans:e,lodInfo:i}=this,{level:n}=i;if(0!==e.length)for(const{row:r,colFrom:h,colTo:o}of e)for(let e=h;e<=o;e++)t.call(s,n,r,i.normalizeCol(e),i.getWorldForColumn(e))}}Ys.pool=new w(Ys);class Vs{constructor(t,s,e){this.row=t,this.colFrom=s,this.colTo=e}}const $s=new ns("0/0/0/0");class Hs{constructor(t,s,e,i,n,r,h,o){this.x=t,this.ymin=s,this.ymax=e,this.invM=i,this.leftAdjust=n,this.rightAdjust=r,this.leftBound=h,this.rightBound=o}static create(t,s){t[1]>s[1]&&([t,s]=[s,t]);const[e,i]=t,[n,r]=s,h=n-e,o=r-i,a=0!==o?h/o:0,c=(Math.ceil(i)-i)*a,u=(Math.floor(i)-i)*a;return new Hs(e,Math.floor(i),Math.ceil(r),a,h<0?c:u,h<0?u:c,h<0?n:e,h<0?e:n)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const Ws=[[0,0],[0,0],[0,0],[0,0]];class Zs{constructor(t,s){this.tileInfo=t,this.fullExtent=s,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const e=t.lods.slice();e.sort((function(t,s){return s.scale-t.scale}));const i=this._lodInfos=e.map((e=>Xs.create(t,e,s)));e.forEach(((t,s)=>{this._infoByLevel[t.level]=i[s],this._infoByScale[t.scale]=i[s],this.scales[s]=t.scale}),this),this._wrap=t.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(t){return this._infoByLevel["number"==typeof t?t:t.level]}getTileBounds(t,s,e=!1){$s.set(s);const i=this._infoByLevel[$s.level];return i?i.getTileBounds(t,$s,e):t}getTileCoords(t,s,e=!1){$s.set(s);const i=this._infoByLevel[$s.level];return i?i.getTileCoords(t,$s,e):t}getTileCoverage(t,s=192,e="closest"){const i="closest"===e?this.getClosestInfoForScale(t.scale):this.getSmallestInfoForScale(t.scale),n=Ys.pool.acquire(i),r=this._wrap;let h,o,a,c=1/0,u=-1/0;const l=n.spans;Ws[0][0]=Ws[0][1]=Ws[1][1]=Ws[3][0]=-s,Ws[1][0]=Ws[2][0]=t.size[0]+s,Ws[2][1]=Ws[3][1]=t.size[1]+s;for(const s of Ws)t.toMap(s,s),s[0]=i.getColumnForX(s[0]),s[1]=i.getRowForY(s[1]);const f=[];let d=3;for(let t=0;t<4;t++){if(Ws[t][1]===Ws[d][1]){d=t;continue}const s=Hs.create(Ws[t],Ws[d]);c=Math.min(s.ymin,c),u=Math.max(s.ymax,u),void 0===f[s.ymin]&&(f[s.ymin]=[]),f[s.ymin].push(s),d=t}if(null==c||null==u||u-c>100)return null;let p=[];for(h=c;h<u;){null!=f[h]&&(p=p.concat(f[h])),o=1/0,a=-1/0;for(let t=p.length-1;t>=0;t--){const s=p[t];o=Math.min(o,s.getLeftCol()),a=Math.max(a,s.getRightCol())}if(o=Math.floor(o),a=Math.floor(a),h>=i.first[1]&&h<=i.last[1])if(r)if(i.size[0]<i.worldSize[0]){const t=Math.floor(a/i.worldSize[0]);for(let s=Math.floor(o/i.worldSize[0]);s<=t;s++)l.push(new Vs(h,Math.max(i.getFirstColumnForWorld(s),o),Math.min(i.getLastColumnForWorld(s),a)))}else l.push(new Vs(h,o,a));else o>i.last[0]||a<i.first[0]||(o=Math.max(o,i.first[0]),a=Math.min(a,i.last[0]),l.push(new Vs(h,o,a)));h+=1;for(let t=p.length-1;t>=0;t--){const s=p[t];s.ymax>=h?s.incrRow():p.splice(t,1)}}return n}getTileParentId(t){$s.set(t);const s=this._lodInfos.indexOf(this._infoByLevel[$s.level])-1;return s<0?null:(this._getTileIdAtLOD($s,this._lodInfos[s],$s),$s.id)}getTileResolution(t){const s=this._infoByLevel["object"==typeof t?t.level:t];return s?s.resolution:-1}getTileScale(t){const s=this._infoByLevel[t.level];return s?s.scale:-1}intersects(t,s){$s.set(s);const e=this._infoByLevel[$s.level],i=t.lodInfo;if(i.resolution>e.resolution){this._getTileIdAtLOD($s,i,$s);const s=i.denormalizeCol($s.col,$s.world);for(const e of t.spans)if(e.row===$s.row&&e.colFrom<=s&&e.colTo>=s)return!0}if(i.resolution<e.resolution){const[s,n,r,h]=t.spans.reduce(((t,s)=>(t[0]=Math.min(t[0],s.row),t[1]=Math.max(t[1],s.row),t[2]=Math.min(t[2],s.colFrom),t[3]=Math.max(t[3],s.colTo),t)),[1/0,-1/0,1/0,-1/0]),o=e.denormalizeCol($s.col,$s.world),a=i.getColumnForX(e.getXForColumn(o)),c=i.getRowForY(e.getYForRow($s.row)),u=i.getColumnForX(e.getXForColumn(o+1))-1,l=i.getRowForY(e.getYForRow($s.row+1))-1;return!(a>h||u<r||c>n||l<s)}const n=i.denormalizeCol($s.col,$s.world);return t.spans.some((t=>t.row===$s.row&&t.colFrom<=n&&t.colTo>=n))}normalizeBounds(t,s,e){if(t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],this._wrap){const s=y(this.tileInfo.spatialReference),i=-e*(s.valid[1]-s.valid[0]);t[0]+=i,t[2]+=i}return t}getSmallestInfoForScale(t){const s=this.scales;if(this._infoByScale[t])return this._infoByScale[t];if(t>s[0])return this._infoByScale[s[0]];for(let e=1;e<s.length-1;e++)if(t>s[e]+1e-6)return this._infoByScale[s[e-1]];return this._infoByScale[s[s.length-1]]}getClosestInfoForScale(t){const s=this.scales;return this._infoByScale[t]||(t=s.reduce(((s,e)=>Math.abs(e-t)<Math.abs(s-t)?e:s),s[0])),this._infoByScale[t]}scaleToLevel(t){const s=this.scales;if(this._infoByScale[t])return this._infoByScale[t].level;for(let e=s.length-1;e>=0;e--)if(t<s[e])return e===s.length-1?this._infoByScale[s[s.length-1]].level:this._infoByScale[s[e]].level+(s[e]-t)/(s[e]-s[e+1]);return this._infoByScale[s[0]].level}scaleToZoom(t){return this.tileInfo.scaleToZoom(t)}_getTileIdAtLOD(t,s,e){const i=this._infoByLevel[e.level];return t.set(e),s.resolution<i.resolution?null:(s.resolution===i.resolution||(t.level=s.level,t.col=Math.floor(e.col*i.resolution/s.resolution+.01),t.row=Math.floor(e.row*i.resolution/s.resolution+.01)),t)}}class Qs{constructor(t,s){this.key=new ns(0,0,0,0),this.bounds=wt(),this.objectIds=new Set,this.key.set(s);const e=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=e.resolution,this.scale=e.scale,this.level=e.level,this.needsClear=!0}get id(){return this.key.id}get extent(){return g.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}get bbox(){const t=this.bounds;return{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}}clone(){return new Qs(this.tileInfoView,this.key)}createChildTiles(){const t=this.key.getChildKeys(),s=m.acquire();for(let e=0;e<t.length;e++)s[e]=new Qs(this.tileInfoView,t[e]);return s}getQuantizationParameters(){return vt.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}const Js={added:[],removed:[]},Ks=new Set,te=new ns(0,0,0,0);class se extends b{constructor(t){super(),this._tiles=new Map,this._index=Gt(9,v("csp-restrictions")?t=>({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=t}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(t){return this._tiles.has(t)}get(t){return this._tiles.get(t)}findByKey(t){return this._tiles.get(t.id)}intersections(t,s){const e="string"==typeof t?this.get(t):t;if(!e)return[];const i=s*e.resolution,n=e.bounds[0]-i,r=e.bounds[1]-i,h=e.bounds[2]+i,o=e.bounds[3]+i,a=[];for(const t of this._index.search({minX:n,minY:r,maxX:h,maxY:o})){const s=t.bounds.slice();s[0]=Math.max(s[0],n),s[1]=Math.max(s[1],r),s[2]=Math.min(s[2],h),s[3]=Math.min(s[3],o),s[2]-s[0]>0&&s[3]-s[1]>0&&a.push({bounds:s,tile:t})}return a}boundsIntersections(t){return this._index.search({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]})}updateTiles(t){const s={added:[],removed:[]};for(const e of t.added)if(!this.has(e)){const t=new Qs(this.tileScheme,e);this._tiles.set(e,t),this._index.insert(t),s.added.push(t)}for(const e of t.removed)if(this.has(e)){const t=this.get(e);this._tiles.delete(e),this._index.remove(t),s.removed.push(t)}this.tiles.length=0,this._tiles.forEach((t=>this.tiles.push(t))),(s.added.length||s.removed.length)&&this.emit("update",s)}setViewState(t){const s=this.tileScheme.getTileCoverage(t,0);if(!s)return;const{spans:e,lodInfo:i}=s,{level:n}=i;if(e.length>0)for(const{row:t,colFrom:s,colTo:r}of e)for(let e=s;e<=r;e++){const s=te.set(n,t,i.normalizeCol(e),i.getWorldForColumn(e)).id;if(Ks.add(s),!this.has(s)){const t=new Qs(this.tileScheme,s);this._tiles.set(s,t),this._index.insert(t),this.tiles.push(t),Js.added.push(t)}}for(let t=this.tiles.length-1;t>=0;t--){const s=this.tiles[t];Ks.has(s.id)||(this._tiles.delete(s.id),this.tiles.splice(t,1),this._index.remove(s),Js.removed.push(s))}(Js.added.length||Js.removed.length)&&this.emit("update",Js),Ys.pool.release(s),Ks.clear(),Js.added.length=0,Js.removed.length=0}}class ee{constructor(){this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(t){const s=new ee;for(const e in t){const i=t[e];if("object"==typeof i)for(const t in i)s[e][t]=i[t];s[e]=i}return s}static empty(){return ee.create({})}static all(){return ee.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let t=0,s="";if(this.mesh){t+=20,s+="-> (20) Mesh needs update\n";for(const t of this.why.mesh)s+=`    + ${t}\n`}if(this.source){t+=10,s+="-> (10) The source needs update\n";for(const t of this.why.source)s+=`    + ${t}\n`}this.targets.feature&&(t+=5,s+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(t+=5,s+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(t+=4,s+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(t+=1,s+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${t<5?"Fastest":t<10?"Fast":t<15?"Moderate":t<20?"Slow":"Very Slow"} update of cost ${t}/45 `),console.debug(s)}toJSON(){return{source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh,queryFilter:this.queryFilter}}}class ie extends dt{constructor(t,s,e){super(t),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=e,this._features=s}static fromFeatures(t,s,e){const i=st([],t,s,!1,!1,e);for(let s=0;s<i.length;s++)i[s].displayId=t[s].displayId;return ie.fromOptimizedFeatures(i,s)}static fromFeatureSet(t,s){const e=et(t,s);return ie.fromOptimizedFeatureSet(e)}static fromOptimizedFeatureSet(t){const{features:s,geometryType:e}=t,i=ie.fromOptimizedFeatures(s,e);i._exceededTransferLimit=t.exceededTransferLimit,i._transform=t.transform;for(const s of t.fields)"esriFieldTypeDate"===s.type&&i._dateFields.add(s.name);return i}static fromOptimizedFeatures(t,s,e){const i=dt.createInstance(),n=new ie(i,t,s);return n._transform=e,n}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}getApproximateSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let t="";for(const s in this._current.attributes)t+=this._current.attributes[s];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t}getGroupId(){return this._current.groupId}setGroupId(t){this._current.groupId=t}copy(){const t=new ie(this.instance,this._features,this.geometryType);return this.copyInto(t),t}next(){if(!this._hasFilter)return++this._featureIndex<this._features.length;for(;++this._featureIndex<this._features.length&&!this._passesFilter(););return this._featureIndex<this._features.length}readLegacyFeature(){return it(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){const t=this.readGeometry();return t?{x:t.coords[0],y:t.coords[1]}:null}readLegacyGeometry(){const t=this.readGeometry();return nt(t,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const t=this.readCentroid();return t?{x:t.coords[0],y:t.coords[1]}:null}readGeometryArea(){return rt(this._current.geometry,2)}readUnquantizedGeometry(){const t=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!t)return t;const s=t.clone();return function({coords:t,lengths:s}){let e=0;for(const i of s){for(let s=1;s<i;s++)t[2*(e+s)]+=t[2*(e+s)-2],t[2*(e+s)+1]+=t[2*(e+s)-1];e+=i}}(s),s}readHydratedGeometry(){const t=this._current.geometry;if(!t)return null;const s=t.clone();return ht(s,s,this.hasZ,this.hasM,this._transform),s}getXHydrate(){const t=this._current.geometry.coords[0]+this._tx,s=this.getQuantizationTransform();return t*s.scale[0]+s.translate[0]}getYHydrate(){const t=this._current.geometry.coords[1]+this._ty,s=this.getQuantizationTransform();return s.translate[1]-t*s.scale[1]}readGeometry(){if(!this._current.hasGeometry)return null;const t=this._current.geometry.clone();if(t.isPoint)return t.coords[0]+=this._tx,t.coords[1]+=this._ty,t;let s=0;for(const e of t.lengths)t.coords[2*s]+=this._tx,t.coords[2*s+1]+=this._ty,s+=e;return t}readCentroid(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){const t=this._computeCentroid();if(!t)return null;t.coords[0]-=this._tx,t.coords[1]-=this._ty,this._current.centroid=t}const t=this._current.centroid.clone();return t.coords[0]+=this._tx,t.coords[1]+=this._ty,t}_readAttribute(t,s){const e=this._current.attributes[t];if(void 0!==e)return s&&this._dateFields.has(t)?new Date(e):e;const i=this.readAttributes(),n=t.toLocaleLowerCase().trim();for(const t in i)if(t.toLocaleLowerCase().trim()===n){const s=this._current.attributes[t];return this._dateFields.has(t)?new Date(s):s}}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}_passesFilter(){if(!this._hasFilter)return!0;let t=0,s=0;switch(this.geometryType){case"esriGeometryPoint":{const e=this._current.geometry;if(!e)return!1;[t,s]=e.coords;break}case"esriGeometryPolygon":{const e=this.readCentroid();if(!e)return!1;[t,s]=e.coords,t-=this._tx,s-=this._ty;break}default:return!1}return t>=this._xmin&&t<=this._xmax&&s>=this._ymin&&s<=this._ymax}}class ne{constructor(t,s){this.item=t,this.controller=s,this.promise=null}}class re{constructor(t){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,t.concurrency&&(this.concurrency=t.concurrency),this._queue=new rs(t.peeker),this.process=t.process;const s=t.scheduler;t.task&&f(s)&&(this._task=s.registerTask(t.task,(t=>this.update(t)),(()=>this.needsUpdate())))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(t){const s=this._controllers.get(t);s&&s.abort()}clear(){this._queue.clear();const t=[];this._controllers.forEach((s=>t.push(s))),this._controllers.clear(),t.forEach((t=>t.abort())),this._processingItems.clear(),this._cancelNext()}forEach(t){this._deferreds.forEach(((s,e)=>t(e)))}get(t){const s=this._deferreds.get(t);return s?s.promise:void 0}isOngoing(t){return this._processingItems.has(t)}has(t){return this._deferreds.has(t)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(t,s){const e=this.get(t);if(e)return e;let i;const n=M();let r=null;s&&(r=x(s,(()=>n.abort())));const h=()=>{o.remove(),f(r)&&r.remove(),this._deferreds.delete(t),this._controllers.delete(t),this._queue.remove(t),this._processingItems.delete(t),this._scheduleNext()},o=_(n.signal,(()=>{const s=this._processingItems.get(t);s&&s.controller.abort(),h(),i.reject(S())}));return i=I(),this._deferreds.set(t,i),this._controllers.set(t,n),i.promise.then(h,h),this._queue.push(t),this._scheduleNext(),i.promise}reset(){const t=[];this._processingItems.forEach((s=>t.push(s))),this._processingItems.clear();for(const s of t)this._queue.push(s.item),s.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const t=[];for(;this._queue.length;)t.push(this._queue.pop());return this.clear(),t}needsUpdate(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}update(t){for(;!t.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),t.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=A((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(t,s){this._canProcessFulfillment(t)&&(this._scheduleNext(),this._deferreds.get(t.item).resolve(s))}_processError(t,s){this._canProcessFulfillment(t)&&(this._scheduleNext(),this._deferreds.get(t.item).reject(s))}_canProcessFulfillment(t){return!!this._deferreds.get(t.item)&&this._processingItems.get(t.item)===t}_process(t){if(F(t))return;let s;const e=M(),i=new ne(t,e);this._processingItems.set(t,i);try{s=this.process(t,e.signal)}catch(t){this._processError(i,t)}var n;(n=s)&&"function"==typeof n.then?(i.promise=s,s.then((t=>this._processResult(i,t)),(t=>this._processError(i,t)))):this._processResult(i,s)}get test(){return{update:t=>this.update(t)}}}var he,oe,ae,ce,ue,le,fe;!function(t){t[t.FILL=0]="FILL",t[t.LINE=1]="LINE",t[t.MARKER=2]="MARKER",t[t.TEXT=3]="TEXT",t[t.LABEL=4]="LABEL"}(he||(he={})),function(t){t[t.SUCCEEDED=0]="SUCCEEDED",t[t.FAILED_OUT_OF_MEMORY=1]="FAILED_OUT_OF_MEMORY"}(oe||(oe={})),function(t){t[t.NONE=0]="NONE",t[t.MAP=1]="MAP",t[t.LABEL=2]="LABEL",t[t.LABEL_ALPHA=4]="LABEL_ALPHA",t[t.HITTEST=8]="HITTEST",t[t.HIGHLIGHT=16]="HIGHLIGHT",t[t.CLIP=32]="CLIP",t[t.DEBUG=64]="DEBUG",t[t.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(ae||(ae={})),function(t){t[t.SIZE=0]="SIZE",t[t.COLOR=1]="COLOR",t[t.OPACITY=2]="OPACITY",t[t.ROTATION=3]="ROTATION"}(ce||(ce={})),function(t){t[t.NONE=0]="NONE",t[t.OPACITY=1]="OPACITY",t[t.COLOR=2]="COLOR",t[t.ROTATION=4]="ROTATION",t[t.SIZE_MINMAX_VALUE=8]="SIZE_MINMAX_VALUE",t[t.SIZE_SCALE_STOPS=16]="SIZE_SCALE_STOPS",t[t.SIZE_FIELD_STOPS=32]="SIZE_FIELD_STOPS",t[t.SIZE_UNIT_VALUE=64]="SIZE_UNIT_VALUE"}(ue||(ue={})),function(t){t[t.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",t[t.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",t[t.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",t[t.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(le||(le={})),function(t){t[t.SPRITE=0]="SPRITE",t[t.GLYPH=1]="GLYPH"}(fe||(fe={}));class de{constructor(){this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}acquire(t,s,e,i,n,r,h,o,a){this.color=t,this.haloColor=s,this.haloSize=e,this.size=i,this.angle=n,this.offsetX=r,this.offsetY=h,this.hAnchor=o,this.vAnchor=a}release(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}de.pool=new w(de);const pe=T.getLogger("esri.views.2d.engine.webgl.Utils");function ye(t){const s={};for(const e of t)s[e.name]=e.strideInBytes;return s}const ge=ye([{name:"geometry",strideInBytes:32,divisor:0}]),we=ye([{name:"geometry",strideInBytes:32,divisor:0}]),me=ye([{name:"geometry",strideInBytes:12,divisor:0}]),be=ye([{name:"geometry",strideInBytes:36,divisor:0}]),ve=ye([{name:"geometry",strideInBytes:32,divisor:0}]),Me=ye([{name:"geometry",strideInBytes:36,divisor:0}]);function xe(t,s){switch(t){case he.MARKER:return ge;case he.FILL:return s?me:we;case he.LINE:return be;case he.TEXT:return ve;case he.LABEL:return Me}}function _e(t){switch(t%4){case 0:case 2:return 4;case 1:case 3:return 1}}function Se(t,s){switch(s%4){case 0:case 2:return new Uint32Array(t);case 1:case 3:return new Uint8Array(t)}}function Ie(t){return"number"==typeof t}function Ae(t,s){switch(t){case"butt":return 0;case"round":return s?2:1;case"square":return 2;default:return pe.error(new C("mapview-invalid-type",`Cap type ${t} is not a valid option. Defaulting to round`)),1}}function Fe(t){switch(t){case"miter":return 2;case"bevel":return 0;case"round":return 1;default:return pe.error(new C("mapview-invalid-type",`Join type ${t} is not a valid option. Defaulting to round`)),1}}function Te(t){switch(t){case 5121:return Uint8Array;case 32819:return Uint16Array;case 5126:return Float32Array;default:return void pe.error(new C("webgl-utils",`Unable to handle type ${t}`))}}const Ce=T.getLogger("esri.views.2d.engine.webgl");function Re(t){return Ie(t.minDataValue)&&Ie(t.maxDataValue)&&null!=t.minSize&&null!=t.maxSize?ue.SIZE_MINMAX_VALUE:(t.expression&&"view.scale"===t.expression||t.valueExpression&&"$view.scale"===t.valueExpression)&&Array.isArray(t.stops)?ue.SIZE_SCALE_STOPS:(null!=t.field||t.expression&&"view.scale"!==t.expression||t.valueExpression&&"$view.scale"!==t.valueExpression)&&(Array.isArray(t.stops)||"levels"in t&&t.levels)?ue.SIZE_FIELD_STOPS:(null!=t.field||t.expression&&"view.scale"!==t.expression||t.valueExpression&&"$view.scale"!==t.valueExpression)&&null!=t.valueUnit?ue.SIZE_UNIT_VALUE:(Ce.error(new C("mapview-bad-type","Found invalid size VisualVariable",t)),ue.NONE)}const ke=T.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Ee=()=>null,Oe=t=>(2147483648&t)>>>31,qe=t=>2147483647&t;function je(t){return 1===Oe(t)}const De={sharedArrayBuffer:v("esri-shared-array-buffer"),atomics:v("esri-atomics")};function Ne(t,s){return e=>s(t(e))}class Pe{constructor(t,s,e,i){this.size=0,this.texelSize=4;const{pixelType:n,layout:r,textureOnly:h}=i;this.textureOnly=h||!1,this.pixelType=n,this._ctype=s,this.layout=r,this._resetRange(),this._shared=t,this.size=e,h||(this.data=this._initData(n,e,t,s))}get buffer(){return D(this.data,(t=>t.buffer))}unsetComponentAllTexels(t,s){const e=N(this.data);for(let i=0;i<this.size*this.size;i++)e[i*this.texelSize+t]&=~s;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(t,s){const e=N(this.data);for(let i=0;i<this.size*this.size;i++)e[i*this.texelSize+t]|=255&s;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(t,s,e){const i=N(this.data);for(const n of e)i[n*this.texelSize+t]|=s,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)}setComponentTexel(t,s,e){N(this.data)[e*this.texelSize+t]|=s,this.dirtyStart=Math.min(this.dirtyStart,e),this.dirtyEnd=Math.max(this.dirtyEnd,e)}unsetComponentTexel(t,s,e){N(this.data)[e*this.texelSize+t]&=~s,this.dirtyStart=Math.min(this.dirtyStart,e),this.dirtyEnd=Math.max(this.dirtyEnd,e)}getData(t,s){const e=qe(t);return N(this.data)[e*this.texelSize+s]}setData(t,s,e){const i=qe(t);0!=(this.layout&1<<s)?(this.data[i*this.texelSize+s]=e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)):ke.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){5121===this.pixelType&&this._shared&&De.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){5121===this.pixelType&&this._shared&&De.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(t){if(this.size=t,!this.textureOnly){const s=this._initData(this.pixelType,t,this._shared,this._ctype),e=N(this.data);s.set(e),this.data=s}}toMessage(){const t=this.dirtyStart,s=this.dirtyEnd,e=this.texelSize;if(t>s)return null;this._resetRange();const i=!(this._shared||"local"===this._ctype),n=this.pixelType,r=this.layout,h=N(this.data);return h.slice?{start:t,end:s,data:i&&h.slice(t*e,(s+1)*e)||null,pixelType:n,layout:r}:i?{start:t,end:s,data:new(Te(this.pixelType))(Array.prototype.slice.call(this.data,t*e,(s+1)*e)),pixelType:n,layout:r}:{start:t,end:s,data:null,pixelType:n,layout:r}}_initData(t,s,e,i){const n=e&&"local"!==i?SharedArrayBuffer:ArrayBuffer,r=Te(t),h=new r(new n(s*s*4*r.BYTES_PER_ELEMENT));for(let t=0;t<h.length;t+=4)h[t+1]=255;return h}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class Le{constructor(t,s){this._client=t,this.config=s,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(hs),this._targetType=0,this._abortController=M(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const e=s.supportsTextureFloat?5126:5121;Ee(`Creating AttributeStore ${De.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:e,layout:15},{pixelType:e,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(t,s){this.config=s;const e=s.schema.processors[0].storage,i=kt(this._schema,e);if((t.targets.feature||t.targets.aggregate)&&(t.storage.data=!0),i&&(v("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",i),t.storage.data=!0,this._schema=e,this._attributeComputeMap.clear(),!F(e))){switch(e.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}for(const t of e.mapping)this._bindAttribute(t)}}onTileData(t,s){if(F(s.addOrUpdate))return;const e=s.addOrUpdate.getCursor();for(;e.next();){const t=e.getDisplayId();this.setAttributeData(t,e)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=M()}async setHighlight(t,s){const e=this._getBlock(0),i=s.map((t=>qe(t)));e.lock(),e.unsetComponentAllTexels(0,1),e.setComponent(0,1,i),e.unlock(),this._idsToHighlight.clear();for(const s of t)this._idsToHighlight.add(s);await this.sendUpdates()}async updateFilters(t,s){const{config:e,service:i,spatialReference:n}=s,{filters:r}=e,h=r.map(((t,s)=>this._updateFilter(t,s,i,n)));(await R(h)).some((t=>t))&&(t.storage.filters=!0,v("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))}setData(t,s,e,i){const n=qe(t);this._ensureSizeForTexel(n),this._getBlock(s).setData(t,e,i)}getData(t,s,e){return this._getBlock(s).getData(t,e)}getHighlightFlag(t){return this._idsToHighlight.has(t)?os:0}unsetAttributeData(t){const s=qe(t);this._getBlock(0).setData(s,0,0)}setAttributeData(t,s){const e=qe(t);if(this._ensureSizeForTexel(e),this._getBlock(0).setData(e,0,this.getFilterFlags(s)),this._targetType!==Oe(t))return;const i=this._attributeComputeMap,n=this.config.supportsTextureFloat?1:2;i.size&&i.forEach(((t,i)=>{const r=i*n%4,h=Math.floor(i*n/4),a=this._getBlock(h+as),c=t(s);if(this.config.supportsTextureFloat)a.setData(e,r,c);else if(c===cs)a.setData(e,r,255),a.setData(e,r+1,255);else{const t=o(Math.round(c),-32767,32766)+32768,s=(65280&t)>>8;a.setData(e,r,255&t),a.setData(e,r+1,s)}}))}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=k(),this._nextUpdate.promise;const t={blocks:this._blocks.map((t=>f(t)?t.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const s=()=>{if(this._currUpdate=null,this._nextUpdate){const t=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>t.resolve()))}},e=this._client.update(t,this._signal).then(s).catch(s);return this._client.render(this._signal),e})).catch((t=>E(t)?(this._createResourcesPromise=null,this._createResources()):(ke.error(new C("mapview-attribute-store","Encountered an error during client update",t)),O()))),this._currUpdate}_ensureSizeForTexel(t){for(;t>=this._size*this._size;)if(this._expand())return}_bindAttribute(t){let s;if(null!=t.fieldIndex)t.normalizationField&&ke.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),s=s=>s.getComputedNumericAtIndex(t.fieldIndex);else{if(!t.field)return;s=t.normalizationField?s=>{const e=s.readAttribute(t.normalizationField);return e?s.readAttribute(t.field)/e:null}:s=>s.readAttribute(t.field)}t.valueRepresentation&&(s=Ne(s,(s=>function(t,s){if(!t||!s)return t;switch(s){case"radius":case"distance":return 2*t;case"diameter":case"width":return t;case"area":return Math.sqrt(t)}return t}(s,t.valueRepresentation)))),this._attributeComputeMap.set(t.binding,Ne(s,(t=>null===t||isNaN(t)||t===1/0?cs:t)))}_createResources(){if(f(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(us),Ee("Initializing AttributeStore");const t={shared:De.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:q(this._blocks,(t=>({textureOnly:t.textureOnly,buffer:t.buffer,pixelType:t.pixelType})))},s=this._client.initialize(t,this._signal).catch((t=>{E(t)?this._createResourcesPromise=null:ke.error(new C("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=s,s.then((()=>F(this._createResourcesPromise)?this._createResources():void 0)),s}_getBlock(t){const s=this._blocks[t];if(f(s))return s;Ee(`Initializing AttributeBlock at index ${t}`);const e=new Pe(De.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[t]);return this._blocks[t]=e,this._createResourcesPromise=null,e}_expand(){if(this._size<this.config.maxTextureSize){const t=this._size<<=1;return Ee("Expanding block size to",t,this._blocks),j(this._blocks,(s=>s.expand(t))),this._createResourcesPromise=null,this._size=t,0}return ke.error(new C("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}async _updateFilter(t,s,e,i){const n=this._filters[s],r=f(n)&&n.hash;if(!n&&!t)return!1;if(r===JSON.stringify(t))return!1;if(F(t)){const t=1<<s+1,e=this._getBlock(0);return this._filters[s]=null,e.setComponentAllTexels(0,t),this.sendUpdates(),!0}const h=await this._getFilter(s,e);return await h.update(t,i),!0}async _getFilter(t,s){const e=this._filters[t];if(f(e))return e;const{default:i}=await import("./p-4230e345.js"),n=new i({geometryType:s.geometryType,hasM:!1,hasZ:!1,timeInfo:s.timeInfo,fieldsIndex:new Rt(s.fields)});return this._filters[t]=n,n}isVisible(t){return!!(2&this._getBlock(0).getData(t,0))}getFilterFlags(t){let s=0;const e=(i=t.getDisplayId(),1===Oe(i)?254:255);var i;for(let i=0;i<this._filters.length;i++){const n=this._filters[i];s|=(e&1<<i&&!F(n)&&!n.check(t)?0:1)<<i}let n=0;if(this._idsToHighlight.size){const s=t.getObjectId();n=this.getHighlightFlag(s)}return s<<1|n}}class Ge{constructor(){this._freeIds=[],this._idCounter=1}createId(t=!1){return function(t,s){return((s?2147483648:0)|t)>>>0}(this._getFreeId(),t)}releaseId(t){this._freeIds.push(t)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}class Ue{constructor(t,s){this._mask=0,this._buf=t,this._mask=s}static fromBuffer(t,s){return new Ue(t,s)}static create(t,s=4294967295){const e=new Uint32Array(Math.ceil(t/32));return new Ue(e,s)}_getIndex(t){return Math.floor(t/32)}has(t){const s=this._mask&t;return!!(this._buf[this._getIndex(s)]&1<<s%32)}set(t){const s=this._mask&t,e=this._getIndex(s);this._buf[e]|=1<<s%32}unset(t){const s=this._mask&t,e=this._getIndex(s);this._buf[e]&=4294967295^1<<s%32}resize(t){const s=this._buf,e=new Uint32Array(Math.ceil(t/32));e.set(s),this._buf=e}or(t){for(let s=0;s<this._buf.length;s++)this._buf[s]|=t._buf[s];return this}and(t){for(let s=0;s<this._buf.length;s++)this._buf[s]&=t._buf[s];return this}xor(t){for(let s=0;s<this._buf.length;s++)this._buf[s]^=t._buf[s];return this}ior(t){for(let s=0;s<this._buf.length;s++)this._buf[s]|=~t._buf[s];return this}iand(t){for(let s=0;s<this._buf.length;s++)this._buf[s]&=~t._buf[s];return this}ixor(t){for(let s=0;s<this._buf.length;s++)this._buf[s]^=~t._buf[s];return this}any(){for(let t=0;t<this._buf.length;t++)if(this._buf[t])return!0;return!1}copy(t){for(let s=0;s<this._buf.length;s++)this._buf[s]=t._buf[s];return this}clone(){return new Ue(this._buf.slice(),this._mask)}clear(){for(let t=0;t<this._buf.length;t++)this._buf[t]=0}forEachSet(t){for(let s=0;s<this._buf.length;s++){let e=this._buf[s],i=32*s;if(e)for(;e;)1&e&&t(i),e>>>=1,i++}}countSet(){let t=0;return this.forEachSet((()=>{t++})),t}}function ze(t,s,e){if(!(t.length>s))for(;t.length<=s;)t.push(e)}class Be{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new Ge,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const t=this._bitsets.length;return this._bitsets.push(Ue.create(this._allocatedSize,2147483647)),t+1}getBitset(t){return this._bitsets[t-1]}_expand(){this._allocatedSize<<=1;for(const t of this._bitsets)t.resize(this._allocatedSize)}_ensureNumeric(t,s){this._numerics[t]||(this._numerics[t]=[]),ze(this._numerics[t],s,0)}_ensureInstanceId(t){ze(this._instanceIds,t,0)}_ensureString(t,s){this._strings[t]||(this._strings[t]=[]),ze(this._strings[t],s,null)}createDisplayId(t=!1){const s=this._idGenerator.createId();return s>this._allocatedSize&&this._expand(),((t,s)=>((s?2147483648:0)|t)>>>0)(s,t)}releaseDisplayId(t){for(const s of this._bitsets)s.unset(t);return this._idGenerator.releaseId(2147483647&t)}getComputedNumeric(t,s){return this.getComputedNumericAtIndex(2147483647&t,0)}setComputedNumeric(t,s,e){return this.setComputedNumericAtIndex(2147483647&t,e,0)}getComputedString(t,s){return this.getComputedStringAtIndex(2147483647&t,0)}setComputedString(t,s,e){return this.setComputedStringAtIndex(2147483647&t,0,e)}getComputedNumericAtIndex(t,s){const e=2147483647&t;return this._ensureNumeric(s,e),this._numerics[s][e]}setComputedNumericAtIndex(t,s,e){const i=2147483647&t;this._ensureNumeric(s,i),this._numerics[s][i]=e}getInstanceId(t){const s=2147483647&t;return this._ensureInstanceId(s),this._instanceIds[s]}setInstanceId(t,s){const e=2147483647&t;this._ensureInstanceId(e),this._instanceIds[e]=s}getComputedStringAtIndex(t,s){const e=2147483647&t;return this._ensureString(s,e),this._strings[s][e]}setComputedStringAtIndex(t,s,e){const i=2147483647&t;this._ensureString(s,i),this._strings[s][i]=e}getXMin(t){return this._bounds[4*(2147483647&t)]}getYMin(t){return this._bounds[4*(2147483647&t)+1]}getXMax(t){return this._bounds[4*(2147483647&t)+2]}getYMax(t){return this._bounds[4*(2147483647&t)+3]}setBounds(t,s){const e=s.readHydratedGeometry();if(!e||!e.coords.length)return!1;let i=1/0,n=1/0,r=-1/0,h=-1/0;e.forEachVertex(((t,s)=>{i=Math.min(i,t),n=Math.min(n,s),r=Math.max(r,t),h=Math.max(h,s)}));const o=2147483647&t;return ze(this._bounds,4*o+4,0),this._bounds[4*o]=i,this._bounds[4*o+1]=n,this._bounds[4*o+2]=r,this._bounds[4*o+3]=h,!0}}const Xe=import("./p-52a67528.js");class Ye{constructor(t,s){this._canCacheExpressionValue=!1,this._sourceInfo=t,this._bitsets={computed:s.getBitset(s.createBitset())}}async updateSchema(t,s){const e=kt(this._schema,s);if(this._schema=s,!s||F(e)||!Et(e,"attributes"))return;v("esri-2d-update-debug")&&console.debug("Applying Update - Store:",e),this._bitsets.computed.clear(),t.targets[s.name]=!0;const i=s.attributes,n=[],r=[];for(const t in i){const s=i[t];switch(s.type){case"field":break;case"expression":n.push(this._createArcadeComputedField(s));break;case"label-expression":n.push(this._createLabelArcadeComputedField(s));break;case"statistic":r.push(s)}}this._computedFields=await R(n),this._canCacheExpressionValue=!this._computedFields.some((t=>"expression"===t.type&&t.expression.referencesScale())),this._statisticFields=r}setComputedAttributes(t,s,e,i){const n=this._bitsets.computed;if(!this._canCacheExpressionValue||!n.has(e)){n.set(e);for(const n of this._computedFields){const r=this._evaluateField(s,n,i);switch(n.resultType){case"numeric":t.setComputedNumericAtIndex(e,n.fieldIndex,r);break;case"string":t.setComputedStringAtIndex(e,n.fieldIndex,r)}}}}async _createArcadeComputedField(t){const s=this._sourceInfo.spatialReference,e=this._sourceInfo.fieldsIndex;return{...t,expression:await P(t.valueExpression,s,e)}}async _createLabelArcadeComputedField(t){const s=this._sourceInfo.spatialReference,e=this._sourceInfo.fields,{createLabelFunction:i}=await Xe,n=await i(t.label,e,s);return{...t,builder:n}}_evaluateField(t,s,e){switch(s.type){case"label-expression":{const e=t.readArcadeFeature();return s.builder.evaluate(e)||""}case"expression":{const{expression:i}=s;return function(t,s,e){t.referencesGeometry();const i=s.readArcadeFeature();try{return t.evaluate({...e,$feature:i})}catch(t){return T.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",t),null}}(i,t,{$view:{scale:e}})}}}}function Ve(t){return(4294901760&t)>>>16}function $e(t){return 65535&t}const He={getObjectId:t=>t.getObjectId(),getAttributes:t=>t.readAttributes(),getAttribute:(t,s)=>t.readAttribute(s),cloneWithGeometry:t=>t,getGeometry:t=>t.readHydratedGeometry(),getCentroid:t=>t.readCentroid()};class We extends Ye{constructor(t,s){super(t,s),this.featureAdapter=He,this.events=new b,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._index=Gt(9,(t=>({minX:this._storage.getXMin(t),minY:this._storage.getYMin(t),maxX:this._storage.getXMax(t),maxY:this._storage.getYMax(t)})))}get storeStatistics(){return{featureCount:0,vertexCount:0}}onTileData(t,s,e){if(F(s.addOrUpdate))return s;this._featureSetsByInstance.set(s.addOrUpdate.instance,s.addOrUpdate),this._storage=e,s.addOrUpdate._storage=e;const i=s.addOrUpdate.getCursor();for(;i.next();){const s=i.getObjectId(),n=i.instance<<16|i.getIndex();let r=this._objectIdToDisplayId.get(s);r||(r=e.createDisplayId(),this._objectIdToDisplayId.set(s,r),this._spatialIndexInvalid=!0),i.setDisplayId(r),e.setInstanceId(r,n),this.setComputedAttributes(e,i,r,t.scale)}return"update"===s.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),s}forEach(t){this._objectIdToDisplayId.forEach((s=>{const e=this._storage.getInstanceId(s),i=this._lookupFeature(e);t(i)}))}forEachUnsafe(t){this._objectIdToDisplayId.forEach((s=>{const e=this._storage.getInstanceId(s),i=Ve(e),n=$e(e),r=this._getFeatureSet(i);r.setIndex(n),t(r)}))}forEachInBounds(t,s){const e=this._searchIndex(t);for(const t of e){const e=this.lookupFeatureByDisplayId(t,this._storage);s(N(e))}}forEachBounds(t,s,e){this._rebuildIndex();const i=[0,0,0,0];for(const n of t){if(!n.readGeometry())continue;const t=n.getDisplayId();i[0]=this._storage.getXMin(t),i[1]=this._storage.getYMin(t),i[2]=this._storage.getXMax(t),i[3]=this._storage.getYMax(t),s(xt(e,i))}}sweepFeatures(t,s,e){this._objectIdToDisplayId.forEach(((i,n)=>{t.has(i)||(s.releaseDisplayId(i),e.unsetAttributeData(i),this._objectIdToDisplayId.delete(n))})),this.events.emit("changed")}sweepFeatureSets(t){this._featureSetsByInstance.forEach(((s,e)=>{t.has(e)||this._featureSetsByInstance.delete(e)}))}lookupObjectId(t,s){const e=this.lookupFeatureByDisplayId(t,s);return F(e)?null:e.getObjectId()}lookupDisplayId(t){return this._objectIdToDisplayId.get(t)}lookupFeatureByDisplayId(t,s){const e=s.getInstanceId(t);return this._lookupFeature(e)}lookupByDisplayIdUnsafe(t){const s=this._storage.getInstanceId(t),e=Ve(s),i=$e(s),n=this._getFeatureSet(e);return n?(n.setIndex(i),n):null}hasInstance(t){return this._featureSetsByInstance.has(t)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;this._index.clear();const t=[];this._objectIdToDisplayId.forEach((s=>{const e=this._storage.getInstanceId(s);this._storage.setBounds(s,this._lookupFeature(e))&&t.push(s)})),this._index.load(t),this._spatialIndexInvalid=!1}_lookupFeature(t){const s=Ve(t),e=$e(t),i=this._getFeatureSet(s);if(!i)return null;const n=i.getCursor();return n.setIndex(e),n}_getFeatureSet(t){return this._featureSetsByInstance.get(t)}_searchIndex(t){return this._rebuildIndex(),this._index.search({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]})}}async function Ze(t,s,e){var i;const{capabilities:{query:{maxRecordCount:n}},collectionId:r,layerDefinition:h,url:o}=t,a=`${o}/collections/${r}/items`,{geometry:c,num:u,start:l,timeExtent:d,where:p}=s,y=f(s.outSpatialReference)?s.outSpatialReference:L,g=function(t){if(F(t))return null;const{xmin:s,ymin:e,xmax:i,ymax:n}=t;return`${s},${e},${i},${n}`}(Ut(c,L)),w=function(t){if(F(t))return null;const{start:s,end:e}=t;return`${s?s.toISOString():".."}/${e?e.toISOString():".."}`}(d),m=function(t){return F(t)||!t||"1=1"===t?null:t}(p),b=null!=u?u:null!=l&&void 0!==l?10:n,{data:v}=await G(a,{...e,query:{bbox:g,datetime:w,query:m,limit:b,startindex:l,f:"json"}}),M=null==(i=v.links)?void 0:i.filter((t=>"next"===t.rel)),x=0!==(null==M?void 0:M.length),{fields:_,globalIdField:S,hasM:I,hasZ:A,objectIdField:T}=h,C=h.geometryType,R=Zt(v,{geometryType:C,hasZ:A,objectIdFieldName:T});if(!U(y,L))for(const t of R)t.geometry&&(t.geometry=ot(Ut(nt(t.geometry,C,A,!1),L,y)));for(const t of R)t.objectId=t.attributes[T];const k=new J;return k.exceededTransferLimit=x,k.features=R,k.fields=_,k.geometryType=C,k.globalIdFieldName=S,k.hasM=I,k.hasZ=A,k.objectIdFieldName=T,k.spatialReference=y||L,k}T.getLogger("esri.layers.graphics.sources.ogcfeature");class Qe{constructor(){this.hasFeatures=!1,this.fieldIndexMap=new Map,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.dateFields=new Set,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasFieldIndex(t){return this.fieldIndexMap.has(t)}isDateField(t){return this.dateFields.has(t)}getFieldIndex(t){return this.fieldIndexMap.get(t)}}function Je(t){const s=t.getLength(),e=t.pos()+s,i={name:"",isDate:!1};for(;t.pos()<e&&t.next();)switch(t.tag()){case 1:i.name=t.getString();break;case 2:"esriFieldTypeDate"===Dt(t.getEnum())&&(i.isDate=!0);break;default:t.skip()}return i}const Ke=T.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");function ti(t){for(;t.next();)switch(t.tag()){case 1:return t.getMessage();default:t.skip()}return null}class si extends dt{constructor(t,s,e,i){super(t),this._hasNext=!1,this._isPoints=!1,this._isPolygons=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=i,this._reader=s,this._header=e,this._hasNext=e.hasFeatures,this._isPoints="esriGeometryPoint"===i,this._isPolygons="esriGeometryPolygon"===i}static fromBuffer(t,s){const e=function(t){try{const s=2,e=new Nt(new Uint8Array(t),new DataView(t));for(;e.next();)switch(e.tag()){case s:return ti(e.getMessage());default:e.skip()}}catch(t){const s=new C("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});Ke.error(s)}return null}(t),i=function(t,s){const e=t.pos(),i=new Qe;let n=0,r=0,h=null,o=null,a=null,c=!1;for(;t.next();)switch(t.tag()){case 1:h=t.getString();break;case 3:o=t.getString();break;case 12:a=t.processMessage(jt);break;case 9:i.exceededTransferLimit=t.getBool(),i.exceededTransferLimit&&(i.offsets.geometry=new Int32Array(8e3),i.centroid=new Int32Array(16e3));break;case 13:{const s=Je(t),e=s.name.toLowerCase().trim(),r=n++;i.fieldIndexMap.set(s.name,r),i.fieldIndexMap.set(e,r),s.isDate&&(i.dateFields.add(s.name),i.dateFields.add(e));break}case 15:{const e=t.getLength(),h=t.pos()+e;if(!i.exceededTransferLimit){const t=i.centroid;i.offsets.geometry.push(0),t.push(268435455),t.push(268435455)}!c&&i.exceededTransferLimit&&(c=!0,i.offsets.attributes=new Uint32Array(8e3*n));let o=r*n;for(;t.pos()<h&&t.next();)switch(t.tag()){case 1:{c?i.offsets.attributes[o++]=t.pos():i.offsets.attributes.push(t.pos());const s=t.getLength();t.skipLen(s);break}case 2:if(s){const s=t.getLength(),e=t.pos()+s;for(;t.pos()<e&&t.next();)switch(t.tag()){case 3:{t.getUInt32();const s=t.getSInt32(),e=t.getSInt32();i.centroid[2*r]=s,i.centroid[2*r+1]=e;break}default:t.skip()}}else{i.offsets.geometry[r]=t.pos();const s=t.getLength();t.skipLen(s)}break;case 4:{const s=t.getLength(),e=t.pos()+s;for(;t.pos()<e&&t.next();)switch(t.tag()){case 3:{t.getUInt32();const s=t.getSInt32(),e=t.getSInt32();i.centroid[2*r]=s,i.centroid[2*r+1]=e;break}default:t.skip()}break}default:t.skip()}r++,i.hasFeatures=!0;break}default:t.skip()}const u=h||o;if(!u)throw new C("FeatureSet has no objectId or globalId field name");return i.featureCount=r,i.fieldCount=n,i.objectIdFieldIndex=i.getFieldIndex(u),i.transform=a,i.displayIds=new Uint32Array(i.featureCount),i.groupIds=new Uint16Array(i.featureCount),t.move(e),i}(e,"esriGeometryPoint"===s),n=dt.createInstance();return new si(n,e,i,s)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getApproximateSize(){if(this._hasFilter){const t=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin);return Math.max(Math.round(this.size*t/262144),0)}return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(t){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=t}getAttributeHash(){let t="";return this._header.fieldIndexMap.forEach((s=>{t+=this._readAttributeAtIndex(s)+"."})),t}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(t){this._header.displayIds[this._featureIndex]=t}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(t){this._header.groupIds[this._featureIndex]=t}readLegacyFeature(){if(void 0===this._cache.legacyFeature){var t;const s=this.readCentroid(),e={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(t=s&&{x:s.coords[0],y:s.coords[1]})?t:null};return this._cache.legacyFeature=e,e}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const t=new K(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=t,t}return this._cache.optFeature}getXHydrate(){const t=this._header.centroid[2*this._featureIndex],s=this.getQuantizationTransform();return t*s.scale[0]+s.translate[0]}getYHydrate(){const t=this._header.centroid[2*this._featureIndex+1],s=this.getQuantizationTransform();return s.translate[1]-t*s.scale[1]}readLegacyPointGeometry(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}}readLegacyGeometry(){const t=this.readGeometry();return nt(t,this.geometryType,!1,!1)}readLegacyCentroid(){const t=this.readCentroid();if(!t)return null;const[s,e]=t.coords;return{x:s,y:e}}readGeometryArea(){return this._cache.area||this.readGeometry(),this._cache.area}readUnquantizedGeometry(){if(void 0===this._cache.unquantGeometry){const t=this.readGeometry();if(!t)return this._cache.unquantGeometry=null,null;const s=t.clone(),e=s.lengths,i=s.coords;for(let t=0,s=2;t<e.length;t++,s+=2){const n=e[t];for(let t=1;t<n;t+=1,s+=2)i[s]+=i[s-2],i[s+1]+=i[s-1]}return this._cache.unquantGeometry=s,s}return this._cache.unquantGeometry}readHydratedGeometry(){const t=this.readGeometry();if(!t)return null;const s=t.clone();return this._isPoints&&(s.coords[0]-=this._tx,s.coords[1]-=this._ty),ht(s,s,this.hasZ,this.hasM,this.getQuantizationTransform()),s}readGeometry(){if(void 0===this._cache.geometry){let t=null;if(this._isPoints)t=new tt([],[this._header.centroid[2*this._featureIndex]+this._tx,this._header.centroid[2*this._featureIndex+1]+this._ty]);else{const s=this._header.offsets.geometry[this._featureIndex],e=this._reader;if(0===s)return null;e.move(s);try{t=this._parseGeometry(e)}catch(t){return console.error("Failed to parse geometry!",t),null}}return this._cache.geometry=t,t}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let t=null;const s=this._header.centroid[2*this._featureIndex]+this._tx,e=this._header.centroid[2*this._featureIndex+1]+this._ty;return 268435455===s?(t=this._computeCentroid(),t&&(this._header.centroid[2*this._featureIndex]=t.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=t.coords[1]-this._ty)):t=new tt([],[s,e]),this._cache.centroid=t,t}return this._cache.centroid}copy(){const t=this._reader.clone(),s=new si(this.instance,t,this._header,this.geometryType);return this.copyInto(s),s}next(){if(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,!this._hasFilter)return++this._featureIndex<this.size;for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size}_readAttribute(t,s){const e=this._header.hasFieldIndex(t)?t:function(t){return t.toLowerCase().trim()}(t),i=this._header.getFieldIndex(e);if(null==i)return;const n=this._readAttributeAtIndex(i);return s&&this._header.isDateField(e)?new Date(n):n}_readAttributes(){const t={};return this._header.fieldIndexMap.forEach(((s,e)=>{t[e]=this._readAttributeAtIndex(s)})),t}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext}_passesFilter(){if(!this._hasFilter)return!0;let t=this._header.centroid[2*this._featureIndex],s=this._header.centroid[2*this._featureIndex+1];if(268435455===t){if(this._isPolygons&&!this.readCentroid())return!1;t=this._header.centroid[2*this._featureIndex],s=this._header.centroid[2*this._featureIndex+1]}return t>=this._xmin&&t<=this._xmax&&s>=this._ymin&&s<=this._ymax}_readAttributeAtIndex(t){const s=this._reader;return s.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+t]),function(t){const s=t.getLength(),e=t.pos()+s;for(;t.pos()<e&&t.next();)switch(t.tag()){case 1:{const s=t.getString();return""===s?null:s}case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}(s)}_preprocessPolygon(t,s){let e=0,i=0,n=0,r=!1,h=!1,o=!1,a=-1;const c=[];let u=0,l=!1;for(let f=0;f<s.length;f++){const d=s[f];let p=t[2*e],y=t[2*e+1],g=0;for(let s=1;s<d;s++){const i=p,n=y,r=p+t[2*(e+s)],h=y+t[2*(e+s)+1];p=r,y=h,g+=(r-i)*(h+n)*.5}const w=g>0;if(w&&l&&(i+=d),w||(a++,l=!1),a>=1e6)break;u+=g,r&&w&&h&&(o=!0);{t[2*n]=t[2*i],t[2*n+++1]=t[2*i+++1];let s=1,e=t[2*i],r=t[2*i+++1];for(let h=2;h<d;h++){const h=t[2*i],o=t[2*i+++1];e*o-h*r==0?(e+=h,r+=o):(t[2*n]=e,t[2*n+++1]=r,s++,e=h,r=o)}t[2*n]=e,t[2*n+++1]=r,s++,c.push(s)}r=!1,h=!0,e+=d}return c.length?(this._cache.area=Math.abs(u),new tt(c,t,o)):null}_parseGeometry(t){const s=t.getLength(),e=t.pos()+s,i=[],n=[];for(;t.pos()<e&&t.next();)switch(t.tag()){case 2:{const s=t.getUInt32(),e=t.pos()+s;for(;t.pos()<e;)n.push(t.getUInt32());break}case 3:{const s=t.getUInt32(),e=t.pos()+s;for(;t.pos()<e;)i.push(t.getSInt32()),i.push(t.getSInt32()),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();break}case 1:default:t.skip()}let r=0;for(const t of n)i[2*r]+=this._tx,i[2*r+1]+=this._ty,r+=t;return this._isPolygons?this._preprocessPolygon(i,n):new tt(n,i)}}class ei{constructor(t){this.service=t}destroy(){}}class ii extends ei{constructor(t){super(t),this._portsOpen=bt(t.source).then((t=>this.client=t))}destroy(){this.client.close(),this.client=null}async executeQuery(t,s){await this._portsOpen;const e=await this.client.invoke("queryFeatures",t.toJSON(),s);return ie.fromFeatureSet(e,this.service.objectIdField)}}class ni extends ei{async executeQuery(t,s){const{data:e}=await Pt(this.service.source,t,{...s,query:{...this.service.customParameters,...null==s?void 0:s.query}});return si.fromBuffer(e,this.service.geometryType)}}class ri extends ei{async executeQuery(t,s){const{source:e,capabilities:i,spatialReference:n,objectIdField:r}=this.service;if(t.quantizationParameters&&!i.query.supportsQuantization){const i=t.clone();i.quantizationParameters=null;const{data:h}=await Lt(e,i,n,{...s,query:{...this.service.customParameters,...null==s?void 0:s.query}}),o=et(h,r);return at(s.transform,o),ie.fromOptimizedFeatureSet(o)}const{data:h}=await Lt(e,t,this.service.spatialReference,{...s,query:{...N(this.service.customParameters),...null==s?void 0:s.query}});return ie.fromFeatureSet(h,this.service.objectIdField)}}class hi extends ei{async executeQuery(t,s){const{capabilities:e}=this.service;if(t.quantizationParameters&&!e.query.supportsQuantization){t.clone().quantizationParameters=null;const e=await Ze(this.service.source,t,s);return at(s.transform,e),ie.fromOptimizedFeatureSet(e)}const i=await Ze(this.service.source,t,s);return ie.fromOptimizedFeatureSet(i)}}class oi{constructor(t){this._abortController=new AbortController,this.requests={pending:new Array,done:new Array},this.tile=t}get signal(){return this._abortController.signal}add(t){this.requests.done.push(t),t.request.end&&(this.resolved=!0)}abort(){this._abortController.abort()}}class ai{constructor(t){this.events=new b,this._subscriptions=new Map,this._serviceQueryInfo={outSpatialReference:t.outSR},this._serviceInfo=t.serviceInfo,this._onRequest=t.onRequest}async queryLastEditDate(){throw new Error("Service does not support query type")}async query(t,s){throw new Error("Service does not support query")}get geometryType(){return this._serviceInfo.geometryType}update(t){kt(t,this._sourceQueryInfo)&&(this._sourceQueryInfo=t)}updateSubscriptions(){}setViewState(t){}subscribe(t){const s=new oi(t);this._subscriptions.set(t.id,s)}unsubscribe(t){const s=this.get(t.id);f(s)&&s.abort(),this._subscriptions.delete(t.id)}pause(){}resume(){}get(t){return this._subscriptions.has(t)?this._subscriptions.get(t):null}enableEvent(t,s){}}const ci=T.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class ui extends ai{constructor(t){super(t),this.type="feature",this._adapter=function(t){const{capabilities:s}=t;return(e=t.source)&&e.capabilities&&e.collectionId&&e.layerDefinition&&e.url?new hi(t):function(t){return Array.isArray(t.source)}(t)?new ii(t):s.query.supportsFormatPBF?new ni(t):new ri(t);var e}(t.serviceInfo),this._queue=new re({concurrency:8,process:async t=>{z(t);const s=t.tile.key.id,{tile:e,signal:i}=t,n={query:v("esri-tiles-debug")?{tile:s.replace(/\//g,"."),depth:t.depth}:void 0,signal:i,transform:e.transform};return this._adapter.executeQuery(t.query,n)}}),this._patchQueue=new re({concurrency:8,process:async t=>{z(t);const s=t.tile.key.id,{tile:e,signal:i}=t,n={query:v("esri-tiles-debug")?{tile:s.replace(/\//g,"."),depth:t.depth}:void 0,signal:i,transform:e.transform};return this._adapter.executeQuery(t.query,n)}})}destroy(){this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}setViewState(t){}get updating(){return!!this._queue.length}subscribe(t){super.subscribe(t),this._fetchDataTile(t).catch((s=>{E(s)||ci.error(new C("mapview-query-error","Encountered error when fetching tile",{tile:t,error:s}))}))}unsubscribe(t){super.unsubscribe(t)}pause(){this._queue.pause()}resume(){this._queue.resume()}async query(t,s){return this._adapter.executeQuery(t,s)}async queryLastEditDate(){const t=this._serviceInfo.source,s={...t.query,f:"json"};return(await G(t.path,{query:s,responseType:"json"})).data.editingInfo.lastEditDate}forEachRequest(t,s){const e=this._subscriptions.get(t),{requests:i,signal:n}=e;for(const t of i.done)s(t.request,{signal:n})}async _executePatchQuery(t,s,e,i){const n=s.clone();n.outFields=[this._serviceInfo.objectIdField,...e],n.returnCentroid=!1,n.returnGeometry=!1;const r=f(n.start)?n.start/8e3:0;return this._patchQueue.push({tile:t,query:n,signal:i.signal,depth:r})}async _resendRequest(t,s){const{query:e,request:i}=t,n=f(e.outFields)?e.outFields:[],r=this._sourceQueryInfo.outFields,h=r.filter((t=>-1===n.indexOf(t)));if(!F(i.features))if(h.length)try{const t=await this._executePatchQuery(i.tile,e,h,s);z(s),e.outFields=r,i.features.joinAttributes(t),this._onRequest({...i,end:i.end||s.end},"new",s)}catch(t){}else this._onRequest({...i,end:i.end||s.end},"new",s)}async resend({dataTileOnly:t}){let s=0,e=!1;const i=[];for(this._subscriptions.forEach((t=>{if(!t.requests.done.length){const s=t.tile;this._onRequest({tile:s,id:s.id,features:null,noData:!0,end:!1},"new",{dataTileOnly:!0})}}));!e;)e=!0,this._subscriptions.forEach((({requests:n,signal:r})=>{n.done.length>s&&(e=!1,i.push(this._resendRequest(n.done[s],{signal:r,dataTileOnly:t,end:n.done.length===s+1})))})),s++;await R(i)}_createQuery(t,s){const e=new Mt({...this._serviceQueryInfo,...this._sourceQueryInfo,...s});return this._serviceInfo.capabilities.query.supportsQuantization||(s.quantizationParameters=null,e.maxAllowableOffset=t.resolution),s.quantizationParameters&&"esriGeometryPolyline"===this.geometryType&&(e.maxAllowableOffset=t.resolution),e.resultType="tile",e.geometry=t.extent,e}}const li=v("esri-featurelayer-webgl"),fi=v("esri-mobile"),di={maxDrillLevel:li&&"object"==typeof li&&null!=li.maxDrillLevel?li.maxDrillLevel:fi?1:4,maxRecordCountFactor:li&&"object"==typeof li&&null!=li.maxRecordCountFactor?li.maxRecordCountFactor:fi?1:3};class pi extends ui{constructor(t){super(t)}async _fetchDataTile(t){const s=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,e=this._subscriptions.get(t.key.id),i=e.signal,n=t.getQuantizationParameters();let r=0;const h=async(o,a)=>{const c=this._sourceQueryInfo,u=this._createQuery(o,{maxRecordCountFactor:s?di.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:n});r++;try{const s=await this._queue.push({tile:t,query:u,signal:i,depth:a});if(r--,z(i),!s)return;if(c!==this._sourceQueryInfo)return void h(o,a);if(s.exceededTransferLimit&&a<di.maxDrillLevel){for(const t of o.createChildTiles())h(t,a+1);return}const n={tile:t,id:t.id,features:s,end:0===r};e.requests.done.push({query:u,request:n}),this._onRequest(n,"new")}catch(s){E(s)||this._onRequest({tile:t,id:t.id,features:null,end:!0},"new")}};h(t,0)}}class yi{constructor(t=Number.POSITIVE_INFINITY){this.size=0,this._start=0,this.maxSize=t,this._buffer=isFinite(t)?new Array(t):[]}get entries(){return this._buffer}enqueue(t){if(this.size===this.maxSize){const s=this._buffer[this._start];return this._buffer[this._start]=t,this._start=(this._start+1)%this.maxSize,s}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=t:this._buffer[this._start+this.size++]=t,null}dequeue(){if(0===this.size)return null;const t=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,t}clear(){for(;f(this.dequeue()););}}class gi{constructor(t,s,e,i,n=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=e,this._purgeOptions=i,this.store=t,this.objectIdField=s,this.purgeInterval=n,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(t){if(this._useGeneratedIds){const s=this._nextId();t.attributes[this.objectIdField]=s,t.objectId=s}else t.objectId=t.attributes[this.objectIdField];if(this._addOrUpdated.set(t.objectId,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return;const s=t.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){const t=f(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,e=o(t,0,1e3);this._trackIdToObservations.set(s,new yi(e))}const e=this._trackIdToObservations.get(s).enqueue(t.objectId);f(e)&&(this._addOrUpdated.has(e)?this._addOrUpdated.delete(e):this._removed.push(e))}checkForUpdates(){const t=this._getToAdd(),s=this._getToRemove(),e=performance.now();e-this._lastPurge>=this.purgeInterval&&(this._purge(e),this._lastPurge=e);const i=[];if(f(s))for(const t of s){const s=this.store.removeById(t);f(s)&&i.push(s)}if(f(t))for(const s of t)s.attributes.__esri_timestamp__=e,this.store.add(s);(t||i)&&this.store.update(t,i)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let s=0;return this._addOrUpdated.forEach((e=>t[s++]=e)),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const s=this._purgeOptions;f(s)&&(this._purgeSomeByDisplayCount(s),this._purgeByAge(s),this._purgeByAgeReceived(t,s),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let s=this.store.size;s>t.displayCount&&this._trackIdToObservations.forEach((e=>{if(s>t.displayCount&&e.size){const t=N(e.dequeue());this._removed.push(t),s--}}))}_purgeByAge(t){var s;if(!t.age||null==(s=this._timeInfo)||!s.startTimeField)return;const e=this._maxAge-60*t.age*1e3;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<e&&this._removed.push(t.objectId)}))}_purgeByAgeReceived(t,s){if(!s.ageReceived)return;const e=t+60*s.ageReceived*1e3;this.store.forEach((t=>{t.attributes.__esri_timestamp__<e&&this._removed.push(t.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((t,s)=>{0===t.size&&this._trackIdToObservations.delete(s)}))}}let wi=class extends(b.EventedMixin(Qt)){onFeature(t){this.emit("feature",t)}};wi=t([a("esri.layers.graphics.sources.connections.StreamConnection")],wi);var mi=wi;const bi=T.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var vi;!function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED"}(vi||(vi={}));let Mi=class extends mi{constructor(t){super(),this.errorString=null;const{geometryType:s,spatialReference:e,sourceSpatialReference:i}=t;this._config=t,this._featureZScaler=qt(s,i,e),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){f(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(F(this._websocket))return"disconnected";switch(this._websocket.readyState){case vi.CONNECTING:case vi.OPEN:return"connected";case vi.CLOSING:case vi.CLOSED:return"disconnected"}}async _tryCreateWebSocket(t=this._config.source.path,s=1e3,e=0){try{if(this.destroyed)return;this._websocket=await this._createWebSocket(t),this.notifyChange("connectionStatus")}catch(i){const n=s/1e3;return this._config.maxReconnectionAttempts&&e>=this._config.maxReconnectionAttempts?(bi.error(new C("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(bi.error(new C("websocket-connection",`Failed to connect. Attempting to reconnect in ${n}s`,i)),await B(s),this._tryCreateWebSocket(t,Math.min(1.5*s,1e3*this._config.maxReconnectionInterval),e+1))}}_createWebSocket(t){const s=new WebSocket(t),e=X(((t,e)=>{s.onopen=()=>t(s),s.onclose=t=>e(t)}));return e.then((()=>{if(this.destroyed)return s.onclose=()=>{},void s.close();s.onclose=t=>this._onClose(t),s.onerror=t=>this._onError(t),s.onmessage=t=>this._onMessage(t)})),e}async _handshake(t=1e4){const s=this._websocket;if(F(s))return;const e=k(),i=s.onmessage,{filter:n,outFields:r,spatialReference:h}=this._config;return e.timeout(t),s.onmessage=t=>{var o;let a=null;try{a=JSON.parse(t.data)}catch(t){}a&&"object"==typeof a||(bi.error(new C("websocket-connection","Protocol violation. Handshake failed - malformed message",t.data)),e.reject(),this.destroy()),(null==(o=a.spatialReference)?void 0:o.wkid)!==(null==h?void 0:h.wkid)&&(bi.error(new C("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${h.wkid}`,t.data)),e.reject(),this.destroy()),"json"!==a.format&&(bi.error(new C("websocket-connection","Protocol violation. Handshake failed - format is not set",t.data)),e.reject(),this.destroy()),n&&a.filter!==n&&bi.error(new C("websocket-connection","Tried to set filter, but server doesn't support it")),r&&a.outFields!==r&&bi.error(new C("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=i,e.resolve()},s.send(JSON.stringify({filter:n,outFields:r,format:"json",spatialReference:{wkid:h.wkid}})),e.promise}_onMessage(t){try{const s=JSON.parse(t.data);if("featureResult"!==s.type)throw new C("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",s);for(const t of s.features)this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}catch(t){return bi.error(new C("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(t){const s="Encountered an error over WebSocket connection";this._set("errorString",s),bi.error("websocket-connection",s)}_onClose(t){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==t.code&&bi.error("websocket-connection",`WebSocket closed unexpectedly with error code ${t.code}`),this.destroyed||this._open()}};t([s()],Mi.prototype,"connectionStatus",null),t([s()],Mi.prototype,"errorString",void 0),Mi=t([a("esri.layers.graphics.sources.connections.WebSocketConnection")],Mi);const xi=T.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),_i={maxQueryDepth:5,maxRecordCountFactor:3};let Si=class extends Mi{constructor(t){super({..._i,...t})}async _open(){const t=await this._fetchServiceDefinition(this._config.source);t.timeInfo.trackIdField||xi.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const s=await this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(s);const{filter:e,outFields:i}=this._config;this.destroyed||this._setFilter(e,i)}_onMessage(t){let s;try{s=this._enrich(JSON.parse(t.data)),this._featureZScaler&&this._featureZScaler(s.geometry)}catch(t){return void xi.error(new C("geoevent-connection","Failed to parse message",t))}this.onFeature(s)}async _fetchServiceDefinition(t){const s=G(t.path,{query:{f:"json"},responseType:"json"}),e=(await s).data;return this._serviceDefinition=e,e}async _fetchWebSocketUrl(t,s){const e=t[0],{urls:i,token:n}=e;return`${this._inferWebSocketBaseUrl(i)}/subscribe?outSR=${s.wkid}${n?"&token="+n:""}`}_inferWebSocketBaseUrl(t){if(1===t.length)return t[0];for(const s of t)if(-1!==s.indexOf("wss"))return s;return xi.error(new C("geoevent-connection","Unable to infer WebSocket url",t)),null}async _setFilter(t,s){const e=this._websocket;if(F(e)||F(t)&&F(s))return;const i=JSON.stringify({filter:this._serializeFilter(t,s)});let n=!1;const r=k();return e.onmessage=t=>{const s=JSON.parse(t.data);s.filter&&(s.error&&(xi.error(new C("geoevent-connection","Failed to set service filter",s.error)),this._set("errorString",`Could not set service filter - ${s.error}`),r.reject(s.error)),e.onmessage=this._onMessage.bind(this),n=!0,r.resolve())},e.send(i),setTimeout((()=>{n||(this.destroyed||this._websocket!==e||xi.error(new C("geoevent-connection","Server timed out when setting filter")),r.reject())}),1e4),r.promise}_serializeFilter(t,s){const e={};if(F(t)&&F(s))return e;if(f(t)&&t.geometry)try{const s=l(t.geometry);if("extent"!==s.type)throw new C(`Expected extent but found type ${s.type}`);e.geometry=JSON.stringify(s.shiftCentralMeridian())}catch(t){xi.error(new C("geoevent-connection","Encountered an error when setting connection geometryDefinition",t))}return f(t)&&t.where&&"1 = 1"!==t.where&&(e.where=t.where),f(s)&&(e.outFields=s.join(",")),e}_enrich(t){if(!this._relatedFeatures)return t;const s=t.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(s))return xi.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",t),t;const{attributes:e,geometry:i}=this._relatedFeatures.get(s);for(const s in e)t.attributes[s]=e[s];return i&&(t.geometry=i),t.geometry||t.centroid||xi.error(new C("geoevent-connection","Found malformed feature - no geometry found",t)),t}async _queryBuddyServices(){try{const{relatedFeatures:t,keepLatestArchive:s}=this._serviceDefinition,e=this._queryRelatedFeatures(t),i=this._queryArchive(s);await e;const n=await i;if(!n)return;for(const t of n.features)this.onFeature(this._enrich(t))}catch(t){xi.error(new C("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}}async _queryRelatedFeatures(t){if(!t)return;const s=await this._queryBuddy(t.featuresUrl);this._addRelatedFeatures(s)}async _queryArchive(t){if(t)return this._queryBuddy(t.featuresUrl)}async _queryBuddy(t){const s=new((await import("./p-cbbd4609.js")).default)({url:t}),{capabilities:e}=await s.load(),i=e.query.supportsMaxRecordCountFactor,n=e.query.supportsPagination,r=e.query.supportsCentroid,h=this._config.maxRecordCountFactor,o=s.capabilities.query.maxRecordCount,a=i?o*h:o,c=new Mt;if(c.outFields=Y(this._config.outFields,["*"]),c.where=Y(V(this._config.filter,"where"),"1=1"),c.returnGeometry=!0,c.returnExceededLimitFeatures=!0,c.outSpatialReference=$.fromJSON(this._config.spatialReference),r&&(c.returnCentroid=!0),i&&(c.maxRecordCountFactor=h),n)return c.num=a,s.destroy(),this._queryPages(t,c);const u=await Lt(t,c,this._config.sourceSpatialReference);return s.destroy(),u.data}async _queryPages(t,s,e=[],i=0){s.start=f(s.num)?i*s.num:null;const{data:n}=await Lt(t,s,this._config.sourceSpatialReference);return n.exceededTransferLimit&&i<this._config.maxQueryDepth?(n.features.forEach((t=>e.push(t))),this._queryPages(t,s,e,i+1)):(e.forEach((t=>n.features.push(t))),n)}_addRelatedFeatures(t){const s=new Map,e=t.features,i=this._serviceDefinition.relatedFeatures.joinField;for(const t of e)s.set(t.attributes[i],t);this._relatedFeatures=s}};Si=t([a("esri.layers.graphics.sources.connections.GeoEventConnection")],Si);var Ii=Si;function Ai(t,s){const e=t.weakClone(),i=lt(s,t.geometry.coords[0]),n=ft(s,t.geometry.coords[1]);return e.geometry=new tt([],[i,n]),e}function Fi(t,s){const e=Gt(9,function(t){switch(t){case"esriGeometryPoint":return t=>({minX:t.geometry.coords[0],minY:t.geometry.coords[1],maxX:t.geometry.coords[0],maxY:t.geometry.coords[1]});default:return t=>{let s=1/0,e=1/0,i=-1/0,n=-1/0;return t.geometry.forEachVertex(((t,r)=>{s=Math.min(s,t),e=Math.min(e,r),i=Math.max(i,t),n=Math.max(n,r)})),{minX:s,minY:e,maxX:i,maxY:n}}}}(s));return e.load(t),e}function Ti(t,s){return t.search({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]})}class Ci{constructor(t,s){this.onUpdate=t,this._geometryType=s,this._objectIdToFeature=new Map}get _features(){const t=[];return this._objectIdToFeature.forEach((s=>t.push(s))),t}add(t){this._objectIdToFeature.set(t.objectId,t),this._index=null}get(t){return this._objectIdToFeature.has(t)?this._objectIdToFeature.get(t):null}forEach(t){this._objectIdToFeature.forEach(t)}search(t){return this._index||(this._index=Fi(this._features,this._geometryType)),Ti(this._index,t)}removeById(t){const s=this._objectIdToFeature.get(t);return s?(this._objectIdToFeature.delete(t),this._index=null,s):null}update(t,s){this.onUpdate(t,s)}get size(){return this._objectIdToFeature.size}}class Ri extends ai{constructor(t){super(t),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._updateInfo={websocket:0,client:0};const{outSR:s}=t,{geometryType:e,objectIdField:i,timeInfo:n,purgeOptions:r,source:h,spatialReference:o,serviceFilter:a,maxReconnectionAttempts:c,maxReconnectionInterval:u,updateInterval:l}=t.serviceInfo,f=new Ci(this._onUpdate.bind(this),e),d=new gi(f,i,n,r),p=function(t,s,e,i,n,r,h){const o=0===t.path.indexOf("wss://")||0===t.path.indexOf("ws://"),a={source:t,sourceSpatialReference:s,spatialReference:e,geometryType:i,filter:n,maxReconnectionAttempts:r,maxReconnectionInterval:h};return o?new Mi(a):new Ii(a)}(h,o,s,e,a,c,u);this._store=f,this._manager=d,this._connection=p,this._quantize=function(t){switch(t){case"esriGeometryPoint":return Ai;case"esriGeometryPolygon":case"esriGeometryPolyline":default:return(s,e)=>{const i=s.weakClone(),n=new tt,r=ct(n,s.geometry,!1,!1,t,e,!1,!1);return i.geometry=r,i}}}(e),this._handles=[this._connection.on("feature",(t=>this._onFeature(t))),this._connection.watch("connectionStatus",(t=>this.events.emit("connectionStatus",t))),this._connection.watch("errorString",(t=>this.events.emit("errorString",t)))];let y=performance.now();this._updateIntervalId=setInterval((()=>{const s=performance.now(),e=s-y;if(e>2500){y=s;const t=Math.round(this._updateInfo.client/(e/1e3)),i=Math.round(this._updateInfo.websocket/(e/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:t,websocket:i})}t.canAcceptRequest()&&this._manager.checkForUpdates()}),l)}destroy(){clearInterval(this._updateIntervalId),this._handles.forEach((t=>t.remove())),this._connection.destroy()}_fetchDataTile(){}enableEvent(t,s){"data-received"===t&&(this._dataReceiveEventEnabled=s)}get updating(){return!1}subscribe(t){super.subscribe(t);const s=this._getTileFeatures(t);this._onRequest({tile:t,id:t.key.id,features:s,end:!0},"new")}unsubscribe(t){super.unsubscribe(t)}forEachRequest(t,s){const e=this._subscriptions.get(t),{tile:i,signal:n}=e;s({tile:i,id:t,features:this._getTileFeatures(i),end:!0},{signal:n})}async resend(t){this._subscriptions.forEach((s=>{const{tile:e}=s,i={tile:e,id:e.id,features:this._getTileFeatures(e),end:!0};this._onRequest(i,"update",t)}))}_getTileFeatures(t){const s=this._store.search(t).map((s=>this._quantize(s,t.transform)));return ie.fromOptimizedFeatures(s,this.geometryType,t.transform)}_onFeature(t){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",t);const s=ut(t,this.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(s)}catch(t){}}async _onUpdate(t,s){const e=D(t,(t=>Fi(t,this.geometryType))),i=D(s,(t=>Fi(t,this.geometryType)));f(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach(((t,s)=>{const n=t.tile,r=D(e,(t=>Ti(t,n))),h=D(r,(t=>t.map((t=>this._quantize(t,n.transform))))),o=D(h,(t=>ie.fromOptimizedFeatures(t,this.geometryType,n.transform))),a=D(i,(t=>Ti(t,n))),c=D(a,(t=>t.map((t=>t.objectId))));this._onRequest({tile:n,id:s,features:o,remove:Y(c,[]),end:!0},"update")}))}}const ki=T.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class Ei extends ui{constructor(t){super(t)}async _fetchDataTile(t){const s=this._subscriptions.get(t.key.id);let e=!1,i=0,n=0;const r=(i,r)=>{n--,z(s);const h=i.reader,o=i.query;if(!h.exceededTransferLimit){if(e=!0,0!==r&&!h.hasFeatures){const e={tile:t,id:t.id,features:h,end:0===n};return s.requests.done.push({request:e,query:o}),void this._onRequest(e,"new")}const i={tile:t,id:t.id,features:h,end:0===n};return s.requests.done.push({request:i,query:o}),void this._onRequest(i,"new")}const a={tile:t,id:t.id,features:h,end:e&&0===n};s.requests.done.push({request:a,query:o}),this._onRequest(a,"new")};let h=0,o=0;for(;!e&&o++<20;){let o;for(let a=0;a<h+1;a++){const h=i++;n++,o=this._fetchDataTilePage(t,h,s).then((t=>t&&r(t,h))).catch((s=>{e=!0,E(s)||(ki.error(new C("mapview-query-error","Encountered error when fetching tile",{tile:t,error:s})),this._onRequest({tile:t,id:t.id,features:null,end:e},"new"))}))}await o,z(s),h=Math.min(h+2,6)}}async _fetchDataTilePage(t,s,e){const i=this._sourceQueryInfo,n=this._createQuery(t,{start:8e3*s,num:8e3,maxRecordCountFactor:3,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()});try{const r=e.signal,h=await this._queue.push({tile:t,query:n,signal:r,depth:s});return z(e),h?i!==this._sourceQueryInfo?this._fetchDataTilePage(t,s,e):{reader:h,query:n}:null}catch(t){return H(t),null}}}function Oi(t,s,e){const i=function(t,s,e){const i=t.clone(),n=1<<i.level,r=i.col+s,h=i.row+e;return r<0&&r!==i.col?(i.col=r+n,i.world-=1):r>=n?(i.col=r-n,i.world+=1):i.col=r,i.row=h,i}(t.key,s,e);return new Qs(t.tileInfoView,i)}let qi=0;class ji{constructor(t,s){this.didSend=!1,this.dataTileCount=0,this.update=ee.all(),this._abortController=new AbortController,this.invalid=!1,this.displayTile=t,this._pixelBuffer=s,this.partitions=Ni(t,s)}setUpdate(t,s){this.update=t,this.dataTileCount=0,s!==this._pixelBuffer&&(this._pixelBuffer=s,this.partitions=Ni(this.displayTile,s)),t.mesh&&(this.didSend=!1)}get signal(){return this._abortController.signal}abort(){this._abortController.abort()}}class Di{constructor(t,s,e){this.resolved=!1,this.tile=s,this.offset=t,this.extent=e}reset(){this.resolved=!1}}function Ni(t,s){const e=[];if(e.push(new Di([0,0],t,null)),0===s)return e;const i=Math.min(s,ls),n=ls;return e.push(new Di([-n,-n],Oi(t,-1,-1),[n-i,n-i,n,n])),e.push(new Di([0,-n],Oi(t,0,-1),[0,n-i,n,n])),e.push(new Di([n,-n],Oi(t,1,-1),[0,n-i,i,n])),e.push(new Di([-n,0],Oi(t,-1,0),[n-i,0,n,n])),e.push(new Di([n,0],Oi(t,1,0),[0,0,i,n])),e.push(new Di([-n,n],Oi(t,-1,1),[n-i,0,n,i])),e.push(new Di([0,n],Oi(t,0,1),[0,0,n,i])),e.push(new Di([n,n],Oi(t,1,1),[0,0,i,i])),e}class Pi{constructor(t,s,e){this.type="remote",this._pendingEdits=new Set,this._queryInfo=null,this._subscriptions={display:new Map},this._invalid={outFields:!1,queryFilterParameters:!1};const i=this._onDataTileRequest.bind(this);this._source=function(t,s,e,i,n){const r=function(t,s,e,i,n){switch(t.type){case"stream":return{type:"geoevent",serviceInfo:t,onRequest:i,outSR:s,canAcceptRequest:n};case"memory":case"on-demand":return{type:"feature",serviceInfo:t,onRequest:i,outSR:s,origin:function(t){return Array.isArray(t)?"local":"path"in t&&gt(t.path)?"hosted":"unknown"}(t.source),tileInfoView:e,canAcceptRequest:n}}}(t,s,e,i,n);switch(r.type){case"feature":switch(r.origin){case"hosted":case"local":return new Ei(r);case"unknown":return new pi(r)}case"geoevent":return new Ri(r)}}(t,s,e,i,(()=>this.canAcceptPatch())),this._serviceInfo=t,this._geometryType=t.geometryType,this._outSR=s}destroy(){this._getSubscriptions().map((({displayTile:t})=>this.unsubscribe(t))),this._source.destroy()}get updating(){return this._source.updating||this._getSubscriptions().some((t=>!t.didSend))}get isStream(){return"geoevent"===this._source.type}get sourceEvents(){return"geoevent"===this._source.type?{type:"geoevent",events:this._source.events}:{type:"feature",events:this._source.events}}enableEvent(t,s){this._source.enableEvent(t,s)}setViewState(t){this._source.setViewState(t)}update(t,s){var e,i,n,r;const h=this._serviceInfo.fields.length,o=null!=(e=null==(i=this._schema)?void 0:i.outFields)?e:[],a=null!=(n=null==(r=this._schema)?void 0:r.pixelBuffer)?n:0,c=s.outFields.filter((t=>-1===o.indexOf(t))),u=[...o,...c],l=0===s.pixelBuffer?0:Math.max(s.pixelBuffer,a);s.pixelBuffer=l,s.outFields=u.length>=.75*h?["*"]:u,s.outFields.sort();const f=kt(this._schema,s);if(this._subscriptions.display.forEach((s=>{s.invalid&&(t.queryFilter=!0)})),!f)return;const d=this._schema&&Et(f,"outFields"),p=this._schema&&Et(f,"pixelBuffer"),y=this._schema&&Ot(f,["definitionExpression","gdbVersion","historicMoment"]);v("esri-2d-update-debug")&&console.debug("Applying Update - Source:",f);const g={returnCentroid:"esriGeometryPolygon"===this._geometryType,returnGeometry:!0,outFields:s.outFields,outSpatialReference:this._outSR,orderByFields:[`${this._serviceInfo.objectIdField} ASC`],where:s.definitionExpression||"1=1",gdbVersion:s.gdbVersion,historicMoment:s.historicMoment?new Date(s.historicMoment):null,timeExtent:yt.fromJSON(s.timeExtent)};t.source=!0,p&&(t.why.mesh.push("Pixel buffer changed"),t.mesh=!0),y&&(t.why.mesh.push("Layer filter changed"),t.why.source.push("Layer filter changed"),t.mesh=!0,t.queryFilter=!0,this._invalid.queryFilterParameters=!0),d&&(t.why.source.push("Layer required fields changed"),this._invalid.outFields=!0),this._schema=s,this._source.update(g),this._queryInfo=g}subscribe(t){this._subscriptions.display.has(t.id)||this._subscribeDisplayTile(t)}unsubscribe(t){if(!this._subscriptions.display.has(t.id))return;const s=this._subscriptions.display.get(t.id);this._subscriptions.display.delete(t.id),this._source.unsubscribe(t),s.abort()}forEachRequest(t,s){this._source.forEachRequest(t,s)}query(t){return this._source.query(t)}createQuery(){return new Mt({...this._queryInfo})}createTileQuery(t){if("stream"===this._serviceInfo.type)throw new Error("Service does not support tile  queries");const s=this.createQuery();return s.quantizationParameters=t.getQuantizationParameters(),s.resultType="tile",s.geometry=t.extent,"esriGeometryPolyline"===this._serviceInfo.geometryType&&(s.maxAllowableOffset=t.resolution),this._serviceInfo.capabilities.query.supportsQuantization||(s.quantizationParameters=null,s.maxAllowableOffset=t.resolution),s}invalidate(){this._subscriptions.display.forEach((t=>t.invalid=!0))}forEachPendingEdit(t){this._getSubscriptions().some((({invalid:t})=>t))?this._pendingEdits.forEach(t):this._pendingEdits.clear()}async onEdits(t){const s=t.addedFeatures.filter((t=>!t.error)).map((t=>t.objectId)),e=t.updatedFeatures.filter((t=>!t.error)).map((t=>t.objectId)),i=t.deletedFeatures.filter((t=>!t.error)).map((t=>t.objectId)),n=[...s,...e];i.forEach((t=>{this._pendingEdits.has(t)&&this._pendingEdits.delete(t)})),n.forEach((t=>this._pendingEdits.add(t)));const r=this._getSubscriptions().map((({displayTile:t})=>t)).map((t=>{const s=this.createTileQuery(t);return s.objectIds=n,{tile:t,query:s}})).map((async({tile:t,query:s})=>({tile:t,result:await this._source.query(s)})));(await R(r)).forEach((({tile:t,result:s})=>{const n=this._subscriptions.display.get(t.key.id);if(!n)return;const r=n.signal,h=ee.all();this.onDisplayTilePatch({type:"update",id:t.key.id,version:qi++,update:h,addOrUpdate:s,remove:[...e,...i],end:!0,noData:!1},{signal:r})})),this.invalidate()}async resubscribe(t,s=!1){const e=this._schema.pixelBuffer;this._subscriptions.display.forEach((s=>s.setUpdate(t,e)));let i=!1;if(this._subscriptions.display.forEach((t=>{t.invalid&&(i=!0)})),this._invalid.outFields&&(this._invalid.outFields=!1),s||this._invalid.queryFilterParameters||i){const t=this._getSubscriptions().map((({displayTile:t})=>t));t.forEach((t=>this.unsubscribe(t))),t.forEach((t=>this.subscribe(t))),this._source.resume(),this._invalid.queryFilterParameters=!1}else t.mesh?await this._source.resend({dataTileOnly:!1}):await this._source.resend({dataTileOnly:!0})}pause(){this._source.pause()}resume(){this._source.resume()}_getSubscriptions(){const t=[];return this._subscriptions.display.forEach((s=>{t.push(s)})),t}_subscribeDisplayTile(t){const s=new ji(t,this._schema.pixelBuffer);this._subscriptions.display.set(t.id,s),this._source.subscribe(t);for(const e of s.partitions){const s=this._source.get(e.tile.id);if(f(s))for(const i of s.requests.done)this._onPartitionMessage(t.id,e,i.request,"new")}}_onDataTileRequest(t,s,e){const i=this._subscriptions.display.get(t.id);if(e&&e.dataTileOnly){for(const e of i.partitions)if(e.tile.id===t.id){this._onPartitionMessage(t.id,e,t,s);break}}else{for(const e of i.partitions)if(e.tile.id===t.id){this._onPartitionMessage(t.id,e,t,s);break}this._subscriptions.display.forEach(((e,i)=>{if(i!==t.id)for(const n of e.partitions)if(n.tile.id===t.id){this._onPartitionMessage(i,n,t,s);break}}))}}_onPartitionMessage(t,s,e,i){const n=D(e.features,(t=>function(t,s){if(F(s.extent))return t;const{offset:e,extent:i}=s,[n,r,h,o]=i,[a,c]=e;return t.extent(n,r,h,o).transform(a,c)}(t,s))),r=this._subscriptions.display.get(t),h=r.signal;let o=r.update;r.didSend||(i="replace"),f(n)&&!n.seen&&(o=ee.all(),n.seen=!0);let a=!1;e.end&&(s.resolved=!0,a=t===s.tile.id),r.didSend=!0,this.onDisplayTilePatch({type:i,id:t,version:qi++,update:o,addOrUpdate:n,remove:e.remove||[],noData:e.noData,end:a},{signal:h})}}function Li(t,s,e,i){i%2&&(i+=1);let n=0,r=0,h=-90,o=90,a=-180,c=180;for(let t=0;t<i/2;t++){for(let s=0;s<5;s++){const i=(a+c)/2,r=e>i?1:0;n|=r<<29-(s+5*t),a=(1-r)*a+r*i,c=(1-r)*i+r*c}for(let e=0;e<5;e++){const i=(h+o)/2,n=s>i?1:0;r|=n<<29-(e+5*t),h=(1-n)*h+n*i,o=(1-n)*i+n*o}}t.geohashX=n,t.geohashY=r}function Gi(t,s,e,i,n){n%2&&(n+=1);let r=0,h=0,o=-90,a=90,c=-180,u=180;for(let t=0;t<n/2;t++){for(let s=0;s<5;s++){const e=(c+u)/2,n=i>e?1:0;r|=n<<29-(s+5*t),c=(1-n)*c+n*e,u=(1-n)*e+n*u}for(let s=0;s<5;s++){const i=(o+a)/2,n=e>i?1:0;h|=n<<29-(s+5*t),o=(1-n)*o+n*i,a=(1-n)*i+n*a}}t[2*s]=r,t[2*s+1]=h}class Ui{constructor(t=[],s=8096){this._nodes=0,this._root=new zi(0,0,0),this._statisticFields=t,this._pool=s?new yi(8096):null}_acquire(t,s,e){this._nodes++;let i=null;return f(this._pool)&&(i=this._pool.dequeue()),f(i)?i.realloc(t,s,e):new zi(t,s,e)}_release(t){this._nodes--,f(this._pool)&&this._pool.enqueue(t)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return W(this._pool,0,(t=>t.size))}get depth(){let t=0;return this._forEachNode((s=>t=Math.max(t,s.depth))),t}dropLevels(t){this._forEachNode((s=>{if(s.depth>=t)for(let t=0;t<s.children.length;t++){const e=s.children[t];s.children[t]=null,e&&this._release(e)}}))}clear(){this.dropLevels(0)}insert(t,s,e=0){const i=ie.fromOptimizedFeatures([t],"esriGeometryPoint").getCursor();i.next();const n=i.readGeometry();if(!n)return;const[r,h]=n.coords;this.insertCursor(i,t.displayId,r,h,t.geohashX,t.geohashY,s,e)}insertCursor(t,s,e,i,n,r,h,o=0){let a=this._root,c=0,u=0,l=0;for(;null!==a;){if(a.depth>=o&&(a.count+=1,a.xTotal+=e,a.yTotal+=i,a.xGeohashTotal+=n,a.yGeohashTotal+=r,a.displayId=s,this._updateStatisticsCursor(t,a,1)),c>=h)return void a.add(s);const f=Math.ceil((c+1)/2),d=Math.floor((c+1)/2),p=1-c%2,y=30-(3*f+2*d),g=30-(2*f+3*d),w=(n&7*p+3*(1-p)<<y)>>y,m=(r&3*p+7*(1-p)<<g)>>g,b=w+m*(8*p+4*(1-p));u=u<<3*p+2*(1-p)|w,l=l<<2*p+3*(1-p)|m,null==a.children[b]&&(a.children[b]=this._acquire(u,l,c+1)),c+=1,a=a.children[b]}}remove(t,s){const e=ie.fromOptimizedFeatures([t],"esriGeometryPoint").getCursor();e.next();const i=e.readGeometry();if(!i)return;const[n,r]=i.coords;this.removeCursor(e,n,r,t.geohashX,t.geohashY,s)}removeCursor(t,s,e,i,n,r){let h=this._root,o=0;for(;null!==h;){if(h.count-=1,h.xTotal-=s,h.yTotal-=e,h.xGeohashTotal-=i,h.yGeohashTotal-=n,this._updateStatisticsCursor(t,h,-1),o>=r)return void h.remove(t.getDisplayId());const a=Math.ceil((o+1)/2),c=Math.floor((o+1)/2),u=1-o%2,l=30-(3*a+2*c),f=30-(2*a+3*c),d=((i&7*u+3*(1-u)<<l)>>l)+((n&3*u+7*(1-u)<<f)>>f)*(8*u+4*(1-u)),p=h.children[d];1===p.count&&(this._release(p),h.children[d]=null),o+=1,h=p}}find(t,s,e){return this._root.find(t,s,e,0,0,0)}findSingleOccupancyNode(t,s,e,i,n){let r=this._root;for(;null!==r;){const h=r.depth,o=r.xNode,a=r.yNode,c=1-h%2,u=r.xGeohashTotal/r.count,l=r.yGeohashTotal/r.count;if(1===r.count&&t<u&&u<=e&&s<l&&l<=i)return r;if(h>=n){r=r.next;continue}const f=Math.ceil((h+1)/2),d=Math.floor((h+1)/2),p=30-(3*f+2*d),y=30-(2*f+3*d),g=~((1<<p)-1),w=~((1<<y)-1),m=(s&w)>>y,b=(e&g)>>p,v=(i&w)>>y,M=o<<3*c+2*(1-c),x=a<<2*c+3*(1-c),_=M+8*c+4*(1-c),S=x+4*c+8*(1-c),I=Math.max(M,(t&g)>>p),A=Math.max(x,m),F=Math.min(_,b),T=Math.min(S,v);let C=null,R=null;for(let t=A;t<=T;t++)for(let s=I;s<=F;s++){const e=r.children[s-M+(t-x)*(8*c+4*(1-c))];e&&(C||(C=e,C.next=r.next),R&&(R.next=e),R=e,e.next=r.next)}r=C||r.next}return null}getRegionDisplayIds(t,s,e,i,n){let r=this._root;const h=[];for(;null!==r;){const o=r.depth,a=r.xNode,c=r.yNode;if(o>=n){const n=r.xGeohashTotal/r.count,o=r.yGeohashTotal/r.count;t<=n&&n<=e&&s<=o&&o<=i&&r.displayIds.forEach((t=>h.push(t))),r=r.next;continue}const u=Math.ceil((o+1)/2),l=Math.floor((o+1)/2),f=1-o%2,d=30-(3*u+2*l),p=30-(2*u+3*l),y=~((1<<d)-1),g=~((1<<p)-1),w=(s&g)>>p,m=(e&y)>>d,b=(i&g)>>p,v=a<<3*f+2*(1-f),M=c<<2*f+3*(1-f),x=v+8*f+4*(1-f),_=M+4*f+8*(1-f),S=Math.max(v,(t&y)>>d),I=Math.max(M,w),A=Math.min(x,m),F=Math.min(_,b);let T=null,C=null;for(let t=I;t<=F;t++)for(let s=S;s<=A;s++){const e=r.children[s-v+(t-M)*(8*f+4*(1-f))];e&&(T||(T=e,T.next=r.next),C&&(C.next=e),C=e,e.next=r.next)}r=T||r.next}return h}getRegionStatistics(t,s,e,i,n){let r=this._root,h=0,o=0,a=0;const c={};let u=0;for(;null!==r;){const l=r.depth,f=r.xNode,d=r.yNode;if(l>=n){const n=r.xGeohashTotal/r.count,l=r.yGeohashTotal/r.count;t<n&&n<=e&&s<l&&l<=i&&(h+=r.count,o+=r.xTotal,a+=r.yTotal,1===r.count&&(u=r.displayId),this._aggregateStatistics(c,r.statistics)),r=r.next;continue}const p=Math.ceil((l+1)/2),y=Math.floor((l+1)/2),g=1-l%2,w=30-(3*p+2*y),m=30-(2*p+3*y),b=~((1<<w)-1),v=~((1<<m)-1),M=(s&v)>>m,x=(e&b)>>w,_=(i&v)>>m,S=f<<3*g+2*(1-g),I=d<<2*g+3*(1-g),A=S+8*g+4*(1-g),F=I+4*g+8*(1-g),T=Math.max(S,(t&b)>>w),C=Math.max(I,M),R=Math.min(A,x),k=Math.min(F,_);let E=null,O=null;for(let n=C;n<=k;n++)for(let l=T;l<=R;l++){const f=r.children[l-S+(n-I)*(8*g+4*(1-g))];if(f){if(n!==C&&n!==k&&l!==T&&l!==R){const n=f.xGeohashTotal/f.count,r=f.yGeohashTotal/f.count;t<n&&n<=e&&s<r&&r<=i&&(h+=f.count,o+=f.xTotal,a+=f.yTotal,1===f.count&&(u=f.displayId),this._aggregateStatistics(c,f.statistics));continue}E||(E=f,E.next=r.next),O&&(O.next=f),O=f,f.next=r.next}}r=E||r.next}return{count:h,attributes:this._normalizeStatistics(c,h),xTotal:o,yTotal:a,referenceId:u}}_forEachNode(t){let s=this._root;for(;null!==s;){const e=this._linkChildren(s)||s.next;t(s),s=e}}_linkChildren(t){let s=null,e=null;for(let i=0;i<=t.children.length;i++){const n=t.children[i];n&&(s||(s=n,s.next=t.next),e&&(e.next=n),e=n,n.next=t.next)}return s}_updateStatisticsCursor(t,s,e){for(const i of this._statisticFields){const n=i.name,r=i.inField?t.readAttribute(i.inField):t.getComputedNumericAtIndex(i.inFieldIndex);switch(i.statisticType){case"norm":{s.statistics[n]||(s.statistics[n]={});const h=t.readAttribute(i.inNormalizationField),o=s.statistics[n].onStatisticField||0,a=s.statistics[n].onStatisticNormalizationField||0;null==r||isNaN(r)||null==h||0===h||isNaN(h)||(s.statistics[n].onStatisticField=o+e*r,s.statistics[n].onStatisticNormalizationField=a+e*h);break}case"sum":case"avg":{s.statistics[n]||(s.statistics[n]={value:0,nanCount:0});const t=s.statistics[n].value,i=s.statistics[n].nanCount;null==r||isNaN(r)?s.statistics[n].nanCount=i+e:s.statistics[n].value=t+e*r;break}case"avg_angle":{s.statistics[n]||(s.statistics[n]={x:0,y:0,nanCount:0});const t=s.statistics[n].x,i=s.statistics[n].y,h=s.statistics[n].nanCount,o=Math.PI/180;null==r||isNaN(r)?s.statistics[n].nanCount=h+e:(s.statistics[n].x=t+e*Math.cos(r*o),s.statistics[n].y=i+e*Math.sin(r*o));break}case"mode":s.statistics[n]||(s.statistics[n]={}),s.statistics[n][r]=(s.statistics[n][r]||0)+e}}}_aggregateStatistics(t,s){for(const e of this._statisticFields){const i=e.name;switch(e.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":t[i]||(t[i]={});for(const e in s[i])t[i][e]=(t[i][e]||0)+s[i][e]}}}_normalizeStatistics(t,s){const e={};for(const i of this._statisticFields){const n=i.name;switch(i.statisticType){case"norm":{const i=t[n];if(s&&null==i.onStatisticNormalizationField)break;if(s&&i.onStatisticNormalizationField){e[n]=i.onStatisticField/i.onStatisticNormalizationField;break}e[n]=0;break}case"sum":{if(!s)break;const{value:i,nanCount:r}=t[n];if(!(s-r))break;e[n]=i;break}case"avg":{if(!s)break;const{value:i,nanCount:r}=t[n];if(!(s-r))break;e[n]=i/(s-r);break}case"avg_angle":{if(!s)break;const{x:i,y:r,nanCount:h}=t[n];if(!(s-h))break;const o=180/Math.PI,a=Math.atan2(r/(s-h),i/(s-h))*o;e[n]=a;break}case"mode":{const s=t[n];let i=0,r=null;for(const t in s){const e=s[t];e>i&&(i=e,r=t)}e[n]="null"===r?null:r;break}}}return e}}class zi{constructor(t,s,e){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(let t=0;t<this.children.length;t++)this.children[t]=null;this.xNode=t,this.yNode=s,this.depth=e}realloc(t,s,e){for(let t=0;t<this.children.length;t++)this.children[t]=null;return this.xNode=t,this.yNode=s,this.depth=e,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}add(t){this.displayIds.add(t)}remove(t){this.displayIds.delete(t)}getLngLatBounds(){const t=this.depth,s=Math.ceil(t/2),e=Math.floor(t/2);return function(t,s){let e=-90,i=90,n=-180,r=180;for(let h=0;h<s;h++){const s=Math.ceil((h+1)/2),o=Math.floor((h+1)/2),a=1-h%2,c=30-(3*s+2*o),u=30-(2*s+3*o),l=2*a+3*(1-a),f=(7*a+3*(1-a)<<c&t.geohashX)>>c,d=(3*a+7*(1-a)<<u&t.geohashY)>>u;for(let t=3*a+2*(1-a)-1;t>=0;t--){const s=(n+r)/2,e=f&1<<t?1:0;n=(1-e)*n+e*s,r=(1-e)*s+e*r}for(let t=l-1;t>=0;t--){const s=(e+i)/2,n=d&1<<t?1:0;e=(1-n)*e+n*s,i=(1-n)*s+n*i}}return[n,e,r,i]}({geohashX:this.xNode<<30-(3*s+2*e),geohashY:this.yNode<<30-(2*s+3*e)},this.depth)}find(t,s,e,i,n,r){if(i>=e)return this;const h=1-i%2,o=3*h+2*(1-h),a=2*h+3*(1-h),c=30-n-o,u=30-r-a,l=this.children[((t&7*h+3*(1-h)<<c)>>c)+((s&3*h+7*(1-h)<<u)>>u)*(8*h+4*(1-h))];return null==l?null:l.find(t,s,e,i+1,n+o,r+a)}}class Bi extends K{constructor(t,s,e,i,n){super(new tt([],[s,e]),i,null,t),this.geohashBoundsInfo=n}get count(){return this.attributes.cluster_count}static create(t,s,e,i,n,r,h,o){const a=new Bi(s,e,i,r,h);return a.displayId=t.createDisplayId(!0),a.referenceId=o,a.tileLevel=n,a}update(t,s,e,i,n,r){return this.geometry.coords[0]=t,this.geometry.coords[1]=s,this.tileLevel=e,this.attributes=i,this.geohashBoundsInfo=n,this.referenceId=null,this.referenceId=r,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function Xi(t){return 57.29577951308232*t}class Yi extends Ye{constructor(t,s,e){super(t,e),this.events=new b,this._geohashLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this.geometryInfo=t.geometryInfo,this._spatialReference=s,this._projectionSupportCheck=zt(s,$.WGS84),this._bitsets.geohash=e.getBitset(e.createBitset()),this._bitsets.inserted=e.getBitset(e.createBitset())}async updateSchema(t,s){const e=this._schema;try{await super.updateSchema(t,s),await this._projectionSupportCheck}catch(t){}const i=kt(e,s);t.mesh&&(t.targets.aggregate=!0),s&&(!F(i)||t.source||t.storage.filters)&&((Et(i,"params.fields")||!this._tree||t.source)&&(this._tree=new Ui(this._statisticFields),this._rebuildTree(),v("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),v("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",i),t.mesh=!0,t.targets[s.name]=!0,this._aggregateValueRanges={})}sweepFeatures(t,s){this._bitsets.inserted.forEachSet((e=>{if(!t.has(e)){const t=s.lookupByDisplayIdUnsafe(e);this._remove(t)}}))}sweepClusters(t,s,e){this._clusters.forEach(((i,n)=>{i&&i.tileLevel!==e&&(t.releaseDisplayId(i.displayId),s.unsetAttributeData(i.displayId),this._clusters.delete(n))}))}onTileData(t,s,e,i,n){if(!this._schema||F(s.addOrUpdate))return s;const r=this._tree,h=this._getTransforms(t,this._spatialReference);{const t=s.addOrUpdate.getCursor();for(;t.next();)this._update(t,i,r)}if(!n)return s;const o=new Array;this._getClustersForTile(o,t,this._schema.params.clusterRadius,e,r,h),s.type="replace"===s.type?"replace":"update",s.addOrUpdate=ie.fromOptimizedFeatures(o,"esriGeometryPoint"),s.addOrUpdate._storage=e;{const i=s.addOrUpdate.getCursor();for(;i.next();){const s=i.getDisplayId();this._bitsets.computed.unset(s),this.setComputedAttributes(e,i,s,t.scale)}}return this._aggregateValueRangesChanged&&s.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),s}onTileUpdate({added:t,removed:s}){if(t.length&&this._setGeohashLevel(t[0].level),!this._schema)return;const e=this._schema.params.clusterRadius;s.forEach((t=>{this._tiles.delete(t.key.id),this._markTileClustersForDeletion(t,e)}))}getAggregate(t){let s=null;return this._clusters.forEach((e=>{e&&e.displayId===t&&(s=e.toJSON())})),s}getDisplayId(t){const s=this._clusters.get(t);return s?s.displayId:null}getFeatureDisplayIdsForAggregate(t){const s=this._clusters.get(t);if(!s)return[];const e=s.geohashBoundsInfo;return this._tree.getRegionDisplayIds(e.xLL,e.yLL,e.xTR,e.yTR,e.level)}getDisplayIdForReferenceId(t){let s;return this._clusters.forEach((e=>{e&&e.referenceId===t&&(s=e.displayId)})),s}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(t){this._clusters.forEach(((s,e)=>{s&&t(s,e)}))}size(){let t=0;return this.forEach((()=>t++)),t}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._bitsets.geohash.clear(),this._tree&&this._tree.clear()}_remove(t){const s=t.getDisplayId(),e=t.getXHydrate(),i=t.getYHydrate(),n=this._geohashBuf[2*s],r=this._geohashBuf[2*s+1];this._bitsets.inserted.has(s)&&(this._bitsets.inserted.unset(s),this._tree.removeCursor(t,e,i,n,r,this._geohashLevel))}_update(t,s,e){const i=t.getDisplayId(),n=this._bitsets.inserted,r=s.isVisible(i);if(r===n.has(i))return;if(!r)return void this._remove(t);const h=t.getXHydrate(),o=t.getYHydrate();this._setGeohash(i,h,o)&&(e.insertCursor(t,i,h,o,this._geohashBuf[2*i],this._geohashBuf[2*i+1],this._geohashLevel),n.set(i))}_setGeohash(t,s,e){if(this._bitsets.geohash.has(t))return!0;const i=this._geohashBuf;if(this._spatialReference.isWebMercator){const n=Xi(s/Z.radius),r=n-360*Math.floor((n+180)/360);Gi(i,t,Xi(Math.PI/2-2*Math.atan(Math.exp(-1*e/Z.radius))),r,12)}else{const n=Ut({x:s,y:e},this._spatialReference,$.WGS84);if(!n)return!1;Gi(i,t,n.y,n.x,12)}return this._bitsets.geohash.set(t),!0}_getClustersForTile(t,s,e,i,n,r,h=!0){const o=this._schema.params.clusterPixelBuffer,a=2*e,c=this._getGeohashLevel(s.key.level),u=Math.ceil(Math.pow(2,s.key.level)*ls/a),l=Math.ceil(o/a)+0,d=Math.ceil(ls/a),{row:p,col:y}=s.key,g=p*ls,w=Math.floor(y*ls/a)-l,m=Math.floor(g/a)-l,b=w+d+2*l,v=m+d+2*l,M=s.tileInfoView.getLODInfoAt(s.key.level);for(let e=w;e<=b;e++)for(let o=m;o<=v;o++){let a=e;M.wrap&&(a=e<0?e+u:e%u);const l=M.wrap&&e<0,d=M.wrap&&e%u!==e,p=this._lookupCluster(i,M,s.key.level,a,o,c,n);if(f(p)){const s=D(r,(t=>l?t.left:d?t.right:t.tile));if(h&&F(s))continue;if(!p.count)continue;if(f(s)&&h){const e=p.geometry.clone();let i=p.attributes;e.coords[0]=lt(s,e.coords[0]),e.coords[1]=ft(s,e.coords[1]),1===p.count&&f(p.referenceId)&&(i={...p.attributes,referenceId:p.referenceId});const n=new K(e,i);n.displayId=p.displayId,t.push(n)}}}}_getGeohashLevel(t){return Math.min(Math.ceil(t/2+2),12)}_setGeohashLevel(t){const s=this._getGeohashLevel(t),e=1*(Math.floor(s/1)+1)-1;if(this._geohashLevel!==e)return this._geohashLevel=e,void this._rebuildTree()}_getTransforms(t,s){const e={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},i=y(s);if(!i)return{tile:e,left:null,right:null};const[n,r]=i.valid;return{tile:e,left:{...e,translate:[r,t.bounds[3]]},right:{...e,translate:[n-r+t.bounds[0],t.bounds[3]]}}}_getClusterId(t,s,e){return(15&t)<<28|(16383&s)<<14|16383&e}_markForDeletion(t,s,e){const i=this._getClusterId(t,s,e);this._clusters.delete(i)}_getClusterBounds(t,s,e){const i=this._schema.params.clusterRadius,n=2*i;let r=e%2?s*n:s*n-i;const h=e*n;let o=r+n;const a=h-n,c=Math.pow(2,t.level)*ls;t.wrap&&r<0&&(r=0),t.wrap&&o>c&&(o=c);const u=h/ls,l=o/ls,f=a/ls;return[t.getXForColumn(r/ls),t.getYForRow(u),t.getXForColumn(l),t.getYForRow(f)]}_lookupCluster(t,s,e,i,n,r,h){const o=this._getClusterId(e,i,n),a=this._clusters.get(o),[c,u,l,d]=this._getClusterBounds(s,i,n),p={x:c,y:u},y={x:l,y:d};let g=0,w=0,m=0,b=0;if(this._spatialReference.isWebMercator){{const t=Xi(p.x/Z.radius);g=t-360*Math.floor((t+180)/360),w=Xi(Math.PI/2-2*Math.atan(Math.exp(-1*p.y/Z.radius)))}{const t=Xi(y.x/Z.radius);m=t-360*Math.floor((t+180)/360),b=Xi(Math.PI/2-2*Math.atan(Math.exp(-1*y.y/Z.radius)))}}else{const t=Ut(p,this._spatialReference,$.WGS84),s=Ut(y,this._spatialReference,$.WGS84);if(!t||!s)return null;g=t.x,w=t.y,m=s.x,b=s.y}const v={geohashX:0,geohashY:0},M={geohashX:0,geohashY:0};Li(v,w,g,r),Li(M,b,m,r);const x=v.geohashX,_=v.geohashY,S=M.geohashX,I=M.geohashY,A={xLL:x,yLL:_,xTR:S,yTR:I,level:r},F=h.getRegionStatistics(x,_,S,I,r),{count:T,xTotal:C,yTotal:R,referenceId:k}=F,E=T?C/T:0,O=T?R/T:0;if(0===T)return this._clusters.set(o,null),null;const q={cluster_count:T,...F.attributes},j=f(a)?a.update(E,O,e,q,A,k):Bi.create(t,o,E,O,e,q,A,k);return 0===T&&(j.geometry.coords[0]=(c+l)/2,j.geometry.coords[1]=(u+d)/2),this._clusters.set(o,j),this._updateAggregateValueRangeForCluster(j,j.tileLevel),j}_updateAggregateValueRangeForCluster(t,s){const e=this._aggregateValueRanges[s]||{minValue:1/0,maxValue:0},i=e.minValue,n=e.maxValue;e.minValue=Math.min(i,t.count),e.maxValue=Math.max(n,t.count),this._aggregateValueRanges[s]=e,i===e.minValue&&n===e.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(t,s){const e=2*s,i=Math.ceil(ls/e),{row:n,col:r}=t.key,h=n*ls,o=Math.floor(r*ls/e),a=Math.floor(h/e);for(let s=o;s<o+i;s++)for(let e=a;e<a+i;e++)this._markForDeletion(t.key.level,s,e)}}function Vi(t){if(!E(t)&&!function(t){return"worker:port-closed"===t.name}(t))throw t}let $i=class extends Qt{constructor(){super(...arguments),this._storage=new Be,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null,this._editing=!1}initialize(){this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new re({concurrency:4,process:(t,s)=>this._onDisplayTilePatch(t,{signal:s})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(t=>!t&&this.onIdle()))])}async startup(){this._initAttributeStore()}_initSource(){this._source=new Pi(this.service,this.spatialReference,this.tileStore.tileScheme),this._source.onDisplayTilePatch=(t,s)=>(this._invalidated=!0,this._patchTile(t,s)),this._source.canAcceptPatch=()=>this._updateQueue.length<50;const t=this._source.sourceEvents;if("geoevent"===t.type){const s=t.events;this.handles.add([s.on("connectionStatus",(t=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(Vi))),s.on("errorString",(t=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(Vi))),s.on("feature",(t=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(Vi))),s.on("updateRate",(t=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...t}}).catch(Vi)))])}}_initAttributeStore(){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new Le({type:"remote",initialize:(t,s)=>Q(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:s}).catch(Vi)),update:(t,s)=>Q(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:s}).catch(Vi)),render:t=>Q(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(Vi))},this.config)}_initStores(){const t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new We(t,this._storage),this.aggregateStore=new Yi(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(t=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(Vi)})))}_initQueryEngine(){var t;const s=this;null==(t=this.queryEngine)||t.destroy(),this.queryEngine=new Bt({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:t=>s.aggregateStore.getFeatureDisplayIdsForAggregate(t).map((t=>s.getObjectId(t)))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy()}get fieldsIndex(){return new Rt(this.service.fields)}get hasAggregates(){return!!this.config.schema.targets.aggregate}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){return this._source.updating||!!this._updateQueue.length}enableEvent(t){this._source.enableEvent(t.name,t.value)}async invalidate(t){if(!t.any())return;v("esri-2d-update-debug")&&t.describe();const s=this.tileStore.tiles.map((({key:t})=>{const s=k();return this._tileToResolver.set(t.id,s),s.promise})),e=this._updateQueue.takeAll();this._updateQueue.resume(),this.hasAggregates&&t.mesh&&t.targets.aggregate&&!t.queryFilter?this._repushAggregateMeshTiles(t):(this._source.resubscribe(t),R(s).then((()=>{this._source.resume()})),t.mesh&&await pt(this,"updating")),this.notifyChange("updating"),await R(s),this._updateQueue.pause();for(const t of e)this._patchTile(t);t.source&&(this._cleanupNeeded=!0)}resume(){return this._updateQueue.resume(),this._source.resume()}async update(t,s,e=!1){this._editing&&await pt(this,"updating"),e&&(this._source.pause(),this._updateQueue.pause()),this._set("config",s),this._schema=s.schema,this._initQueryEngine(),await R([this._source.update(t,s.schema.source),this.featureStore.updateSchema(t,s.schema.targets.feature),this.attributeStore.update(t,s),this.attributeStore.updateFilters(t,this)]),await this.aggregateStore.updateSchema(t,s.schema.targets.aggregate)}async refresh(){this._source.resubscribe(ee.all(),!0),this._cleanupNeeded=!0,this.notifyChange("updating"),await pt(this,"updating",!0)}onTileUpdate(t){this.aggregateStore.onTileUpdate(t);for(const s of t.added)this._source.subscribe(s),this._level=s.level;for(const s of t.removed)this._source.unsubscribe(s),this._cleanupNeeded=!0,this._tileToResolver.has(s.id)&&(this._tileToResolver.get(s.id).resolve(),this._tileToResolver.delete(s.id));this.notifyChange("updating")}onIdle(){this.hasAggregates&&this._invalidated&&(this._repushAggregateMeshTiles(),this._invalidated=!1),this._markAndSweep()}async onEdits(t){if(this._editing)return await pt(this,"updating"),await B(16),this.onEdits(t);this._editing=!0;try{await this._source.onEdits(t),await pt(this,"updating")}catch(t){}this._editing=!1}queryExtent(t){return this.queryEngine.executeQueryForExtent(t)}queryFeatures(t){return this.queryEngine.executeQuery(t)}queryFeatureCount(t){return this.queryEngine.executeQueryForCount(t)}queryLatestObservations(t){return this.queryEngine.executeQueryForLatestObservations(t)}queryObjectIds(t){return this.queryEngine.executeQueryForIds(t)}async queryStatistics(){return{...this.featureStore.storeStatistics,displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0}}getObjectId(t){return this.featureStore.lookupObjectId(t,this._storage)}getDisplayId(t){if(this._schema.targets.aggregate){const s=this.aggregateStore.getDisplayId(t);if(F(s)){const s=this.featureStore.lookupDisplayId(t);return this.aggregateStore.getDisplayIdForReferenceId(s)}return s}return this.featureStore.lookupDisplayId(t)}getFeature(t){const s=this.featureStore.lookupFeatureByDisplayId(t,this._storage);if(F(s))return null;const e=s.readHydratedGeometry(),i=nt(e,s.geometryType,s.hasZ,s.hasM);return{attributes:s.readAttributes(),geometry:i}}getAggregate(t){return this.aggregateStore.getAggregate(t)}async setHighlight(t){const s=t.map((t=>this.getDisplayId(t)));return this.attributeStore.setHighlight(t,s)}_repushAggregateMeshTiles(t){for(const s of this.tileStore.tiles)this._patchTile({type:"replace",id:s.key.id,addOrUpdate:ie.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,noData:!1,update:t||ee.create({mesh:!0,targets:{aggregate:!0}})})}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(t,s){const e=this._updateQueue.push(t,s).then((()=>{this.notifyChange("updating")})).catch((()=>{this.notifyChange("updating")}));return this.notifyChange("updating"),e}async _onDisplayTilePatch(t,s){z(s);const e=this.tileStore.get(t.id);if(!e)return;const i=t.update;t.remove.length&&(this._cleanupNeeded=!0);const n=[];for(const s of t.remove)n.push(this.featureStore.lookupDisplayId(s));t.remove=n;try{if(F(t.addOrUpdate))return this.processor.onTileData(e,{...t,addOrUpdate:null},s).catch((t=>{H(t)})),void this._finishedPatch(t);t.addOrUpdate._storage=this._storage;const n=t.addOrUpdate.hasFilter(),r=t.addOrUpdate.instance;t.addOrUpdate._arcadeSpatialReference=this.spatialReference,(!this.featureStore.hasInstance(r)||i.targets.feature&&!n)&&this.featureStore.onTileData(e,t,this._storage),!i.storage.data&&!i.storage.filters||n||(this.attributeStore.onTileData(e,t),this._source.isStream?await this.attributeStore.sendUpdates():this.attributeStore.sendUpdates()),this.hasAggregates&&i.targets.aggregate&&(this.aggregateStore.onTileData(e,t,this._storage,this.attributeStore,i.mesh),i.mesh&&(this.attributeStore.onTileData(e,t),await this.attributeStore.sendUpdates())),i.mesh&&await this.processor.onTileData(e,t,s),this._maybeForceCleanup(),this._finishedPatch(t)}catch(t){H(t)}}_finishedPatch(t){(t.noData||t.end)&&this._tileToResolver.has(t.id)&&(this._tileToResolver.get(t.id).resolve(),this._tileToResolver.delete(t.id))}_markAndSweep(){if(this._lastCleanup=performance.now(),!this._cleanupNeeded&&!this._source.isStream)return;this._cleanupNeeded=!1;const t=this._storage.getBitset(this._markedIdsBufId),s=new Set;t.clear();const e=e=>{const i=this.featureStore.lookupDisplayId(e),n=(4294901760&this._storage.getInstanceId(i))>>>16;i&&(s.add(n),t.set(i))};for(const t of this.tileStore.tiles)this._source.forEachRequest(t.key.id,(t=>{if(F(t.features))return;const s=t.features.getCursor();for(;s.next();){const t=s.getObjectId();e(t)}}));this._source.forEachPendingEdit((t=>e(t))),this._updateQueue.forEach((t=>{for(const s of t.remove)e(s)})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(s)}};t([s({constructOnly:!0})],$i.prototype,"tileStore",void 0),t([s()],$i.prototype,"config",void 0),t([s({readOnly:!0,dependsOn:["service"]})],$i.prototype,"fieldsIndex",null),t([s()],$i.prototype,"processor",void 0),t([s({constructOnly:!0})],$i.prototype,"remoteClient",void 0),t([s({constructOnly:!0})],$i.prototype,"service",void 0),t([s({dependsOn:["tileStore"]})],$i.prototype,"spatialReference",null),t([s()],$i.prototype,"updating",null),$i=t([a("esri.views.2d.layers.features.controllers.FeatureController2D")],$i);var Hi=$i;const Wi=new Set;let Zi=class extends Qt{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null}initialize(){this.handles.add(this.watch("updating",(t=>{this.remoteClient.invoke("setUpdating",t).catch((()=>{}))})))}destroy(){var t,s,e;null==(t=this.controller)||t.destroy(),null==(s=this.processor)||s.destroy(),null==(e=this.tileStore)||e.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}async startup({service:t,config:s,tileInfo:e}){if(this.service=t,!this.tileStore){const t=new Zs(mt.fromJSON(e));this.tileStore=new se(t)}await this._configure(s),this.tileStore.clear()}async updateTiles(t){this.tileStore.updateTiles(t)}async update({config:t,pause:s}){const e=ee.empty();return await R([this.processor.update(e,t),this.controller.update(e,t,s)]),e.toJSON()}async invalidate(t){const s=ee.create(t),e=this.controller.invalidate(s);return await this.remoteClient.invoke("setUpdating",this.updating),e}setViewState(t){const s=Gs.fromJSON(t);this._set("viewState",s)}async _configure(t){await R([this._handleControllerConfig(t),this._handleProcessorConfig(t)]),this.controller.processor=this.processor,await this.update({config:t})}async _handleControllerConfig(t){const s=await this._createController(this.service,t);return await s.startup(),s}async _handleProcessorConfig(t){return this._createProcessor(this.service,t)}async _createController(t,s){this.controller&&this.controller.destroy();const{tileStore:e,remoteClient:i}=this,n=new Hi({service:t,config:s,tileStore:e,remoteClient:i});return this.controller=n,n}async _createProcessor(t,s){const e=s.schema.processors[0].type,i=(await function(t){return"heatmap"===t?import("./p-8287937f.js"):import("./p-d77c4749.js")}(e)).default,{remoteClient:n,tileStore:r}=this,h=new i({service:t,config:s,tileStore:r,remoteClient:n});return this.processor&&this.processor.destroy(),this.processor=h,h}};t([s()],Zi.prototype,"controller",void 0),t([s()],Zi.prototype,"processor",void 0),t([s({dependsOn:["controller.updating"]})],Zi.prototype,"updating",null),t([s()],Zi.prototype,"viewState",void 0),Zi=t([a("esri.views.2d.layers.features.Pipeline")],Zi);const Qi=Object.freeze({__proto__:null,default:Zi,getInstances:function(){return Wi}});export{ue as A,_e as C,he as E,Se as O,Qi as P,Ae as S,Fe as Z,le as _,xe as a,je as b,He as d,As as n,Re as o,Fs as t}