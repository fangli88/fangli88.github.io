import"./p-476cf7c4.js";import{y as e,Z as s,s as t,a8 as i,e4 as r,a0 as l,e5 as o,Q as n,ay as a,aC as u,z as c,bq as h,ae as p,U as y,D as d,E as m,ag as f,F as b,K as v,b as j,cN as w,aG as g}from"./p-ab028778.js";import"./p-2ef6e039.js";import"./p-7575e94f.js";import"./p-73b795c3.js";import{j as S,x}from"./p-e07a8dfe.js";import"./p-b92ca348.js";import"./p-f16fbea1.js";import{l as G,b as O}from"./p-1ff061ae.js";import"./p-8fc84c2d.js";import{l as P,p as M}from"./p-1cce98ff.js";import{d as k}from"./p-c5691699.js";import"./p-dc697c54.js";import"./p-754df0ae.js";import"./p-89accc4e.js";import"./p-4a36891c.js";import{t as L}from"./p-48626aa9.js";import{o as E}from"./p-f53b64f4.js";import{s as K}from"./p-b9c578c1.js";import{S as F,i as N,o as z,C}from"./p-4561de0e.js";import{l as R}from"./p-279240d1.js";const T={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function _(e){const s=e.folders||[],i=s.slice(),r=new Map,l=new Map,o=new Map,n=new Map,a=new Map,u={esriGeometryPoint:l,esriGeometryPolyline:o,esriGeometryPolygon:n};(e.featureCollection&&e.featureCollection.layers||[]).forEach((e=>{const s=t(e);s.featureSet.features=[];const i=e.featureSet.geometryType;r.set(i,s);const a=e.layerDefinition.objectIdField;"esriGeometryPoint"===i?J(l,a,e.featureSet.features):"esriGeometryPolyline"===i?J(o,a,e.featureSet.features):"esriGeometryPolygon"===i&&J(n,a,e.featureSet.features)})),e.groundOverlays&&e.groundOverlays.forEach((e=>{a.set(e.id,e)})),s.forEach((s=>{s.networkLinkIds.forEach((t=>{const r=function(e,s,t){const i=function(e,s){let t;return s.some((s=>s.id===e&&(t=s,!0))),t}(e,t);return i&&(i.parentFolderId=s,i.networkLink=i),i}(t,s.id,e.networkLinks);r&&i.push(r)}))})),i.forEach((e=>{e.featureInfos&&(e.points=t(r.get("esriGeometryPoint")),e.polylines=t(r.get("esriGeometryPolyline")),e.polygons=t(r.get("esriGeometryPolygon")),e.mapImages=[],e.featureInfos.map((s=>{switch(s.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const t=u[s.type].get(s.id);t&&e[T[s.type]].featureSet.features.push(t);break}case"GroundOverlay":{const t=a.get(s.id);t&&e.mapImages.push(t);break}}})),e.fullExtent=V([e]))}));const c=V(i);return{folders:s,sublayers:i,extent:c}}function q(e,t,o,n){const a=i&&i.findCredential(e);return e=r(e,{token:a&&a.token}),s(l.kmlServiceUrl,{query:{url:e,model:"simple",folders:"",refresh:0!==o||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:n})}function I(e,s,t=null,i=[]){const r=[],l={},o=s.sublayers,n=s.folders.map((e=>e.id));return o.forEach((s=>{const o=new e;if(t?o.read(s,t):o.read(s),i.length&&n.indexOf(o.id)>-1&&(o.visible=-1!==i.indexOf(o.id)),l[s.id]=o,null!=s.parentFolderId&&-1!==s.parentFolderId){const e=l[s.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers.unshift(o)}else r.unshift(o)})),r}function J(e,s,t){t.forEach((t=>{e.set(t.attributes[s],t)}))}function V(s){const t=N(),i=N(C);for(const e of s){if(e.polygons&&e.polygons.featureSet&&e.polygons.featureSet.features)for(const s of e.polygons.featureSet.features)o(t,s.geometry),z(i,t);if(e.polylines&&e.polylines.featureSet&&e.polylines.featureSet.features)for(const s of e.polylines.featureSet.features)o(t,s.geometry),z(i,t);if(e.points&&e.points.featureSet&&e.points.featureSet.features)for(const s of e.points.featureSet.features)o(t,s.geometry),z(i,t);if(e.mapImages)for(const s of e.mapImages)o(t,s.extent),z(i,t)}return F(i,C)?null:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:e.WGS84}}var W;let A=W=class extends(n.EventedMixin(a(u))){constructor(){super(...arguments),this._sublayersHandles=null,this.description=null,this.id=null,this.networkLink=null,this.title=null,this.sourceJSON=null,this.fullExtent=null}initialize(){S(this,"networkLink").then((()=>x(this,"visible"))).then((()=>this.load()))}load(e){if(!this.networkLink)return;const s=j(e)?e.signal:null,t=this._fetchService(this._get("networkLink").href,s).then((e=>{const s=V(e.sublayers);this.fullExtent=c.fromJSON(s),this.sourceJSON=e;const t=h(p.ofType(W),I(W,e));this.sublayers?this.sublayers.addMany(t):this.sublayers=t,this.layer.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")}));return this.addResolvingPromise(t),y(this)}set sublayers(e){const s=this._get("sublayers");s&&(s.forEach((e=>{e.parent=null,e.layer=null})),this._sublayersHandles.forEach((e=>e.remove())),this._sublayersHandles=null),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this._sublayersHandles=[e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))]),this._set("sublayers",e)}castSublayers(e){return h(p.ofType(W),e)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,s){return!!s.visibility}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach((s=>s.layer=e))}_fetchService(e,s){return q(e,this.layer.outSpatialReference,this.layer.refreshInterval,s).then((e=>_(e.data)))}};d([m()],A.prototype,"description",void 0),d([m()],A.prototype,"id",void 0),d([m({readOnly:!0,value:null})],A.prototype,"networkLink",void 0),d([m({json:{write:{allowNull:!0}}})],A.prototype,"parent",void 0),d([m({value:null,json:{write:{allowNull:!0}}})],A.prototype,"sublayers",null),d([f("sublayers")],A.prototype,"castSublayers",null),d([m({value:null,json:{read:{source:"name"}}})],A.prototype,"title",void 0),d([m({value:!0})],A.prototype,"visible",null),d([b("visible",["visibility"])],A.prototype,"readVisible",null),d([m()],A.prototype,"sourceJSON",void 0),d([m({value:null})],A.prototype,"layer",null),d([m({type:c})],A.prototype,"fullExtent",void 0),A=W=d([v("esri.layers.support.KMLSublayer")],A);var D=A;const Q=["kml","xml"];let U=class extends(L(E(K(P(k(G(O))))))){constructor(...s){super(...s),this._visibleFolders=[],this.allSublayers=new R({root:this,rootCollectionNames:["sublayers"],getChildrenFunction:e=>e.sublayers}),this.outSpatialReference=e.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType="KML",this.sublayers=null,this.type="kml",this.url=null}initialize(){this.watch("sublayers",((e,s)=>{s&&s.forEach((e=>{e.parent=null,e.layer=null})),e&&e.forEach((e=>{e.parent=this,e.layer=this}))}),!0),this.on("sublayer-update",(()=>this.notifyChange("fullExtent")))}normalizeCtorArgs(e,s){return"string"==typeof e?{url:e,...s}:e}readSublayersFromItemOrWebMap(e,s){this._visibleFolders=s.visibleFolders}readSublayers(e,s,t){return I(D,s,t,this._visibleFolders)}writeSublayers(e,s){const t=[],i=e.toArray();for(;i.length;){const e=i[0];e.networkLink||(e.visible&&t.push(e.id),e.sublayers&&i.push(...e.sublayers.toArray())),i.shift()}s.visibleFolders=t}get title(){const e=this._get("title");return e&&"defaults"!==this.originOf("title")?e:this.url?w(this.url,Q)||"KML":e||""}set title(e){this._set("title",e)}get visibleSublayers(){const e=this.sublayers,s=[],t=e=>{e.visible&&(s.push(e),e.sublayers&&e.sublayers.forEach(t))};return e&&e.forEach(t),s}get fullExtent(){return this._recomputeFullExtent()}load(e){const s=j(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"]},e).then((()=>this._fetchService(s)))),y(this)}async _fetchService(e){const s=_((await y().then((()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:q(this.url,this.outSpatialReference,this.refreshInterval,e)))).data);s&&this.read(s,{origin:"service"})}_recomputeFullExtent(){let e=null;this.extent&&(e=this.extent.clone());const s=t=>{if(t.sublayers)for(const i of t.sublayers.items)s(i),i.visible&&i.fullExtent&&(e?e.union(i.fullExtent):e=i.fullExtent.clone())};return s(this),e}};d([m({readOnly:!0})],U.prototype,"allSublayers",void 0),d([m({type:e})],U.prototype,"outSpatialReference",void 0),d([m({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],U.prototype,"path",void 0),d([m({readOnly:!0,json:{read:!1,write:!1}})],U.prototype,"legendEnabled",void 0),d([m({type:["show","hide","hide-children"]})],U.prototype,"listMode",void 0),d([m({type:["KML"]})],U.prototype,"operationalLayerType",void 0),d([m({type:p.ofType(D),json:{write:{ignoreOrigin:!0}}})],U.prototype,"sublayers",void 0),d([b(["web-map","portal-item"],"sublayers",["visibleFolders"])],U.prototype,"readSublayersFromItemOrWebMap",null),d([b("service","sublayers",["sublayers"])],U.prototype,"readSublayers",null),d([g("sublayers")],U.prototype,"writeSublayers",null),d([m({readOnly:!0,json:{read:!1}})],U.prototype,"type",void 0),d([m({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}},dependsOn:["url","parsedUrl"]})],U.prototype,"title",null),d([m(M)],U.prototype,"url",void 0),d([m({readOnly:!0,dependsOn:["sublayers"]})],U.prototype,"visibleSublayers",null),d([m({type:c})],U.prototype,"extent",void 0),d([m({dependsOn:["extent"]})],U.prototype,"fullExtent",null),U=d([v("esri.layers.KMLLayer")],U);var Z=U;export default Z;