import"./p-476cf7c4.js";import{m as t,ea as s,cb as i,D as e,E as r,aG as n,K as h,dQ as o,n as a,s as c,l,k as u,C as f,b as p,aq as d,i as m,b8 as w,dj as y,eb as M,ec as g,ed as b,ee as v,ef as x,di as _,t as S,bA as z,d as V,eg as T,eh as j,ei as k,aJ as F,bT as I,c7 as L,O as C,U as A,ej as G,d1 as P,V as D,h as R,ad as U,cL as B,X as O,aF as N,y as E}from"./p-ab028778.js";import"./p-2ef6e039.js";import"./p-7575e94f.js";import{a as K}from"./p-ebb65ba7.js";import{m as W,K as $}from"./p-fd91cc88.js";import"./p-43d5e67f.js";import"./p-6dae6b5e.js";import"./p-babdd7a5.js";import"./p-098cc742.js";import"./p-73b795c3.js";import"./p-e07a8dfe.js";import"./p-c6c7c9c2.js";import"./p-f16fbea1.js";import"./p-8fc84c2d.js";import"./p-e7501203.js";import"./p-8a0d1aa6.js";import"./p-f3cc8f75.js";import"./p-e2c62b7c.js";import"./p-a1a69fdc.js";import{y as q,p as X}from"./p-89accc4e.js";import"./p-8509ef38.js";import"./p-15538a25.js";import"./p-311069c2.js";import{j as H,N as Y,O as J}from"./p-6501f469.js";import"./p-8bb40e65.js";import"./p-50ee3927.js";import"./p-05d2fbdb.js";import"./p-02a4b6c8.js";import"./p-abda1e64.js";import"./p-a8e713de.js";import"./p-fb40af74.js";import"./p-4f43bb64.js";import"./p-2b439a2e.js";import"./p-4561de0e.js";import"./p-3db2569b.js";import"./p-a6dff060.js";import"./p-920b2088.js";import{r as Q,D as Z}from"./p-fa359158.js";import"./p-004e9de0.js";import"./p-65bdc41d.js";import{A as tt,E as st,_ as it,o as et,t as rt,n as nt,M as ht,a as ot,u as at,h as ct,c as lt,b as ut,e as ft,S as pt,Z as dt,C as mt,O as wt,d as yt,f as Mt}from"./p-9029ef66.js";import"./p-82888562.js";import"./p-b37db934.js";import"./p-237dc417.js";import{s as gt,X as bt,i as vt,o as xt,R as _t,p as St,f as zt,j as Vt,w as Tt,x as jt,g as kt}from"./p-f6aca36e.js";import{a as Ft,l as It,s as Lt,b as Ct,c as At,h as Gt,E as Pt,r as Dt,i as Rt,u as Ut,M as Bt,d as Ot,f as Nt,o as Et}from"./p-6258c9fc.js";import{p as Kt}from"./p-381be496.js";function Wt(t,s){return 65535&t|s<<16}function $t(t,s,i,e){return 255&t|(255&s)<<8|(255&i)<<16|e<<24}function qt(t){if(!t)return 0;const{r:s,g:i,b:e,a:r}=t;return $t(s*r,i*r,e*r,255*r)}function Xt(t){if(!t)return 0;const[s,i,e,r]=t;return $t(s*(r/255),i*(r/255),e*(r/255),r)}const Ht=new Ft;function Yt(t){if(!Ht.hasBidiChar(t))return[t,!1];let s;return s="rtl"===Ht.checkContextual(t)?"IDNNN":"ICNNN",[Ht.bidiTransform(t,s,"VLYSN"),!0]}function Jt(t){switch(t){case"above-along":case"below-along":case"center-along":return 1;default:return 0}}function Qt(t,s,i,e,r){switch(t){case st.FILL:return rs.from(s,e);case st.LINE:return hs.from(s,i);case st.MARKER:return ns.from(s);case st.TEXT:return os.from(s);case st.LABEL:return as.from(s,r);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${t}`)}}class Zt{constructor(t){this._data=0,this._data=t}static load(t){const s=this.shared;return s.data=t,s}set data(t){this._data=t}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(t){this.setBits(t,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(t){this.setBit(20,t)}get sdf(){return!!this.bit(11)}set sdf(t){this.setBit(11,t)}get pattern(){return!!this.bit(12)}set pattern(t){this.setBit(12,t)}get textureBinding(){return this.bits(0,8)}set textureBinding(t){this.setBits(t,0,8)}get geometryTypeString(){switch(this.geometryType){case st.FILL:return"fill";case st.MARKER:return"marker";case st.LINE:return"line";case st.TEXT:return"text";case st.LABEL:return"label";default:throw new t(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(t,s){const i=1<<t;s?this._data|=i:this._data&=~i}bit(t){return(this._data&1<<t)>>t}setBits(t,s,i){for(let e=s,r=0;e<i;e++,r++)this.setBit(e,0!=(t&1<<r))}bits(t,s){let i=0;for(let e=t,r=0;e<s;e++,r++)i|=this.bit(e)<<r;return i}hasVV(){return!1}setVV(t,s){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf}}getVariationHash(){return this._data&~(7&this.textureBinding)}}Zt.shared=new Zt(0);const ts=t=>class extends t{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(t){this.setBit(16,t)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(t){this.setBit(17,t)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(t){this.setBit(18,t)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(t){this.setBit(19,t)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(t,s){super.setVV(t,s);const i=function(t,s=!1){const i=tt.SIZE_FIELD_STOPS|tt.SIZE_MINMAX_VALUE|tt.SIZE_SCALE_STOPS|tt.SIZE_UNIT_VALUE,e=(t&(it.FIELD_TARGETS_OUTLINE|it.MINMAX_TARGETS_OUTLINE|it.SCALE_TARGETS_OUTLINE|it.UNIT_TARGETS_OUTLINE))>>>4;return s?i&e:i&~e}(t,s)&t;this.vvSizeMinMaxValue=!!(i&tt.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(i&tt.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(i&tt.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(i&tt.SIZE_SCALE_STOPS)}},ss=t=>class extends t{get vvRotation(){return 0!==this.bit(15)}set vvRotation(t){this.setBit(15,t)}hasVV(){return super.hasVV()||this.vvRotation}setVV(t,s){super.setVV(t,s),this.vvRotation=!s&&!!(t&tt.ROTATION)}},is=t=>class extends t{get vvColor(){return 0!==this.bit(13)}set vvColor(t){this.setBit(13,t)}hasVV(){return super.hasVV()||this.vvColor}setVV(t,s){super.setVV(t,s),this.vvColor=!s&&!!(t&tt.COLOR)}},es=t=>class extends t{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(t){this.setBit(14,t)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(t,s){super.setVV(t,s),this.vvOpacity=!s&&!!(t&tt.OPACITY)}};class rs extends(is(es(Zt))){static load(t){const s=this.shared;return s.data=t,s}static from(t,s){const i=this.load(0);return i.geometryType=st.FILL,s?i.dotDensity=!0:i.setVV(t,!1),i.data}getVariation(){return{...super.getVariation(),dotDensity:this.dotDensity,vvColor:this.vvColor,vvOpacity:this.vvOpacity}}get dotDensity(){return!!this.bit(15)}set dotDensity(t){this.setBit(15,t)}}rs.shared=new rs(0);class ns extends(is(es(ss(ts(Zt))))){static load(t){const s=this.shared;return s.data=t,s}static from(t){const s=this.load(0);return s.geometryType=st.MARKER,s.setVV(t,!1),s.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}ns.shared=new ns(0);class hs extends(is(es(ts(Zt)))){static load(t){const s=this.shared;return s.data=t,s}static from(t,s){const i=this.load(0);return i.geometryType=st.LINE,i.setVV(t,s),i.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}hs.shared=new hs(0);class os extends(is(es(ss(ts(Zt))))){static load(t){const s=this.shared;return s.data=t,s}static from(t){const s=this.load(t);return s.geometryType=st.TEXT,s.setVV(t,!1),s.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}os.shared=new os(0);class as extends(ts(Zt)){static load(t){const s=this.shared;return s.data=t,s}static from(t,s){const i=this.load(0);return i.geometryType=st.LABEL,i.setVV(t,!1),i.mapAligned=!!Jt(s),i.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}as.shared=new as(0);const cs={marker:st.MARKER,fill:st.FILL,line:st.LINE,text:st.TEXT};class ls{constructor(t,s,i){this.layers=t,this.data=s,this.hash=this._createHash(),this.rendererKey=i;for(const s of t)s.materialKey=Qt(cs[s.type],this.rendererKey,!1,!1)}get type(){return"expanded-cim"}_createHash(){let t="";for(const s of this.layers)t+=s.templateHash;return t}}const us=async(t,i)=>new ls(await s(t.data,i),t.data,t.rendererKey),fs=async(t,s,e)=>{if(!t)return null;if("cim"===t.type)return us(t,s);if("web-style"===t.type){const r=i.fromJSON(t),n={type:"cim",data:(await r.fetchCIMSymbol(e)).data,rendererKey:t.rendererKey};return us(n,s)}return t};var ps;let ds=ps=class extends o{writeLevels(t,s,i){for(const i in t)return void(s.stops=this.levels[i])}clone(){return new ps({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:a(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:a(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map((t=>t.clone())),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:c(this.levels)})}};function ms(t){return function(t){switch(Zt.load(t).geometryType){case st.MARKER:return new ns(t);case st.FILL:return new rs(t);case st.LINE:return new hs(t);case st.TEXT:return new os(t);case st.LABEL:return new as(t)}}(t)}function ws(t){switch(t.type){case"line-marker":var s;return{type:"line-marker",color:null==(s=t.color)?void 0:s.toJSON(),placement:t.placement,style:t.style};default:return d(t.toJSON()).toJSON()}}function ys(t,s,i){if(!t)return null;let e=0,r=!1;switch(p(s)&&"visualVariables"in s&&(e=function(t){if(!t)return tt.NONE;let s=0;for(const i of t)if("size"===i.type){const t=et(i);s|=t,"outline"===i.target&&(s|=t<<4)}else"color"===i.type?s|=tt.COLOR:"opacity"===i.type?s|=tt.OPACITY:"rotation"===i.type&&(s|=tt.ROTATION);return s}(s.visualVariables||[]),r="dot-density"===s.type),t.type){case"simple-fill":case"picture-fill":return function(t,s,i,e){const r=Qt(st.FILL,s,!1,i),n=e?ms(r):r,h=t.clone(),o=h.outline;h.outline=null;const a=[],c={materialKey:n,hash:h.hash(),...ws(h)};if(a.push(c),o){const t=Qt(st.LINE,s,!0,!1),i={materialKey:e?ms(t):t,hash:o.hash(),...ws(o)};a.push(i)}return{type:"composite-symbol",layers:a,hash:a.reduce(((t,s)=>s.hash+t),"")}}(t,e,r,i);case"simple-marker":case"picture-marker":return function(t,s,i){const e=Qt(st.MARKER,s,!1,!1),r=i?ms(e):e,n=ws(t);return{materialKey:r,hash:t.hash(),...n,angle:t.angle}}(t,e,i);case"simple-line":return function(t,s,i){const e=Qt(st.LINE,s,!1,!1),r=i?ms(e):e,n=t.clone(),h=n.marker;n.marker=null;const o=[];if(o.push({materialKey:r,hash:n.hash(),...ws(n)}),h){var a;const t=Qt(st.MARKER,s,!1,!1),e=i?ms(t):t;h.color=null!=(a=h.color)?a:n.color,o.push({materialKey:e,hash:h.hash(),lineWidth:n.width,...ws(h)})}return{type:"composite-symbol",layers:o,hash:o.reduce(((t,s)=>s.hash+t),"")}}(t,e,i);case"text":return function(t,s,i){const e=Qt(st.TEXT,s,!1,!1),r=i?ms(e):e,n=ws(t);return{materialKey:r,hash:t.hash(),...n,angle:t.angle}}(t,e,i);case"label":return function(t,s,i){const e=Qt(st.LABEL,s,!1,!1,t.labelPlacement);return{materialKey:i?ms(e):e,hash:t.hash(),...t.toJSON(),labelPlacement:t.labelPlacement}}(t,e,i);case"cim":return{type:"cim",rendererKey:e,data:t.data};case"web-style":return{...ws(t),type:"web-style",hash:t.hash(),rendererKey:e};default:throw new Error(`symbol not supported ${t.type}`)}}e([r()],ds.prototype,"levels",void 0),e([n("levels")],ds.prototype,"writeLevels",null),ds=ps=e([h("esri.views.2d.engine.LevelDependentSizeVariable")],ds),l.getLogger("esri.views.2d.layers.support.clusterUtils"),u.add("esri-cluster-arcade-enabled",1),u("esri-cluster-arcade-enabled"),l.getLogger("esri.renderers.visualVariables.support.utils"),new f({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch",mesh:"mesh"}),l.getLogger("esri.views.2d.layers.features.schemaUtils");const Ms=l.getLogger("esri/views/2d/engine/webgl/util/Matcher");class gs{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,s,i){const e=new gs;if(t.symbol){const r=await fs(t.symbol,i),n=s.createTemplateGroup(r,null);e.setDefault(n)}return e}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,s,i,e,r){return this.getDefault()}async analyze(t,s,i,e,r){return null}}class bs extends gs{constructor(t,s,i,e){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=s,this._fieldIndex=e,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,s,i){const{isMaxInclusive:e,normalizationField:r,normalizationTotal:n,normalizationType:h}=t,o=new bs(t.field,e,{normalizationField:r,normalizationTotal:n,normalizationType:h},t.fieldIndex),a=await fs(t.backgroundFillSymbol,i);await m(t.intervals.map((async t=>{const e=await fs(t.symbol,i),r=await s.createTemplateGroup(e,a);o.add({min:t.min,max:t.max},r)})));const c=await fs(t.defaultSymbol,i);if(c){const t=await s.createTemplateGroup(c,a);o.setDefault(t)}return o}add(t,s){this._intervals.push({interval:t,result:s}),this._intervals.sort(((t,s)=>t.interval.min-s.interval.min))}size(){return super.size()+this._intervals.length}match(t,s,i,e,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?s.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(s);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let t=0;t<this._intervals.length;t++){const{interval:s,result:i}=this._intervals[t],e=this._isMaxInclusive?n<=s.max:n<s.max;if(n>=s.min&&e)return i}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const s=t.readAttribute(this._field);if(!this._needsNormalization())return s;const{normalizationField:i,normalizationTotal:e,normalizationType:r}=this._normalizationInfo,n=!!i&&t.readAttribute(i);if(r)switch(r){case"esriNormalizeByField":return n?s/n:void 0;case"esriNormalizeByLog":return Math.log(s)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return s/e*100;default:return void Ms.error(`Found unknown normalization type: ${r}`)}else Ms.error("Normalization is required, but no type was set!")}}class vs extends gs{constructor(t,s,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=s||""}static async fromUVRenderer(t,s,i){const e=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const n=await fs(t.backgroundFillSymbol,i),h=new vs(r,e,t.fieldIndex);await m(t.map.map((async t=>{const e=await fs(t.symbol,i),r=await s.createTemplateGroup(e,n);"<Null>"===t.value?h.setNullResult(r):h.add(t.value,r)})));const o=await fs(t.defaultSymbol,i);if(o){const t=await s.createTemplateGroup(o,n);h.setDefault(t)}return h}setNullResult(t){this._nullResult=t}add(t,s){this._resultsMap.set(t.toString(),s)}size(){return super.size()+this._resultsMap.size}match(t,s,i,e,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?s.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(s);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const h=n.toString();return this._resultsMap.has(h)?this._resultsMap.get(h):this.getDefault()}_getValueFromFields(t){const s=[];for(const i of this._fields){const e=t.readAttribute(i);s.push(e)}return s.join(this._seperator)}}class xs extends gs{constructor(t,s,i,e){super(),this.type="dictionary",this._groupIdCache=new w(100),this._renderer=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=s,this._info=i,this._scaleFn=e}static async fromDictionaryRenderer(t,s,i){const e=(await import("./p-ab028778.js").then((function(t){return t.ex}))).default.fromJSON(t.renderer);await e.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const r=await async function(t,s){const i=t||1;if("number"==typeof i)return()=>i;const e=await y(i,s.spatialReference,s.fields);return(t,i,r)=>M(e,t,{$view:r},s.geometryType,i)||1}(e.scaleExpression,i);return new xs(e,s,i,r)}async _analyzeFeature(s,i,e,r){const n=s.readLegacyFeature(),h=this._scaleFn(n,i,e),o=this._attributeHash(n)+"-"+h,a=this._groupIdCache.get(o);if(a)return a;const c={...e,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},l=ys(await this._renderer.getSymbolAsync(n,c),this._renderer),u=fs(l,this._info,r).then((s=>{if("expanded-cim"!==s.type)return Ms.error(new t("mapview-bad-type",`Found unexpected type ${s.type} in dictionary response`)),null;s.hash+="-"+h;for(const t of s.layers)t.scaleFactor=h,t.templateHash+="-"+h,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=g(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(s,null)}));return this._groupIdCache.put(o,u,1),u}async analyze(t,s,i,e,r){const n=s.getCursor(),h=[];for(;n.next();)h.push(this._analyzeFeature(n,i,e,r));return m(h)}match(t,s,i,e,r){return null}_attributeHash(t){let s="";for(const i of this._symbolFields){const e=this._fieldMap[i];e&&(s+=t.attributes[e]+"-")}return s}}const _s=l.getLogger("esri/views/2d/engine/webgl/mesh/factories/matcherUtils");function Ss(t){const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}function zs(s,i){if(s&&"name"in s){const e=s;return i&&i.error(new t(e.name,e.message,e.details)),!1}return!0}var Vs,Ts;function js(t){switch(t){case"left":return Vs.Left;case"right":return Vs.Right;case"center":case"justify":return Vs.Center}}function ks(t){switch(t){case"top":return Ts.Top;case"middle":return Ts.Center;case"baseline":return Ts.Baseline;case"bottom":return Ts.Bottom}}!function(t){t[t.Left=-1]="Left",t[t.Center=0]="Center",t[t.Right=1]="Right"}(Vs||(Vs={})),function(t){t[t.Top=1]="Top",t[t.Center=0]="Center",t[t.Bottom=-1]="Bottom",t[t.Baseline=2]="Baseline"}(Ts||(Ts={}));class Fs{constructor(t,s,i,e){this.center=rt(t,s),this.centerT=nt(),this.halfWidth=i/2,this.halfHeight=e/2,this.width=i,this.height=e}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new Fs(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,s=4){const i=Math.abs(t.centerT[0]-this.centerT[0]),e=Math.abs(t.centerT[1]-this.centerT[1]),r=Math.min((t.halfWidth+this.halfWidth+s)/i,(t.halfHeight+this.halfHeight+s)/e);return b(r)}extend(t){const s=Math.min(this.xmin,t.xmin),i=Math.min(this.ymin,t.ymin),e=Math.max(this.xmax,t.xmax)-s,r=Math.max(this.ymax,t.ymax)-i,n=s+e/2,h=i+r/2;this.width=e,this.height=r,this.halfWidth=e/2,this.halfHeight=r/2,this.x=n,this.y=h}static deserialize(t){const s=t.readF32(),i=t.readF32(),e=t.readInt32(),r=t.readInt32();return new Fs(s,i,e,r)}}const Is=Math.PI/180;class Ls{constructor(t,s,i,e){this._rotationT=ot(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255;const r=i.rect,n=new Float32Array(8);s*=e;const h=i.code?r.width*e:i.metrics.width,o=i.code?r.height*e:i.metrics.height;n[0]=t*=e,n[1]=s,n[2]=t+h,n[3]=s,n[4]=t,n[5]=s+o,n[6]=t+h,n[7]=s+o,this._data=n,this._setTextureCoords(r),this._scale=e,this._mosaic=i,this.x=t,this.y=s}get width(){return this._mosaic.metrics.width*this._scale}get mosaic(){return this._mosaic}set angle(t){this._angle=t,ut(this._rotationT),lt(this._rotationT,this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){const{height:t,width:s}=this._mosaic.metrics,i=s*this._scale,e=Math.abs(t)*this._scale,r=new Float32Array(8);r[0]=this.x,r[1]=this.y,r[2]=this.x+i,r[3]=this.y,r[4]=this.x,r[5]=this.y+e,r[6]=this.x+i,r[7]=this.y+e;const n=at(ot(),this._rotationT,this._T);ft(r,r,n);let h=1/0,o=1/0,a=0,c=0;for(let t=0;t<4;t++){const s=r[2*t],i=r[2*t+1];h=Math.min(h,s),o=Math.min(o,i),a=Math.max(a,s),c=Math.max(c,i)}const l=a-h,u=c-o;return new Fs(h+l/2,o+u/2,l,u)}setTransform(t){this._T=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const s=this._offsets,i=new Float32Array(8),e=at(ot(),this._rotationT,this._T);ft(i,t,e),s.upperLeft=Wt(8*i[0],8*i[1]),s.upperRight=Wt(8*i[2],8*i[3]),s.lowerLeft=Wt(8*i[4],8*i[5]),s.lowerRight=Wt(8*i[6],8*i[7])}_setTextureCoords({x:t,y:s,width:i,height:e}){this._texcoords={upperLeft:Wt(t,s),upperRight:Wt(t+i,s),lowerLeft:Wt(t,s+e),lowerRight:Wt(t+i,s+e)}}}const Cs=(t,s)=>({code:0,page:0,sdf:!0,rect:new It(0,0,11,8),textureBinding:s,metrics:{advance:0,height:4,width:t,left:0,top:0}});class As{constructor(t,s,i){this._rotation=0,this._decorate(t,s,i),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=s.length>1,this._hasRotation=0!==i.angle,this._T=this._createGlyphTransform(this.bounds,i);for(const s of t)s.setTransform(this._T)}setRotation(t){if(0===t&&0===this._rotation)return;this._rotation=t;const s=this._T,i=ht(ot(),t);at(s,i,s);for(const t of this.glyphs)t.setTransform(this._T)}_decorate(t,s,i){if(!i.decoration||"none"===i.decoration||!t.length)return;const e=i.scale,r="underline"===i.decoration?30:20,n=t[0].textureBinding;for(const i of s)t.push(new Ls(i.startX*e,i.startY*e+r*e,Cs((i.width+i.glyphWidthEnd)*e,n),1))}get boundsT(){const t=this.bounds,s=Q(nt(),t.x,t.y);if(Z(s,s,this._T),this._hasRotation){const i=Math.max(t.width,t.height);return new Fs(s[0],s[1],i,i)}return new Fs(s[0],s[1],t.width,t.height)}_createBounds(t){let s=1/0,i=1/0,e=0,r=0;for(const n of t)s=Math.min(s,n.xTopLeft),i=Math.min(i,n.yTopLeft),e=Math.max(e,n.xTopLeft+n.width),r=Math.max(r,n.yBottomRight);const n=e-s,h=r-i;return new Fs(s+n/2,i+h/2,n,h)}_createGlyphTransform(t,s){const i=Is*s.angle,e=ot(),r=nt();return ct(e,e,Q(r,s.xOffset,-s.yOffset)),s.isCIM?lt(e,e,i):(ct(e,e,Q(r,t.x,t.y)),lt(e,e,i),ct(e,e,Q(r,-t.x,-t.y))),e}}class Gs{constructor(t,s,i,e,r,n){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(s,i)),this.end=Math.max(0,Math.max(s,i)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=e,this.yMin=r,this.yMax=n}}const Ps=t=>10===t,Ds=t=>32===t;class Rs{static getPlacement(t,s,i){const e=v(s);if(!e)return null;const r=x(t);return e.execute(r,s,i)}}const Us=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this.geometryType=st.TEXT,this._aux=$t(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,s){this._shapingInfo=t&&t.length?_(t,(t=>function(t,s,i){const e=i.scale,r=new Array,n=function(t,s,i){const e=new Array,r=i.maxLineWidth*(1/i.scale),n=s?t.length-1:0,h=s?-1:t.length,o=s?-1:1;let a=n,c=0,l=0,u=a,f=u,p=0,d=1/0,m=0;for(;a!==h;){const{code:s,metrics:i}=t[a],h=Math.abs(i.top);Ps(s)||Ds(s)||(d=Math.min(d,h),m=Math.max(m,h+i.height)),Ps(s)?(a!==n&&(e.push(new Gs(t,u,a-o,c,d,m)),d=1/0,m=0),c=0,u=a+o,f=a+o,l=0):Ds(s)?(f=a+o,l=0,p=i.advance,c+=i.advance):c>r?(f!==u?(c-=p,e.push(new Gs(t,u,f-2*o,c-l,d,m)),d=1/0,m=0,u=f,c=l):(e.push(new Gs(t,u,a-o,c,d,m)),d=1/0,m=0,u=a,f=a,c=0),c+=i.advance,l+=i.advance):(c+=i.advance,l+=i.advance),a+=o}const w=new Gs(t,u,a-o,c,d,m);return w.start>=0&&w.end<t.length&&e.push(w),e}(t,s,i),h=function(t,s){let i=0;for(let s=0;s<t.length;s++){const{width:e}=t[s];i=Math.max(e,i)}const e=t[0].yMin;return{x:0,y:e,height:t[t.length-1].yMax+s.lineHeight*(t.length-1)+("underline"===s.decoration?4:0)-e,width:i}}(n,i),{vAlign:o,hAlign:a}=i,c=o===Ts.Baseline?1:0,l=(1-c)*-h.y+h.height/2*(c?0:o-1)+-26*(c?1:0);for(let s=0;s<n.length;s++){const{start:h,end:o,width:c}=n[s];let u=-1*(a+1)*(c/2)-3;const f=s*i.lineHeight+l-3;n[s].startX=u,n[s].startY=f;for(let s=h;s<=o;s++){const i=t[s];if(Ps(i.code))continue;const n=new Ls(u+i.metrics.left,f-i.metrics.top,i,e);u+=i.metrics.advance,r.push(n)}}return new As(r,n,i)}(t,s,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:gt*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):null}writeMeshWithGeometry(t,s,i,e,r,n){if(p(this._textPlacement)){const e=null!=n?n:i.readLegacyGeometry();return this._writePlacedText(t,s,r,e)}const h=n?W($(n),2):"esriGeometryPolygon"===e?i.readCentroid():i.readUnquantizedGeometry();if(h){if(h.isPoint){const[i,e]=h.coords;return this._writeGlyphs(t,s,r,{x:i,y:e})}h.forEachVertex(((i,e)=>this._writeGlyphs(t,s,r,{x:i,y:e})))}}_writePlacedText(t,s,i,e){const r=this._shapingInfo;if(S(r))return;const n=Zt.load(this._materialKey),h=V(this._textPlacement),o=Rs.getPlacement(e,h,z(1));if(!o)return;let a,c,l=o.next();for(;null!=l;){c=Wt(Math.round(8*l.tx),Math.round(8*l.ty)),a=l.getAngle(),r.setRotation(a);for(const e of r.glyphs){n.textureBinding=e.textureBinding;const r=s.getVector("geometry").vertexCount,h=s.indexVector.length,o=this._writeIndices(s),a=this._writeVertex(s,i,c,e);t.writeDisplayRecord(this.geometryType,n.data,r,a,h,o)}r.setRotation(-a),l=o.next()}}_writeGlyphs(t,s,i,e){const r=this._shapingInfo;if(S(r))return;const n=Zt.load(this._materialKey),h=Wt(Math.round(8*e.x),Math.round(8*e.y));for(const e of r.glyphs){n.textureBinding=e.textureBinding;const r=s.getVector("geometry").vertexCount,o=s.indexVector.length,a=this._writeIndices(s),c=this._writeVertex(s,i,h,e);t.writeDisplayRecord(this.geometryType,n.data,r,c,o,a)}}_writeVertexCommon(t,s,i,e){const r=this._color,n=this._haloColor,h=$t(0,0,this._referenceSize,this._bitset),o=$t(0,0,this._size,this._haloSize);t.push(i),t.push(s),t.push(r),t.push(n),t.push(o),t.push(h)}_writeVertex(t,s,i,e){const r=t.get("geometry");return this._writeVertexCommon(r,s,i,e),r.push(e.offsets.upperLeft),r.push(e.texcoords.upperLeft),this._writeVertexCommon(r,s,i,e),r.push(e.offsets.upperRight),r.push(e.texcoords.upperRight),this._writeVertexCommon(r,s,i,e),r.push(e.offsets.lowerLeft),r.push(e.texcoords.lowerLeft),this._writeVertexCommon(r,s,i,e),r.push(e.offsets.lowerRight),r.push(e.texcoords.lowerRight),4}_writeIndices(t){const s=t.getVector("geometry").vertexCount,i=t.indexVector;return i.push(s+0),i.push(s+1),i.push(s+2),i.push(s+1),i.push(s+3),i.push(s+2),6}};class Bs{static executeEffects(t,s){const i=x(s);let e=new k(i);for(const s of t){const t=T(s);t&&(e=t.execute(e,s,1.3333333333333333))}return e}static next(t){const s=t.next();return j(s),s}}class Os{get needsPixelBuffer(){return!!this.effects||this.geometryType===st.MARKER||this.geometryType===st.TEXT||this.geometryType===st.LABEL}writeMesh(t,s,i,e,r){if(S(this.effects))return this.writeMeshWithGeometry(t,s,i,e,r);const n=Bs.executeEffects(this.effects,i.readLegacyGeometry());let h=Bs.next(n);for(;h;)this.writeMeshWithGeometry(t,s,i,F(h),r,h),h=Bs.next(n)}writeMeshWithGeometry(t,s,i,e,r,n){}bindFeature(t,s,i){}}class Ns extends(Us(Os)){constructor(t,s,i,e,r,n,h,o,a,c,l,u,f,p,d,m,w,y=!1){super(),this._xOffset=z(u),this._yOffset=z(f),this._decoration=a||"none",this._color=e,this._haloColor=r,this._haloSize=Math.min(Math.floor(5*z(I(i))),127),this._size=Math.min(Math.round(z(s)),127);const M=Math.min(Math.round(z(s)),127);this._referenceSize=Math.round(Math.sqrt(256*M)),this._scale=this._size/24,this._angle=l,this._justify=function(t){switch(t){case"left":return Vs.Left;case"right":return Vs.Right;case"center":case"justify":return Vs.Center}}(n||"center"),this._xAlignD=js(n||"center"),this._yAlignD=ks(h||"baseline"),this._baseline="baseline"===(h||"baseline"),this._bitset=(1===o?1:0)|(c?1:0)<<1;const g=Zt.load(t);g.sdf=!0,this._materialKey=g.data,this._lineWidth=z(p)||512,this._lineHeight=d||1,this._textPlacement=m,this.effects=w,this._isCIM=y}static fromText(t,s){const i=new Ns(t.materialKey,t.font.size,t.haloSize||0,t.color&&Xt(t.color)||0,t.haloColor&&Xt(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,0,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1),[,e]=Yt(t.text);return i.bindTextInfo(s,e),i}static fromCIMText(t,s){const i=t.scaleFactor||1,e=new Ns(t.materialKey,t.size*t.sizeRatio*i,t.outlineSize*t.sizeRatio,qt(t.color),qt(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*i,t.offsetY*t.sizeRatio*i,512,1,t.markerPlacement,t.effects,!0),[,r]=Yt(t.text);return e.bindTextInfo(s,r),e}}const Es=t=>class extends t{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this.geometryType=st.MARKER}writeMeshWithGeometry(t,s,i,e,r,n){const h=s.indexVector,o=s.get("geometry"),a=s.getVector("geometry"),c=a.vertexCount,l=c,u=h.length;if(p(this._markerPlacement)){const t=null!=n?n:i.readLegacyGeometry();this._writePlacedMarkers(o,h,c,r,t)}else{const t=n?W($(n),2):"esriGeometryPolygon"===e?i.readCentroid():i.readUnquantizedGeometry();if(!t)return;if(t.isPoint){const[s,i]=t.coords;this._writeVertices(o,r,this._getPos(s,i)),this._writeIndices(h,c)}else t.forEachVertex(((t,s)=>{const i=a.vertexCount;this._writeVertices(o,r,this._getPos(t,s)),this._writeIndices(h,i)}))}const f=s.getVector("geometry").vertexCount-l;t.writeDisplayRecord(this.geometryType,this._materialKey,l,f,u,h.length-u)}_applyTransformation(t,s,i=0){ut(t),ct(t,t,rt(this.xOffset,-this.yOffset)),this.angle+i!==0&&lt(t,t,.017453292519944444*(this.angle+i));const e=this._computedWidth,r=this._computedHeight,n=(this._anchorX-.5)*e,h=(this._anchorY-.5)*r;Q(s,n,h),Z(s,s,t),this._offsetUpperLeft=Wt(16*s[0],16*s[1]),Q(s,n+e,h),Z(s,s,t),this._offsetUpperRight=Wt(16*s[0],16*s[1]),Q(s,n,h+r),Z(s,s,t),this._offsetBottomLeft=Wt(16*s[0],16*s[1]),Q(s,n+e,h+r),Z(s,s,t),this._offsetBottomRight=Wt(16*s[0],16*s[1])}_writePlacedMarkers(t,s,i,e,r){const n=Rs.getPlacement(r,V(this._markerPlacement),z(1));if(!n)return;const h=nt(),o=ot();let a=0,c=n.next();for(;null!=c;)c.tx>=-128&&c.tx<=640&&c.ty>=-128&&c.ty<=640&&(this._applyTransformation(o,h,c.getAngle()/.017453292519944444),this._writeVertices(t,e,this._getPos(c.tx,c.ty)),this._writeIndices(s,i+a),a+=4),c=n.next()}_getPos(t,s){return Wt(Math.round(8*t),Math.round(8*s))}_writeVertices(t,s,i){t.push(i),t.push(this._offsetUpperLeft),t.push(this._texUpperLeft),t.push(this._bitestAndDistRatio),t.push(s),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetUpperRight),t.push(this._texUpperRight),t.push(this._bitestAndDistRatio),t.push(s),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetBottomLeft),t.push(this._texBottomLeft),t.push(this._bitestAndDistRatio),t.push(s),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetBottomRight),t.push(this._texBottomRight),t.push(this._bitestAndDistRatio),t.push(s),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth)}_writeIndices(t,s){const i=s;t.push(i+0),t.push(i+1),t.push(i+2),t.push(i+1),t.push(i+3),t.push(i+2)}};class Ks extends(Es(Os)){constructor(t,s,i,e,r,n,h,o,a,c,l,u,f,p,d,m,w,y,M,g,b){super(),this.angle=e,this.height=h,this.width=n,this.xOffset=s*M,this.yOffset=i*M,this._markerPlacement=g,this.effects=b,this._anchorX=.5-(.5+m)*d.width/d.width,this._anchorY=.5-(.5+w)*d.height/d.height;const v=(1===p?1:0)|(l?1:0)<<1|(f?1:0)<<2|(u?1:0)<<3,x=d&&d.sdf,_=ns.load(t);_.sdf=x,_.pattern=!0,_.textureBinding=d.textureBinding,this._materialKey=_.data,this._fillColor=r,this._outlineColor=a,this._sizeOutlineWidth=$t(Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*h),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*o),255)));const S=d.rect.x+bt,z=d.rect.y+bt,V=S+d.width,T=z+d.height;this._texUpperLeft=Wt(S,z),this._texUpperRight=Wt(V,z),this._texBottomLeft=Wt(S,T),this._texBottomRight=Wt(V,T),n*=y,h*=y,n*=M,h*=M;const j=Math.round(Math.min(64*y,255));this._bitestAndDistRatio=$t(0,0,v,j),this._computedWidth=n,this._computedHeight=h;const k=nt(),F=ot();this._applyTransformation(F,k)}static fromCIMMarker(t,s){const i=t.size,e=(s&&s.width||1)/(s&&s.height||1)*t.scaleX,r=t.scaleSymbolsProportionally&&t.frameHeight?i/t.frameHeight:1,n=qt(t.color),h=qt(t.outlineColor),o=z(i),a=o*e,c=z(t.offsetX||0),l=z(t.offsetY||0),u=z(t.outlineWidth||0)*r,f=t.alignment||0,p=z(t.referenceSize);let d=t.rotation||0;t.rotateClockwise||(d=-d);let m=0,w=0;const y=t.anchorPoint;return y&&(t.isAbsoluteAnchorPoint?i&&(m=-y.x/(i*e),w=y.y/i):(m=y.x,w=y.y)),new Ks(t.materialKey,c,l,d,n,a,o,p,h,u,t.colorLocked,t.scaleSymbolsProportionally,!1,f,s,m,w,t.sizeRatio,L(t.scaleFactor,1),t.markerPlacement,t.effects)}static fromPictureMarker(t,s){const i=Math.round(z(t.width)),e=Math.round(z(t.height)),r=vt,n=Math.round(z(t.xoffset||0)),h=Math.round(z(t.yoffset||0));return new Ks(t.materialKey,n,h,t.angle,r,i,e,e,0,0,!1,!1,!1,0,s,0,0,1,1,null,null)}static fromSimpleMarker(t,s){const i=Xt(t.color),e=Math.round(z(t.size)),r=e,n=Math.round(z(t.xoffset||0)),h=Math.round(z(t.yoffset||0)),o=t.style,a=t.outline,c=0|(a&&a.color&&Xt(a.color)),l=0|(a&&a.width&&Math.round(z(a.width))),u=new Ks(t.materialKey,n,h,t.angle,i,e,r,r,c,l,!1,!1,"esriSMSCross"===o||"esriSMSX"===o,0,s,0,0,126/64,1,null,null);return u.boundsType="esriSMSCircle"===o?"circle":"square",u}static fromLineSymbolMarker(t,s){const i=Xt(t.color),e=Math.round(z(6*t.lineWidth)),r=e,n="cross"===t.style||"x"===t.style;let h;switch(t.placement){case"begin-end":h="Both";break;case"begin":h="JustBegin";break;case"end":h="JustEnd";break;default:h="None"}const o={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},a=new Ks(t.materialKey,0,0,0,i,e,r,r/6,i,n?Math.round(z(t.lineWidth)):0,!1,!1,n,1,s,0,0,126/64,1,o,null);return a.boundsType="circle"===t.style?"circle":"square",a}}function Ws(t,s,i,e,r,n,h){mi=0;const o=(e-i)*n,a=r&&r.length,c=a?(r[0]-i)*n:o;let l,u,f,p,d,m=$s(s,i,0,0,c,n,!0);if(m&&m.next!==m.prev){if(a&&(m=function(t,s,i,e,r,n){const h=new Array;for(let r=0,o=e.length;r<o;r++){const a=$s(t,s,0,e[r]*n,r<o-1?e[r+1]*n:i*n,n,!1);a===a.next&&(a.steiner=!0),h.push(Zs(a))}h.sort(ai);for(const t of h)ti(t,r),r=qs(r,r.next);return r}(s,i,e,r,m,n)),o>80*n){l=f=s[0+i*n],u=p=s[1+i*n];for(let t=n;t<c;t+=n){const e=s[t+i*n],r=s[t+1+i*n];l=Math.min(l,e),u=Math.min(u,r),f=Math.max(f,e),p=Math.max(p,r)}d=Math.max(f-l,p-u),d=0!==d?1/d:0}Xs(m,t,n,l,u,d,h,0)}}function $s(t,s,i,e,r,n,h){let o;if(h===function(t,s,i,e,r,n){let h=0;for(let i=e,o=r-n;i<r;i+=n)h+=(t[o+s*n]-t[i+s*n])*(t[i+1+s*n]+t[o+1+s*n]),o=i;return h}(t,s,0,e,r,n)>0)for(let i=e;i<r;i+=n)o=Js(i+s*n,t[i+s*n],t[i+1+s*n],o);else for(let i=r-n;i>=e;i-=n)o=Js(i+s*n,t[i+s*n],t[i+1+s*n],o);return o&&oi(o,o.next)&&(Qs(o),o=o.next),o}function qs(t,s=t){if(!t)return t;let i,e=t;do{if(i=!1,e.steiner||!oi(e,e.next)&&0!==ii(e.prev,e,e.next))e=e.next;else{if(Qs(e),e=s=e.prev,e===e.next)break;i=!0}}while(i||e!==s);return s}function Xs(t,s,i,e,r,n,h,o){if(!t)return;!o&&n&&(t=si(t,e,r,n));let a=t;for(;t.prev!==t.next;){const c=t.prev,l=t.next;if(n?Ys(t,e,r,n):Hs(t))s.push(c.index/i+h),s.push(t.index/i+h),s.push(l.index/i+h),Qs(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?Xs(t=ci(t,s,i,h),s,i,e,r,n,h,2):2===o&&li(t,s,i,e,r,n,h):Xs(qs(t),s,i,e,r,n,h,1);break}}}function Hs(t){const s=t.prev,i=t,e=t.next;if(ii(s,i,e)>=0)return!1;let r=t.next.next;const n=r;let h=0;for(;r!==t.prev&&(0===h||r!==n);){if(h++,ri(s.x,s.y,i.x,i.y,e.x,e.y,r.x,r.y)&&ii(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Ys(t,s,i,e){const r=t.prev,n=t,h=t.next;if(ii(r,n,h)>=0)return!1;const o=r.x>n.x?r.x>h.x?r.x:h.x:n.x>h.x?n.x:h.x,a=r.y>n.y?r.y>h.y?r.y:h.y:n.y>h.y?n.y:h.y,c=hi(r.x<n.x?r.x<h.x?r.x:h.x:n.x<h.x?n.x:h.x,r.y<n.y?r.y<h.y?r.y:h.y:n.y<h.y?n.y:h.y,s,i,e),l=hi(o,a,s,i,e);let u=t.prevZ,f=t.nextZ;for(;u&&u.z>=c&&f&&f.z<=l;){if(u!==t.prev&&u!==t.next&&ri(r.x,r.y,n.x,n.y,h.x,h.y,u.x,u.y)&&ii(u.prev,u,u.next)>=0)return!1;if(u=u.prevZ,f!==t.prev&&f!==t.next&&ri(r.x,r.y,n.x,n.y,h.x,h.y,f.x,f.y)&&ii(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;u&&u.z>=c;){if(u!==t.prev&&u!==t.next&&ri(r.x,r.y,n.x,n.y,h.x,h.y,u.x,u.y)&&ii(u.prev,u,u.next)>=0)return!1;u=u.prevZ}for(;f&&f.z<=l;){if(f!==t.prev&&f!==t.next&&ri(r.x,r.y,n.x,n.y,h.x,h.y,f.x,f.y)&&ii(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function Js(t,s,i,e){const r=pi.create(t,s,i);return e?(r.next=e.next,r.prev=e,e.next.prev=r,e.next=r):(r.prev=r,r.next=r),r}function Qs(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Zs(t){let s=t,i=t;do{(s.x<i.x||s.x===i.x&&s.y<i.y)&&(i=s),s=s.next}while(s!==t);return i}function ti(t,s){if(s=function(t,s){let i=s;const e=t.x,r=t.y;let n,h=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=e&&t>h){if(h=t,t===e){if(r===i.y)return i;if(r===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==s);if(!n)return null;if(e===h)return n.prev;const o=n,a=n.x,c=n.y;let l,u=1/0;for(i=n.next;i!==o;)e>=i.x&&i.x>=a&&e!==i.x&&ri(r<c?e:h,r,a,c,r<c?h:e,r,i.x,i.y)&&(l=Math.abs(r-i.y)/(e-i.x),(l<u||l===u&&i.x>n.x)&&ni(i,t)&&(n=i,u=l)),i=i.next;return n}(t,s)){const i=fi(s,t);qs(i,i.next)}}function si(t,s,i,e){for(let r;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=hi(r.x,r.y,s,i,e)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,si(t,s,i,e);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let s,i=1;for(;;){let e,r=t;t=null,s=null;let n=0;for(;r;){n++,e=r;let h=0;for(;h<i&&e;h++)e=e.nextZ;let o=i;for(;h>0||o>0&&e;){let i;0===h?(i=e,e=e.nextZ,o--):0!==o&&e?r.z<=e.z?(i=r,r=r.nextZ,h--):(i=e,e=e.nextZ,o--):(i=r,r=r.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i}r=e}if(s.nextZ=null,i*=2,n<2)return t}}(t)}function ii(t,s,i){return(s.y-t.y)*(i.x-s.x)-(s.x-t.x)*(i.y-s.y)}function ei(t,s,i,e){return!!(oi(t,s)&&oi(i,e)||oi(t,e)&&oi(i,s))||ii(t,s,i)>0!=ii(t,s,e)>0&&ii(i,e,t)>0!=ii(i,e,s)>0}function ri(t,s,i,e,r,n,h,o){return(r-h)*(s-o)-(t-h)*(n-o)>=0&&(t-h)*(e-o)-(i-h)*(s-o)>=0&&(i-h)*(n-o)-(r-h)*(e-o)>=0}function ni(t,s){return ii(t.prev,t,t.next)<0?ii(t,s,t.next)>=0&&ii(t,t.prev,s)>=0:ii(t,s,t.prev)<0||ii(t,t.next,s)<0}function hi(t,s,i,e,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=32767*(s-e)*r)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function oi(t,s){return t.x===s.x&&t.y===s.y}function ai(t,s){return t.x-s.x}function ci(t,s,i,e){let r=t;do{const n=r.prev,h=r.next.next;!oi(n,h)&&ei(n,r,r.next,h)&&ni(n,h)&&ni(h,n)&&(s.push(n.index/i+e),s.push(r.index/i+e),s.push(h.index/i+e),Qs(r),Qs(r.next),r=t=h),r=r.next}while(r!==t);return r}function li(t,s,i,e,r,n,h){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.index!==t.index&&ui(o,t)){let a=fi(o,t);return o=qs(o,o.next),a=qs(a,a.next),Xs(o,s,i,e,r,n,h,0),void Xs(a,s,i,e,r,n,h,0)}t=t.next}o=o.next}while(o!==t)}function ui(t,s){return t.next.index!==s.index&&t.prev.index!==s.index&&!function(t,s){let i=t;do{if(i.index!==t.index&&i.next.index!==t.index&&i.index!==s.index&&i.next.index!==s.index&&ei(i,i.next,t,s))return!0;i=i.next}while(i!==t);return!1}(t,s)&&ni(t,s)&&ni(s,t)&&function(t,s){let i=t,e=!1;const r=(t.x+s.x)/2,n=(t.y+s.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(e=!e),i=i.next}while(i!==t);return e}(t,s)}function fi(t,s){const i=pi.create(t.index,t.x,t.y),e=pi.create(s.index,s.x,s.y),r=t.next,n=s.prev;return t.next=s,s.prev=t,i.next=r,r.prev=i,e.next=i,i.prev=e,n.next=e,e.prev=n,e}class pi{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,s,i){const e=di[mi++];return e.index=t,e.x=s,e.y=i,e.prev=null,e.next=null,e.z=null,e.prevZ=null,e.nextZ=null,e.steiner=!1,e}}const di=new Array;let mi=0;for(let t=0;t<8096;t++)di.push(new pi);const wi=new Lt,yi=new Ct(0,0,0,1,128);function Mi(t,s,i){let e=0;for(let r=1;r<i;r++)e+=(t[2*(s+r)]-t[2*(s+r-1)])*(t[2*(s+r)+1]+t[2*(s+r-1)+1]);return e}function gi(t,s,i,e,r){let n=0;for(let h=i;h<e;h+=3){const i=2*(t.getValue(h)-r),e=2*(t.getValue(h+1)-r),o=2*(t.getValue(h+2)-r);n+=Math.abs((s[i]-s[o])*(s[e+1]-s[i+1])-(s[i]-s[e])*(s[o+1]-s[i+1]))}return n}yi.setExtent(xt);const bi=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this.geometryType=st.FILL}writeMeshWithGeometry(t,s,i,e,r,n){const h=rs.load(this._materialKey),o=s.indexVector,a=s.getVector("geometry"),c=a.vertexCount,l=o.length;let u=n?W($(n),2):i.readUnquantizedGeometry();if(!u)return;if(u=function(t){if(!function(t,s,i){let e=0;for(let s=0;s<t.lengths.length;s++){const r=t.lengths[s];for(let s=0;s<r;s++){const r=t.coords[2*(s+e)],n=t.coords[2*(s+e)+1];if(r<-128||r>i||n<-128||n>i)return!0}e+=r}return!1}(t,0,xt+128))return t;yi.reset(3);let s=0;for(let i=0;i<t.lengths.length;i++){const e=t.lengths[i];let r=t.coords[2*(0+s)],n=t.coords[2*(0+s)+1];yi.moveTo(r,n);for(let i=1;i<e;i++)r=t.coords[2*(i+s)],n=t.coords[2*(i+s)+1],yi.lineTo(r,n);yi.close(),s+=e}const i=yi.result(!1);if(!i)return null;const e=[],r=[];for(const t of i){let s=0;for(const i of t)r.push(i.x),r.push(i.y),s++;e.push(s)}return new K(e,r)}(u),!u)return;let f=u.coords;!this.forceLibtess&&function(t,s,i){const{coords:e,lengths:r,hasIndeterminateRingOrder:n}=s;if(n)return!1;const h=t.length;let o=0;for(let s=0;s<r.length;){let n=s,a=r[s],c=Mi(e,o,a);const l=[];for(;++n<r.length;){const t=r[n],s=Mi(e,o+a,t);if(!(s>0))break;c+=s,l.push(o+a),a+=t}const u=t.length;Ws(t,e,o,o+a,l,2,i);const f=gi(t,e,u,t.length,i),p=Math.abs(c);if(Math.abs((f-p)/Math.max(1e-7,p))>1e-5)return t.seek(h),!1;s=n,o+=a}return!0}(o,u,c)||(f=[],function(t,s,i,e){const r=[],{coords:n,lengths:h}=i;wi.beginPolygon(t,r);let o=0;for(let t=0;t<h.length;t++){const s=i.lengths[t];wi.beginContour();for(let t=0;t<s;t++){const s=[n[2*(o+t)],n[2*(o+t)+1],0];wi.addVertex(s,s)}wi.endContour(),o+=s}wi.endPolygon();for(let t=0;t<r.length;t++)s.push(r[t]+e)}(f,o,u,c)),this._write(a,i,r,f,h),t.writeDisplayRecord(this.geometryType,this._materialKey,c,a.vertexCount-c,l,o.length-l)}_write(t,s,i,e,r){for(let n=0;n<e.length;n+=2){const h=Wt(1*e[n],1*e[n+1]);t.data.push(h),t.data.push(i),r.dotDensity?t.data.writeF32(1/Math.abs(s.readGeometryArea())):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3))}}},vi=l.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class xi extends Os{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,s,i,e){const r=s.readLegacyFeature(),n=this._materialCache,h=this._cimLayer.materialHash;if(!h)return vi.error("A Dynamic mesh template must have a material hash value or function!"),C(null);const o="function"==typeof h?h(r,i,e):h;if(n.has(o)){const t=n.get(o);return A(t)}if(this._ongoingMaterialRequestMap.has(o))return this._ongoingMaterialRequestMap.get(o);const a=G(this._cimLayer.cim,this._cimLayer.materialOverrides);a.mosaicHash=o;const c=t.getMosaicItem(a).then((t=>(this._ongoingMaterialRequestMap.delete(o),n.set(o,t),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(o),vi.error(".analyze()",t.message),null)));return this._ongoingMaterialRequestMap.set(o,c),c}}class _i extends(bi(xi)){constructor(t){if(super(t),At(t.color))this._dynamicPropertyMap.set("_fillColor",((s,i,e)=>{const r=t.color(s,i,e);return r&&qt(r)||0}));else{const s=t.color;this.fillColor=s&&qt(s)||0}let s=0;At(t.height)||(s=t.height||0),this._dynamicPropertyMap.set("_height",((i,e,r)=>At(t.height)?t.height(i,e,r):s));let i=0;At(t.offsetX)||(i=z(t.offsetX||0)+128,i>255&&(i=255)),this._dynamicPropertyMap.set("_offsetX",((s,e,r)=>{if(At(t.offsetX)){let i=z(t.offsetX(s,e,r))+128;return i>255&&(i=255),i}return i}));let e=1;At(t.scaleX)||(e=t.scaleX||1),this._dynamicPropertyMap.set("_scaleX",((s,i,r)=>At(t.scaleX)?t.scaleX(s,i,r):e));let r=0;At(t.offsetY)||(r=z(-t.offsetY||0)+128,r>255&&(r=255)),this._dynamicPropertyMap.set("_offsetY",((s,i,e)=>{if(At(t.offsetY)){let r=z(-t.offsetY(s,i,e))+128;return r>255&&(r=255),r}return r}));let n=0;At(t.angle)||(n=Gt(t.angle)||0),this._dynamicPropertyMap.set("_angle",((s,i,e)=>At(t.angle)?Gt(t.angle(s,i,e)):n)),this.effects=t.effects,this._cimFillLayer=t,this._fillMaterialKey=rs.load(t.materialKey)}static fromCIMFill(t){return new _i(t)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)}));const r=this._fillMaterialKey,n=this._materialCache,h=this._cimFillLayer;this.aux3=$t(0,0,this._angle,h.colorLocked?1:0);const o=(0,h.materialHash)(e,s,i),a=n.get(o);let c=null;if(a&&zs(a.spriteMosaicItem)&&(c=a.spriteMosaicItem),c){const{rect:t,width:s,height:i}=c,e=t.x+bt,n=t.y+bt,h=e+s,o=n+i;let a=P(z(this._height));a>255?a=255:a<=0&&(a=P(o-n));let l=P(z(this._height/i*s||0));l>255?l=255:l<=0&&(l=P(h-e));const u=this._scaleX,f=1;this.tl=Wt(e,n),this.br=Wt(h,o),this.aux1=$t(l,a,this._offsetX,this._offsetY),this.aux2=Wt(128*u,128*f),r.sdf=c.sdf,r.pattern=!0,r.textureBinding=c.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}}const Si=xt+16,zi=new Ct(0,0,0,1,16);zi.setExtent(xt);const Vi=new Uint32Array(9),Ti=new Uint32Array(36),ji=new Uint32Array(3),ki=new Uint32Array(6),Fi=t=>s=>{const i=Math.ceil(1024*t._halfWidth),e=Math.ceil(1024*t._halfReferenceWidth);s.entry0=t.offset+t.vertexCount++;{const r=Wt(s.distance,i),n=$t(Math.round(31*s.prevNormal.x),Math.round(31*s.prevNormal.y),Math.round(0),Math.round(-31)),h=$t(0,0,0,t._bitset);Ti[0]=Wt(8*s.currentVertex.x,8*s.currentVertex.y),Ti[1]=t.id,Ti[2]=t._fillColor,Ti[3]=n,Ti[4]=r,Ti[5]=t._tl,Ti[6]=t._br,Ti[7]=h,Ti[8]=Wt(e,0)}s.entry2=t.offset+t.vertexCount++;{const r=Wt(s.distance,i),n=$t(Math.round(31*-s.prevNormal.x),Math.round(31*-s.prevNormal.y),Math.round(0),Math.round(31)),h=$t(0,0,0,t._bitset);Ti[9]=Wt(8*s.currentVertex.x,8*s.currentVertex.y),Ti[10]=t.id,Ti[11]=t._fillColor,Ti[12]=n,Ti[13]=r,Ti[14]=t._tl,Ti[15]=t._br,Ti[16]=h,Ti[17]=Wt(e,0)}s.exit0=t.offset+t.vertexCount++;{const r=Wt(s.distance,i),n=$t(Math.round(31*s.nextNormal.x),Math.round(31*s.nextNormal.y),Math.round(0),Math.round(-31)),h=$t(0,0,0,t._bitset);Ti[18]=Wt(8*s.currentVertex.x,8*s.currentVertex.y),Ti[19]=t.id,Ti[20]=t._fillColor,Ti[21]=n,Ti[22]=r,Ti[23]=t._tl,Ti[24]=t._br,Ti[25]=h,Ti[26]=Wt(e,0)}s.exit2=t.offset+t.vertexCount++;{const r=Wt(s.distance,i),n=$t(Math.round(31*-s.nextNormal.x),Math.round(31*-s.nextNormal.y),Math.round(0),Math.round(31)),h=$t(0,0,0,t._bitset);Ti[27]=Wt(8*s.currentVertex.x,8*s.currentVertex.y),Ti[28]=t.id,Ti[29]=t._fillColor,Ti[30]=n,Ti[31]=r,Ti[32]=t._tl,Ti[33]=t._br,Ti[34]=h,Ti[35]=Wt(e,0)}t.geometryBuf.writeRegion(Ti)},Ii=t=>s=>{ki[0]=s.leftExit0,ki[1]=s.rightEntry0,ki[2]=s.leftExit2,ki[3]=s.rightEntry0,ki[4]=s.rightEntry2,ki[5]=s.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(ki)},Li=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},this._tessellationOptions={},this.geometryType=st.LINE}writeMeshWithGeometry(t,s,i,e,r,n){const h=s.indexVector,o=s.get("geometry"),a=s.getVector("geometry").vertexCount,c=h.length,l=null!=n?n:i.readLegacyGeometry();if(l){switch(e){case"esriGeometryPolyline":{const t=this._clipLines(l.paths);if(0===t.length)return;this._write(h,o,a,r,t);break}case"esriGeometryPolygon":{const t=this._clipLines(l.rings);if(0===t.length)return;this._write(h,o,a,r,t);break}}t.writeDisplayRecord(this.geometryType,this._materialKey,a,this.tessellationProperties.vertexCount,c,this.tessellationProperties.indexCount)}}_clipLines(t){const s=[];let i=!1,e=0;for(;e<t.length;){const r=[],n=t[e];zi.reset(2);let[h,o]=n[0];if(i)zi.moveTo(h,o);else{if(h<-16||h>Si||o<-16||o>Si){i=!0;continue}r.push({x:h,y:o})}let a=!1;const c=n.length;for(let t=1;t<c;++t)if(h+=n[t][0],o+=n[t][1],i)zi.lineTo(h,o);else{if(h<-16||h>Si||o<-16||o>Si){a=!0;break}r.push({x:h,y:o})}if(a)i=!0;else{if(i){const t=zi.resultWithStarts();if(t)for(const i of t)s.push(i)}else s.push({line:r,start:0});e++,i=!1}}return s}_write(t,s,i,e,r){this.tessellationProperties.id=e,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=s,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=i;for(const t of r){const s=t.line;s.length<2||(this._tessellationOptions.initialDistance=t.start%65535,this._tessellationCallbacks instanceof Pt&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),Dt(s,this._tessellationOptions,this._tessellationCallbacks),Rt())}}_initializeTessellator(t){const s=hs.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<_t/2&&!(s.vvSizeFieldStops||s.vvSizeMinMaxValue||s.vvSizeScaleStops||s.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:Fi(this.tessellationProperties),bridge:Ii(this.tessellationProperties)};else{const t=new Pt((t=>(s,i,e,r,n,h,o,a,c)=>{const l=Wt(c,Math.ceil(1024*t._halfWidth)),u=$t(Math.round(31*n),Math.round(31*h),Math.round(31*o),Math.round(31*a)),f=$t(31*e,31*r,0,t._bitset);return Vi[0]=Wt(8*s,8*i),Vi[1]=t.id,Vi[2]=t._fillColor,Vi[3]=u,Vi[4]=l,Vi[5]=t._tl,Vi[6]=t._br,Vi[7]=f,Vi[8]=Wt(Math.ceil(1024*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(Vi),t.offset+t.vertexCount++})(this.tessellationProperties),(t=>(s,i,e)=>{ji[0]=s,ji[1]=i,ji[2]=e,t.indexCount+=3,t.indexBuf.writeRegion(ji)})(this.tessellationProperties));t.miterLimitCosine=this._miterLimitCosine,t.textured=this._isDashed||this._hasPattern,t.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=t}}};class Ci extends(Li(xi)){constructor(t){super(t),this._cimLineLayer=t;let s=0;if(At(t.width)||(s=.5*z(t.width)),this._dynamicPropertyMap.set("_halfWidth",((i,e,r)=>At(t.width)?.5*z(t.width(i,e,r)):s)),At(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,At(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join,At(t.color))this._dynamicPropertyMap.set("_fillColor",((s,i,e)=>{const r=t.color(s,i,e);return r&&qt(r)||0}));else{const s=t.color;this._fillColor=s&&qt(s)||0}At(t.miterLimit)?this._dynamicPropertyMap.set("_miterLimitCosine",((s,i,e)=>Ut(t.miterLimit(s,i,e)))):this._miterLimitCosine=Ut(t.miterLimit),this._scaleFactor=t.scaleFactor||1,this._isDashed=t.isDashed,this.effects=t.effects,this.tessellationProperties._bitset=t.colorLocked?1:0,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t){return new Ci(t)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,n=(0,this._cimLineLayer.materialHash)(e,s,i),h=r.get(n);let o=null;if(h&&zs(h.spriteMosaicItem)&&(o=h.spriteMosaicItem),o){this._hasPattern=!0;const{rect:t,width:s,height:i}=o,e=t.x+bt,r=t.y+bt,n=e+s,h=r+i;this.tessellationProperties._tl=Wt(e,r),this.tessellationProperties._br=Wt(n,h)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const a=hs.load(this._materialKey);o&&(a.sdf=o.sdf,a.pattern=!0,a.textureBinding=o.textureBinding),this._materialKey=a.data}}const Ai=nt(),Gi=ot(),Pi=l.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class Di extends(Es(xi)){constructor(t){super(t),this._cimMarkerLayer=t,At(t.color)?this._dynamicPropertyMap.set("_fillColor",((s,i,e)=>qt(t.color(s,i,e)))):this._fillColor=qt(t.color),At(t.outlineColor)?this._dynamicPropertyMap.set("_outlineColor",((s,i,e)=>qt(t.outlineColor(s,i,e)))):this._outlineColor=qt(t.outlineColor),At(t.size)?this._dynamicPropertyMap.set("_size",((s,i,e)=>z(t.size(s,i,e)))):this._size=z(t.size),At(t.scaleX)?this._dynamicPropertyMap.set("_scaleX",t.scaleX):this._scaleX=t.scaleX,At(t.offsetX)?this._dynamicPropertyMap.set("xOffset",((s,i,e)=>z(t.offsetX(s,i,e)))):this.xOffset=z(t.offsetX),At(t.offsetY)?this._dynamicPropertyMap.set("yOffset",((s,i,e)=>z(t.offsetY(s,i,e)))):this.yOffset=z(t.offsetY),At(t.outlineWidth)?this._dynamicPropertyMap.set("_outlineWidth",((s,i,e)=>z(t.outlineWidth(s,i,e)))):this._outlineWidth=z(t.outlineWidth),At(t.rotation)?this._dynamicPropertyMap.set("_angle",t.rotation):this._angle=t.rotation,this._scaleFactor=L(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this.effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t){return new Di(t)}bindFeature(s,i,e){const r=s.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,s)=>{this[s]=t(r,i,e)}));const n=this._cimMarkerLayer.materialHash,h="function"==typeof n?n(r,i,e):n,o=this._materialCache.get(h);if(!o||!zs(o.spriteMosaicItem)||!o.spriteMosaicItem)return void Pi.error(new t("mapview-cim","Encountered an error when binding feature"));const a=o.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,l=a.width/a.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,p=f*l;const d=this.xOffset,m=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const w=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/z(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*w,M=z(this._cimMarkerLayer.referenceSize);let g=0,b=0;const v=this._cimMarkerLayer.anchorPoint;v&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(g=-v.x/(this._size*l),b=v.y/this._size):(g=v.x,b=v.y)),this._sizeOutlineWidth=$t(Math.round(Math.min(Math.sqrt(128*p),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*M),255))),this.angle=u;const x=Math.round(Math.min(64*c,255));this._bitestAndDistRatio=$t(0,0,this._bitSet,x);const _=a.rect.x+bt,S=a.rect.y+bt,V=_+a.width,T=S+a.height;this._texUpperLeft=Wt(_,S),this._texUpperRight=Wt(V,S),this._texBottomLeft=Wt(_,T),this._texBottomRight=Wt(V,T);const j=ns.load(this._materialKey);j.sdf=a.sdf,j.pattern=!0,j.textureBinding=a.textureBinding,this._materialKey=j.data,this._anchorX=.5-(.5+g)*a.width/a.width,this._anchorY=.5-(.5+b)*a.height/a.height,p*=c,f*=c,p*=this._scaleFactor,f*=this._scaleFactor,p*=a.rect.width/a.width,f*=a.rect.height/a.height,this._computedWidth=p,this._computedHeight=f,this._applyTransformation(Gi,Ai),this.xOffset=d,this.yOffset=m}}class Ri extends(Us(xi)){constructor(t){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map;const s=t.scaleFactor||1;let i,e,r;this._cimTextLayer=t,At(t.color)?this._dynamicPropertyMap.set("_color",((s,i,e)=>qt(t.color(s,i,e)))):this._color=qt(t.color),At(t.color)?this._dynamicPropertyMap.set("_haloColor",((s,i,e)=>qt(t.outlineColor(s,i,e)))):this._haloColor=qt(t.outlineColor),At(t.size)||(i=Math.min(Math.round(z(t.size*t.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",((s,e,r)=>At(t.size)?Math.min(Math.round(z(t.size(s,e,r)*t.sizeRatio)),127):i)),At(t.outlineSize)?this._dynamicPropertyMap.set("_haloSize",((s,i,e)=>Math.min(Math.floor(5*z(t.outlineSize(s,i,e)*t.sizeRatio)),127))):this._haloSize=Math.min(Math.floor(5*z(t.outlineSize*t.sizeRatio)),127),At(t.offsetX)||(e=Math.round(z(t.offsetX*t.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",((s,i,r)=>At(t.offsetX)?Math.round(z(t.offsetX(s,i,r)*t.sizeRatio)):e)),At(t.offsetY)||(r=Math.round(z(t.offsetY*t.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",((s,i,e)=>At(t.offsetY)?Math.round(z(t.offsetY(s,i,e)*t.sizeRatio)):r)),At(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,At(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,At(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,this._scaleFactor=s,At(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text;const n=Math.min(Math.round(z(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*n)),this._materialKey=t.materialKey;const h=os.load(this._materialKey);h.sdf=!0,this._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=h.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=t.markerPlacement,this.effects=t.effects,this._isCIM=!0}static fromCIMText(t){return new Ri(t)}async analyze(t,s,i,e){const r=s.readLegacyFeature(),n=function(t,s,i,e){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(s,i,e):""}(this._cimTextLayer,r,i,e),h=await t.getMosaicItem(this._cimTextLayer.cim,Ss(n));return this._textToGlyphs.set(n,h.glyphMosaicItems),h}bindFeature(t,s,i){const e=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=js(this._horizontalAlignment||"center"),this._yAlignD=ks(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}class Ui extends(bi(Os)){constructor(t,s,i,e,r,n,h,o,a){super(),this.effects=a;const c=rs.load(t);s&&(c.sdf=s.sdf,c.pattern=!0,c.textureBinding=s.textureBinding),this.fillColor=i,this.tl=e,this.br=r,this.aux1=n,this.aux2=h,this.aux3=o,this._materialKey=c.data}static fromCIMFill(t,s){const i=t.color,e=i&&qt(i)||0,r=t.materialKey;if(!s){const s=$t(0,0,0,t.colorLocked?1:0);return new Ui(r,null,e,0,0,0,0,s,t.effects)}const{rect:n,width:h,height:o}=s,a=n.x+bt,c=n.y+bt,l=a+h,u=c+o;let f=P(z(t.height||0));f>255?f=255:f<=0&&(f=P(u-c));let p=P(z(t.height/o*h||0));p>255?p=255:p<=0&&(p=P(l-a));let d=z(t.offsetX||0)+128;d>255&&(d=255);let m=z(-t.offsetY||0)+128;m>255&&(m=255);const w=t.scaleX||1,y=Wt(a,c),M=Wt(l,u),g=$t(p,f,d,m),b=Wt(128*w,128),v=$t(0,0,Bt(t.angle),t.colorLocked?1:0);return new Ui(r,s,e,y,M,g,b,v,t.effects)}static fromSimpleFill(t,s,i=!1){const{color:e}=t,r=e&&"esriSFSNull"!==t.style&&Xt(e)||0,n=$t(0,0,0,i?255:0),h=t.materialKey;if(!s)return new Ui(h,null,r,0,0,0,0,n,null);const{rect:o,width:a,height:c}=s,l=o.x+bt,u=o.y+bt,f=l+a,p=u+c,d=Wt(l,u),m=Wt(f,p),w=$t(P(f-l),P(p-u),0,0),y=Wt(128,128);return new Ui(h,s,r,d,m,w,y,n,null)}static fromPictureFill(t,s,i=!1){const e=vt,{rect:r,width:n,height:h}=s,o=r.x+bt,a=r.y+bt,c=o+n,l=a+h,u=Wt(o,a),f=Wt(c,l);let p=P(z(t.width));p>255&&(p=255);let d=P(z(t.height));d>255&&(d=255);let m=z(t.xoffset)+128;m>255&&(m=255);let w=z(-t.yoffset)+128;w>255&&(w=255);const y=$t(p,d,m,w),M=Wt(128*t.xscale,128*t.yscale),g=$t(0,0,0,i?255:0);return new Ui(t.materialKey,s,e,u,f,y,M,g,null)}}const Bi=l.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class Oi extends(Li(Os)){constructor(t,s,i,e,r,n,h,o,a,c,l,u,f,p,d,m){super();const w=hs.load(t);s&&(w.sdf=s.sdf,w.pattern=!0,w.textureBinding=s.textureBinding),this._capType=e,this._joinType=r,this._miterLimitCosine=Ut(n),this.tessellationProperties._fillColor=h,this.tessellationProperties._tl=o,this.tessellationProperties._br=a,this._hasPattern=c,this._isDashed=l,this._joinOnUTurn=d,this._isColorLocked=u,this._zOrder=p,this.effects=m,this._materialKey=w.data,this.tessellationProperties._bitset=u?1:0,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*f,this._initializeTessellator(!1)}static fromCIMLine(t,s,i){const e=t.color,r=t.scaleFactor||1,n=t.isDashed;let h=t.cap;n&&1===h&&(h=2);const o=t.join,a=z(t.width)*r,c=z(t.referenceWidth),l=z(t.miterLimit),u=e&&qt(e)||0;if(!s)return new Oi(t.materialKey,s,a,h,o,l,u,0,0,!1,n,t.colorLocked,c,t.zOrder,i,t.effects);const{rect:f,width:p,height:d}=s,m=f.x+bt,w=f.y+bt,y=m+p,M=w+d,g=Wt(m,w),b=Wt(y,M);return new Oi(t.materialKey,s,a,h,o,l,u,g,b,!0,n,t.colorLocked,c,t.zOrder,i,t.effects)}static fromSimpleLine(t,s,i){const{color:e}=t,r="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,n=pt(t.cap||"round",r),h=dt(t.join||"round");let o=e&&"esriSLSNull"!==t.style&&Xt(e)||0;"esriSLSNull"===t.style&&(o=0);const a=z(t.width),c=t.miterLimit;if(!s)return new Oi(t.materialKey,s,a,n,h,c,o,0,0,!1,r,!1,a,0,i,null);const{rect:l,width:u,height:f}=s,p=l.x+bt,d=l.y+bt,m=p+u,w=d+f,y=Wt(p,d),M=Wt(m,w);return new Oi(t.materialKey,s,a,n,h,c,o,y,M,!0,r,!1,a,0,i,null)}static fromPictureLineSymbol(t,s,i,e){return Bi.error("PictureLineSymbol support does not exist!"),null}}class Ni{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){return this._resolver?this._resolver.promise.then((()=>this.acquire())):(this._resolver=D(),A())}release(){const t=this._resolver;this._resolver=null,t.resolve()}}const Ei=l.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Ki=new Array;function Wi(t,s){const i=t.length;return t.push(null),s.then((s=>t[i]=s)),t}function $i(t){return!!(1&t)}class qi{constructor(t,s){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Ni,this._fetchResource=t,this._joinOnUTurn=s}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,s){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const e=new Array;s&&this._createMeshTemplates(e,s,!0),this._createMeshTemplates(e,t,!1);const r=this._createGroupId("expanded-cim"===t.type);return this._idToTemplateGroup.set(r,e),this._symbolToTemplate.set(i,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):Ki}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?($i(t)||Ei.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):Ki}getMosaicItem(t,s){const i=this._createTemplateId(),e=R((t=>this._idToResolver.set(i,t)));return this._fetchQueue.push({symbol:t,id:i,glyphIds:s}),e}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?function(t,s,i){return t.acquire().then((()=>s(i))).then((()=>t.release())).catch((s=>{throw t.release(),s}))}(this._lock,this._fetchAllQueuedResources.bind(this),t):A()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],ys(H),!1),marker:this._createMeshTemplates([],ys(Y),!1),line:this._createMeshTemplates([],ys(J),!1)})}_fetchAllQueuedResources(s){if(!this._fetchQueue.length)return A();const i=this._fetchQueue,e=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],m(e).then((()=>this._fetchResource(i,s).then((t=>{for(const{id:s,mosaicItem:i}of t)this._idToResolver.get(s)(i),this._idToResolver.delete(s)})))).catch((s=>{U(s)?this._fetchQueue=this._fetchQueue.concat(i):function(t){return"worker:port-closed"===t.name}(s)||Ei.error(new t("mapview-template-store","Unable to fetch requested texture resources",s))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return zs(s,Ei)?Ks.fromSimpleMarker(t,s):this._markerError}async _createPMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return zs(s,Ei)?Ks.fromPictureMarker(t,s):this._markerError}async _createSFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return zs(i,Ei)?Ui.fromSimpleFill(t,i,s):this._fillError}async _createPFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return zs(i,Ei)?Ui.fromPictureFill(t,i,s):this._fillError}async _createSLS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return zs(i,Ei)?Oi.fromSimpleLine(t,i,this._joinOnUTurn):this._lineError}async _createLMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return zs(s,Ei)?Ks.fromLineSymbolMarker(t,s):this._markerError}async _createTS(t){const{glyphMosaicItems:s}=await this.getMosaicItem(t);return Ns.fromText(t,s)}async _createCIMText(t){const{glyphMosaicItems:s}=await this.getMosaicItem(t.cim,Ss(t.text));return t.cim.mosaicHash=t.materialHash,zs(s,Ei)?Ns.fromCIMText(t,s):this._textError}async _createCIMFill(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:s}=await this.getMosaicItem(t.cim);return zs(s,Ei)?Ui.fromCIMFill(t,s):this._fillError}async _createCIMLine(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:s}=await this.getMosaicItem(t.cim);return zs(s,Ei)?Oi.fromCIMLine(t,s,this._joinOnUTurn):this._lineError}async _createCIMMarker(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:s}=await this.getMosaicItem(t.cim);return zs(s,Ei)?Ks.fromCIMMarker(t,s):this._markerError}async _createCIM(t){const s=t.templateHash;if(this._cimTemplateCache.has(s))return this._cimTemplateCache.get(s);let i;switch(t.type){case"marker":i=this._createCIMMarker(t);break;case"line":i=this._createCIMLine(t);break;case"fill":i=this._createCIMFill(t);break;case"text":i=this._createCIMText(t)}return i.then((t=>this._cimTemplateCache.set(s,t))),i}_createDynamicCIM(t){const s=t.templateHash;if(this._cimTemplateCache.has(s))return this._cimTemplateCache.get(s);let i;switch(t.type){case"marker":i=Di.fromCIMMarker(t);break;case"line":i=Ci.fromCIMLine(t);break;case"fill":i=_i.fromCIMFill(t);break;case"text":i=Ri.fromCIMText(t)}return this._cimTemplateCache.set(s,i),i}_createPrimitiveMeshTemplates(t,s,i){switch(s.type){case"esriSMS":return Wi(t,this._createSMS(s));case"esriPMS":return Wi(t,this._createPMS(s));case"esriSFS":return Wi(t,this._createSFS(s,i));case"line-marker":return Wi(t,this._createLMS(s));case"esriPFS":return Wi(t,this._createPFS(s,i));case"esriSLS":return Wi(t,this._createSLS(s,!1));case"esriTS":return Wi(t,this._createTS(s));default:return Ei.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,s,i){if(-1!==s.type.indexOf("3d"))return Ei.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===s.type){for(const i of s.layers)"function"==typeof i.materialHash?t.push(this._createDynamicCIM(i)):Wi(t,this._createCIM(i));return t}if("composite-symbol"===s.type){for(const e of s.layers)this._createPrimitiveMeshTemplates(t,e,i);return t}return"cim"===s.type||"label"===s.type||"web-style"===s.type?t:this._createPrimitiveMeshTemplates(t,s,i)}}class Xi{constructor(){this.vertexData=new Map,this.vertexCount=0,this.indexData=[]}clear(){this.vertexData.clear(),this.vertexCount=0,this.indexData=[]}update(t,s,i){for(const s in t)this.vertexData.set(s,t[s]);for(const s in this.vertexData)null===t[s]&&this.vertexData.delete(s);this.vertexCount=s,this.indexData=i}}class Hi{constructor(t,s,i,e=0,r=0){this.id=t,this.geometryType=s,this.materialKey=i,this.minZoom=e,this.maxZoom=r,this.meshData=null,this.symbolLevel=0,this.zOrder=0,this.vertexFrom=0,this.vertexCount=0,this.indexFrom=0,this.indexCount=0}get sortKey(){return void 0===this._sortKey&&this._computeSortKey(),this._sortKey}clone(){return this.copy()}copy(){const t=new Hi(this.id,this.geometryType,this.materialKey);return t.vertexFrom=this.vertexFrom,t.vertexCount=this.vertexCount,t.indexFrom=this.indexFrom,t.indexCount=this.indexCount,t.zOrder=this.zOrder,t.symbolLevel=this.symbolLevel,t.meshData=this.meshData,t.minZoom=this.minZoom,t.maxZoom=this.maxZoom,t}setMeshDataFromBuffers(t,s,i){const e=new Xi;for(const i in s){const r=s[i].stride,n=s[i].data,h=[],o=mt(r);for(let s=0;s<r*t.vertexCount/o;++s)h[s]=n[s+r*t.vertexFrom/o];e.vertexData.set(i,h)}e.indexData.length=0;for(let s=0;s<t.indexCount;++s)e.indexData[s]=i[s+t.indexFrom]-t.vertexFrom;e.vertexCount=t.vertexCount,this.meshData=e}readMeshDataFromBuffers(t,s){this.meshData?this.meshData.clear():this.meshData=new Xi;for(const s in t){const i=t[s].stride,e=t[s].data,r=[],n=mt(i);for(let t=0;t<i*this.vertexCount/n;++t)r[t]=e[t+i*this.vertexFrom/n];this.meshData.vertexData.set(s,r)}this.meshData.indexData.length=0;for(let t=0;t<this.indexCount;++t)this.meshData.indexData[t]=s[t+this.indexFrom]-this.vertexFrom;this.meshData.vertexCount=this.vertexCount}writeMeshDataToBuffers(t,s,i,e){for(const i in s){const e=s[i].stride,r=this.meshData.vertexData.get(i),n=s[i].data,h=mt(e);for(let s=0;s<e*this.meshData.vertexCount/h;++s)n[s+e*t/h]=r[s]}for(let s=0;s<this.meshData.indexData.length;++s)e[s+i]=this.meshData.indexData[s]+t;this.vertexFrom=t,this.vertexCount=this.meshData.vertexCount,this.indexFrom=i,this.indexCount=this.meshData.indexData.length}static writeAllMeshDataToBuffers(t,s,i){let e=0,r=0;for(const n of t)n.writeMeshDataToBuffers(e,s,r,i),e+=n.vertexCount,r+=n.indexCount}_computeSortKey(){this._sortKey=(31&this.symbolLevel)<<12|(127&this.zOrder)<<4|7&this.geometryType}serialize(t){return t.push(this.geometryType),t.push(this.materialKey),t.push(this.vertexFrom),t.push(this.vertexCount),t.push(this.indexFrom),t.push(this.indexCount),t.push(this.minZoom),t.push(this.maxZoom),t}static deserialize(t,s){const i=t.readInt32(),e=t.readInt32(),r=new Hi(s.id,i,e);return r.vertexFrom=t.readInt32(),r.vertexCount=t.readInt32(),r.indexFrom=t.readInt32(),r.indexCount=t.readInt32(),r.minZoom=t.readInt32(),r.maxZoom=t.readInt32(),r}}function Yi(t,s){if(null!==s){t.push(s.length);for(const i of s)i.serialize(t);return t}t.push(0)}function Ji(t,s,i){const e=t.readInt32(),r=new Array(e);for(let e=0;e<r.length;e++)r[e]=s.deserialize(t,i);return r}const Qi=l.getLogger("esri/views/2d/engine/webgl/collisions/Metric");class Zi{constructor(t,s,i,e,r){this.id=t,this.range=s,this.boxes=null,this.minZoom=-1,this.size=0,this.directionX=0,this.directionY=0,this.offsetX=0,this.offsetY=0,this.placementPadding=0,this.anchor=rt(i,e),this.baseZoom=r}add(t,s,i){t.x=t.x+s,t.y=t.y+i,this.bounds?this.boxes?(this.boxes.push(t),this.bounds.extend(t)):(this.boxes=[this.bounds,t],this.bounds=this.bounds.clone(),this.bounds.extend(t)):this.bounds=t}computeIndex(){const t=this.anchor[1],s=Math.floor(this.anchor[0]/St),i=Math.floor(t/St);this.xBucket=s,this.yBucket=i;const e=xt/St;if(this.hasVV)return this.xOverflow=e,void(this.yOverflow=e);this.xOverflow=Math.min(e,Math.ceil(2*this.bounds.width/St)),this.yOverflow=Math.min(e,Math.ceil(2*this.bounds.height/St))}findCollisionDelta(t){const s=this.bounds.findCollisionDelta(t.bounds),i=this.boxes&&this.boxes.length,e=t.boxes&&t.boxes.length;return Math.abs(s)>zt||!i&&!e?s:i&&e?this._boxesToBoxes(t):i?this._boxesToBox(t):this._boxToBoxes(t)}computeVVOffset(t,s){s||Qi.error("mapview-labeling",`Unable to compute label offset. Expected an evaluator function but found ${s}`);let i=this.size;if(this.hasVV){const e=s(t);i=isNaN(e)||null==e||e===1/0?this.size:e}this._computeOffset(i)}setPlacementOffset(t,s,i,e,r){this.hasVV=t,this.size=s,this.placementPadding=Math.round(i),this.directionX=e,this.directionY=r}clone(){const t=new Zi(this.id,this.range,this.anchor[0],this.anchor[1],this.baseZoom);return t.minZoom=this.minZoom,this.bounds&&(t.bounds=this.bounds.clone()),this.boxes&&(t.boxes=this.boxes.map((t=>t.clone()))),t.xBucket=this.xBucket,t.yBucket=this.yBucket,t.xOverflow=this.xOverflow,t.yOverflow=this.yOverflow,t.hasVV=this.hasVV,t.size=this.size,t.directionX=this.directionX,t.directionY=this.directionY,t.offsetX=this.offsetX,t.offsetY=this.offsetY,t}_boxToBoxes(t){let s=-1/0;for(const i of t.boxes){const t=this.bounds.findCollisionDelta(i);s=Math.max(t,s)}return s}_boxesToBox(t){let s=this.boxes[0].findCollisionDelta(t.bounds);for(let i=1;i<this.boxes.length;i++){const e=this.boxes[i].findCollisionDelta(t.bounds);s=Math.max(e,s)}return s}_boxesToBoxes(t){let s=-1/0;for(let i=0;i<this.boxes.length;i++){const e=this.boxes[i];for(const i of t.boxes){const t=e.findCollisionDelta(i);s=Math.max(t,s)}}return s}_computeOffset(t){this.offsetX=this.directionX*(t/2+this.placementPadding),this.offsetY=this.directionY*(t/2+this.placementPadding)}serialize(t){return t.push(this.id),this.bounds.serialize(t),t.push(this.range.from),t.push(this.range.count),t.push(this.anchor[0]),t.push(this.anchor[1]),t.push(this.baseZoom),t.push(this.hasVV?1:0),t.push(this.size),t.writeF32(this.directionX),t.writeF32(this.directionY),t.push(this.offsetX),t.push(this.offsetY),t.push(this.placementPadding),Yi(t,this.boxes),t}static deserialize(t){const s=t.readInt32(),i=Fs.deserialize(t),e={from:t.readInt32(),count:t.readInt32()},r=t.readInt32(),n=t.readInt32(),h=t.readInt32(),o=t.readInt32(),a=t.readInt32(),c=t.readF32(),l=t.readF32(),u=t.readInt32(),f=t.readInt32(),p=t.readInt32(),d=Ji(t,Fs),m=new Zi(s,e,r,n,h);return m.bounds=i,m.boxes=d,m.setPlacementOffset(!!o,a,p,c,l),m.offsetX=u,m.offsetY=f,m.computeIndex(),o||m._computeOffset(a),m}}class te{constructor(t){this.insertAfter=null,this.id=t,this.displayRecords=[],this.metrics=[]}copy(){const t=new te(this.id);return t.set(this),t}clone(){const t=new te(this.id);return t.displayRecords=this.displayRecords.map((t=>t.clone())),t.metrics=this.metrics.map((t=>t.clone())),t.insertAfter=this.insertAfter,t}set(t){this.id=t.id,this.displayRecords=t.displayRecords,this.metrics=t.metrics,this.insertAfter=t.insertAfter}serialize(t){return t.push(this.id),Yi(t,this.metrics),Yi(t,this.displayRecords),t}static deserialize(t){const s=t.readInt32(),i=new te(s),e={id:s},r=Ji(t,Zi);return r.length&&(i.metrics=r),i.displayRecords=Ji(t,Hi,e),i}}class se{constructor(t){this._pos=0,this._buffer=t,this._i32View=new Int32Array(this._buffer),this._f32View=new Float32Array(this._buffer)}readInt32(){return this._i32View[this._pos++]}readF32(){return this._f32View[this._pos++]}}class ie{constructor(t,s){this._pos=0;const i=s?this._roundToNearest(s,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t}get length(){return this._pos}_roundToNearest(t,s){const i=Math.round(t);return i+(s-i%s)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const s=this._roundToNearest(1.5*(this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(s),e=new this._ctor(i);e.set(this._buffer,0),this._array=i,this._buffer=e}}writeF32(t){this._ensureSize(1);const s=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,s}push(t){this._ensureSize(1);const s=this._pos;return this._buffer[this._pos++]=t,s}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,s){this._buffer[t]=s}getValue(t){return this._buffer[t]}incr(t){this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const s=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,s}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,s=[];for(let i=0;i<t.byteLength/4;i++)s.push(t[i]);return s}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}class ee{constructor(t,s){this.vertexVectorsMap=t,this._currentIndex=-1,this._currentRecordOffset=0,this._currentMetricOffset=0,this._currentMetrics=[];const i=4*(8*s.records+1),e=4*(20*s.metrics+1);this._bufDisplayObjects=new ie(Uint32Array,4*(4*s.features+1)+4),this._bufDisplayRecords=new ie(Uint32Array,i+4),this._bufMetrics=new ie(Uint32Array,e+4),this._bufDisplayObjects.push(0),this._bufDisplayRecords.push(0),this._bufMetrics.push(0)}get vertexBuffersMap(){if(!this._vertexBuffersMap){this._vertexBuffersMap={};for(let t=0;t<this.vertexVectorsMap.length;t++)this._vertexBuffersMap[t]=this.vertexVectorsMap[t].intoBuffers();this.vertexVectorsMap=null}return this._vertexBuffersMap}get(t){return this.vertexVectorsMap[t]}currentDisplayRecordCount(){return this._bufDisplayRecords[this._currentRecordOffset]}writeDisplayObject(t,s){this._bufDisplayObjects.incr(0),this._currentIndex=this._bufDisplayObjects.push(t),this._bufDisplayObjects.push(s),this._bufDisplayObjects.push(0),this._bufDisplayObjects.push(0),this._currentRecordOffset=0,this._currentMetricOffset=0,this._currentMetrics=[]}hasDisplayRecords(){return!(0===this._currentRecordOffset)}endDisplayObject(){this.hasDisplayRecords()?this._currentMetrics&&(0===this._currentMetricOffset&&(this._bufDisplayObjects.setValue(this._currentIndex+3,this._bufMetrics.length),this._currentMetricOffset=this._bufMetrics.length),Yi(this._bufMetrics,this._currentMetrics)):this._rollbackDisplayObject()}writeDisplayRecord(t,s,i,e,r,n,h=0,o=0){0===this._currentRecordOffset&&(this._currentRecordOffset=this._bufDisplayRecords.push(0),this._bufDisplayObjects.setValue(this._currentIndex+2,this._currentRecordOffset)),this._bufDisplayRecords.incr(this._currentRecordOffset),this._bufDisplayRecords.push(t),this._bufDisplayRecords.push(s),this._bufDisplayRecords.push(i),this._bufDisplayRecords.push(e),this._bufDisplayRecords.push(r),this._bufDisplayRecords.push(n),this._bufDisplayRecords.push(h),this._bufDisplayRecords.push(o)}writeMetrics(t){t&&this._currentMetrics.push(...t)}static deserializeDisplayObjects(t){const{bufDisplayObjects:s,bufMetrics:i,bufRecords:e}=t,r=new se(s),n=new se(e),h=new se(i),o=[];let a=r.readInt32();for(n.readInt32(),h.readInt32();a--;){const t=r.readInt32(),s=r.readInt32(),i=r.readInt32(),e=r.readInt32(),a=new te(t);0!==s&&(a.insertAfter=s),0!==i&&(a.displayRecords=Ji(n,Hi,{id:t})),0!==e&&(a.metrics=Ji(h,Zi)),o.push(a)}return o}encode(t,s){const i={};for(let t=0;t<this.vertexVectorsMap.length;t++){const e=this.vertexVectorsMap[t];i[t]={},e.transfer(i[t],s)}t.bufDisplayObjects=this._bufDisplayObjects.buffer(),t.bufRecords=this._bufDisplayRecords.buffer(),t.bufMetrics=this._bufMetrics.buffer(),s.push(t.bufDisplayObjects),s.push(t.bufMetrics),s.push(t.bufRecords),t.vertexBuffersMap=i,this.destroy()}destroy(){this.vertexVectorsMap=null,this._bufDisplayObjects=null,this._bufDisplayRecords=null,this._bufMetrics=null}_rollbackDisplayObject(){this._bufDisplayObjects.decr(0),this._bufDisplayObjects.seek(this._bufDisplayObjects.length-4),this._currentIndex=this._bufDisplayObjects.length}}class re{constructor(t,s,i){this.data=t,this.stride=s,this.vertexCount=i}static decode(t){const s=wt(t.data,t.stride);return new re(s,t.stride,t.vertexCount)}static fromVertexVector(t){const s=wt(t.data.buffer(),t.stride);return new re(s,t.stride,t.vertexCount)}}class ne{constructor(t,s,i){this.geometryType=t,this.indexBuffer=new Uint32Array(s),this.namedBuffers=i}static decode(t){const s=t.geometryType,i=t.indexBuffer,e={};for(const s in t.namedBuffers)e[s]=re.decode(t.namedBuffers[s]);return new ne(s,i,e)}static fromVertexVectors(t){const s=t.geometryType,i=t.indexVector.buffer(),e={};for(const s in t.namedVectors)e[s]=re.fromVertexVector(t.namedVectors[s]);return new ne(s,i,e)}}class he{constructor(t,s){this.data=t,this.stride=s}get vertexCount(){const t=this.data.length/(this.stride/4);return t!==(0|t)&&console.debug("Corrupted stride"),t}transfer(t,s){const i=this.data.buffer();t.vertexCount=this.vertexCount,t.data=i,t.stride=this.stride,s.push(i)}}class oe{constructor(t,s,i=!1){this.geometryType=t,this.indexVector=new ie(Uint32Array,6*s),this.namedVectors={};const e=yt(t,i);for(const t in e){const i=e[t];let r;switch(i%4){case 0:case 2:r=new ie(Uint32Array,i*s);break;case 1:case 3:r=new ie(Uint8Array,i*s)}this.namedVectors[t]=new he(r,i)}}get(t){return this.namedVectors[t].data}getVector(t){return this.namedVectors[t]}transfer(t,s){const i=this.indexVector.buffer(),e={};s.push(i);for(const t in this.namedVectors){const i=this.namedVectors[t];e[t]={},i.transfer(e[t],s)}t.geometryType=this.geometryType,t.indexBuffer=i,t.namedBuffers=e,this.destroy()}intoBuffers(){const t=ne.fromVertexVectors(this);return this.destroy(),t}destroy(){this.indexVector=null,this.namedVectors=null}}function ae(t){return t.length-1}function ce(t,s,i=1){const[e,r]=function(t,s){return t[s+1]}(t,s);return Math.sqrt(e*e+r*r)*i}class le{constructor(t,s,i,e,r){this._segments=t,this._index=s,this._distance=i,this._xStart=e,this._yStart=r,this._done=!1}static create(t){return new le(t,0,0,t[0][0],t[0][1])}clone(){return new le(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy;let s=Math.acos((0*t+-1*-this.dx)/(1*this.length));return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:s}=this;return Math.sqrt(t*t+s*s)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<ae(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,s){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let e=this.backwardLength;for(;this.prev();){if(e+this.length>t)return this._seekBackwards(t-e);e+=this.length}return this._distance=0,s?this:null}seek(t,s=!1){if(t<0)return this._seekBackwards(Math.abs(t),s);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,s);i+=this.length}return this._distance=1,s?this:null}}function ue(t,s,i){const e=function(t){let s=0;for(let i=0;i<ae(t);i++)s+=ce(t,i);return s}(t),r=le.create(t),n=e/2,h=Math.floor((e-s)/2/s);r.seek(n-h*s);for(let t=-h;t<=h;t++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&i(r.clone(),t,n+t*s,e),r.seek(s)}function fe(t,s){const i=1e-6;if(s<=0)return;const e=t.length;if(e<3)return;const r=[];let n=0;r.push(0);for(let s=1;s<e;s++)n+=Et(t[s],t[s-1]),r.push(n);s=Math.min(s,.2*n);const h=[];h.push(t[0][0]),h.push(t[0][1]);const o=t[e-1][0],a=t[e-1][1],c=Ot([0,0],t[0],t[1]);Nt(c),t[0][0]+=s*c[0],t[0][1]+=s*c[1],Ot(c,t[e-1],t[e-2]),Nt(c),t[e-1][0]+=s*c[0],t[e-1][1]+=s*c[1];for(let t=1;t<e;t++)r[t]+=s;r[e-1]+=s;const l=.5*s;for(let n=1;n<e-1;n++){let o=0,a=0,c=0;for(let e=n-1;e>=0&&!(r[e+1]<r[n]-l);e--){const h=l+r[e+1]-r[n],u=r[e+1]-r[e],f=r[n]-r[e]<l?1:h/u;if(Math.abs(f)<i)break;const p=f*f,d=f*h-.5*p*u,m=f*u/s,w=t[e+1],y=t[e][0]-w[0],M=t[e][1]-w[1];o+=m/d*(w[0]*f*h+.5*p*(h*y-u*w[0])-p*f*u*y/3),a+=m/d*(w[1]*f*h+.5*p*(h*M-u*w[1])-p*f*u*M/3),c+=m}for(let h=n+1;h<e&&!(r[h-1]>r[n]+l);h++){const e=l-r[h-1]+r[n],u=r[h]-r[h-1],f=r[h]-r[n]<l?1:e/u;if(Math.abs(f)<i)break;const p=f*f,d=f*e-.5*p*u,m=f*u/s,w=t[h-1],y=t[h][0]-w[0],M=t[h][1]-w[1];o+=m/d*(w[0]*f*e+.5*p*(e*y-u*w[0])-p*f*u*y/3),a+=m/d*(w[1]*f*e+.5*p*(e*M-u*w[1])-p*f*u*M/3),c+=m}h.push(o/c),h.push(a/c)}h.push(o),h.push(a);for(let s=0,i=0;s<e;s++)t[s][0]=h[i++],t[s][1]=h[i++]}const pe=l.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),de=function(){const t=new Map;return s=>(t.has(s)||t.set(s,(t=>{let s=0;if(0===t)return 1/0;for(;!(t%2);)s++,t/=2;return s})(s)),t.get(s))}(),me=t=>Math.floor(127*t+127),we=t=>Math.floor(10*t),ye=t=>Math.round(t*(254/360)),Me=(t,s)=>Wt(Math.round(8*t),Math.round(8*s));class ge extends Ns{constructor(t,s,i,e){super(t,i.font.size,i.haloSize||0,i.color&&Xt(i.color)||0,i.haloColor&&Xt(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Jt(s.labelPlacement)?1:0,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this.geometryType=st.LABEL;const r=function(t,s){const i=!!t.minScale&&s.scaleToZoom(t.minScale)||0;return B(i,0,25.5)}(s,e),n=function(t,s){const i=!!t.maxScale&&s.scaleToZoom(t.maxScale)||255;return B(i,0,25.5)}(s,e),h=s.labelPlacement,[o,a]=function(t){switch(t){case"above-left":return[Vs.Right,Ts.Bottom];case"above-center":case"above-along":return[Vs.Center,Ts.Bottom];case"above-right":return[Vs.Left,Ts.Bottom];case"center-left":return[Vs.Right,Ts.Center];case"center-center":case"center-along":return[Vs.Center,Ts.Center];case"center-right":return[Vs.Left,Ts.Center];case"below-left":return[Vs.Right,Ts.Top];case"below-center":case"below-along":return[Vs.Center,Ts.Top];case"below-right":return[Vs.Left,Ts.Top];case"always-horizontal":return[Vs.Center,Ts.Baseline];default:return console.debug(`Found invalid placement type ${t}`),[Vs.Center,Ts.Center]}}(h);this._xAlignD=o,this._yAlignD=a,this._minZoom=r,this._maxZoom=n,this._refPlacementPadding=z(i.haloSize)+Vt;const c=as.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,s){if("center-along"===t.labelPlacement){const s=t.symbol;s.xoffset=0,s.yoffset=0,s.angle=0,s.font.decoration="none"}return new ge(t.materialKey,t,t.symbol,s)}get _shapedBox(){return V(this._shapingInfo).bounds}bindReferenceTemplate(t){let s=function(t){switch(t){case Vs.Right:return-1;case Vs.Center:return 0;case Vs.Left:return 1;default:return console.debug(`Found invalid horizontal alignment ${t}`),0}}(this._xAlignD),i=function(t){switch(t){case Ts.Top:return 1;case Ts.Center:return 0;case Ts.Bottom:case Ts.Baseline:return-1;default:return console.debug(`Found invalid vertical alignment ${t}`),0}}(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,S(t))return void(this._refSymbolAndPlacementOffset=$t(0,0,me(s),me(i)));if("circle"===t.boundsType&&(s||i)){const t=Math.sqrt(s*s+i*i);s/=t,i/=t}const e=Math.max(t.height,t.width);this._refSymbolAndPlacementOffset=$t(4*this._refPlacementPadding,e,me(s),me(i)),this._referenceSize=e,this._refPlacementDirX=s,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}writeMesh(s,i,e,r,n,h){if(S(this._shapingInfo))return;const o=new Array,a=this._shapingInfo,c="esriGeometryPolygon"===e.geometryType?e.readLegacyCentroid():e.readLegacyGeometry();if(c){switch(this.current={out:s,outVecs:i,outMetrics:o,inId:n,inShaping:a,zoomLevel:h},r){case"esriGeometryPolyline":this._placeLineLabels(c);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(c);break;default:((s,i="mapview-labeling")=>{pe.error(new t(i,"mapview-labeling"))})(0,`Geometry of type ${r} is not supported`)}s.writeMetrics(this.current.outMetrics)}}_isVisible(t,s){const i=we(this.current.zoomLevel);return we(t)<=i&&i<=we(s)}_placePointLabels(t){const{out:s,outVecs:i,outMetrics:e,inId:r}=this.current;this._writeGlyphs(s,i,r,t,e)}_placeLineLabels(t){const s=function(t,s){const i=s;for(let s=0;s<t.length;s++){let e=t[s];const r=[];r.push(e[0]);for(let t=1;t<e.length;t++){let[s,i]=r[t-1];s+=e[t][0],i+=e[t][1],r.push([s,i])}fe(r,i);const n=[];n.push(r[0]);for(let t=1;t<r.length;t++){const[s,i]=r[t-1],[e,h]=r[t],o=Math.round(e-s),a=Math.round(h-i);n.push([o,a])}t[s]=n,e=n}return t}(t.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),e=(this._shapedBox.width+128)/4;for(const t of s)ue(t,e,i)}_placeSubdivGlyphs(t,s,i,e){const r=de(s),n=this._shapedBox.width/4,h=Math.min(i,e-i),o=b(h/(4+n/2)),a=0===s?o:Math.min(r,o),c=Math.max(this._minZoom,this.current.zoomLevel+2-a),l=this._shapedBox.width/2*Math.pow(2,this.current.zoomLevel-c);this.current.inShaping.isMultiline?0===s&&this._placeStraight(t,c):this._placeCurved(t,c,l)}_placeStraight(t,s){const{out:i,outVecs:e,outMetrics:r,inId:n}=this.current;this._writeGlyphs(i,e,n,t,r,s)}_placeCurved(t,s,i){const e={from:this.current.out.currentDisplayRecordCount(),count:-1},r=new Zi(this.current.inId,e,t.x,t.y,s),n=t.clone(),h=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=ye(h),this._placeFirst(n,r,s,1),this._placeBack(t,n,r,s,i,1),this._placeForward(t,n,r,s,i,1),this._outLineLabelAngle=ye(o),this._placeFirst(n,r,s,0),this._placeBack(t,n,r,s,i,0),this._placeForward(t,n,r,s,i,0),r.range.count=this.current.out.currentDisplayRecordCount()-r.range.from,r.bounds&&this.current.outMetrics.push(r)}_placeBack(t,s,i,e,r,n){const h=t.clone();let o=t.backwardLength+0;for(;h.prev()&&!(o>=r);)this._placeOnSegment(h,s,i,o,e,-1,n),o+=h.length+0}_placeForward(t,s,i,e,r,n){const h=t.clone();let o=t.remainingLength+0;for(;h.next()&&!(o>=r);)this._placeOnSegment(h,s,i,o,e,1,n),o+=h.length+0}_placeFirst(t,s,i,e){const r=t,n=this.current.inShaping,h=n.glyphs,o=this.current.zoomLevel,{out:a,outVecs:c,inId:l}=this.current,u=Me(r.x,r.y);for(const r of h){const h=r.x>n.bounds.x?e:1-e,f=h*t.remainingLength+(1-h)*t.backwardLength,p=Math.abs(r.x+r.width/2-n.bounds.x),d=Math.max(0,o+b(p/(f+0))),m=Math.max(i,d);r.maxZoom=25,r.angle=t.angle+(1-e)*Math.PI,r.minZoom=m,this._writeGlyph(a,c,r,l,u),e&&this._isVisible(r.minZoom,r.maxZoom)&&s.add(r.bounds,0,0)}}_placeOnSegment(t,s,i,e,r,n,h){const o=this.current.inShaping.glyphs,{out:a,outVecs:c,inId:l}=this.current,u=this.current.inShaping,f=this.current.zoomLevel,p={x:t.x+e*-n*(t.dx/t.length),y:t.y+e*-n*(t.dy/t.length)},d=Me(p.x,p.y);for(const p of o){const o=p.x>u.bounds.x?h:1-h;if(!(o&&1===n||!o&&-1===n))continue;const m=Math.abs(p.x+p.width/2-u.bounds.x),w=Math.max(0,f+b(m/e)-.1),y=Math.max(r,f+b(m/(e+t.length+0)));0!==w&&(p.angle=t.angle+(1-h)*Math.PI,p.minZoom=y,p.maxZoom=w,this._writeGlyph(a,c,p,l,d),h&&this._isVisible(p.minZoom,p.maxZoom)&&i.add(p.bounds,t.x-s.x,t.y-s.y))}}_writeGlyphs(t,s,i,e,r,n=this._minZoom){const h=this._shapingInfo;if(S(h))return;if(e.x<0||e.x>=512||e.y<0||e.y>=512)return;const o=t.currentDisplayRecordCount(),a=Me(e.x+this._refOffsetX,e.y-this._refOffsetY),c=new Zi(i,{from:o,count:-1},e.x+this._refOffsetX,e.y-this._refOffsetY,n);for(const e of h.glyphs)e.minZoom=n,e.maxZoom=this._maxZoom,this._writeGlyph(t,s,e,i,a);c.range.count=t.currentDisplayRecordCount()-c.range.from,c.bounds=h.boundsT;const l=as.load(this._materialKey);c.setPlacementOffset(l.vvSizeFieldStops||l.vvSizeMinMaxValue||l.vvSizeScaleStops||l.vvSizeUnitValue,this._referenceSize,this._refPlacementPadding,this._refPlacementDirX,this._refPlacementDirY),r.push(c)}_writeGlyph(t,s,i,e,r){const n=Zt.load(this._materialKey);n.textureBinding=i.textureBinding;const h=s.indexVector.length,o=s.getVector("geometry").vertexCount,a=this._writeIndices(s),c=this._writeVertex(s,e,r,i);t.writeDisplayRecord(this.geometryType,n.data,o,c,h,a)}_writeVertexCommon(t,s,i,e){const r=this._color,n=this._haloColor,h=$t(0,0,this._size,this._haloSize),o=Math.max(e.minZoom,this._minZoom),a=Math.min(e.maxZoom,this._maxZoom),c=$t(we(o),we(a),this._outLineLabelAngle,0);t.push(i),t.push(s),t.push(r),t.push(n),t.push(h),t.push(this._refSymbolAndPlacementOffset),t.push(c)}}class be{constructor(t,s,i){this._isDD=!1,this._geometryType=t,this._idField=s,this._templateStore=i}update(t,s){this._isDD="simple"===t.mesh.matcher.type&&t.mesh.matcher.isDotDensity,p(t.mesh.labels)&&this._setLabelTemplates(t.mesh.labels,s)}_setLabelTemplates(t,s){this._labelTemplates=t.map((t=>ge.fromLabelClass(t,s)))}get templates(){return this._templateStore}createMeshData(t){const s=new Array(5),i=this._labelTemplates&&this._labelTemplates.length>0,e="esriGeometryPolyline"===this._geometryType?Tt:jt;return s[st.MARKER]=new oe(st.MARKER,4*t),s[st.FILL]=new oe(st.FILL,t,this._isDD),s[st.LINE]=new oe(st.LINE,t),s[st.TEXT]=new oe(st.TEXT,4*t),s[st.LABEL]=new oe(st.LABEL,i?4*e:0),new ee(s,{features:t,records:t,metrics:0})}async analyze(t,s,i,e,r){if(O(r))return;let n;"dictionary"===s.type&&(n=await s.analyze(this._idField,t.copy(),i,e,r));let h=0;for(;t.next();){let r;if(r=n?n[h++]:s.match(this._idField,t,this._geometryType,i,e),t.setGroupId(r),$i(r)){const s=this._templateStore.getDynamicTemplateGroup(r);for(const r of s)r&&r.analyze&&r.analyze(this._templateStore,t,i,e)}}return this._templateStore.finalize(r)}async analyzeGraphics(t,s,i,e,r){if(O(r))return;const n=t.getCursor();for(s&&await s.analyze(this._idField,n.copy(),i,e,r);n.next();){let t=n.getGroupId();if(null!=t&&-1!==t||(t=s.match(this._idField,n,n.geometryType,i,e),n.setGroupId(t)),$i(t)){const s=this._templateStore.getDynamicTemplateGroup(t);for(const t of s)t&&t.analyze&&t.analyze(this._templateStore,n,i,e)}n.setGroupId(t)}return this._templateStore.finalize(r)}writeGraphic(t,s){const i=s.getGroupId(),e=s.getDisplayId(),r=this._templateStore.getTemplateGroup(i),n=s.geometryType;if(null!=e){if($i(i))for(const t of r)t.bindFeature(s,null,null);if(r){t.writeDisplayObject(e,s.readGraphic().insertAfter);for(const i of r){if(!i)continue;const r=t.get(i.geometryType);i.writeMesh(t,r,s,n,e)}}}}writeCursor(t,s,i,e,r,n){const h=s.getGroupId(),o=s.getDisplayId(),a=this._templateStore.getTemplateGroup(h);if(null==o)return;if(!a)return;if(t.writeDisplayObject(o,0),$i(h))for(const t of a)t.bindFeature(s,i,e);for(const i of a){const e=t.get(i.geometryType);!i.needsPixelBuffer&&s.hasFilter()||i.writeMesh(t,e,s,this._geometryType,o)}const c=t.hasDisplayRecords();if(p(n)&&c){const i=n&&this._findLabelRef(a);this._writeLabels(t,s,o,n,i,r)}t.endDisplayObject()}_findLabelRef(t){for(const s of t)if(s instanceof Ks)return s;return null}_writeLabels(t,s,i,e,r,n){for(const h of e)if(p(h)&&h){const{glyphs:e,rtl:o,index:a}=h,c=this._labelTemplates[a],l=t.get(c.geometryType);c.bindReferenceTemplate(r),c.bindTextInfo(e,o),c.writeMesh(t,l,s,this._geometryType,i,n)}}}class ve{constructor(t,s=2){this._bucketSize=t,this._rowsLength=xt/t,this._colsLength=xt/t,this._elementsPerBucket=s,this._grid=this._initGrid()}checkOverlap(t,s){const i=Math.floor(t/this._bucketSize),e=Math.floor(s/this._bucketSize);return i<0||i>=this._rowsLength||e<0||e>=this._colsLength||this._grid[e*this._colsLength+i]>=this._elementsPerBucket}markUsed(t,s){const i=Math.floor(t/this._bucketSize),e=Math.floor(s/this._bucketSize);this._grid[e*this._colsLength+i]+=1}reset(){this._grid=this._initGrid()}_initGrid(){return new Uint8Array(this._rowsLength*this._colsLength)}}l.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");let xe=class extends Kt{constructor(){super(...arguments),this.type="symbol"}destroy(){}get supportsTileUpdates(){return!0}async update(t,s){const i=s.schema.processors[0];if("symbol"!==i.type)return;const e=q(this._schema,i);X(e,"mesh")&&(u("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",e),t.mesh=!0,t.why.mesh.push("Symbology changed"),this._schema=i,this._factory=this._createFactory(i),this._factory.update(i,this.tileStore.tileScheme.tileInfo))}onTileData(t,s,i){return N(i),this._onTileData(t,s,i)}onTileError(t,s,i){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:s},{signal:i.signal})}_createFactory(s){const{geometryType:i,objectIdField:e,fields:r}=this.service,n={geometryType:i,fields:r,spatialReference:E.fromJSON(this.spatialReference)},h=new qi(((t,s)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",t,s)),!1);return this._store=h,this._matcher=async function(s,i,e){switch(s.type){case"simple":return gs.fromBasicRenderer(s,i,e);case"map":return vs.fromUVRenderer(s,i,e);case"interval":return bs.fromCBRenderer(s,i,e);case"dictionary":return xs.fromDictionaryRenderer(s,i,e);default:return _s.error(new t("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}}(s.mesh.matcher,h,n),new be(i,e,h)}async _onTileData(t,s,i){const{type:e,addOrUpdate:r,remove:n,end:h}=s;if(!r)return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:{type:e,addOrUpdate:null,remove:n,clear:!1,end:h}},i);const o=this._processFeatures(t,r,i),a=i.signal;try{const s=await o,i=_(s,(t=>t.message)),r=_(s,(t=>t.transferList))||[],c={type:e,addOrUpdate:i,remove:n,clear:!1,end:h},l={transferList:V(r)||[],signal:a};return N(l),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:c},l)}catch(s){this._handleError(t,s,i)}}async _processFeatures(t,s,i){if(S(s)||!s.hasFeatures)return null;const e={transform:t.transform,hasZ:!1,hasM:!1},r=this._factory,n={viewingMode:"",scale:t.scale},h=await this._matcher;N(i);const o=this._getLabelInfos(t,s);return await r.analyze(s.getCursor(),h,e,n),N(i),this._writeFeatureSet(t,s,e,o,r)}_writeFeatureSet(t,s,i,e,r){const n=r.createMeshData(s.getApproximateSize()),h={viewingMode:"",scale:t.scale},o=s.getCursor();for(;o.next();)try{const s=o.getDisplayId(),a=p(e)?e.get(s):null;r.writeCursor(n,o,i,h,t.level,a)}catch(t){}return this._encodeDisplayData(n)}_encodeDisplayData(t){const s={},i=new Array;return t.encode(s,i),{message:s,transferList:i}}_handleError(t,s,i){if(!U(s))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:s.message},{signal:i.signal})}_shouldDiscard(t,s){switch(this.service.geometryType){case"esriGeometryPoint":{const i=s.readLegacyPointGeometry();return!i||t.checkOverlap(i.x,i.y)}case"esriGeometryPolygon":{const i=s.readLegacyCentroid();return!i||t.checkOverlap(i.x,i.y)}default:return!1}}_markUsed(t,s){switch(this.service.geometryType){case"esriGeometryPoint":{const{x:i,y:e}=s.readLegacyPointGeometry();return t.markUsed(i,e)}case"esriGeometryPolygon":{const{x:i,y:e}=s.readLegacyCentroid();return t.markUsed(i,e)}}}_getLabelInfos(t,s){const i=_(this._schema.mesh.labels,(s=>s.filter((s=>function(t,s){return(!t.minScale||t.minScale>=s)&&(!t.maxScale||t.maxScale<=s)}(s,t.scale)))));if(S(i)||0===i.length)return null;const e=new Map,r=new ve(kt),n=s.getCursor();for(;n.next();){const t=n.getDisplayId();if(this._shouldDiscard(r,n)){e.has(t)||e.set(t,null);continue}let s=!1;const h=[],o=Mt(t),a=o&&1!==n.readAttribute("cluster_count")?"aggregate":"feature";for(const e of i){if(e.target!==a)continue;const i=n.getStorage().getComputedStringAtIndex(o&&"feature"===a?n.readAttribute("referenceId"):t,e.fieldIndex);if(!i)continue;const r=Yt(i.toString()),c=r[1];this._store.getMosaicItem(e.symbol,Ss(r[0])).then((t=>{h[e.index]={glyphs:t.glyphMosaicItems,rtl:c,index:e.index}})),s=!0}e.set(t,h),s&&this._markUsed(r,n)}return e}};xe=e([h("esri.views.2d.layers.features.processors.SymbolProcessor")],xe);var _e=xe;export default _e;