import{k as t,Q as s,l as i,m as h,b as e,bi as r,cQ as n}from"./p-ab028778.js";import{t as o,a}from"./p-ebb65ba7.js";import{l as u}from"./p-fd91cc88.js";import{t as c}from"./p-43d5e67f.js";import{i as f}from"./p-2b439a2e.js";import{G as m}from"./p-4561de0e.js";const d={minX:0,minY:0,maxX:0,maxY:0};class l{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=f(9,t("csp-restrictions")?t=>({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const t=new Array(this._idByBounds.size);let s=0;this._idByBounds.forEach(((i,h)=>{t[s++]=h})),this._indexInvalid=!1,this._index.clear(),this._index.load(t)}else this._boundsToLoad.length&&(this._index.load(this._boundsToLoad.filter((t=>this._idByBounds.has(t)))),this._boundsToLoad.length=0)}}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(t){const s=this._boundsById.get(t);this._boundsById.delete(t),s&&(this._idByBounds.delete(s),this._indexInvalid||this._index.remove(s))}forEachInBounds(t,s){this._loadIndex();for(const i of function(t,s){return d.minX=s[0],d.minY=s[1],d.maxX=s[2],d.maxY=s[3],t.search(d)}(this._index,t))s(this._idByBounds.get(i))}get(t){return this._boundsById.get(t)}has(t){return this._boundsById.has(t)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(t,s){if(!this._indexInvalid){const s=this._boundsById.get(t);s&&(this._index.remove(s),this._idByBounds.delete(s))}this._boundsById.set(t,s),s&&(this._idByBounds.set(s,t),this._indexInvalid||(this._boundsToLoad.push(s),this._boundsToLoad.length>5e4&&this._loadIndex()))}}const p={getObjectId:t=>t.objectId,getAttributes:t=>t.attributes,getAttribute:(t,s)=>t.attributes[s],cloneWithGeometry:(t,s)=>new o(s,t.attributes,null,t.objectId),getGeometry:t=>t.geometry,getCentroid:(t,s)=>(t.centroid||(t.centroid=c(new a,t.geometry,s.hasZ,s.hasM)),t.centroid)};class g{constructor(t){this.geometryInfo=t,this._boundsStore=new l,this._featuresById=new Map,this._markedIds=new Set,this.events=new s,this.featureAdapter=p}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){if(!this.numFeatures)return null;const t=r(n);return this._featuresById.forEach((s=>{const i=this._boundsStore.get(s.objectId);i&&(t[0]=Math.min(i[0],t[0]),t[1]=Math.min(i[1],t[1]),t[2]=Math.max(i[2],t[2]),t[3]=Math.max(i[3],t[3]))})),t}get storeStatistics(){let t=0;return this._featuresById.forEach((s=>{s.geometry&&s.geometry.coords&&(t+=s.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:t/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}add(t){this._add(t),this._emitChanged()}addMany(t){for(const s of t)this._add(s);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(t){const s=this._featuresById.get(t);return s?(this._remove(s),this._emitChanged(),s):null}removeManyById(t){this._boundsStore.invalidateIndex();for(const s of t){const t=this._featuresById.get(s);t&&this._remove(t)}this._emitChanged()}forEachBounds(t,s,i){for(const h of t){const t=this._boundsStore.get(h.objectId);t&&s(m(i,t))}}getFeature(t){return this._featuresById.get(t)}has(t){return this._featuresById.has(t)}forEach(t){this._featuresById.forEach((s=>t(s)))}forEachInBounds(t,s){this._boundsStore.forEachInBounds(t,(t=>{s(this._featuresById.get(t))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let t=!1;this._featuresById.forEach(((s,i)=>{this._markedIds.has(i)||(t=!0,this._remove(s))})),this._markedIds.clear(),t&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(t){if(!t)return;const s=t.objectId;if(null==s)return void i.getLogger("esri.layers.graphics.data.FeatureStore").error(new h("featurestore:invalid-feature","feature id is missing",{feature:t}));const n=this._featuresById.get(s);let o;if(this._markedIds.add(s),n?(t.displayId=n.displayId,o=this._boundsStore.get(s),this._boundsStore.delete(s)):e(this.onFeatureAdd)&&this.onFeatureAdd(t),!t.geometry||!t.geometry.coords||!t.geometry.coords.length)return this._boundsStore.set(s,null),void this._featuresById.set(s,t);o=u(o||r(),t.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),this._boundsStore.set(s,o),this._featuresById.set(s,t)}_remove(t){return e(this.onFeatureRemove)&&this.onFeatureRemove(t),this._markedIds.delete(t.objectId),this._boundsStore.delete(t.objectId),this._featuresById.delete(t.objectId),t}}export{g as h}