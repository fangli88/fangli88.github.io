import{bd as t,bg as i,cs as e,cB as s,cO as n,cR as r,h as o,m as a,C as u,cS as h,bf as l,cP as c,cT as f,p,t as d,q as y,U as m,cU as w,ct as S,cV as g,aJ as F,cW as M,O as v,b as R,cX as x,cY as b,s as _,be as I,cZ as T,c_ as N,c$ as P,i as q,d0 as j,bi as G}from"./p-ab028778.js";import{a as Q}from"./p-ebb65ba7.js";import{q as A,o as B,w as D,r as C,f as O,_ as E,L as U,v as V,K as L}from"./p-fd91cc88.js";import{WhereClause as Z}from"./p-babdd7a5.js";import{P as $}from"./p-c6c7c9c2.js";import{m as X}from"./p-f3cc8f75.js";import{s as k}from"./p-a1a69fdc.js";import{t as J}from"./p-02a4b6c8.js";import{Q as W,r as Y}from"./p-4f43bb64.js";import{w as z,o as K,i as H,C as tt}from"./p-4561de0e.js";import{r as it}from"./p-3db2569b.js";import{t as et}from"./p-a6dff060.js";import{n as st}from"./p-920b2088.js";const nt=[0,0];function rt(t,i){if(!i)return null;if("x"in i){const e={x:0,y:0};return[e.x,e.y]=t(i.x,i.y,nt),null!=i.z&&(e.z=i.z),null!=i.m&&(e.m=i.m),e}if("xmin"in i){const e={xmin:0,ymin:0,xmax:0,ymax:0};return[e.xmin,e.ymin]=t(i.xmin,i.ymin,nt),[e.xmax,e.ymax]=t(i.xmax,i.ymax,nt),i.hasZ&&(e.zmin=i.zmin,e.zmax=i.zmax,e.hasZ=!0),i.hasM&&(e.mmin=i.mmin,e.mmax=i.mmax,e.hasM=!0),e}return"rings"in i?{rings:ot(i.rings,t),hasM:i.hasM,hasZ:i.hasZ}:"paths"in i?{paths:ot(i.paths,t),hasM:i.hasM,hasZ:i.hasZ}:"points"in i?{points:at(i.points,t),hasM:i.hasM,hasZ:i.hasZ}:void 0}function ot(t,i){const e=[];for(const s of t)e.push(at(s,i));return e}function at(t,i){const e=[];for(const s of t){const t=i(s[0],s[1],[0,0]);e.push(t),s.length>2&&t.push(s[2]),s.length>3&&t.push(s[3])}return e}async function ut(t,i){if(!i)return;const e=Array.isArray(t)?t.map((t=>{var i;return null==(i=t.geometry)?void 0:i.spatialReference})):[t];await Y(e.map((t=>({source:t,dest:i}))))}const ht=rt.bind(null,n),lt=rt.bind(null,r);function ct(n,r,o){return n?(o||(o=r,r=n.spatialReference),t(r)&&t(o)&&!i(r,o)?e(r,o)?s(o)?ht(n):lt(n):W(J,[n],r,o,null)[0]:n):n}const ft=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(t,e,s){!t||!t.length||!e||!s||i(e,s);const n={geometries:t,inSpatialReference:e,outSpatialReference:s,resolve:null};return this._jobs.push(n),o((t=>{n.resolve=t,null===this._timer&&(this._timer=setTimeout(this._process,10))}))}_process(){this._timer=null;const t=this._jobs.shift();if(!t)return;const{geometries:i,inSpatialReference:n,outSpatialReference:r,resolve:o}=t;e(n,r)?s(r)?o(i.map(ht)):o(i.map(lt)):o(W(J,i,n,r,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};function pt(t,i){if(!(this instanceof pt))return new pt(t,i);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&("function"==typeof i?this.toBBox=i:this._initFormat(i)),this.clear()}function dt(t,i,e){if(!e)return i.indexOf(t);for(var s=0;s<i.length;s++)if(e(t,i[s]))return s;return-1}function yt(t,i){mt(t,0,t.children.length,i,t)}function mt(t,i,e,s,n){n||(n=xt(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var r,o=i;o<e;o++)r=t.children[o],wt(n,t.leaf?s(r):r);return n}function wt(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function St(t,i){return t.minX-i.minX}function gt(t,i){return t.minY-i.minY}function Ft(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Mt(t){return t.maxX-t.minX+(t.maxY-t.minY)}function vt(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function Rt(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function xt(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function bt(t,i,e,s,n){for(var r,o=[i,e];o.length;)(e=o.pop())-(i=o.pop())<=s||(r=i+Math.ceil((e-i)/s/2)*s,it(t,r,i,e,n),o.push(i,r,r,e))}pt.prototype={all:function(){return this._all(this.data,[])},search:function(t){var i=this.data,e=[],s=this.toBBox;if(!Rt(t,i))return e;for(var n,r,o,a,u=[];i;){for(n=0,r=i.children.length;n<r;n++)o=i.children[n],Rt(t,a=i.leaf?s(o):o)&&(i.leaf?e.push(o):vt(t,a)?this._all(o,e):u.push(o));i=u.pop()}return e},collides:function(t){var i=this.data,e=this.toBBox;if(!Rt(t,i))return!1;for(var s,n,r,o,a=[];i;){for(s=0,n=i.children.length;s<n;s++)if(r=i.children[s],Rt(t,o=i.leaf?e(r):r)){if(i.leaf||vt(t,o))return!0;a.push(r)}i=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var i=0,e=t.length;i<e;i++)this.insert(t[i]);return this}var s=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var n=this.data;this.data=s,s=n}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=xt([]),this},remove:function(t,i){if(!t)return this;for(var e,s,n,r,o=this.data,a=this.toBBox(t),u=[],h=[];o||u.length;){if(o||(o=u.pop(),s=u[u.length-1],e=h.pop(),r=!0),o.leaf&&-1!==(n=dt(t,o.children,i)))return o.children.splice(n,1),u.push(o),this._condense(u),this;r||o.leaf||!vt(o,a)?s?(e++,o=s.children[e],r=!1):o=null:(u.push(o),h.push(e),e=0,s=o,o=o.children[0])}return this},toBBox:function(t){return t},compareMinX:St,compareMinY:gt,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,i){for(var e=[];t;)t.leaf?i.push.apply(i,t.children):e.push.apply(e,t.children),t=e.pop();return i},_build:function(t,i,e,s){var n,r=e-i+1,o=this._maxEntries;if(r<=o)return yt(n=xt(t.slice(i,e+1)),this.toBBox),n;s||(s=Math.ceil(Math.log(r)/Math.log(o)),o=Math.ceil(r/Math.pow(o,s-1))),(n=xt([])).leaf=!1,n.height=s;var a,u,h,l,c=Math.ceil(r/o),f=c*Math.ceil(Math.sqrt(o));for(bt(t,i,e,f,this.compareMinX),a=i;a<=e;a+=f)for(bt(t,a,h=Math.min(a+f-1,e),c,this.compareMinY),u=a;u<=h;u+=c)l=Math.min(u+c-1,h),n.children.push(this._build(t,u,l,s-1));return yt(n,this.toBBox),n},_chooseSubtree:function(t,i,e,s){for(var n,r,o,a,u,h,l,c,f,p;s.push(i),!i.leaf&&s.length-1!==e;){for(l=c=1/0,n=0,r=i.children.length;n<r;n++)u=Ft(o=i.children[n]),f=t,p=o,(h=(Math.max(p.maxX,f.maxX)-Math.min(p.minX,f.minX))*(Math.max(p.maxY,f.maxY)-Math.min(p.minY,f.minY))-u)<c?(c=h,l=u<l?u:l,a=o):h===c&&u<l&&(l=u,a=o);i=a||i.children[0]}return i},_insert:function(t,i,e){var s=e?t:(0,this.toBBox)(t),n=[],r=this._chooseSubtree(s,this.data,i,n);for(r.children.push(t),wt(r,s);i>=0&&n[i].children.length>this._maxEntries;)this._split(n,i),i--;this._adjustParentBBoxes(s,n,i)},_split:function(t,i){var e=t[i],s=e.children.length,n=this._minEntries;this._chooseSplitAxis(e,n,s);var r=this._chooseSplitIndex(e,n,s),o=xt(e.children.splice(r,e.children.length-r));o.height=e.height,o.leaf=e.leaf,yt(e,this.toBBox),yt(o,this.toBBox),i?t[i-1].children.push(o):this._splitRoot(e,o)},_splitRoot:function(t,i){this.data=xt([t,i]),this.data.height=t.height+1,this.data.leaf=!1,yt(this.data,this.toBBox)},_chooseSplitIndex:function(t,i,e){var s,n,r,o,a,u,h,l,c,f,p,d,y,m;for(u=h=1/0,s=i;s<=e-i;s++)c=n=mt(t,0,s,this.toBBox),f=r=mt(t,s,e,this.toBBox),p=Math.max(c.minX,f.minX),d=Math.max(c.minY,f.minY),y=Math.min(c.maxX,f.maxX),m=Math.min(c.maxY,f.maxY),o=Math.max(0,y-p)*Math.max(0,m-d),a=Ft(n)+Ft(r),o<u?(u=o,l=s,h=a<h?a:h):o===u&&a<h&&(h=a,l=s);return l},_chooseSplitAxis:function(t,i,e){var s=t.leaf?this.compareMinX:St,n=t.leaf?this.compareMinY:gt;this._allDistMargin(t,i,e,s)<this._allDistMargin(t,i,e,n)&&t.children.sort(s)},_allDistMargin:function(t,i,e,s){t.children.sort(s);var n,r,o=this.toBBox,a=mt(t,0,i,o),u=mt(t,e-i,e,o),h=Mt(a)+Mt(u);for(n=i;n<e-i;n++)r=t.children[n],wt(a,t.leaf?o(r):r),h+=Mt(a);for(n=e-i-1;n>=i;n--)r=t.children[n],wt(u,t.leaf?o(r):r),h+=Mt(u);return h},_adjustParentBBoxes:function(t,i,e){for(var s=e;s>=0;s--)wt(i[s],t)},_condense:function(t){for(var i,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(i=t[e-1].children).splice(i.indexOf(t[e]),1):this.clear():yt(t[e],this.toBBox)},_initFormat:function(t){var i=["return a"," - b",";"];this.compareMinX=new Function("a","b",i.join(t[0])),this.compareMinY=new Function("a","b",i.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};const _t=new class{constructor(t,i){this._cache=new st(t),this._invalidCache=new st(i)}get(t,i){const e=`${i.uid}:${t}`,s=this._cache.get(e);if(s)return s;if(void 0!==this._invalidCache.get(e))return null;try{const s=Z.create(t,i);return this._cache.put(e,s),s}catch{return this._invalidCache.put(e,null),null}}}(50,500),It="feature-store:unsupported-query",Tt=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function Nt(t,i){return t?_t.get(t,i):null}function Pt(t,i,e,s=!0){const n=[];for(const e of i)if("*"!==e&&!t.has(e))if(s){const i=qt(e);try{const e=Nt(i,t);if(!e)throw new a(It,"invalid SQL expression",{where:i});if(!e.isStandardized)throw new a(It,"expression is not standard",{clause:e});Pt(t,e.fieldNames,"expression contains missing fields")}catch(t){const i=t&&t.details;if(i&&(i.clause||i.where))throw t;i&&i.missingFields?n.push(...i.missingFields):n.push(e)}}else n.push(e);if(n.length)throw new a(It,e,{missingFields:n})}function qt(t){return t.split(" as ")[0]}function jt(t){return t.split(" as ")[1]}function Gt(t,i){const e=i.get(t);return!!e&&!Tt.has(e.type)}function Qt(t,i){return t?i?4:3:i?3:2}function At(t,i,e,s,n){if(!t)return!1;const r=Qt(i,e),{coords:o,lengths:a}=t;let u=!1,h=0;for(const t of a)u=Bt(u,o,r,h,t,s,n),h+=t*r;return u}function Bt(t,i,e,s,n,r,o){let a=t,u=s;for(let t=s,h=s+n*e;t<h;t+=e){u=t+e,u===h&&(u=s);const n=i[t],l=i[t+1],c=i[u],f=i[u+1];(l<o&&f>=o||f<o&&l>=o)&&n+(o-l)/(f-l)*(c-n)<r&&(a=!a)}return a}const Dt=new u({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),Ct=Object.freeze({}),Ot=new Q,Et=new Q,Ut=new Q,Vt={esriGeometryPoint:D,esriGeometryPolyline:E,esriGeometryPolygon:U,esriGeometryMultipoint:V};function Lt(t,i,e,s=t.hasZ,n=t.hasM){const r=t.hasZ&&s,o=t.hasM&&n;if(e){const a=B(Ut,i,t.hasZ,t.hasM,"esriGeometryPoint",e,s,n);return D(a,r,o)}return D(i,r,o)}function Zt(t,i,e,s,n,r,o=i,a=e){const u=i&&o,h=e&&a,l=s?"coords"in s?s:s.geometry:null;if(!l)return null;if(n){let s=C(Et,l,i,e,t,n,o,a);return r&&(s=B(Ut,s,u,h,t,r)),Vt[t](s,u,h)}if(r){const s=B(Ut,l,i,e,t,r,o,a);return Vt[t](s,u,h)}return O(Ot,l,i,e,o,a),Vt[t](Ot,u,h)}async function $t(t,i,e){const{outFields:s,orderByFields:n,groupByFieldsForStatistics:r,outStatistics:o}=t;if(s)for(let t=0;t<s.length;t++)s[t]=s[t].trim();if(n)for(let t=0;t<n.length;t++)n[t]=n[t].trim();if(r)for(let t=0;t<r.length;t++)r[t]=r[t].trim();if(o)for(let t=0;t<o.length;t++)o[t].onStatisticField&&(o[t].onStatisticField=o[t].onStatisticField.trim());return t.geometry&&!t.outSR&&(t.outSR=t.geometry.spatialReference),Xt(t,i,e)}async function Xt(t,i,e){if(!t)return null;let{where:n}=t;if(t.where=n=n&&n.trim(),(!n||/^1 *= *1$/.test(n)||i&&i===n)&&(t.where=null),!t.geometry)return t;let r=await async function(t){const{geometry:i,distance:e,units:n}=t;if(null==e||"vertexAttributes"in i)return i;const r=i.spatialReference,o=n?Dt.fromJSON(n):h(r),a=r&&(l(r)||s(r))?i:await ut(r,c).then((()=>ct(i,c)));return(await ti().then((t=>t.geodesicBuffer)))(a.spatialReference,a,e,o)}(t);if(t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel){const{spatialReference:i}=t.geometry;r=f(r),r.spatialReference=i}t.geometry=r,await ut(r.spatialReference,e);const o=(await $(p(r)))[0];if(d(o))throw Ct;const a=o.toJSON(),u=await ct(a,a.spatialReference,e);if(!u)throw Ct;return u.spatialReference=e,t.geometry=u,t}function kt(t){return t&&Jt in t?JSON.parse(JSON.stringify(t,Wt)):t}const Jt="_geVersion",Wt=(t,i)=>t!==Jt?i:void 0,Yt={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},zt={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},Kt={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},Ht={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function ti(){return import("./p-6337d6d6.js")}function ii(t,i,e,s,n){if(y(i)&&"esriGeometryPoint"===e&&("esriSpatialRelIntersects"===t||"esriSpatialRelContains"===t)){const t=A(new Q,i,!1,!1);return m((i=>function(t,i,e,s){return At(t,!1,!1,s.coords[0],s.coords[1])}(t,0,0,i)))}if(y(i)&&"esriGeometryMultipoint"===e){const e=A(new Q,i,!1,!1);if("esriSpatialRelContains"===t)return m((t=>function(t,i,e,s,n,r){const o=Qt(n,r),{coords:a,lengths:u}=s;if(!u)return!1;for(let i=0,e=0;i<u.length;i++,e+=o)if(!At(t,false,false,a[e],a[e+1]))return!1;return!0}(e,0,0,t,s,n)))}if(w(i)&&"esriGeometryPoint"===e&&("esriSpatialRelIntersects"===t||"esriSpatialRelContains"===t))return m((t=>S(i,Zt(e,s,n,t))));if(w(i)&&"esriGeometryMultipoint"===e&&"esriSpatialRelContains"===t)return m((t=>g(i,Zt(e,s,n,t))));if(w(i)&&"esriSpatialRelIntersects"===t){const t=M(e);return m((r=>t(i,Zt(e,s,n,r))))}return ti().then((r=>{const o=r[Yt[t]].bind(null,i.spatialReference,i);return t=>o(Zt(e,s,n,t))}))}async function ei(i,e,s){const{spatialRel:n,geometry:r}=i;if(r){if(!0!==zt[n])throw new a("feature-store:unsupported-query","Unsupported query spatial relationship",{query:i});if(t(r.spatialReference)&&t(s)){if(!function(t){return!0===Kt[F(t)]}(r))throw new a("feature-store:unsupported-query","Unsupported query geometry type",{query:i});if(!function(t){return!0===Ht[t]}(e))throw new a("feature-store:unsupported-query","Unsupported layer geometry type",{query:i});if(i.outSR)return ut(i.geometry&&i.geometry.spatialReference,i.outSR)}}}function si(t){if(w(t))return!0;if(y(t)){for(const i of t.rings){if(5!==i.length)return!1;if(i[0][0]!==i[1][0]||i[0][0]!==i[4][0]||i[2][0]!==i[3][0]||i[0][1]!==i[3][1]||i[0][1]!==i[4][1]||i[1][1]!==i[2][1])return!1}return!0}return!1}function ni(t,i,e){if(!i||!t)return null;const{startTimeField:s,endTimeField:n}=t;if(!s&&!n)return null;const{start:r,end:o}=i;return null===r&&null===o?null:void 0===r&&void 0===o?()=>!1:s&&n?function(t,i,e,s,n){return null!=s&&null!=n?r=>{const o=t.getAttribute(r,i),a=t.getAttribute(r,e);return(null==o||o<=n)&&(null==a||a>=s)}:null!=s?i=>{const n=t.getAttribute(i,e);return null==n||n>=s}:null!=n?e=>{const s=t.getAttribute(e,i);return null==s||s<=n}:void 0}(e,s,n,r,o):function(t,i,e,s){return null!=e&&null!=s&&e===s?s=>t.getAttribute(s,i)===e:null!=e&&null!=s?n=>{const r=t.getAttribute(n,i);return r>=e&&r<=s}:null!=e?s=>t.getAttribute(s,i)>=e:null!=s?e=>t.getAttribute(e,i)<=s:void 0}(e,s||n,r,o)}class ri{constructor(t,i,e){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues,this.fieldsIndex=e,this.featureAdapter=i;const s=t.outFields;if(s&&-1===s.indexOf("*")){this.outFields=s;let t=0;for(const i of s){const s=qt(i),n=this.fieldsIndex.get(s),r=n?null:Nt(s,e),o=n?n.name:jt(i)||"FIELD_EXP_"+t++;this._fieldDataCache.set(i,{alias:o,clause:r})}}}countDistinctValues(t){return this.returnDistinctValues?(t.forEach((t=>this.getAttributes(t))),this._returnDistinctMap.size):t.length}getAttributes(t){const i=this._processAttributesForOutFields(t);return this._processAttributesForDistinctValues(i)}getFieldValue(t,i,e){const s=e?e.name:i;let n=null;return this._fieldDataCache.has(s)?n=this._fieldDataCache.get(s).clause:e||(n=Nt(i,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:n})),e?this.featureAdapter.getAttribute(t,s):n.calculateValue(t,this.featureAdapter)}validateItem(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:Nt(i,this.fieldsIndex)}),this._fieldDataCache.get(i).clause.testFeature(t,this.featureAdapter)}validateItems(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:Nt(i,this.fieldsIndex)}),this._fieldDataCache.get(i).clause.testSet(t,this.featureAdapter)}_processAttributesForOutFields(t){const i=this.outFields;if(!i||!i.length)return this.featureAdapter.getAttributes(t);const e={};for(const s of i){const{alias:i,clause:n}=this._fieldDataCache.get(s);e[i]=n?n.calculateValue(t,this.featureAdapter):this.featureAdapter.getAttribute(t,i)}return e}_processAttributesForDistinctValues(t){if(d(t)||!this.returnDistinctValues)return t;const i=this.outFields,e=[];if(i)for(const s of i){const{alias:i}=this._fieldDataCache.get(s);e.push(t[i])}else for(const i in t)e.push(t[i]);const s=`${(i||["*"]).join(",")}=${e.join(",")}`;let n=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++n),n>1?null:t}}function oi(t){return t.substr(24,12)+t.substr(19,4)+t.substr(16,2)+t.substr(14,2)+t.substr(11,2)+t.substr(9,2)+t.substr(6,2)+t.substr(4,2)+t.substr(2,2)+t.substr(0,2)}function ai(t,i,e){return(e?t>i:t<i)?-1:(e?t<i:t>i)?1:0}function ui(t,i,e){return e?i-t:t-i}function hi(t,i,e,s){if(e&&"esriFieldTypeDate"===e.type){const e=new Date(t).getTime(),n=new Date(i).getTime();if(!isNaN(e)&&!isNaN(n))return ui(e,n,s)}if("number"==typeof t&&"number"==typeof i)return ui(t,i,s);if("string"==typeof t&&"string"==typeof i){const n=t.toUpperCase(),r=i.toUpperCase();return!e||"esriFieldTypeGUID"!==e.type&&"esriFieldTypeGlobalID"!==e.type?ai(n,r,s):ai(oi(n),oi(r),s)}return s?1:-1}class li{constructor(t,i,e){this.items=t,this.queryGeometry=i,this.definitionExpression=e.definitionExpression,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.fieldsIndex=e.fieldsIndex,this.timeInfo=e.timeInfo,this.featureAdapter=e.featureAdapter,this.aggregateAdapter=e.aggregateAdapter}get size(){return this.items.length}createQueryResponseForCount(t){const i=new ri(t,this.featureAdapter,this.fieldsIndex);if(!t.outStatistics)return i.countDistinctValues(this.items);const{groupByFieldsForStatistics:e,having:s}=t;if(!(null==e?void 0:e.length))return 1;const n=new Map,r=new Map,o=new Set,a=t.outStatistics;for(const t of a){const{statisticType:a}=t,u="exceedslimit"!==a?t.onStatisticField:void 0;if(!r.has(u)){const t=[];for(const s of e){const e=this._getAttributeValues(i,s,n);t.push(e)}r.set(u,this._calculateUniqueValues(t))}const h=r.get(u);for(const t in h){const{data:e,items:n}=h[t],r=e.join(",");s&&!i.validateItems(n,s)||o.add(r)}}return o.size}createQueryResponse(e){let s;return s=e.outStatistics?e.outStatistics.some((t=>"exceedslimit"===t.statisticType))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e),e.returnQueryGeometry&&(s.queryGeometry=t(e.outSR)&&!i(this.queryGeometry.spatialReference,e.outSR)?kt({spatialReference:e.outSR,...ct(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):kt({spatialReference:e.outSR,...this.queryGeometry})),s}executeAttributesQuery(t){const i=Nt(t.where,this.fieldsIndex);if(!i)return m(this);if(i.isStandardized){let e=0;const s=[];for(const t of this.items)i.testFeature(t,this.featureAdapter)&&(s[e++]=t);const n=new li(s,this.queryGeometry,this);return n.definitionExpression=t.where,m(n)}return v(new TypeError("Where clause is not standardized"))}executeAggregateIdsQuery(t){if(!t.aggregateIds||!t.aggregateIds.length||d(this.aggregateAdapter))return m(this);const i=new Set;for(const e of t.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(e).forEach((t=>i.add(t)));const e=this.featureAdapter.getObjectId;return m(new li(this.items.filter((t=>i.has(e(t)))),this.queryGeometry,this))}executeObjectIdsQuery(t){if(!t.objectIds||!t.objectIds.length)return m(this);const i=new Set(t.objectIds),e=this.featureAdapter.getObjectId;return m(new li(this.items.filter((t=>i.has(e(t)))),this.queryGeometry,this))}executeTimeQuery(t){const i=ni(this.timeInfo,t.timeExtent,this.featureAdapter);if(!R(i))return m(this);const e=this.items.filter(i);return m(new li(e,this.queryGeometry,this))}filterLatest(){const{trackIdField:t,startTimeField:i,endTimeField:e}=this.timeInfo,s=e||i,n=new Map,r=this.featureAdapter.getAttribute;for(const i of this.items){const e=r(i,t),o=r(i,s),a=n.get(e);(!a||o>r(a,s))&&n.set(e,i)}const o=Array.from(n.values());return m(new li(o,this.queryGeometry,this))}async project(t){if(!t||i(this.spatialReference,t))return this;const e=this.featureAdapter,s=(await async function(t,i,e){return ft.push(t,i,e)}(this.items.map((t=>Zt(this.geometryType,this.hasZ,this.hasM,e.getGeometry(t)))),this.spatialReference,t)).map(((t,i)=>e.cloneWithGeometry(this.items[i],L(t,this.hasZ,this.hasM))));return new li(s,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:t,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}_sortFeatures(t,i,e){if(t.length>1&&i&&i.length)for(const s of i.reverse()){const i=s.split(" "),n=i[0],r=this.fieldsIndex.get(n),o=i[1]&&"desc"===i[1].toLowerCase();t.sort(((t,i)=>hi(e(t,n,r),e(i,n,r),r,o)))}}_createFeatureQueryResponse(t){const i=this.items,{geometryType:e,hasM:s,hasZ:n,objectIdField:r,spatialReference:o}=this,{outFields:a,outSR:u,quantizationParameters:h,resultRecordCount:l,resultOffset:c,returnZ:f,returnM:p}=t,d=null!=l&&i.length>(c||0)+l,y=a&&(a.indexOf("*")>-1?[...this.fieldsIndex.fields]:a.map((t=>this.fieldsIndex.get(t))));return{exceededTransferLimit:d,features:this._createFeatures(t,i),fields:y,geometryType:e,hasM:s&&p,hasZ:n&&f,objectIdFieldName:r,spatialReference:kt(u||o),transform:h&&x(h)||null}}_createFeatures(t,i){const e=new ri(t,this.featureAdapter,this.fieldsIndex),{hasM:s,hasZ:n}=this,{orderByFields:r,quantizationParameters:o,returnGeometry:a,returnCentroid:u,maxAllowableOffset:h,resultOffset:l,resultRecordCount:c,returnZ:f=!1,returnM:p=!1}=t,d=n&&f,y=s&&p;let m=[],w=0;const S=[...i];if(this._sortFeatures(S,r,((t,i,s)=>e.getFieldValue(t,i,s))),a||u){const t=x(o);if(a&&!u)for(const i of S)m[w++]={attributes:e.getAttributes(i),geometry:Zt(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(i),h,t,d,y)};else if(!a&&u)for(const i of S)m[w++]={attributes:e.getAttributes(i),centroid:Lt(this,this.featureAdapter.getCentroid(i,this),t)};else for(const i of S)m[w++]={attributes:e.getAttributes(i),centroid:Lt(this,this.featureAdapter.getCentroid(i,this),t),geometry:Zt(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(i),h,t,d,y)}}else for(const t of S){const i=e.getAttributes(t);i&&(m[w++]={attributes:i})}const g=l||0;return null!=c&&(m=m.slice(g,Math.min(m.length,g+c))),m}_createExceedsLimitQueryResponse(t){let i=!1,e=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY;for(const i of t.outStatistics)if("exceedslimit"===i.statisticType){e=null!=i.maxPointCount?i.maxPointCount:Number.POSITIVE_INFINITY,s=null!=i.maxRecordCount?i.maxRecordCount:Number.POSITIVE_INFINITY,n=null!=i.maxVertexCount?i.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)i=this.items.length>e;else if(this.items.length>s)i=!0;else{const t=this.hasZ?this.hasM?4:3:this.hasM?3:2,e=this.featureAdapter;i=this.items.reduce(((t,i)=>{const s=e.getGeometry(i);return t+(s&&s.coords.length||0)}),0)/t>n}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(i)}}]}}_createStatisticsQueryResponse(t){const i={attributes:{}},e=[],s=new Map,n=new Map,r=new Map,o=new Map,a=new ri(t,this.featureAdapter,this.fieldsIndex),u=t.outStatistics,{groupByFieldsForStatistics:h,having:l,orderByFields:c}=t,f=h&&h.length,p=!!f,d=p&&h[0],y=p&&!this.fieldsIndex.get(d);for(const t of u){const{outStatisticFieldName:u,statisticType:c}=t,m=t,w="exceedslimit"!==c?t.onStatisticField:void 0,S="percentile_disc"===c||"percentile_cont"===c,g=p&&1===f&&(w===d||y)&&"count"===c;if(p){if(!r.has(w)){const t=[];for(const i of h){const e=this._getAttributeValues(a,i,s);t.push(e)}r.set(w,this._calculateUniqueValues(t))}const t=r.get(w);for(const i in t){const{count:e,data:n,items:r,itemPositions:c}=t[i],f=n.join(",");if(!l||a.validateItems(r,l)){const t=o.get(f)||{attributes:{}};let i=null;if(g)i=e;else{const t=this._getAttributeValues(a,w,s),e=c.map((i=>t[i]));i=S&&"statisticParameters"in m?this._getPercentileValue(m,e):this._getStatisticValue(m,e)}t.attributes[u]=i,h.forEach(((i,e)=>t.attributes[this.fieldsIndex.get(i)?i:`EXPR_${e+1}`]=n[e])),o.set(f,t)}}}else{const t=this._getAttributeValues(a,w,s);i.attributes[u]=S&&"statisticParameters"in m?this._getPercentileValue(m,t):this._getStatisticValue(m,t,n)}e.push({name:u,alias:u,type:"esriFieldTypeDouble"})}const m=p?Array.from(o.values()):[i];return this._sortFeatures(m,c,((t,i)=>t.attributes[i])),{fields:e,features:m}}_getStatisticValue(t,i,e){const{onStatisticField:s,statisticType:n}=t,r=e&&e.has(s)?e.get(s):this._calculateStatistics(i);return e&&e.set(s,r),r["var"===n?"variance":n]}_getPercentileValue(t,i){const{onStatisticField:e,statisticParameters:s,statisticType:n}=t,{value:r,orderBy:o}=s,a="desc"===o,u=this.fieldsIndex.get(e),h=[...i].filter((t=>null!=t)).sort(((t,i)=>hi(t,i,u,a)));return this._calculatePercentile(h,r,"percentile_disc"===n)}_getAttributeValues(t,i,e){if(e.has(i))return e.get(i);const s=this.fieldsIndex.get(i),n=this.items.map((e=>t.getFieldValue(e,i,s)));return e.set(i,n),n}_calculateStatistics(t){let i=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,s=null,n=null,r=null,o=null;const a=[];let u=0;for(const n of t)"string"==typeof n?u++:null==n||isNaN(n)||(s+=n,i=Math.min(i,n),e=Math.max(e,n),a.push(n),u++);if(u){n=s/u;let t=0;for(const i of a)t+=Math.pow(i-n,2);o=u>1?t/(u-1):0,r=Math.sqrt(o)}else i=null,e=null;return{avg:n,count:u,max:e,min:i,stddev:r,sum:s,variance:o}}_calculateUniqueValues(t){const i={},e=this.items,s=e.length;for(let n=0;n<s;n++){const s=e[n],r=[];for(const i of t)r.push(i[n]);const o=r.join(",");null==i[o]?i[o]={count:1,data:r,items:[s],itemPositions:[n]}:(i[o].count++,i[o].items.push(s),i[o].itemPositions.push(n))}return i}_calculatePercentile(t,i,e){if(0===t.length)return null;if(i<=0)return t[0];if(i>=1)return t[t.length-1];const s=(t.length-1)*i,n=Math.floor(s),r=n+1,o=s%1,a=t[n],u=t[r];return r>=t.length||e||"string"==typeof a||"string"==typeof u?a:a*(1-o)+u*o}}const ci=new Set,fi=new j(2e6);let pi=0;const di=H(),yi=H();class mi{constructor(t){this.capabilities={query:et},this.geometryType=t.geometryType,this.hasM=t.hasM,this.hasZ=t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.definitionExpression=t.definitionExpression,this.featureStore=t.featureStore,this.aggregateAdapter=t.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=t.timeInfo,t.cacheSpatialQueries&&(this._geometryQueryCache=new b(pi+++"$$",fi)),this.fieldsIndex=new k(t.fields),t.scheduler&&t.task&&(this._frameQueue=new X,this._frameTask=t.scheduler.registerTask(t.task,(t=>this._update(t)),(()=>this._frameQueue.length>0)))}destroy(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()}get featureAdapter(){return this.featureStore.featureAdapter}get fullExtent(){const t=this.featureStore.fullBounds;return t?{xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:kt(this.spatialReference)}:null}get timeExtent(){return this.timeInfo?(this._timeExtent||(this._timeExtent=function(t,i){if(!t)return null;const e=i.featureAdapter,{startTimeField:s,endTimeField:n}=t;let r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(s&&n)i.forEach((t=>{const i=e.getAttribute(t,s),a=e.getAttribute(t,n);null==i||isNaN(i)||(r=Math.min(r,i)),null==a||isNaN(a)||(o=Math.max(o,a))}));else{const t=s||n;i.forEach((i=>{const s=e.getAttribute(i,t);null==s||isNaN(s)||(r=Math.min(r,s),o=Math.max(o,s))}))}return{start:r,end:o}}(this.timeInfo,this.featureStore)),this._timeExtent):null}clearCache(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null}async executeQuery(t={},i){let e,s=_(t);try{s=await this._schedule((()=>$t(s,this.definitionExpression,this.spatialReference)),i),s=await this._reschedule((()=>this._checkQuerySupport(s)),i),e=await this._reschedule((()=>this._executeGeometryQuery(s,i)),i),e=await this._reschedule((()=>e.executeAggregateIdsQuery(s)),i),e=await this._reschedule((()=>e.executeObjectIdsQuery(s)),i),e=await this._reschedule((()=>e.executeTimeQuery(s)),i),e=await this._reschedule((()=>e.executeAttributesQuery(s)),i)}catch(t){if(t!==Ct)throw t;e=new li([],null,this)}return e.createQueryResponse(s)}async executeQueryForCount(t={},i){let e,s=_(t);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=await this._schedule((()=>$t(s,this.definitionExpression,this.spatialReference)),i),s=await this._reschedule((()=>this._checkQuerySupport(s)),i),e=await this._reschedule((()=>this._executeGeometryQuery(s,i)),i),e=await this._reschedule((()=>e.executeAggregateIdsQuery(s)),i),e=await this._reschedule((()=>e.executeObjectIdsQuery(s)),i),e=await this._reschedule((()=>e.executeTimeQuery(s)),i),e=await this._reschedule((()=>e.executeAttributesQuery(s)),i)}catch(t){if(t!==Ct)throw t;return 0}return e.createQueryResponseForCount(s)}async executeQueryForExtent(t={},i){let e,s=_(t);const n=s.outSR;try{s=await this._schedule((()=>$t(s,this.definitionExpression,this.spatialReference)),i),s=await this._reschedule((()=>this._checkQuerySupport(s)),i),s.returnGeometry=!0,s.returnCentroid=!1,s.outSR=null,e=await this._reschedule((()=>this._executeGeometryQuery(s,i)),i),e=await this._reschedule((()=>e.executeAggregateIdsQuery(s)),i),e=await this._reschedule((()=>e.executeObjectIdsQuery(s)),i),e=await this._reschedule((()=>e.executeTimeQuery(s)),i),e=await this._reschedule((()=>e.executeAttributesQuery(s)),i);const t=e.size;if(!t)return{count:t,extent:null};z(yi,tt),this.featureStore.forEachBounds(e.items,(t=>K(yi,t)),di);const r={xmin:yi[0],ymin:yi[1],xmax:yi[3],ymax:yi[4],spatialReference:kt(this.spatialReference)};this.hasZ&&isFinite(yi[2])&&isFinite(yi[5])&&(r.zmin=yi[2],r.zmax=yi[5]);const o=ct(r,e.spatialReference,n);if(o.spatialReference=kt(n||this.spatialReference),o.xmax-o.xmin==0){const t=I(o.spatialReference);o.xmin-=t,o.xmax+=t}if(o.ymax-o.ymin==0){const t=I(o.spatialReference);o.ymin-=t,o.ymax+=t}if(this.hasZ&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin==0){const t=I(o.spatialReference);o.zmin-=t,o.zmax+=t}return{count:t,extent:o}}catch(t){if(t===Ct)return{count:0,extent:null};throw t}}async executeQueryForIds(t={},i){return this.executeQueryForIdSet(t,i).then((t=>Array.from(t)))}async executeQueryForIdSet(t={},i){let e,s=_(t);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=await this._schedule((()=>$t(s,this.definitionExpression,this.spatialReference)),i),s=await this._reschedule((()=>this._checkQuerySupport(s)),i),e=await this._reschedule((()=>this._executeGeometryQuery(s,i)),i),e=await this._reschedule((()=>e.executeAggregateIdsQuery(s)),i),e=await this._reschedule((()=>e.executeObjectIdsQuery(s)),i),e=await this._reschedule((()=>e.executeTimeQuery(s)),i),e=await this._reschedule((()=>e.executeAttributesQuery(s)),i);const t=e.items,n=new Set;return await this._reschedule((()=>{for(const i of t)n.add(e.featureAdapter.getObjectId(i))}),i),n}catch(t){if(t===Ct)return new Set;throw t}}async executeQueryForLatestObservations(t={},i){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new a("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:t,timeInfo:this.timeInfo});let e,s=_(t);try{s=await this._schedule((()=>$t(s,this.definitionExpression,this.spatialReference)),i),s=await this._reschedule((()=>this._checkQuerySupport(s)),i),e=await this._reschedule((()=>this._executeGeometryQuery(s,i)),i),e=await this._reschedule((()=>e.executeAggregateIdsQuery(s)),i),e=await this._reschedule((()=>e.executeObjectIdsQuery(s)),i),e=await this._reschedule((()=>e.executeTimeQuery(s)),i),e=await this._reschedule((()=>e.executeAttributesQuery(s)),i),e=await this._reschedule((()=>e.filterLatest()),i)}catch(t){if(t!==Ct)throw t;e=new li([],null,this)}return e.createQueryResponse(s)}async _schedule(t,i){return this._frameQueue?this._frameQueue.push(t,i):t()}async _reschedule(t,i){return this._frameQueue?this._frameQueue.unshift(t,i):t()}_update(t){for(this._budget=t;!t.done&&this._frameQueue&&this._frameQueue.process();)t.madeProgress();this._budget=null}_getAll(){if(!this._allItems){const t=[];this.featureStore.forEach((i=>t.push(i))),this._allItems=new li(t,null,this)}return this._allItems}async _executeGeometryQuery(e,s){const{geometry:n,outSR:r,spatialRel:o}=e,a=t(r)&&!i(this.spatialReference,r),u=this._geometryQueryCache?a?JSON.stringify({geometry:n,spatialRelationship:o,outSpatialReference:r}):JSON.stringify({geometry:n,spatialRelationship:o}):null;if(u){const t=this._geometryQueryCache.get(u);if(!T(t))return t}const h=async t=>{if(a&&(e.returnGeometry||e.returnCentroid)){const i=await t.project(r);return u&&this._geometryQueryCache.put(u,i,i.size||1),i}return u&&this._geometryQueryCache.put(u,t,t.size||1),t};if(!n)return h(this._getAll());const l=this.featureAdapter;if("esriSpatialRelDisjoint"===o){const t=this._searchFeatures(this._getQueryBBoxes(n));if(!t.length)return h(this._getAll());let i,e;const r=new Set;for(const i of t)r.add(l.getObjectId(i));return await this._reschedule((()=>{let t=0;i=new Array(r.size),this.featureStore.forEach((e=>i[t++]=e)),e=r}),s),h(await this._reschedule((async()=>{const t=await ii(o,n,this.geometryType,this.hasZ,this.hasM);return new li(await this._runSpatialFilter(i,(i=>!e.has(l.getObjectId(i))||t(l.getGeometry(i))),s),n,this)}),s))}const c=this._searchFeatures(this._getQueryBBoxes(n));if(!c.length){const t=new li([],n,this);return u&&this._geometryQueryCache.put(u,t,t.size||1),t}if(this._canExecuteSoloPass(n,e))return h(new li(c,n,this));const f=await ii(o,n,this.geometryType,this.hasZ,this.hasM),p=await this._runSpatialFilter(c,(t=>f(l.getGeometry(t))),s);return h(new li(p,n,this))}async _runSpatialFilter(t,i,e){if(!i)return t;if(!this._budget)return t.filter((t=>i(t)));let s=0;const n=new Array,r=async()=>{for(;s<t.length;){const o=t[s];i(o)&&n.push(o),this._budget.done&&await this._reschedule((()=>r()),e),++s}};return this._reschedule((()=>r()),e).then((()=>n))}_canExecuteSoloPass(t,i){const{geometryType:e}=this,{spatialRel:s}=i;return si(t)&&("esriSpatialRelEnvelopeIntersects"===s||"esriGeometryPoint"===e&&("esriSpatialRelIntersects"===s||"esriSpatialRelContains"===s||"esriSpatialRelWithin"===s))}_getQueryBBoxes(t){if(si(t)){if(w(t))return[N(t.xmin,t.ymin,t.xmax,t.ymax)];if(y(t))return t.rings.map((t=>N(Math.min(t[0][0],t[2][0]),Math.min(t[0][1],t[2][1]),Math.max(t[0][0],t[2][0]),Math.max(t[0][1],t[2][1]))))}return[P(G(),t)]}_searchFeatures(t){for(const i of t)this.featureStore.forEachInBounds(i,(t=>{ci.add(t)}));const i=new Array(ci.size);let e=0;return ci.forEach((t=>i[e++]=t)),ci.clear(),i}async _checkQuerySupport(t){if(t.distance<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text)throw new a("feature-store:unsupported-query","Unsupported query options",{query:t});return q([this._checkAttributesQuerySupport(t),this._checkStatisticsQuerySupport(t),ei(t,this.geometryType,this.spatialReference),ut(this.spatialReference,t.outSR)]).then((()=>t))}_checkAttributesQuerySupport(t){const{outFields:i,orderByFields:e,returnDistinctValues:s,outStatistics:n}=t,r=n?n.map((t=>t.outStatisticFieldName&&t.outStatisticFieldName.toLowerCase())):[];if(e&&e.length>0){const t=" asc",i=" desc",s=e.map((e=>{const s=e.toLowerCase();return s.indexOf(t)>-1?s.split(t)[0]:s.indexOf(i)>-1?s.split(i)[0]:e})).filter((t=>-1===r.indexOf(t)));Pt(this.fieldsIndex,s,"orderByFields contains missing fields")}if(i&&i.length>0)Pt(this.fieldsIndex,i,"outFields contains missing fields");else if(s)throw new a("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:t});!function(t,i){if(!i)return!0;const e=_t.get(i,t);if(!e)throw new a(It,"invalid SQL expression",{where:i});if(!e.isStandardized)throw new a(It,"where clause is not standard",{where:i});Pt(t,e.fieldNames,"where clause contains missing fields")}(this.fieldsIndex,t.where)}async _checkStatisticsQuerySupport(t){const{outStatistics:i,groupByFieldsForStatistics:e,having:s}=t,n=e&&e.length,r=i&&i.length;if(s){if(!n||!r)throw new a("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:t});!function(t,i,e){if(!i)return!0;const s=_t.get(i,t);if(!s)throw new a(It,"invalid SQL expression",{having:i});if(!s.isAggregate)throw new a(It,"having does not contain a valid aggregate function",{having:i});if(Pt(t,s.fieldNames,"having contains missing fields"),!s.getExpressions().every((i=>{const{aggregateType:s,field:n}=i,r=t.has(n)&&t.get(n).name;return e.some((i=>{const{onStatisticField:e,statisticType:n}=i;return(t.has(e)&&t.get(e).name)===r&&n.toLowerCase().trim()===s}))})))throw new a(It,"expressions in having should also exist in outStatistics",{having:i})}(this.fieldsIndex,s,i)}if(r){if(!function(t){return t.every((t=>"exceedslimit"!==t.statisticType))}(i))return;const s=i.map((t=>t.onStatisticField));Pt(this.fieldsIndex,s,"onStatisticFields contains missing fields"),n&&Pt(this.fieldsIndex,e,"groupByFieldsForStatistics contains missing fields");for(const e of i){const{onStatisticField:i,statisticType:s}=e;if("percentile_disc"!==s&&"percentile_cont"!==s||!("statisticParameters"in e)){if("count"!==s&&i&&Gt(i,this.fieldsIndex))throw new a("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:e,query:t})}else{const{statisticParameters:i}=e;if(!i)throw new a("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:e,query:t})}}}}}export{Xt as W,ii as Y,mi as b,ut as f,ct as g,pt as i,ni as n}