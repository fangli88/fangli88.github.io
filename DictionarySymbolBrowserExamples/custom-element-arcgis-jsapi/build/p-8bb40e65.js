import{bg as e,bS as r,l as a,m as t,b as s}from"./p-ab028778.js";import{e as n,t as c,a as o}from"./p-ebb65ba7.js";import{r as i}from"./p-50ee3927.js";const l=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class u{constructor(e){this.options=e,this.geometryTypes=l}createFeatureResult(){return new n}prepareFeatures(){}finishFeatureResult(a){if(!a||!a.features||!a.hasZ||!this.options.sourceSpatialReference||!a.spatialReference||e(a.spatialReference,this.options.sourceSpatialReference)||a.spatialReference.vcsWkid)return;const t=r(this.options.sourceSpatialReference)/r(a.spatialReference);if(1!==t)for(const e of a.features){if(!e.geometry||!e.geometry.coords)continue;const r=e.geometry.coords;for(let e=2;e<r.length;e+=3)r[e]*=t}}addFeature(e,r){e.features.push(r)}createFeature(){return new c}createSpatialReference(){return{wkid:0}}createGeometry(){return new o}addField(e,r){e.fields.push(r)}addCoordinate(e,r){e.coords.push(r)}addCoordinatePoint(e,r){e.coords.push(r)}addLength(e,r){e.lengths.push(r)}addQueryGeometry(e,r){e.queryGeometry=r.queryGeometry,e.queryGeometryType=r.queryGeometryType}createPointGeometry(){return new o}}const f=a.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),b=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],y=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],p=["upperLeft","lowerLeft"];function k(e){return e>=b.length?null:b[e]}function d(e){return e>=p.length?null:p[e]}function T(e,r){return r>=e.geometryTypes.length?null:e.geometryTypes[r]}function h(e,r,a){const t=r.createPointGeometry(a);for(;e.next();)switch(e.tag()){case 3:{const a=e.getUInt32(),s=e.pos()+a;let n=0;for(;e.pos()<s;)r.addCoordinatePoint(t,e.getSInt64(),n++);break}case 1:case 2:default:e.skip()}return t}function q(e,r,a){const t=r.createGeometry(a),s=2+(a.hasZ?1:0)+(a.hasM?1:0);for(;e.next();)switch(e.tag()){case 2:{const a=e.getUInt32(),s=e.pos()+a;let n=0;for(;e.pos()<s;)r.addLength(t,e.getUInt32(),n++);break}case 3:{const a=e.getUInt32(),n=e.pos()+a;let c=0;for(;e.pos()<n;)r.addCoordinate(t,e.getSInt64(),c),c++,c===s&&(c=0);break}case 1:default:e.skip()}return t}function w(e){const r=new o;let a="esriGeometryPoint";for(;e.next();)switch(e.tag()){case 2:{const a=e.getUInt32(),t=e.pos()+a;for(;e.pos()<t;)r.lengths.push(e.getUInt32());break}case 3:{const a=e.getUInt32(),t=e.pos()+a;for(;e.pos()<t;)r.coords.push(e.getSInt64());break}case 1:a=l[e.getEnum()];break;default:e.skip()}return{queryGeometry:r,queryGeometryType:a}}function m(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function F(e){const r={type:k(0)};for(;e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:r.type=k(e.getEnum());break;case 3:r.alias=e.getString();break;case 4:r.sqlType=(a=e.getEnum())>=y.length?null:y[a];break;case 5:try{r.domain=JSON.parse(e.getString())}catch(e){f.error(new t("query:parsing-pbf","Failed to parse domain",{error:e})),r.domain=null}break;case 6:r.defaultValue=e.getString();break;default:e.skip()}var a;return r}function g(e){const r={};for(;e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:r.isSystemMaintained=e.getBool();break;default:e.skip()}return r}function G(e,r,a,t){const s=r.createFeature(a);let n=0;for(;e.next();)switch(e.tag()){case 1:{const r=t[n++].name;s.attributes[r]=e.processMessage(m);break}case 2:s.geometry=e.processMessageWithArgs(q,r,a);break;case 4:s.centroid=e.processMessageWithArgs(h,r,a);break;default:e.skip()}return s}function D(e){const r=[1,1,1,1];for(;e.next();)switch(e.tag()){case 1:r[0]=e.getDouble();break;case 2:r[1]=e.getDouble();break;case 4:r[2]=e.getDouble();break;case 3:r[3]=e.getDouble();break;default:e.skip()}return r}function I(e){const r=[0,0,0,0];for(;e.next();)switch(e.tag()){case 1:r[0]=e.getDouble();break;case 2:r[1]=e.getDouble();break;case 4:r[2]=e.getDouble();break;case 3:r[3]=e.getDouble();break;default:e.skip()}return r}function S(e){const r={originPosition:d(0)};for(;e.next();)switch(e.tag()){case 1:r.originPosition=d(e.getEnum());break;case 2:r.scale=e.processMessage(D);break;case 3:r.translate=e.processMessage(I);break;default:e.skip()}return r}function P(e){const r={};for(;e.next();)switch(e.tag()){case 1:r.shapeAreaFieldName=e.getString();break;case 2:r.shapeLengthFieldName=e.getString();break;case 3:r.units=e.getString();break;default:e.skip()}return r}function L(e,r){const a=r.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:a.wkid=e.getUInt32();break;case 5:a.wkt=e.getString();break;case 2:a.latestWkid=e.getUInt32();break;case 3:a.vcsWkid=e.getUInt32();break;case 4:a.latestVcsWkid=e.getUInt32();break;default:e.skip()}return a}function V(e,r){const a=r.createFeatureResult();a.geometryType=T(r,0);let t=!1;for(;e.next();)switch(e.tag()){case 1:a.objectIdFieldName=e.getString();break;case 3:a.globalIdFieldName=e.getString();break;case 4:a.geohashFieldName=e.getString();break;case 5:a.geometryProperties=e.processMessage(P);break;case 7:a.geometryType=T(r,e.getEnum());break;case 8:a.spatialReference=e.processMessageWithArgs(L,r);break;case 10:a.hasZ=e.getBool();break;case 11:a.hasM=e.getBool();break;case 12:a.transform=e.processMessage(S);break;case 9:{const r=e.getBool();a.exceededTransferLimit=r;break}case 13:r.addField(a,e.processMessage(F));break;case 15:t||(r.prepareFeatures(a),t=!0),r.addFeature(a,e.processMessageWithArgs(G,r,a,a.fields));break;case 2:a.uniqueIdField=e.processMessage(g);break;case 6:default:e.skip()}return r.finishFeatureResult(a),a}function B(e,r){const a={};let t=null;for(;e.next();)switch(e.tag()){case 4:t=e.processMessageWithArgs(w);break;case 1:a.featureResult=e.processMessageWithArgs(V,r);break;case 2:case 3:default:e.skip()}return s(t)&&a.featureResult&&r.addQueryGeometry(a,t),a}function R(e,r){try{const a=2,t=new i(new Uint8Array(e),new DataView(e)),s={};for(;t.next();)switch(t.tag()){case a:s.queryResult=t.processMessageWithArgs(B,r);break;default:t.skip()}return s}catch(e){throw new t("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e})}}function C(e,r){const a=R(e,r),t=a.queryResult.featureResult,s=a.queryResult.queryGeometry,n=a.queryResult.queryGeometryType;if(t&&t.features&&t.features.length&&t.objectIdFieldName){const e=t.objectIdFieldName;for(const r of t.features)r.attributes&&(r.objectId=r.attributes[e])}return t&&(t.queryGeometry=s,t.queryGeometryType=n),t}export{S as F,u as a,k as g,C as t}