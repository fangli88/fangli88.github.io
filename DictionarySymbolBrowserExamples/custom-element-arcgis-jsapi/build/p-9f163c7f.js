import"./p-476cf7c4.js";import{ad as t,N as e,ae as s,af as i,i as r,M as n,ag as a,ah as o,ai as l,aj as c,ak as h,q as u,r as f,al as m,am as y,an as M,ac as d}from"./p-dc4230e0.js";import"./p-7fc65112.js";import{h as p,y as g,r as w,a as C,f as I,N as P,j as b}from"./p-8322a04a.js";class k{dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(t,e,s){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===t.type||"esriSFS"===t.type){const[s,i,r]=p.rasterizeSimpleFill(this._rasterizationCanvas,t.style,e);return{size:[i,r],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if("simple-line"===t.type||"esriSLS"===t.type){const[e,s,i]=p.rasterizeSimpleLine(t.style,t.cap);return{size:[s,i],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let i,r,n;if("simple-marker"===t.type||"esriSMS"===t.type||"line-marker"===t.type?(i=g.fromSimpleMarker(t),n=w(i)):"CIMHatchFill"===t.type?(i=g.fromCIMHatchFill(t),r=new C(i.frame.xmin,-i.frame.ymax,i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin)):t.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===t.markerPlacement.type?(i=g.fromCIMInsidePolygon(t),r=new C(i.frame.xmin,-i.frame.ymax,i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin)):(i=t,n=w(i)),n&&!s){const[t,e,s]=I(n);return t?{size:[e,s],image:new Uint32Array(t.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[a,o,l,c,h]=g.rasterize(this._rasterizationCanvas,i,r,!s);return a?{size:[o,l],image:new Uint32Array(a.buffer),sdf:!1,simplePattern:!1,anchorX:c,anchorY:h}:null}rasterizeImageResource(e,s,i,r){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=s;const n=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${s}px`),n.drawImage(i,0,0,e,s));const a=n.getImageData(0,0,e,s),o=new Uint8Array(a.data);if(r)for(const t of r)if(t&&t.oldColor&&4===t.oldColor.length&&t.newColor&&4===t.newColor.length){const[e,s,i,r]=t.oldColor,[n,a,l,c]=t.newColor;if(e===n&&s===a&&i===l&&r===c)continue;for(let t=0;t<o.length;t+=4)e===o[t]&&s===o[t+1]&&i===o[t+2]&&r===o[t+3]&&(o[t]=n,o[t+1]=a,o[t+2]=l,o[t+3]=c)}let l;for(let t=0;t<o.length;t+=4)l=o[t+3]/255,o[t]=o[t]*l,o[t+1]=o[t+1]*l,o[t+2]=o[t+2]*l;let c=o,h=e,u=s;const f=512;if(h>=f||u>=f){const i=h/u;i>1?(h=f,u=Math.round(f/i)):(u=f,h=Math.round(f*i)),c=new Uint8Array(4*h*u);const r=new Uint8ClampedArray(c.buffer);t(o,e,s,r,h,u,!1)}return{size:[e,s],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}class x{constructor(){}rasterizeText(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const s=this._textRasterizationCanvas,i=s.getContext("2d");this.setFontProperties(i,e),this.parameters=e,this.textLines=t.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const r=this.computeTextWidth(i,e),n=this.lineHeight*this.textLines.length;var a;s.width=r,s.height=n,this.renderedLineHeight=Math.round(this.lineHeight*e.pixelRatio),this.renderedHaloSize=e.halo.size*e.pixelRatio,this.renderedWidth=r*e.pixelRatio,this.renderedHeight=n*e.pixelRatio,this.fillStyle=`rgba(${(a=e.color).slice(0,3).toString()},${a[3]})`,this.haloStyle=function(t){return`rgb(${t.slice(0,3).toString()})`}(e.halo.color);const o=this.renderedLineHeight,l=this.renderedHaloSize;this.setFontProperties(i,e);const c=function(t,e){return"center"===t?.5*e:"right"===t?e:0}(i.textAlign,this.renderedWidth)+l,h=l;let u=0,f=0;l>0&&this.renderHalo(i,c,h,u,f,e),f+=h,u+=c;for(const t of this.textLines)i.globalCompositeOperation="destination-out",i.fillStyle="rgb(0, 0, 0)",i.fillText(t,u,f),i.globalCompositeOperation="source-over",i.fillStyle=this.fillStyle,i.fillText(t,u,f),f+=o;const m=i.getImageData(0,0,this.renderedWidth,this.renderedHeight),y=new Uint8Array(m.data);if(e.premultiplyColors){let t;for(let e=0;e<y.length;e+=4)t=y[e+3]/255,y[e]=y[e]*t,y[e+1]=y[e+1]*t,y[e+2]=y[e+2]*t}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(y.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(t,e,s,i,r,n){const a=this.renderedWidth,o=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=a,this._haloRasterizationCanvas.height=o;const l=this._haloRasterizationCanvas,c=l.getContext("2d");c.clearRect(0,0,a,o),this.setFontProperties(c,n),c.fillStyle=this.haloStyle,c.strokeStyle=this.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this.renderHaloEmulated(c,e,s):this.renderHaloNative(c,e,s),t.globalAlpha=this.parameters.halo.color[3],t.drawImage(l,0,0,a,o,i,r,a,o),t.globalAlpha=1}renderHaloEmulated(t,e,s){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const n of this.textLines){for(const[i,a]of v)t.fillText(n,e+r*i,s+r*a);s+=i}}renderHaloNative(t,e,s){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const n of this.textLines){const a=2*r,o=5,l=.1;for(let i=0;i<o;i++)t.lineWidth=(1-(o-1)*l+i*l)*a,t.strokeText(n,e,s);s+=i}}setFontProperties(t,s){const i=s.font,r=`${i.style} ${i.weight} ${e(s.size*s.pixelRatio)}px ${i.family}, sans-serif`;let n;switch(t.font=r,t.textBaseline="top",s.horizontalAlignment){case"left":n="left";break;case"right":n="right";break;case"center":n="center";break;default:n="left"}t.textAlign=n}computeTextWidth(t,e){let s=0;for(const e of this.textLines)s=Math.max(s,t.measureText(e).width);const i=e.font;return("italic"===i.style||"oblique"===i.style||"string"==typeof i.weight&&("bold"===i.weight||"bolder"===i.weight)||"number"==typeof i.weight&&i.weight>600)&&(s+=.3*t.measureText("A").width),s+=2*this.parameters.halo.size,Math.round(s)}computeLineHeight(){return Math.round(1.275*this.parameters.size+2*this.parameters.halo.size)}}const v=[];{const t=16;for(let e=0;e<360;e+=360/t)v.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var z;!function(t){t.Legend="legend",t.Preview="preview"}(z||(z={}));const S=(t,s,i)=>{if(t&&t.targetSize){let r;if(i){const s=Math.max(i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin);r=t.targetSize/e(s)}else r=t.targetSize/s.referenceSize;return r}return t&&t.scaleFactor?t.scaleFactor:1},A={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};function U(t,e,s,i){let r,n;return"function"==typeof t.materialHash?(r=(0,t.materialHash)(e,s,i),n=b(t.cim,t.materialOverrides)):(r=t.materialHash,n=t.cim),{analyzedCIM:n,hash:r}}const X=new class{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._rasterizer=new k,this._textRasterizer=new x,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(t,e,s,i,r,n,a,o){i=i||(e?null!=e.centroid?"esriGeometryPolygon":m(e.geometry):null)||function(t){if(!(t&&t.data&&t.data.symbol))return null;switch(t.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(t);const l=await this.analyzeCIMSymbol(t,e?function(t){return(t?Object.keys(t):[]).map((e=>({name:e,alias:e,type:"string"==typeof t[e]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(e.attributes):null,s,i,o);return this.rasterizeCIMSymbol(l,e,i,r,n,a)}async analyzeCIMSymbol(t,e,n,a,o){const l=[],c=e?{geometryType:a,spatialReference:this._spatialReference,fields:e}:null;let h;await P(t.data,c,l,this._avoidSDF),s(o);for(const t of l)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(h||(h=[]),h.push(this.fetchPictureMarkerResource(t,o))),n&&"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=i(n,t.text,t.cim.textCase));return h&&await r(h),l}async fetchPictureMarkerResource(t,e){const s=t.materialHash;if(!this._pictureMarkerCache.get(s)){const i=(await n(t.cim.url,{responseType:"image",signal:e&&e.signal})).data;this._pictureMarkerCache.set(s,i)}}rasterizeCIMSymbol(t,e,s,i,r,n){const o=[];for(const l of t){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(e,r,n));const t=this._getRasterizedResource(l,e,s,i,r,n);if(!t)continue;let c=0,h=t.anchorX||0,u=t.anchorY||0,f=!1,m=0,y=0;if("esriGeometryPoint"===s){const t=S(i,l,null);if(m=a(l.offsetX,e,r,n)*t||0,y=a(l.offsetY,e,r,n)*t||0,"marker"===l.type)c=a(l.rotation,e,r,n)||0,f=!!l.rotateClockwise&&l.rotateClockwise;else if("text"===l.type){if(c=a(l.angle,e,r,n)||0,void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case"left":h=-.5;break;case"right":h=.5;break;default:h=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case"top":u=.5;break;case"bottom":u=-.5;break;case"baseline":u=-.25;break;default:u=0}}}null!=t&&o.push({angle:c,rotateClockWise:f,anchorX:h,anchorY:u,offsetX:m,offsetY:y,rasterizedResource:t})}return this.getSymbolImage(o)}getSymbolImage(t){const s=document.createElement("canvas"),i=s.getContext("2d");let r=0,n=0,a=0,l=0;const c=[];for(let s=0;s<t.length;s++){const o=t[s],h=o.rasterizedResource;if(!h)continue;const u=h.size,f=o.offsetX,m=o.offsetY,y=o.anchorX,M=o.anchorY,d=o.rotateClockWise||!1;let p=o.angle,g=e(f)-u[0]*(.5+y),w=e(m)-u[1]*(.5+M),C=g+u[0],I=w+u[1];if(p){d&&(p=-p);const t=Math.sin(p*Math.PI/180),e=Math.cos(p*Math.PI/180),s=g*e-w*t,i=g*t+w*e,r=g*e-I*t,n=g*t+I*e,a=C*e-I*t,o=C*t+I*e,l=C*e-w*t,c=C*t+w*e;g=Math.min(s,r,a,l),w=Math.min(i,n,o,c),C=Math.max(s,r,a,l),I=Math.max(i,n,o,c)}r=g<r?g:r,n=w<n?w:n,a=C>a?C:a,l=I>l?I:l;const P=i.createImageData(h.size[0],h.size[1]);P.data.set(new Uint8ClampedArray(h.image.buffer)),c.push({offsetX:f,offsetY:m,rotateClockwise:d,angle:p,rasterizedImage:P,anchorX:y,anchorY:M})}s.width=a-r,s.height=l-n;const h=-r,u=l;for(let t=0;t<c.length;t++){const s=c[t],r=this._imageDataToCanvas(s.rasterizedImage),n=h-s.rasterizedImage.width*(.5+s.anchorX),a=u-s.rasterizedImage.height*(.5-s.anchorY);if(s.angle){const t=(360-s.angle)*Math.PI/180;i.save(),i.translate(e(s.offsetX),-e(s.offsetY)),i.translate(h,u),i.rotate(t),i.translate(-h,-u),i.drawImage(r,n,a),i.restore()}else i.drawImage(r,n+e(s.offsetX),a-e(s.offsetY))}const f=new o({x:h/s.width-.5,y:u/s.height-.5});return{imageData:0!==s.width&&0!==s.height?i.getImageData(0,0,s.width,s.height):i.createImageData(1,1),anchorPosition:f}}_imageDataToCanvas(t){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const e=this._imageDataCanvas,s=e.getContext("2d");return e.width=t.width,e.height=t.height,s.putImageData(t,0,0),e}_imageTo32Array(t,e,s){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,r=i.getContext("2d");return i.width=e,i.height=s,r.drawImage(t,0,0,e,s),new Uint32Array(r.getImageData(0,0,e,s).data.buffer)}_getRasterizedResource(t,e,s,i,r,n){let o,h,u,f;if("esriGeometryPolyline"===s||"esriGeometryPolygon"===s){const c=i&&i.style?i.style:z.Legend,f="esriGeometryPolyline"===s?A.stroke[c]:A.fill[c];if("line"===t.type){if("CIMSolidStroke"!==t.cim.type){if("CIMPictureStroke"===t.cim.type){const s=a(t.width,e,r,n);let i,o,l;return({image:i,width:o,height:l}=this._getPictureResource(t,s)),this._rasterizePictureResource(t,i,o,l,f,s)}return null}({analyzedCIM:o,hash:u}=U(t,e,r,n)),h=this._embedCIMLayerInVectorMarker(o,f)}else if("marker"===t.type){if("CIMPictureMarker"===t.cim.type)return null;if("CIMVectorMarker"!==t.cim.type)return null;t.cim.offsetX=a(t.offsetX,e,r,n),t.cim.offsetY=a(t.offsetY,e,r,n),t.cim.rotation=a(t.rotation,e,r,n),t.cim.markerPlacement=t.markerPlacement,({analyzedCIM:o}=U(t,e,r,n)),u=l(JSON.stringify(o)).toString(),h=this._embedCIMLayerInVectorMarker(o,f)}else{if("text"===t.type)return null;if("fill"===t.type){if("CIMHatchFill"===t.cim.type||"CIMVectorMarker"===t.cim.type||"CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type){const s=t.cim.size||t.cim.height;let i,a,l;if("CIMPictureMarker"===t.cim.type||"CIMPictureFill"===t.cim.type)({image:i,width:a,height:l}=this._getPictureResource(t,s));else{({analyzedCIM:o,hash:u}=U(t,e,r,n));const s=this._rasterizer.rasterizeJSONResource(o,1,this._avoidSDF);i=s.image,a=s.size[0],l=s.size[1]}return this._rasterizePictureResource(t,i,a,l,f,null)}if("CIMSolidFill"!==t.cim.type)return null;({analyzedCIM:o,hash:u}=U(t,e,r,n)),h=this._embedCIMLayerInVectorMarker(o,f)}}}else{if("text"===t.type)return f=this._rasterizeTextResource(t,e,i,r,n),f;({analyzedCIM:o,hash:u}=U(t,e,r,n));const s=S(i,t,null);if("CIMPictureMarker"===t.cim.type){const i=a(t.size,e,r,n)*s,{image:o,width:l,height:c}=this._getPictureResource(t,i);return f={image:o,size:[l,c],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},f}c(o,s,{preserveOutlineWidth:!1}),h=o}u+=s,i&&(u+=JSON.stringify(i));const m=this._resourceCache;return m.has(u)?m.get(u):(f=this._rasterizer.rasterizeJSONResource(h,window.devicePixelRatio||1,this._avoidSDF),m.set(u,f),f)}_rasterizeTextResource(t,e,s,i,r){const n=S(s,t,null),o=a(t.text,e,i,r);if(!o||0===o.length)return null;const l=a(t.fontName,e,i,r),c=a(t.style,e,i,r),u=a(t.weight,e,i,r),f=a(t.decoration,e,i,r),m=a(t.size,e,i,r)*n,y=a(t.horizontalAlignment,e,i,r),M=a(t.verticalAlignment,e,i,r),d=h(a(t.color,e,i,r)),p=h(a(t.outlineColor,e,i,r)),g={color:d,size:m,horizontalAlignment:y,verticalAlignment:M,font:{family:l,style:c,weight:u,decoration:f},halo:{size:a(t.outlineSize,e,i,r)||0,color:p,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,g)}_rasterizePictureResource(t,s,i,r,n,a){const o=document.createElement("canvas"),l=o.getContext("2d");o.height=e(Math.max(Math.abs(n.frame.ymax-n.frame.ymin),a)),o.width=e(Math.abs(n.frame.xmax-n.frame.xmin));const c=l.createImageData(i,r);c.data.set(new Uint8ClampedArray(s.buffer));const h=this._imageDataToCanvas(c),m=l.createPattern(h,"repeat"),y=Math.cos((-t.cim.rotation||0)*Math.PI/180),M=Math.sin((-t.cim.rotation||0)*Math.PI/180);m.setTransform({m11:y,m12:M,m21:-M,m22:y,m41:e(t.cim.offsetX)||0,m42:e(t.cim.offsetY)||0});const d=n.canvasPaths;let p,g,w;u(d)?(p=d.rings,l.fillStyle=m,g=l.fill,w=["evenodd"]):f(d)&&(p=d.paths,l.strokeStyle=m,l.lineWidth=a,g=l.stroke,p[0][0][1]=o.height/2,p[0][1][1]=o.height/2),l.beginPath();for(const t of p){const s=t?t.length:0;if(s>1){let i=t[0];l.moveTo(e(i[0]),e(i[1]));for(let r=1;r<s;++r)i=t[r],l.lineTo(e(i[0]),e(i[1]));l.closePath()}}g.apply(l,w);const C=l.getImageData(0,0,o.width,o.height),I=new Uint8Array(C.data);return{size:[o.width,o.height],image:new Uint32Array(I.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(t,s){const i=this._pictureMarkerCache.get(t.materialHash);if(!i)return null;const r=i.height/i.width,n=s?r>1?e(s):e(s)/r:i.width,a=s?r>1?e(s)*r:e(s):i.height;return{image:this._imageTo32Array(i,n,a),width:n,height:a}}_embedCIMLayerInVectorMarker(t,e){const s=u(e.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:e.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:e.geometry,symbol:{type:s,symbolLayers:[t]}}]}}}(null,!0);async function Y(t,e={}){const{size:s,maxSize:i,feature:r,fieldMap:n,geometryType:a,style:o,node:l,opacity:c}=e,h=y(t),u=Math.min(null!=s?s:h,null!=i?i:d(120));u!==h&&(t=t.clone(),M(t,u,{preserveOutlineWidth:!0}));let f=3;t&&t.data&&t.data.symbol&&"CIMPointSymbol"!==t.data.symbol.type&&(f=1);const m=await X.rasterizeCIMSymbolAsync(t,r,n,a,{scaleFactor:f,style:o}),p=document.createElement("canvas");p.width=m.imageData.width,p.height=m.imageData.height,p.getContext("2d").putImageData(m.imageData,0,0);let g=p.width/f,w=p.height/f;if(null!=s&&(null==(null==e?void 0:e.scale)||(null==e?void 0:e.scale))){const t=g/w;g=t<=1?Math.ceil(u*t):u,w=t<=1?u:Math.ceil(u/t)}const C=new Image(g,w);return C.src=p.toDataURL(),null!=c&&(C.style.opacity=`${c}`),l&&l.appendChild(C),C}export{Y as previewCIMSymbol}