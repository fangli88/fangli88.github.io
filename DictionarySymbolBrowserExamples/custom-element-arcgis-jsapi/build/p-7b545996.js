import"./p-476cf7c4.js";import{y as e,M as s,s as t,Z as i,eE as r,aI as l,eF as o,ay as n,b3 as a,b6 as u,z as p,bV as h,aS as y,U as c,D as d,E as m,aU as b,F as f,K as v,b as j,dw as w,b9 as g}from"./p-dc4230e0.js";import"./p-643e1e47.js";import"./p-66f366a9.js";import"./p-365c5902.js";import{j as S,x}from"./p-76e49c46.js";import"./p-540c739d.js";import"./p-b415e09b.js";import{l as G,b as M}from"./p-05aa0405.js";import"./p-6e5ff36c.js";import{l as O,p as P}from"./p-5e52b0f8.js";import{d as k}from"./p-536a38f2.js";import"./p-0a74e573.js";import"./p-46a6b4f6.js";import{S as L,i as E,o as F,C as K}from"./p-78ce4926.js";import"./p-0038f454.js";import"./p-1f2c53c6.js";import"./p-0c52ed76.js";import{t as z}from"./p-4cc1d148.js";import{o as N}from"./p-3ce6769f.js";import{s as C}from"./p-3a5e7221.js";import{l as I}from"./p-dabedd67.js";const R={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function T(e){const s=e.folders||[],i=s.slice(),r=new Map,l=new Map,o=new Map,n=new Map,a=new Map,u={esriGeometryPoint:l,esriGeometryPolyline:o,esriGeometryPolygon:n};(e.featureCollection&&e.featureCollection.layers||[]).forEach((e=>{const s=t(e);s.featureSet.features=[];const i=e.featureSet.geometryType;r.set(i,s);const a=e.layerDefinition.objectIdField;"esriGeometryPoint"===i?J(l,a,e.featureSet.features):"esriGeometryPolyline"===i?J(o,a,e.featureSet.features):"esriGeometryPolygon"===i&&J(n,a,e.featureSet.features)})),e.groundOverlays&&e.groundOverlays.forEach((e=>{a.set(e.id,e)})),s.forEach((s=>{s.networkLinkIds.forEach((t=>{const r=function(e,s,t){const i=function(e,s){let t;return s.some((s=>s.id===e&&(t=s,!0))),t}(e,t);return i&&(i.parentFolderId=s,i.networkLink=i),i}(t,s.id,e.networkLinks);r&&i.push(r)}))})),i.forEach((e=>{e.featureInfos&&(e.points=t(r.get("esriGeometryPoint")),e.polylines=t(r.get("esriGeometryPolyline")),e.polygons=t(r.get("esriGeometryPolygon")),e.mapImages=[],e.featureInfos.map((s=>{switch(s.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const t=u[s.type].get(s.id);t&&e[R[s.type]].featureSet.features.push(t);break}case"GroundOverlay":{const t=a.get(s.id);t&&e.mapImages.push(t);break}}})),e.fullExtent=U([e]))}));const p=U(i);return{folders:s,sublayers:i,extent:p}}function V(e,t,o,n){const a=i&&i.findCredential(e);return e=r(e,{token:a&&a.token}),s(l.kmlServiceUrl,{query:{url:e,model:"simple",folders:"",refresh:0!==o||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:n})}function _(e,s,t=null,i=[]){const r=[],l={},o=s.sublayers,n=s.folders.map((e=>e.id));return o.forEach((s=>{const o=new e;if(t?o.read(s,t):o.read(s),i.length&&n.indexOf(o.id)>-1&&(o.visible=-1!==i.indexOf(o.id)),l[s.id]=o,null!=s.parentFolderId&&-1!==s.parentFolderId){const e=l[s.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers.unshift(o)}else r.unshift(o)})),r}function J(e,s,t){t.forEach((t=>{e.set(t.attributes[s],t)}))}function U(s){const t=E(),i=E(K);for(const e of s){if(e.polygons&&e.polygons.featureSet&&e.polygons.featureSet.features)for(const s of e.polygons.featureSet.features)o(t,s.geometry),F(i,t);if(e.polylines&&e.polylines.featureSet&&e.polylines.featureSet.features)for(const s of e.polylines.featureSet.features)o(t,s.geometry),F(i,t);if(e.points&&e.points.featureSet&&e.points.featureSet.features)for(const s of e.points.featureSet.features)o(t,s.geometry),F(i,t);if(e.mapImages)for(const s of e.mapImages)o(t,s.extent),F(i,t)}return L(i,K)?null:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:e.WGS84}}var W;let q=W=class extends(n.EventedMixin(a(u))){constructor(){super(...arguments),this._sublayersHandles=null,this.description=null,this.id=null,this.networkLink=null,this.title=null,this.sourceJSON=null,this.fullExtent=null}initialize(){S(this,"networkLink").then((()=>x(this,"visible"))).then((()=>this.load()))}load(e){if(!this.networkLink)return;const s=j(e)?e.signal:null,t=this._fetchService(this._get("networkLink").href,s).then((e=>{const s=U(e.sublayers);this.fullExtent=p.fromJSON(s),this.sourceJSON=e;const t=h(y.ofType(W),_(W,e));this.sublayers?this.sublayers.addMany(t):this.sublayers=t,this.layer.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")}));return this.addResolvingPromise(t),c(this)}set sublayers(e){const s=this._get("sublayers");s&&(s.forEach((e=>{e.parent=null,e.layer=null})),this._sublayersHandles.forEach((e=>e.remove())),this._sublayersHandles=null),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this._sublayersHandles=[e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))]),this._set("sublayers",e)}castSublayers(e){return h(y.ofType(W),e)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,s){return!!s.visibility}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach((s=>s.layer=e))}_fetchService(e,s){return V(e,this.layer.outSpatialReference,this.layer.refreshInterval,s).then((e=>T(e.data)))}};d([m()],q.prototype,"description",void 0),d([m()],q.prototype,"id",void 0),d([m({readOnly:!0,value:null})],q.prototype,"networkLink",void 0),d([m({json:{write:{allowNull:!0}}})],q.prototype,"parent",void 0),d([m({value:null,json:{write:{allowNull:!0}}})],q.prototype,"sublayers",null),d([b("sublayers")],q.prototype,"castSublayers",null),d([m({value:null,json:{read:{source:"name"}}})],q.prototype,"title",void 0),d([m({value:!0})],q.prototype,"visible",null),d([f("visible",["visibility"])],q.prototype,"readVisible",null),d([m()],q.prototype,"sourceJSON",void 0),d([m({value:null})],q.prototype,"layer",null),d([m({type:p})],q.prototype,"fullExtent",void 0),q=W=d([v("esri.layers.support.KMLSublayer")],q);var A=q;const D=["kml","xml"];let Z=class extends(z(N(C(O(k(G(M))))))){constructor(...s){super(...s),this._visibleFolders=[],this.allSublayers=new I({root:this,rootCollectionNames:["sublayers"],getChildrenFunction:e=>e.sublayers}),this.outSpatialReference=e.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType="KML",this.sublayers=null,this.type="kml",this.url=null}initialize(){this.watch("sublayers",((e,s)=>{s&&s.forEach((e=>{e.parent=null,e.layer=null})),e&&e.forEach((e=>{e.parent=this,e.layer=this}))}),!0),this.on("sublayer-update",(()=>this.notifyChange("fullExtent")))}normalizeCtorArgs(e,s){return"string"==typeof e?{url:e,...s}:e}readSublayersFromItemOrWebMap(e,s){this._visibleFolders=s.visibleFolders}readSublayers(e,s,t){return _(A,s,t,this._visibleFolders)}writeSublayers(e,s){const t=[],i=e.toArray();for(;i.length;){const e=i[0];e.networkLink||(e.visible&&t.push(e.id),e.sublayers&&i.push(...e.sublayers.toArray())),i.shift()}s.visibleFolders=t}get title(){const e=this._get("title");return e&&"defaults"!==this.originOf("title")?e:this.url?w(this.url,D)||"KML":e||""}set title(e){this._set("title",e)}get visibleSublayers(){const e=this.sublayers,s=[],t=e=>{e.visible&&(s.push(e),e.sublayers&&e.sublayers.forEach(t))};return e&&e.forEach(t),s}get fullExtent(){return this._recomputeFullExtent()}load(e){const s=j(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"]},e).then((()=>this._fetchService(s)))),c(this)}async _fetchService(e){const s=T((await c().then((()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:V(this.url,this.outSpatialReference,this.refreshInterval,e)))).data);s&&this.read(s,{origin:"service"})}_recomputeFullExtent(){let e=null;this.extent&&(e=this.extent.clone());const s=t=>{if(t.sublayers)for(const i of t.sublayers.items)s(i),i.visible&&i.fullExtent&&(e?e.union(i.fullExtent):e=i.fullExtent.clone())};return s(this),e}};d([m({readOnly:!0})],Z.prototype,"allSublayers",void 0),d([m({type:e})],Z.prototype,"outSpatialReference",void 0),d([m({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Z.prototype,"path",void 0),d([m({readOnly:!0,json:{read:!1,write:!1}})],Z.prototype,"legendEnabled",void 0),d([m({type:["show","hide","hide-children"]})],Z.prototype,"listMode",void 0),d([m({type:["KML"]})],Z.prototype,"operationalLayerType",void 0),d([m({type:y.ofType(A),json:{write:{ignoreOrigin:!0}}})],Z.prototype,"sublayers",void 0),d([f(["web-map","portal-item"],"sublayers",["visibleFolders"])],Z.prototype,"readSublayersFromItemOrWebMap",null),d([f("service","sublayers",["sublayers"])],Z.prototype,"readSublayers",null),d([g("sublayers")],Z.prototype,"writeSublayers",null),d([m({readOnly:!0,json:{read:!1}})],Z.prototype,"type",void 0),d([m({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}},dependsOn:["url","parsedUrl"]})],Z.prototype,"title",null),d([m(P)],Z.prototype,"url",void 0),d([m({readOnly:!0,dependsOn:["sublayers"]})],Z.prototype,"visibleSublayers",null),d([m({type:p})],Z.prototype,"extent",void 0),d([m({dependsOn:["extent"]})],Z.prototype,"fullExtent",null),Z=d([v("esri.layers.KMLLayer")],Z);var B=Z;export default B;