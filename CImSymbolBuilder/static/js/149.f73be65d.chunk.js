(this["webpackJsonpmy-app"]=this["webpackJsonpmy-app"]||[]).push([[149],{733:function(e,t,a){"use strict";a.r(t);var s=a(0),r=a(5),u=a(11),n=a(6),l=(a(4),a(7),a(1)),i=a(2),o=a(14),d=a(3),c=(a(9),a(10),a(8)),h=a(50),p=a(80),y=a(187),b=a(295),m=a(333);const F=new Set(["Feature Layer","Table"]);let g=class extends p.a{constructor(){super(...arguments),this.type="feature-layer"}load(e){const t=Object(n.h)(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Object(c.u)(this)}get queryTask(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:t,dynamicDataSource:a,gdbVersion:s,spatialReference:u}=this.layer,n=Object(r.a)("featurelayer-pbf")&&e?"pbf":"json";return new m.a({url:t.path,format:n,dynamicDataSource:a,gdbVersion:s,sourceSpatialReference:u})}addAttachment(e,t){return this.load().then(()=>{const a=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+a+"/addAttachment",r=this._getLayerRequestOptions(),u=this._getFormDataForAttachment(t,r.query);return Object(h.default)(s,{body:u}).then(e=>this._createFeatureEditResult(e.data.addAttachmentResult)).catch(e=>{throw this._createAttachmentErrorResult(a,e)})})}updateAttachment(e,t,a){return this.load().then(()=>{const s=e.attributes[this.layer.objectIdField],r=this.layer.parsedUrl.path+"/"+s+"/updateAttachment",u=this._getLayerRequestOptions({query:{attachmentId:t}}),n=this._getFormDataForAttachment(a,u.query);return Object(h.default)(r,{body:n}).then(e=>this._createFeatureEditResult(e.data.updateAttachmentResult)).catch(e=>{throw this._createAttachmentErrorResult(s,e)})})}async applyEdits(e,t){await this.load();const a=e.addFeatures.map(this._serializeFeature,this),s=e.updateFeatures.map(this._serializeFeature,this),r=this._getFeatureIds(e.deleteFeatures);Object(y.b)(a,s,this.layer.spatialReference);const u=[],n=[],l=[...e.deleteAttachments];for(const c of e.addAttachments)u.push(await this._serializeAttachment(c));for(const c of e.updateAttachments)n.push(await this._serializeAttachment(c));const i=u.length||n.length||l.length?{adds:u,updates:n,deletes:l}:null,o=this._getLayerRequestOptions({method:"post",query:{adds:a.length?JSON.stringify(a):null,updates:s.length?JSON.stringify(s):null,deletes:r.length?r.join(","):null,gdbVersion:null==t?void 0:t.gdbVersion,rollbackOnFailure:null==t?void 0:t.rollbackOnFailureEnabled,useGlobalIds:null==t?void 0:t.globalIdUsed,attachments:i&&JSON.stringify(i)}}),d=await Object(h.default)(this.layer.parsedUrl.path+"/applyEdits",o);return this._createEditsResult(d)}deleteAttachments(e,t){return this.load().then(()=>{const a=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";return Object(h.default)(s,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"})).then(e=>e.data.deleteAttachmentResults.map(this._createFeatureEditResult)).catch(e=>{throw this._createAttachmentErrorResult(a,e)})})}queryAttachments(e,t={}){const{parsedUrl:a}=this.layer,s=a.path;return this.load().then(()=>{const a=this._getLayerRequestOptions(t);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const{objectIds:t}=e,r=[];for(const e of t){const t=s+"/"+e+"/attachments";r.push(Object(h.default)(t,a))}return Object(c.b)(r).then(e=>t.map((t,a)=>({parentObjectId:t,attachmentInfos:e[a].data.attachmentInfos}))).then(e=>Object(b.b)(e,s))}return this.queryTask.executeAttachmentQuery(e,a)})}queryFeatures(e,t){return this.load().then(()=>this.queryTask.execute(e,t))}queryFeaturesJSON(e,t){return this.load().then(()=>this.queryTask.executeJSON(e,t))}queryObjectIds(e,t){return this.load().then(()=>this.queryTask.executeForIds(e,t))}queryFeatureCount(e,t){return this.load().then(()=>this.queryTask.executeForCount(e,t))}queryExtent(e,t){return this.load().then(()=>this.queryTask.executeForExtent(e,t))}queryRelatedFeatures(e,t){return this.load().then(()=>this.queryTask.executeRelationshipQuery(e,t))}queryRelatedFeaturesCount(e,t){return this.load().then(()=>this.queryTask.executeRelationshipQueryForCount(e,t))}async _fetchService(e){const t=this.layer.sourceJSON;if(t)this.sourceJSON=t;else{const{data:t}=await Object(h.default)(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:Object(r.a)("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));this.sourceJSON=t}const a=this.sourceJSON.type;if(!F.has(a))throw new o.a("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`)}_serializeFeature(e){const{geometry:t,attributes:a}=e;return Object(n.g)(t)?{attributes:a}:"mesh"===t.type||"extent"===t.type?null:{geometry:t.toJSON(),attributes:a}}async _serializeAttachment(e){const{feature:t,attachment:a}=e,{globalId:s,name:r,contentType:u,data:n,uploadId:l}=a,i={globalId:s,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(i.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),l)i.uploadId=l;else if(n){const e=await async function(e){return"string"==typeof e?Object(d.i)(e)||{data:e}:Object(c.c)((t,a)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(Object(d.i)(s.result)),s.onerror=e=>a(e)})}(n);i.contentType=e.mediaType,i.data=e.data,n instanceof File&&(i.name=n.name)}return r&&(i.name=r),u&&(i.contentType=u),i}_getFeatureIds(e){const t=e[0];return t?"objectId"in t?this._getIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]}_getIdsFromFeatures(e){const t=this.layer.objectIdField;return e.map(e=>e.attributes&&e.attributes[t])}_getIdsFromFeatureIdentifier(e){return e.map(e=>e.objectId)}_createEditsResult(e){const t=e.data,a=e.data&&e.data.attachments;return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:a&&a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:a&&a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:a&&a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new o.a("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_createAttachmentErrorResult(e,t){const a=t.details.messages&&t.details.messages[0]||t.message,s=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new o.a("feature-layer-source:attachment-failure",a,{code:s})}}_getFormDataForAttachment(e,t){const a=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(a)for(const s in t){const e=t[s];null!=e&&(a.set?a.set(s,e):a.append(s,e))}return a}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:a,dynamicDataSource:s}=this.layer;return{...e,query:Object(u.c)({gdbVersion:a,layer:s?JSON.stringify({source:s}):void 0,...t.query,f:"json",...null==e?void 0:e.query}),responseType:"json"}}};Object(s.a)([Object(l.b)()],g.prototype,"type",void 0),Object(s.a)([Object(l.b)({constructOnly:!0})],g.prototype,"layer",void 0),Object(s.a)([Object(l.b)({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion","layer.dynamicDataSource"]})],g.prototype,"queryTask",null),g=Object(s.a)([Object(i.a)("esri.layers.graphics.sources.FeatureLayerSource")],g);var R=g;t.default=R}}]);
//# sourceMappingURL=149.f73be65d.chunk.js.map